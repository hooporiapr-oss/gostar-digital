<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>THE DRILL | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --purple: #9D4EDD;
    --purple-dark: #7B2CBF;
    --pink: #FF1493;
    --pink-light: #FF69B4;
    --gold: #FFD700;
    --teal: #00D9A5;
    --orange: #FF6B00;
    --cyan: #00CED1;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.08);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    height: 100%;
    overflow: hidden;
}
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100vh;
    height: 100dvh;
}
body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

/* Main Container - NO SCROLL */
.game-container {
    max-width: 420px;
    margin: 0 auto;
    padding: 8px 12px;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Language Toggle */
.lang-toggle {
    position: absolute;
    top: 8px;
    right: 12px;
    display: flex;
    gap: 4px;
    z-index: 10;
}
.lang-btn {
    padding: 4px 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.lang-btn.active {
    background: var(--purple);
    color: var(--text);
    border-color: var(--purple);
}

/* Back Button */
.back-btn {
    position: absolute;
    top: 8px;
    left: 12px;
    color: var(--muted);
    text-decoration: none;
    font-size: 0.7rem;
    z-index: 10;
}
.back-btn:hover { color: var(--text); }

/* Header - Compact */
.header {
    text-align: center;
    padding: 6px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--purple), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.powered-by {
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
}
.powered-by .ritnome { color: var(--gold); font-weight: 700; }

/* Stats Bar - Compact */
.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 6px 10px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--gold);
}
.stat-label {
    font-size: 0.5rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Message Display */
.message-display {
    background: linear-gradient(135deg, var(--card), var(--darker));
    border: 2px solid var(--purple);
    border-radius: 10px;
    padding: 8px 12px;
    margin: 4px 0;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}
.message-display::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, rgba(157,78,221,0.1), transparent);
    pointer-events: none;
}
.sequence-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(255,215,0,0.5);
    animation: numberPop 0.3s ease-out;
}
@keyframes numberPop {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); opacity: 1; }
}
.message-text {
    font-size: 0.75rem;
    color: var(--muted);
    text-align: center;
}
.message-text.forward { color: var(--teal); }
.message-text.backward { color: var(--pink); }

/* Mode Selector - Compact */
.mode-selector {
    display: flex;
    gap: 6px;
    margin: 4px 0;
    flex-shrink: 0;
}
.mode-btn {
    flex: 1;
    padding: 6px;
    border: 2px solid var(--card);
    background: var(--card);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
}
.mode-btn.active {
    border-color: var(--purple);
    color: var(--text);
    background: linear-gradient(135deg, rgba(157,78,221,0.2), transparent);
}

/* Ritnome‚Ñ¢ Tempo Selector - Inline */
.tempo-section {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tempo-label {
    font-size: 0.55rem;
    color: var(--muted);
    white-space: nowrap;
}
.tempo-label .ritnome { color: var(--gold); font-weight: 700; }
.tempo-buttons {
    display: flex;
    gap: 4px;
    flex: 1;
}
.tempo-btn {
    flex: 1;
    padding: 6px 4px;
    border: 1px solid var(--card);
    background: var(--card);
    border-radius: 6px;
    color: var(--muted);
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    position: relative;
}
.tempo-btn .icon { font-size: 0.8rem; }
.tempo-btn .bpm { font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; }
.tempo-btn.active {
    border-color: var(--gold);
    color: var(--gold);
    background: rgba(255,215,0,0.1);
}

/* BPM Lock Styles */
.tempo-btn.locked {
    opacity: 0.5;
    cursor: not-allowed;
}
.tempo-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: 2px;
    right: 4px;
    font-size: 0.6rem;
}
.tempo-btn.locked:hover {
    border-color: var(--gold);
}

/* Court Grid - VISIBLE CELLS */
.court-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 8px;
    background: linear-gradient(145deg, var(--card), var(--darker));
    border-radius: 12px;
    border: 2px solid rgba(157,78,221,0.3);
    min-height: 0;
    aspect-ratio: 1;
    margin: 4px 0;
}
.grid-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
}

/* Colorful grid rows */
.grid-cell:nth-child(-n+5) { 
    background: linear-gradient(135deg, #FF6B00, #FF8C42); 
    color: var(--dark); 
}
.grid-cell:nth-child(n+6):nth-child(-n+10) { 
    background: linear-gradient(135deg, #FFD700, #FFA500); 
    color: var(--dark); 
}
.grid-cell:nth-child(n+11):nth-child(-n+15) { 
    background: linear-gradient(135deg, #00D9A5, #00CED1); 
    color: var(--dark); 
}
.grid-cell:nth-child(n+16):nth-child(-n+20) { 
    background: linear-gradient(135deg, #9D4EDD, #7B2CBF); 
    color: var(--text); 
}
.grid-cell:nth-child(n+21) { 
    background: linear-gradient(135deg, #FF1493, #FF69B4); 
    color: var(--dark); 
}

.grid-cell:hover { transform: scale(1.05); }
.grid-cell:active { transform: scale(0.95); }
.grid-cell.disabled { opacity: 0.5; pointer-events: none; }
.grid-cell.correct {
    animation: correctPulse 0.4s ease-out;
    box-shadow: 0 0 20px var(--teal), 0 0 40px var(--teal);
}
.grid-cell.wrong {
    animation: wrongShake 0.4s ease-out;
    box-shadow: 0 0 20px var(--pink);
}
.grid-cell.hint {
    animation: hintGlow 0.6s ease-in-out;
    box-shadow: 0 0 30px var(--gold), 0 0 50px var(--gold);
    transform: scale(1.1);
}
@keyframes correctPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}
@keyframes wrongShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}
@keyframes hintGlow {
    0%, 100% { box-shadow: 0 0 15px var(--gold); }
    50% { box-shadow: 0 0 40px var(--gold), 0 0 60px var(--gold); }
}

/* Progress Bar */
.progress-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tier-badge {
    background: linear-gradient(135deg, var(--purple), var(--pink));
    padding: 4px 10px;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 1px;
    white-space: nowrap;
}
.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--card);
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple), var(--pink));
    border-radius: 4px;
    transition: width 0.3s ease-out;
}

/* Action Button */
.action-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
    background: linear-gradient(135deg, var(--purple), var(--pink));
    color: var(--text);
    flex-shrink: 0;
}
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(157,78,221,0.5);
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Feedback Overlay */
.feedback-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 90%;
    animation: slideUp 0.3s ease-out;
    border: 2px solid var(--purple);
}
@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.feedback-emoji { font-size: 3rem; margin-bottom: 10px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 2px;
    margin-bottom: 8px;
}
.feedback-title.success { color: var(--teal); }
.feedback-title.fail { color: var(--pink); }
.feedback-message {
    color: var(--muted);
    margin-bottom: 20px;
    font-size: 0.85rem;
}
.feedback-ritnome {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 15px;
}
.feedback-ritnome .ritnome { color: var(--gold); }
.feedback-stats {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin-bottom: 20px;
}
.feedback-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    color: var(--gold);
}
.feedback-stat-label {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
}
.feedback-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 4px;
}
.feedback-btn.primary {
    background: linear-gradient(135deg, var(--purple), var(--pink));
    color: var(--text);
}
.feedback-btn.secondary {
    background: var(--darker);
    color: var(--muted);
    border: 1px solid var(--muted);
}

/* Upgrade Modal */
.upgrade-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 20px;
}
.upgrade-overlay.show { display: flex; }
.upgrade-card {
    background: linear-gradient(145deg, #1a1a25, #0d0d12);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 340px;
    width: 100%;
    box-shadow: 0 0 40px rgba(255,215,0,0.2);
}
.upgrade-icon { font-size: 3rem; margin-bottom: 15px; }
.upgrade-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 10px;
}
.upgrade-subtitle {
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 20px;
}
.upgrade-benefits {
    text-align: left;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
}
.upgrade-benefit {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    color: var(--text);
    font-size: 0.9rem;
}
.upgrade-benefit .check { color: var(--teal); }
.upgrade-price {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 5px;
}
.upgrade-price-note {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 20px;
}
.upgrade-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    letter-spacing: 2px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    margin-bottom: 10px;
}
.upgrade-close {
    background: transparent;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
}

/* Coach Message Toast */
.coach-message {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--purple), var(--pink));
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8rem;
    opacity: 0;
    transition: all 0.4s ease-out;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Desktop */
@media (min-width: 700px) {
    .game-container {
        max-width: 480px;
        padding: 15px 20px;
    }
    .header { padding: 10px 0; }
    .logo { font-size: 1.2rem; }
    .court-name { font-size: 1.8rem; }
    .stats-bar { padding: 10px 15px; gap: 25px; }
    .stat-value { font-size: 1.4rem; }
    .court-grid { gap: 6px; padding: 12px; }
    .grid-cell { font-size: 1.4rem; border-radius: 8px; }
    .action-btn { padding: 16px; font-size: 1.3rem; }
}
</style>
</head>
<body class="en">

<!-- Language Toggle -->
<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<!-- Back Button -->
<a href="laugh-hub.html" class="back-btn">‚Üê <span class="lang-en">Back</span><span class="lang-es">Volver</span></a>

<div class="game-container">
    <!-- Header -->
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT<sup style="font-size:0.5em">‚Ñ¢</sup></div>
        <div class="court-name">üèÄ THE DRILL</div>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="currentTier">1</div>
            <div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="bestTier">0</div>
            <div class="stat-label">Best</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
    </div>

    <!-- Message Display -->
    <div class="message-display" id="messageDisplay">
        <span class="message-text" id="messageText">
            <span class="lang-en">Select mode & tempo, then START!</span>
            <span class="lang-es">Selecciona modo y tempo, luego ¬°EMPIEZA!</span>
        </span>
    </div>

    <!-- Mode Selector -->
    <div class="mode-selector">
        <button class="mode-btn active" id="forwardBtn" data-mode="forward">
            ‚û°Ô∏è <span class="lang-en">FORWARD</span><span class="lang-es">ADELANTE</span>
        </button>
        <button class="mode-btn" id="backwardBtn" data-mode="backward">
            ‚¨ÖÔ∏è <span class="lang-en">BACKWARD</span><span class="lang-es">ATR√ÅS</span>
        </button>
    </div>

    <!-- Ritnome‚Ñ¢ Tempo Selector -->
    <div class="tempo-section">
        <div class="tempo-label">üéµ <span class="ritnome">Ritnome‚Ñ¢</span></div>
        <div class="tempo-buttons">
            <button class="tempo-btn active" data-bpm="60">
                <span class="icon">üê¢</span>
                <span class="bpm">60</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn" data-bpm="90">
                <span class="icon">üèÉ</span>
                <span class="bpm">90</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn" data-bpm="120">
                <span class="icon">‚ö°</span>
                <span class="bpm">120</span>
                <span>BPM</span>
            </button>
        </div>
    </div>

    <!-- Court Grid -->
    <div class="court-grid" id="courtGrid"></div>

    <!-- Progress Bar -->
    <div class="progress-section">
        <div class="tier-badge">
            <span class="lang-en">TIER</span><span class="lang-es">NIVEL</span> 
            <span id="tierDisplay">1</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Action Button -->
    <button class="action-btn" id="actionBtn">
        <span class="lang-en">START DRILL üèÄ</span>
        <span class="lang-es">INICIAR EJERCICIO üèÄ</span>
    </button>
</div>

<!-- Feedback Overlay -->
<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üéâ</div>
        <h2 class="feedback-title" id="feedbackTitle">GREAT JOB!</h2>
        <p class="feedback-message" id="feedbackMessage">You completed the drill!</p>
        <div class="feedback-ritnome"><span class="ritnome">Ritnome‚Ñ¢</span> Training</div>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackTier">1</div>
                <div class="feedback-stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackLaughs">0</div>
                <div class="feedback-stat-label">üòÇ Earned</div>
            </div>
        </div>
        <button class="feedback-btn primary" id="continueBtn">
            <span class="lang-en">CONTINUE üèÄ</span>
            <span class="lang-es">CONTINUAR üèÄ</span>
        </button>
        <button class="feedback-btn secondary" id="restartBtn">
            <span class="lang-en">RESTART</span>
            <span class="lang-es">REINICIAR</span>
        </button>
    </div>
</div>

<!-- Upgrade Modal -->
<div class="upgrade-overlay" id="upgradeOverlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">üîì</div>
        <h2 class="upgrade-title">
            <span class="lang-en">UNLOCK ALL TEMPOS</span>
            <span class="lang-es">DESBLOQUEA TODOS</span>
        </h2>
        <p class="upgrade-subtitle">
            <span class="lang-en">Train at 90 & 120 BPM for maximum cognitive benefits</span>
            <span class="lang-es">Entrena a 90 y 120 BPM para m√°ximos beneficios</span>
        </p>
        <div class="upgrade-benefits">
            <div class="upgrade-benefit">
                <span class="check">‚úì</span>
                <span class="lang-en">60 BPM ‚Äî Foundation (Current)</span>
                <span class="lang-es">60 BPM ‚Äî Base (Actual)</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">90 BPM ‚Äî Optimal Challenge</span>
                <span class="lang-es">90 BPM ‚Äî Desaf√≠o √ìptimo</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">120 BPM ‚Äî Elite Training</span>
                <span class="lang-es">120 BPM ‚Äî Entrenamiento √âlite</span>
            </div>
        </div>
        <div class="upgrade-price">$5<span style="font-size: 1rem;">/month</span></div>
        <div class="upgrade-price-note">
            <span class="lang-en">Cancel anytime ‚Ä¢ Instant access</span>
            <span class="lang-es">Cancela cuando quieras ‚Ä¢ Acceso inmediato</span>
        </div>
        <button class="upgrade-btn" id="upgradeBtn">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </button>
        <button class="upgrade-close" id="upgradeClose">
            <span class="lang-en">Continue with 60 BPM</span>
            <span class="lang-es">Continuar con 60 BPM</span>
        </button>
    </div>
</div>

<!-- Coach Message Toast -->
<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // ==================== ENVIRONMENT DETECTION ====================
    var host = window.location.hostname;
    var isProduction = (host.indexOf('laughcourt') > -1 || host.indexOf('github.io') > -1);
    var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '');
    var isPreview = !isProduction && !isLocal;

    // ==================== PRODUCTION AUTH & HEARTBEAT ====================
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('lc-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) {
            window.location.replace('index.html');
            return;
        }

        var sessionPin = sessionStorage.getItem('lc-pin');
        var sessionToken = sessionStorage.getItem('lc-token');

        function validateSession() {
            if (!sessionPin || !sessionToken) {
                window.location.href = 'index.html';
                return;
            }
            fetch('/api/session/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: sessionPin, token: sessionToken })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.valid) {
                    alert(d.message || 'Session ended. Please log in again.');
                    localStorage.removeItem('lc-user');
                    localStorage.removeItem('lc-bpm-access');
                    sessionStorage.removeItem('lc-pin');
                    sessionStorage.removeItem('lc-token');
                    window.location.href = 'index.html';
                }
            })
            .catch(function(err) {
                console.log('Session validation error:', err);
            });
        }

        validateSession();
        setInterval(validateSession, 30000);
    }
    // ==================== END PRODUCTION AUTH & HEARTBEAT ====================

    // Translations
    const translations = {
        en: {
            startDrill: 'START DRILL üèÄ',
            watchSequence: 'WATCH... üëÄ',
            tapForward: '‚û°Ô∏è Tap in FORWARD order!',
            tapBackward: '‚¨ÖÔ∏è Tap in BACKWARD order!',
            watchForward: 'Watch the sequence... ‚û°Ô∏è FORWARD',
            watchBackward: 'Watch the sequence... ‚¨ÖÔ∏è BACKWARD',
            selectStart: 'Select mode & tempo, then START!',
            readyTier: 'Ready for Tier',
            backTier1: 'Back to Tier 1 - Let\'s go!',
            tierUp: 'TIER UP!',
            movingTo: 'Amazing! Moving to Tier',
            drilledIt: 'DRILLED IT!',
            circuitsTo: 'circuits to next tier!',
            almost: 'ALMOST!',
            shakeOff: 'Shake it off and try again!',
            nextDrill: 'NEXT DRILL üèÄ',
            tryAgain: 'TRY AGAIN üèÄ',
            thatWas: 'That was'
        },
        es: {
            startDrill: 'INICIAR EJERCICIO üèÄ',
            watchSequence: 'MIRA... üëÄ',
            tapForward: '‚û°Ô∏è ¬°Toca en orden ADELANTE!',
            tapBackward: '‚¨ÖÔ∏è ¬°Toca en orden ATR√ÅS!',
            watchForward: 'Mira la secuencia... ‚û°Ô∏è ADELANTE',
            watchBackward: 'Mira la secuencia... ‚¨ÖÔ∏è ATR√ÅS',
            selectStart: 'Selecciona modo y tempo, luego ¬°EMPIEZA!',
            readyTier: 'Listo para Nivel',
            backTier1: '¬°Volvemos al Nivel 1!',
            tierUp: '¬°SUBISTE DE NIVEL!',
            movingTo: '¬°Incre√≠ble! Pasando al Nivel',
            drilledIt: '¬°PERFECTO!',
            circuitsTo: 'circuitos para el siguiente nivel!',
            almost: '¬°CASI!',
            shakeOff: '¬°Sac√∫delo e intenta de nuevo!',
            nextDrill: 'SIGUIENTE üèÄ',
            tryAgain: 'INTENTAR DE NUEVO üèÄ',
            thatWas: 'Era el'
        }
    };

    let currentLang = 'en';
    const t = (key) => translations[currentLang][key] || key;

    function setLang(lang) {
        currentLang = lang;
        document.body.className = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.id === 'btn' + lang.charAt(0).toUpperCase() + lang.slice(1));
        });
    }

    // BPM Access Control
    const bpmAccess = {
        allBPM: false,
        userType: 'guest',
        checked: false
    };

    // Game State
    const state = {
        tier: 1,
        bestTier: 0,
        totalLaughs: 0,
        sessionLaughs: 0,
        streak: 0,
        mode: 'forward',
        bpm: 60, // Default to 60 BPM for trial users
        sequence: [],
        userSequence: [],
        isPlaying: false,
        isShowingSequence: false,
        circuitsCompleted: 0
    };

    // BPM to milliseconds (tempo-based timing)
    const getBpmDelay = (bpm) => Math.round(60000 / bpm);

    // Tier = numbers to remember (tier 1 = 2 numbers, tier 10 = 11 numbers)
    const getSequenceLength = (tier) => tier + 1;

    // DOM Elements
    const courtGrid = document.getElementById('courtGrid');
    const messageDisplay = document.getElementById('messageDisplay');
    const messageText = document.getElementById('messageText');
    const actionBtn = document.getElementById('actionBtn');
    const feedbackOverlay = document.getElementById('feedbackOverlay');
    const coachMessage = document.getElementById('coachMessage');
    const upgradeOverlay = document.getElementById('upgradeOverlay');

    // Check BPM access from server
    function checkBPMAccess() {
        // Skip API call in preview/local - just apply locks
        if (!isProduction) {
            bpmAccess.allBPM = false;
            bpmAccess.userType = 'guest';
            bpmAccess.checked = true;
            applyBPMLocks();
            return;
        }

        const userPIN = localStorage.getItem('lc-user-pin');
        
        if (!userPIN) {
            // Guest user - 60 BPM only
            bpmAccess.allBPM = false;
            bpmAccess.userType = 'guest';
            bpmAccess.checked = true;
            applyBPMLocks();
            return;
        }
        
        // Check server for access level
        fetch('/api/user/bpm-access/' + userPIN)
            .then(res => res.json())
            .then(data => {
                bpmAccess.allBPM = data.allBPM || false;
                bpmAccess.userType = data.userType || 'guest';
                bpmAccess.checked = true;
                applyBPMLocks();
            })
            .catch(err => {
                console.log('BPM access check failed, defaulting to locked:', err);
                bpmAccess.allBPM = false;
                bpmAccess.userType = 'guest';
                bpmAccess.checked = true;
                applyBPMLocks();
            });
    }

    // Apply locks to 90 and 120 BPM buttons
    function applyBPMLocks() {
        const tempoBtns = document.querySelectorAll('.tempo-btn');
        
        tempoBtns.forEach(btn => {
            const bpm = parseInt(btn.dataset.bpm);
            
            if (bpm > 60 && !bpmAccess.allBPM) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        });
        
        // Ensure 60 BPM is selected for locked users
        if (!bpmAccess.allBPM) {
            selectTempo(60);
        }
    }

    // Select a tempo
    function selectTempo(bpm) {
        state.bpm = bpm;
        
        document.querySelectorAll('.tempo-btn').forEach(b => { 
            b.classList.remove('active'); 
        });
        
        const targetBtn = document.querySelector('.tempo-btn[data-bpm="' + bpm + '"]');
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
    }

    // Show upgrade modal
    function showUpgradeModal() {
        upgradeOverlay.classList.add('show');
    }

    // Hide upgrade modal
    function hideUpgradeModal() {
        upgradeOverlay.classList.remove('show');
    }

    // Initialize grid
    function initGrid() {
        courtGrid.innerHTML = '';
        for (let i = 1; i <= 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell disabled';
            cell.textContent = i;
            cell.dataset.number = i;
            cell.addEventListener('click', () => handleCellClick(i));
            courtGrid.appendChild(cell);
        }
    }

    // Generate random sequence
    function generateSequence(length) {
        const seq = [];
        const available = Array.from({length: 25}, (_, i) => i + 1);
        for (let i = 0; i < length; i++) {
            const idx = Math.floor(Math.random() * available.length);
            seq.push(available.splice(idx, 1)[0]);
        }
        return seq;
    }

    // Show sequence to user
    async function showSequence() {
        state.isShowingSequence = true;
        actionBtn.disabled = true;
        disableGrid();

        const watchText = state.mode === 'forward' ? t('watchForward') : t('watchBackward');
        messageDisplay.innerHTML = `<span class="message-text ${state.mode}">${watchText}</span>`;
        
        await sleep(800);

        const delay = getBpmDelay(state.bpm);

        for (let i = 0; i < state.sequence.length; i++) {
            const num = state.sequence[i];
            
            // Show number in display
            messageDisplay.innerHTML = `<span class="sequence-number">${num}</span>`;
            
            // Highlight cell
            const cell = courtGrid.querySelector(`[data-number="${num}"]`);
            cell.classList.add('hint');
            
            await sleep(delay);
            
            cell.classList.remove('hint');
            await sleep(200);
        }

        // Ready to input
        const promptText = state.mode === 'forward' ? t('tapForward') : t('tapBackward');
        messageDisplay.innerHTML = `<span class="message-text ${state.mode}">${promptText}</span>`;
        
        state.isShowingSequence = false;
        enableGrid();
    }

    // Handle cell click
    function handleCellClick(num) {
        if (state.isShowingSequence || !state.isPlaying) return;

        const cell = courtGrid.querySelector(`[data-number="${num}"]`);
        state.userSequence.push(num);

        // Determine expected sequence based on mode
        const expectedSequence = state.mode === 'forward' 
            ? state.sequence 
            : [...state.sequence].reverse();
        
        const currentIndex = state.userSequence.length - 1;
        const expected = expectedSequence[currentIndex];

        if (num === expected) {
            // Correct!
            cell.classList.add('correct');
            setTimeout(() => cell.classList.remove('correct'), 400);
            
            // Update display to show progress
            updateSequenceProgress();

            if (state.userSequence.length === state.sequence.length) {
                // Completed sequence!
                handleSuccess();
            }
        } else {
            // Wrong!
            cell.classList.add('wrong');
            setTimeout(() => cell.classList.remove('wrong'), 400);
            handleFailure(expected);
        }
    }

    // Update sequence display with progress
    function updateSequenceProgress() {
        const expectedSequence = state.mode === 'forward' 
            ? state.sequence 
            : [...state.sequence].reverse();
        
        let html = '';
        for (let i = 0; i < expectedSequence.length; i++) {
            if (i < state.userSequence.length) {
                html += `<span class="sequence-number" style="color: var(--teal); font-size: 1.5rem;">${state.userSequence[i]}</span>`;
            } else {
                html += `<span class="sequence-number" style="color: var(--muted); font-size: 1.2rem;">?</span>`;
            }
        }
        messageDisplay.innerHTML = html;
    }

    // Handle success
    function handleSuccess() {
        state.isPlaying = false;
        disableGrid();
        
        // Calculate laughs with BPM bonus
        const baseLaughs = state.tier;
        const bpmBonus = state.bpm === 120 ? 2 : state.bpm === 90 ? 1 : 0;
        const modeBonus = state.mode === 'backward' ? state.tier : 0;
        const laughsEarned = baseLaughs + bpmBonus + modeBonus;
        
        state.sessionLaughs += laughsEarned;
        state.totalLaughs += laughsEarned;
        state.streak++;
        state.circuitsCompleted++;
        
        if (state.tier > state.bestTier) {
            state.bestTier = state.tier;
        }
        
        updateStats();
        
        // Show coach message
        const messages = [
            "PERFECT RECALL! üß†",
            "DRILLED IT! üí™",
            "MEMORY CHAMPION! üèÜ",
            "UNSTOPPABLE! üî•",
            "COACH IS PROUD! üòÇ"
        ];
        showCoachMessage(messages[Math.floor(Math.random() * messages.length)]);
        
        // Update progress
        const progress = (state.circuitsCompleted % 3) / 3 * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        
        // Tier up every 3 circuits
        if (state.circuitsCompleted % 3 === 0 && state.tier < 10) {
            setTimeout(() => {
                showFeedback(true, laughsEarned, true);
            }, 1000);
        } else {
            setTimeout(() => {
                showFeedback(true, laughsEarned, false);
            }, 800);
        }
    }

    // Handle failure
    function handleFailure(expected) {
        state.isPlaying = false;
        disableGrid();
        state.streak = 0;
        
        // Show correct answer
        const cell = courtGrid.querySelector(`[data-number="${expected}"]`);
        cell.classList.add('hint');
        setTimeout(() => cell.classList.remove('hint'), 1000);
        
        showCoachMessage(`${t('thatWas')} ${expected}! üí™`);
        
        updateStats();
        
        setTimeout(() => {
            showFeedback(false, 0, false);
        }, 1500);
    }

    // Show feedback overlay
    function showFeedback(success, laughs, tierUp) {
        const emoji = document.getElementById('feedbackEmoji');
        const title = document.getElementById('feedbackTitle');
        const message = document.getElementById('feedbackMessage');
        const tierStat = document.getElementById('feedbackTier');
        const laughsStat = document.getElementById('feedbackLaughs');
        const continueBtn = document.getElementById('continueBtn');
        
        if (success) {
            if (tierUp) {
                emoji.textContent = 'üöÄ';
                title.textContent = t('tierUp');
                title.className = 'feedback-title success';
                message.textContent = `${t('movingTo')} ${state.tier + 1}!`;
                state.tier++;
            } else {
                emoji.textContent = 'üòÇ';
                title.textContent = t('drilledIt');
                title.className = 'feedback-title success';
                message.textContent = `${state.circuitsCompleted % 3}/3 ${t('circuitsTo')}`;
            }
            continueBtn.innerHTML = `<span class="lang-en">${translations.en.nextDrill}</span><span class="lang-es">${translations.es.nextDrill}</span>`;
        } else {
            emoji.textContent = 'üòÖ';
            title.textContent = t('almost');
            title.className = 'feedback-title fail';
            message.textContent = t('shakeOff');
            continueBtn.innerHTML = `<span class="lang-en">${translations.en.tryAgain}</span><span class="lang-es">${translations.es.tryAgain}</span>`;
        }
        
        tierStat.textContent = state.tier;
        laughsStat.textContent = laughs;
        
        feedbackOverlay.classList.add('show');
        updateStats();
    }

    // Start drill
    function startDrill() {
        state.sequence = generateSequence(getSequenceLength(state.tier));
        state.userSequence = [];
        state.isPlaying = true;
        state.sessionLaughs = 0;
        
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.watchSequence}</span><span class="lang-es">${translations.es.watchSequence}</span>`;
        actionBtn.disabled = true;
        
        showSequence();
    }

    // UI Helpers
    function enableGrid() {
        courtGrid.querySelectorAll('.grid-cell').forEach(cell => {
            cell.classList.remove('disabled');
        });
    }

    function disableGrid() {
        courtGrid.querySelectorAll('.grid-cell').forEach(cell => {
            cell.classList.add('disabled');
        });
    }

    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('bestTier').textContent = state.bestTier;
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;
    }

    function showCoachMessage(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(() => coachMessage.classList.remove('show'), 2500);
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Event Listeners
    actionBtn.addEventListener('click', () => {
        if (!state.isPlaying && !state.isShowingSequence) {
            startDrill();
        }
    });

    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (state.isPlaying) return;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.mode = btn.dataset.mode;
        });
    });

    // Tempo button clicks with BPM lock check
    document.querySelectorAll('.tempo-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (state.isPlaying) return;
            
            const bpm = parseInt(btn.dataset.bpm);
            
            // Check if locked
            if (bpm > 60 && !bpmAccess.allBPM) {
                showUpgradeModal();
                return;
            }
            
            selectTempo(bpm);
        });
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.startDrill}</span><span class="lang-es">${translations.es.startDrill}</span>`;
        actionBtn.disabled = false;
        messageDisplay.innerHTML = `<span class="message-text">${t('readyTier')} ${state.tier}!</span>`;
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuitsCompleted = 0;
        state.streak = 0;
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.startDrill}</span><span class="lang-es">${translations.es.startDrill}</span>`;
        actionBtn.disabled = false;
        messageDisplay.innerHTML = `<span class="message-text">${t('backTier1')}</span>`;
        updateStats();
    });

    // Upgrade modal events
    document.getElementById('upgradeBtn').addEventListener('click', () => {
        window.location.href = 'index.html?upgrade=true';
    });

    document.getElementById('upgradeClose').addEventListener('click', () => {
        hideUpgradeModal();
    });

    document.getElementById('btnEn').addEventListener('click', () => setLang('en'));
    document.getElementById('btnEs').addEventListener('click', () => setLang('es'));

    // Initialize
    initGrid();
    setLang(currentLang);
    updateStats();
    checkBPMAccess(); // Check BPM access on load
})();
</script>
</body>
</html>
