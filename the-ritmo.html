<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>THE RITMO | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --red: #FF1744;
    --red-dark: #D50000;
    --orange: #FF6D00;
    --gold: #FFD700;
    --teal: #00D9A5;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.08);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    height: 100%;
    overflow: hidden;
}
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100vh;
    height: 100dvh;
}
body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

/* Main Container - NO SCROLL */
.game-container {
    max-width: 420px;
    margin: 0 auto;
    padding: 8px 12px;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Language Toggle */
.lang-toggle {
    position: absolute;
    top: 8px;
    right: 12px;
    display: flex;
    gap: 4px;
    z-index: 10;
}
.lang-btn {
    padding: 4px 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.lang-btn.active {
    background: var(--red);
    color: var(--text);
    border-color: var(--red);
}

/* Back Button */
.back-btn {
    position: absolute;
    top: 8px;
    left: 12px;
    color: var(--muted);
    text-decoration: none;
    font-size: 0.7rem;
    z-index: 10;
}
.back-btn:hover { color: var(--text); }

/* Header - Compact */
.header {
    text-align: center;
    padding: 6px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--red), var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.powered-by {
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
}
.powered-by .ritnome { color: var(--gold); font-weight: 700; }

/* Stats Bar - Compact */
.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 6px 10px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--gold);
}
.stat-value.red { color: var(--red); }
.stat-label {
    font-size: 0.5rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Message Display */
.message-display {
    background: linear-gradient(135deg, var(--card), var(--darker));
    border: 2px solid var(--red);
    border-radius: 10px;
    padding: 8px 12px;
    margin: 4px 0;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}
.message-display::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, rgba(255,23,68,0.1), transparent);
    pointer-events: none;
}
.message-text {
    font-size: 0.75rem;
    color: var(--muted);
    text-align: center;
}
.message-text.coach { color: var(--gold); }
.message-text.success { color: var(--teal); }
.message-text.fail { color: var(--red); }

/* Rhythm Visual - Inline */
.rhythm-visual {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    min-height: 30px;
    margin-top: 4px;
}
.rhythm-note {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--muted);
    transition: all 0.2s;
}
.rhythm-note.active {
    background: linear-gradient(135deg, var(--red), var(--gold));
    border-color: var(--gold);
    color: var(--dark);
    transform: scale(1.2);
    box-shadow: 0 0 15px rgba(255,23,68,0.5);
}
.rhythm-note.done {
    background: var(--teal);
    border-color: var(--teal);
    color: var(--dark);
}
.rhythm-note.missed {
    background: var(--red);
    border-color: var(--red);
    color: var(--text);
}

/* Ritnome‚Ñ¢ Tempo Selector - Inline */
.tempo-section {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tempo-label {
    font-size: 0.55rem;
    color: var(--muted);
    white-space: nowrap;
}
.tempo-label .ritnome { color: var(--gold); font-weight: 700; }
.tempo-buttons {
    display: flex;
    gap: 4px;
    flex: 1;
}
.tempo-btn {
    flex: 1;
    padding: 6px 4px;
    border: 1px solid var(--card);
    background: var(--card);
    border-radius: 6px;
    color: var(--muted);
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    position: relative;
}
.tempo-btn .icon { font-size: 0.8rem; }
.tempo-btn .bpm { font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; }
.tempo-btn.active {
    border-color: var(--gold);
    color: var(--gold);
    background: rgba(255,215,0,0.1);
}

/* BPM Lock Styles */
.tempo-btn.locked {
    opacity: 0.5;
    cursor: not-allowed;
}
.tempo-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: 2px;
    right: 4px;
    font-size: 0.6rem;
}
.tempo-btn.locked:hover {
    border-color: var(--gold);
}

/* Court Grid - VISIBLE CELLS */
.court-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 8px;
    background: linear-gradient(145deg, var(--card), var(--darker));
    border-radius: 12px;
    border: 2px solid rgba(255,23,68,0.3);
    min-height: 0;
    aspect-ratio: 1;
    margin: 4px 0;
}
.grid-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    background: linear-gradient(145deg, #1e1e2a, #151520);
    border: 1px solid rgba(255,215,0,0.2);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
}
.grid-cell:hover {
    border-color: rgba(255,215,0,0.4);
    background: linear-gradient(145deg, #252532, #1a1a24);
}
.grid-cell:active { transform: scale(0.95); }
.grid-cell.beat {
    background: linear-gradient(135deg, var(--red), var(--orange));
    border-color: var(--gold);
    box-shadow: 0 0 25px rgba(255,23,68,0.6), 0 0 50px rgba(255,215,0,0.3);
    animation: pulseBeat 0.2s ease-out;
}
.grid-cell.tap-correct {
    background: linear-gradient(135deg, var(--teal), #00E676);
    border-color: var(--teal);
    box-shadow: 0 0 20px rgba(0,217,165,0.5);
}
.grid-cell.tap-wrong {
    background: linear-gradient(135deg, var(--red), var(--red-dark));
    border-color: var(--red);
    box-shadow: 0 0 20px rgba(255,23,68,0.5);
}
@keyframes pulseBeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Progress Bar */
.progress-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tier-badge {
    background: linear-gradient(135deg, var(--red), var(--orange));
    padding: 4px 10px;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 1px;
    white-space: nowrap;
    color: var(--text);
}
.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--card);
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red), var(--gold));
    border-radius: 4px;
    transition: width 0.3s ease-out;
}

/* Action Button */
.action-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
    background: linear-gradient(135deg, var(--red), var(--orange));
    color: var(--text);
    flex-shrink: 0;
}
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(255,23,68,0.5);
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Feedback Overlay */
.feedback-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 90%;
    animation: slideUp 0.3s ease-out;
    border: 2px solid var(--gold);
}
@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.feedback-emoji { font-size: 3rem; margin-bottom: 10px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 2px;
    margin-bottom: 8px;
    color: var(--gold);
}
.feedback-message {
    color: var(--muted);
    margin-bottom: 15px;
    font-size: 0.85rem;
}
.feedback-ritnome {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 15px;
}
.feedback-ritnome .ritnome { color: var(--gold); }
.feedback-stats {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin-bottom: 20px;
}
.feedback-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    color: var(--gold);
}
.feedback-stat-label {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
}
.feedback-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 4px;
}
.feedback-btn.primary {
    background: linear-gradient(135deg, var(--red), var(--orange));
    color: var(--text);
}
.feedback-btn.secondary {
    background: var(--darker);
    color: var(--muted);
    border: 1px solid var(--muted);
}

/* Upgrade Modal */
.upgrade-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 20px;
}
.upgrade-overlay.show { display: flex; }
.upgrade-card {
    background: linear-gradient(145deg, #1a1a25, #0d0d12);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 340px;
    width: 100%;
    box-shadow: 0 0 40px rgba(255,215,0,0.2);
}
.upgrade-icon { font-size: 3rem; margin-bottom: 15px; }
.upgrade-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 10px;
}
.upgrade-subtitle {
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 20px;
}
.upgrade-benefits {
    text-align: left;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
}
.upgrade-benefit {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    color: var(--text);
    font-size: 0.9rem;
}
.upgrade-benefit .check { color: var(--teal); }
.upgrade-price {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 5px;
}
.upgrade-price-note {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 20px;
}
.upgrade-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    letter-spacing: 2px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    margin-bottom: 10px;
}
.upgrade-close {
    background: transparent;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
}

/* Coach Message Toast */
.coach-message {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--red), var(--gold));
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--dark);
    opacity: 0;
    transition: all 0.4s ease-out;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Desktop */
@media (min-width: 700px) {
    .game-container {
        max-width: 480px;
        padding: 15px 20px;
    }
    .header { padding: 10px 0; }
    .logo { font-size: 1.2rem; }
    .court-name { font-size: 1.8rem; }
    .stats-bar { padding: 10px 15px; gap: 25px; }
    .stat-value { font-size: 1.4rem; }
    .court-grid { gap: 6px; padding: 12px; }
    .grid-cell { border-radius: 8px; }
    .action-btn { padding: 16px; font-size: 1.3rem; }
    .rhythm-note { width: 30px; height: 30px; font-size: 0.75rem; }
}
</style>
</head>
<body class="en">

<!-- Language Toggle -->
<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<!-- Back Button -->
<a href="laugh-hub.html" class="back-btn">‚Üê <span class="lang-en">Back</span><span class="lang-es">Volver</span></a>

<div class="game-container">
    <!-- Header -->
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT<sup style="font-size:0.5em">‚Ñ¢</sup></div>
        <div class="court-name">üéµ THE RITMO</div>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value red" id="currentTier">1</div>
            <div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="circuitDisplay">0/3</div>
            <div class="stat-label"><span class="lang-en">Circuit</span><span class="lang-es">Circuito</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
    </div>

    <!-- Message Display with Rhythm Visual -->
    <div class="message-display" id="messageDisplay">
        <span class="message-text" id="messageText">
            <span class="lang-en">üéµ Listen to the rhythm, then tap it back!</span>
            <span class="lang-es">üéµ ¬°Escucha el ritmo, luego rep√≠telo!</span>
        </span>
        <div class="rhythm-visual" id="rhythmVisual"></div>
    </div>

    <!-- Ritnome‚Ñ¢ Tempo Selector -->
    <div class="tempo-section" id="tempoSection">
        <div class="tempo-label">üéµ <span class="ritnome">Ritnome‚Ñ¢</span></div>
        <div class="tempo-buttons">
            <button class="tempo-btn active" data-bpm="60">
                <span class="icon">üê¢</span>
                <span class="bpm">60</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn" data-bpm="90">
                <span class="icon">üèÉ</span>
                <span class="bpm">90</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn" data-bpm="120">
                <span class="icon">‚ö°</span>
                <span class="bpm">120</span>
                <span>BPM</span>
            </button>
        </div>
    </div>

    <!-- Court Grid -->
    <div class="court-grid" id="courtGrid"></div>

    <!-- Progress Bar -->
    <div class="progress-section">
        <div class="tier-badge">
            <span class="lang-en">TIER</span><span class="lang-es">NIVEL</span> 
            <span id="tierDisplay">1</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Action Button -->
    <button class="action-btn" id="actionBtn">
        <span class="lang-en">START RITMO üéµ</span>
        <span class="lang-es">INICIAR RITMO üéµ</span>
    </button>
</div>

<!-- Feedback Overlay -->
<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üéµ</div>
        <h2 class="feedback-title" id="feedbackTitle">TIER UP!</h2>
        <p class="feedback-message" id="feedbackMessage">Amazing rhythm!</p>
        <div class="feedback-ritnome"><span class="ritnome">Ritnome‚Ñ¢</span> Rhythm Training</div>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackTier">2</div>
                <div class="feedback-stat-label"><span class="lang-en">New Tier</span><span class="lang-es">Nuevo Nivel</span></div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackLaughs">0</div>
                <div class="feedback-stat-label">üòÇ</div>
            </div>
        </div>
        <button class="feedback-btn primary" id="continueBtn">
            <span class="lang-en">CONTINUE üéµ</span>
            <span class="lang-es">CONTINUAR üéµ</span>
        </button>
        <button class="feedback-btn secondary" id="restartBtn">
            <span class="lang-en">RESTART</span>
            <span class="lang-es">REINICIAR</span>
        </button>
    </div>
</div>

<!-- Upgrade Modal -->
<div class="upgrade-overlay" id="upgradeOverlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">üîì</div>
        <h2 class="upgrade-title">
            <span class="lang-en">UNLOCK ALL TEMPOS</span>
            <span class="lang-es">DESBLOQUEA TODOS</span>
        </h2>
        <p class="upgrade-subtitle">
            <span class="lang-en">Train at 90 & 120 BPM for maximum cognitive benefits</span>
            <span class="lang-es">Entrena a 90 y 120 BPM para m√°ximos beneficios</span>
        </p>
        <div class="upgrade-benefits">
            <div class="upgrade-benefit">
                <span class="check">‚úì</span>
                <span class="lang-en">60 BPM ‚Äî Foundation (Current)</span>
                <span class="lang-es">60 BPM ‚Äî Base (Actual)</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">90 BPM ‚Äî Optimal Challenge</span>
                <span class="lang-es">90 BPM ‚Äî Desaf√≠o √ìptimo</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">120 BPM ‚Äî Elite Training</span>
                <span class="lang-es">120 BPM ‚Äî Entrenamiento √âlite</span>
            </div>
        </div>
        <div class="upgrade-price">$5<span style="font-size: 1rem;">/month</span></div>
        <div class="upgrade-price-note">
            <span class="lang-en">Cancel anytime ‚Ä¢ Instant access</span>
            <span class="lang-es">Cancela cuando quieras ‚Ä¢ Acceso inmediato</span>
        </div>
        <button class="upgrade-btn" id="upgradeBtn">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </button>
        <button class="upgrade-close" id="upgradeClose">
            <span class="lang-en">Continue with 60 BPM</span>
            <span class="lang-es">Continuar con 60 BPM</span>
        </button>
    </div>
</div>

<!-- Coach Message Toast -->
<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // Translations
    const translations = {
        en: {
            startRitmo: 'START RITMO üéµ',
            nextRound: 'NEXT ROUND üéµ',
            listen: 'üéµ Listen to the rhythm...',
            yourTurn: 'Your turn! Tap the rhythm!',
            tierUp: 'TIER UP!',
            perfectRhythm: 'Perfect rhythm! üòÇ',
            gotRhythm: 'You got rhythm! üî•',
            smoothMoves: 'Smooth moves!',
            onPoint: 'On point! üéµ',
            almost: 'Almost had it!',
            tryAgain: 'Try again, feel the beat',
            listenCloser: 'Listen closer...',
            youllGetIt: "You'll get it!",
            ready: 'Ready for the next beat?',
            amazing: 'Amazing rhythm!'
        },
        es: {
            startRitmo: 'INICIAR RITMO üéµ',
            nextRound: 'SIGUIENTE üéµ',
            listen: 'üéµ Escucha el ritmo...',
            yourTurn: '¬°Tu turno! ¬°Repite el ritmo!',
            tierUp: '¬°SUBISTE DE NIVEL!',
            perfectRhythm: '¬°Ritmo perfecto! üòÇ',
            gotRhythm: '¬°Tienes sabor! üî•',
            smoothMoves: '¬°Qu√© flow!',
            onPoint: '¬°En punto! üéµ',
            almost: '¬°Casi!',
            tryAgain: 'Intenta de nuevo',
            listenCloser: 'Escucha mejor...',
            youllGetIt: '¬°T√∫ puedes!',
            ready: '¬øListo para el siguiente ritmo?',
            amazing: '¬°Ritmo incre√≠ble!'
        }
    };

    let currentLang = 'en';
    const t = (key) => translations[currentLang][key] || key;

    function setLang(lang) {
        currentLang = lang;
        document.body.className = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.id === 'btn' + lang.charAt(0).toUpperCase() + lang.slice(1));
        });
    }

    // BPM Access Control
    const bpmAccess = {
        allBPM: false,
        userType: 'guest',
        checked: false
    };

    // Audio Engine
    let audioCtx = null;
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playBeat(freq, duration) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq || 440;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (duration || 0.15));
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + (duration || 0.15));
    }

    function playSuccess() {
        if (!audioCtx) return;
        playBeat(523, 0.1);
        setTimeout(() => playBeat(659, 0.1), 100);
        setTimeout(() => playBeat(784, 0.15), 200);
    }

    function playFail() {
        if (!audioCtx) return;
        playBeat(200, 0.3);
    }

    // Game State
    const state = {
        tier: 1,
        circuit: 0,
        totalLaughs: 0,
        streak: 0,
        bpm: 60, // Default to 60 BPM for trial users
        gamePhase: 'idle', // idle, playing, listening
        rhythmPattern: [],
        playerPattern: [],
        currentBeatIndex: 0,
        beatTimeout: null,
        listenTimeout: null
    };

    // DOM Elements
    const courtGrid = document.getElementById('courtGrid');
    const messageDisplay = document.getElementById('messageDisplay');
    const messageText = document.getElementById('messageText');
    const rhythmVisual = document.getElementById('rhythmVisual');
    const actionBtn = document.getElementById('actionBtn');
    const feedbackOverlay = document.getElementById('feedbackOverlay');
    const coachMessage = document.getElementById('coachMessage');
    const upgradeOverlay = document.getElementById('upgradeOverlay');
    let cells = [];

    // Check BPM access from server
    function checkBPMAccess() {
        const userPIN = localStorage.getItem('lc-user-pin');
        
        if (!userPIN) {
            // Guest user - 60 BPM only
            bpmAccess.allBPM = false;
            bpmAccess.userType = 'guest';
            bpmAccess.checked = true;
            applyBPMLocks();
            return;
        }
        
        // Check server for access level
        fetch('/api/user/bpm-access/' + userPIN)
            .then(res => res.json())
            .then(data => {
                bpmAccess.allBPM = data.allBPM || false;
                bpmAccess.userType = data.userType || 'guest';
                bpmAccess.checked = true;
                applyBPMLocks();
            })
            .catch(err => {
                console.log('BPM access check failed, defaulting to locked:', err);
                bpmAccess.allBPM = false;
                bpmAccess.userType = 'guest';
                bpmAccess.checked = true;
                applyBPMLocks();
            });
    }

    // Apply locks to 90 and 120 BPM buttons
    function applyBPMLocks() {
        const tempoBtns = document.querySelectorAll('.tempo-btn');
        
        tempoBtns.forEach(btn => {
            const bpm = parseInt(btn.dataset.bpm);
            
            if (bpm > 60 && !bpmAccess.allBPM) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        });
        
        // Ensure 60 BPM is selected for locked users
        if (!bpmAccess.allBPM) {
            selectTempo(60);
        }
    }

    // Select a tempo
    function selectTempo(bpm) {
        state.bpm = bpm;
        
        document.querySelectorAll('.tempo-btn').forEach(b => { 
            b.classList.remove('active'); 
        });
        
        const targetBtn = document.querySelector('.tempo-btn[data-bpm="' + bpm + '"]');
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
    }

    // Show upgrade modal
    function showUpgradeModal() {
        upgradeOverlay.classList.add('show');
    }

    // Hide upgrade modal
    function hideUpgradeModal() {
        upgradeOverlay.classList.remove('show');
    }

    // Initialize grid
    function initGrid() {
        courtGrid.innerHTML = '';
        cells = [];
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.index = i;
            cell.addEventListener('click', () => handleCellTap(i));
            courtGrid.appendChild(cell);
            cells.push(cell);
        }
    }

    // Generate rhythm pattern
    function generatePattern() {
        const length = Math.min(3 + Math.floor(state.tier / 2), 8); // 3-8 beats
        const pattern = [];
        const usedCells = [];

        for (let i = 0; i < length; i++) {
            let cellIndex;
            do {
                cellIndex = Math.floor(Math.random() * 25);
            } while (usedCells.includes(cellIndex) && usedCells.length < 25);
            usedCells.push(cellIndex);
            pattern.push({ cell: cellIndex, time: i });
        }
        return pattern;
    }

    // Update rhythm visual
    function updateRhythmVisual() {
        rhythmVisual.innerHTML = '';
        for (let i = 0; i < state.rhythmPattern.length; i++) {
            const note = document.createElement('div');
            note.className = 'rhythm-note';
            note.textContent = i + 1;
            note.id = 'note-' + i;
            rhythmVisual.appendChild(note);
        }
    }

    // Play rhythm
    function playRhythm() {
        state.gamePhase = 'playing';
        state.currentBeatIndex = 0;
        const interval = 60000 / state.bpm;

        messageText.innerHTML = t('listen');
        messageText.className = 'message-text coach';

        function playNextBeat() {
            if (state.currentBeatIndex >= state.rhythmPattern.length) {
                setTimeout(() => startListening(), interval);
                return;
            }

            const beat = state.rhythmPattern[state.currentBeatIndex];

            // Visual
            cells[beat.cell].classList.add('beat');
            const noteEl = document.getElementById('note-' + state.currentBeatIndex);
            if (noteEl) noteEl.classList.add('active');

            // Audio
            const freq = 300 + (beat.cell % 5) * 100;
            playBeat(freq, 0.15);

            setTimeout(() => {
                cells[beat.cell].classList.remove('beat');
                if (noteEl) {
                    noteEl.classList.remove('active');
                    noteEl.classList.add('done');
                }
            }, interval * 0.8);

            state.currentBeatIndex++;
            state.beatTimeout = setTimeout(playNextBeat, interval);
        }

        playNextBeat();
    }

    // Start listening
    function startListening() {
        state.gamePhase = 'listening';
        state.playerPattern = [];
        state.currentBeatIndex = 0;

        // Reset note visuals
        document.querySelectorAll('.rhythm-note').forEach(n => {
            n.classList.remove('done', 'active', 'missed');
        });

        messageText.textContent = t('yourTurn');
        messageText.className = 'message-text success';

        // Timeout for player response
        const timeout = (state.rhythmPattern.length + 3) * (60000 / state.bpm);
        state.listenTimeout = setTimeout(() => {
            if (state.gamePhase === 'listening') {
                handleFail();
            }
        }, timeout);
    }

    // Handle cell tap
    function handleCellTap(index) {
        initAudio();
        if (state.gamePhase !== 'listening') return;

        const expectedBeat = state.rhythmPattern[state.currentBeatIndex];
        const noteEl = document.getElementById('note-' + state.currentBeatIndex);

        if (index === expectedBeat.cell) {
            // Correct!
            cells[index].classList.add('tap-correct');
            if (noteEl) noteEl.classList.add('done');
            playBeat(440 + state.currentBeatIndex * 50, 0.1);

            setTimeout(() => cells[index].classList.remove('tap-correct'), 200);

            state.currentBeatIndex++;

            if (state.currentBeatIndex >= state.rhythmPattern.length) {
                clearTimeout(state.listenTimeout);
                handleSuccess();
            }
        } else {
            // Wrong!
            cells[index].classList.add('tap-wrong');
            if (noteEl) noteEl.classList.add('missed');

            setTimeout(() => cells[index].classList.remove('tap-wrong'), 300);

            clearTimeout(state.listenTimeout);
            handleFail();
        }
    }

    // Handle success
    function handleSuccess() {
        state.gamePhase = 'idle';
        state.streak++;
        state.totalLaughs++;
        state.circuit++;

        playSuccess();

        const successMessages = [t('perfectRhythm'), t('gotRhythm'), t('smoothMoves'), t('onPoint')];
        showCoachMessage(successMessages[Math.floor(Math.random() * successMessages.length)]);

        updateStats();

        if (state.circuit >= 3) {
            // Tier up!
            state.circuit = 0;
            state.tier++;
            showTierUpModal();
        } else {
            setTimeout(() => {
                actionBtn.disabled = false;
                actionBtn.innerHTML = `<span class="lang-en">${translations.en.nextRound}</span><span class="lang-es">${translations.es.nextRound}</span>`;
                messageText.textContent = t('ready');
                messageText.className = 'message-text';
                setLang(currentLang);
            }, 1500);
        }
    }

    // Handle fail
    function handleFail() {
        state.gamePhase = 'idle';
        state.streak = 0;

        playFail();

        const failMessages = [t('almost'), t('tryAgain'), t('listenCloser'), t('youllGetIt')];
        showCoachMessage(failMessages[Math.floor(Math.random() * failMessages.length)]);

        updateStats();

        setTimeout(() => {
            actionBtn.disabled = false;
            actionBtn.innerHTML = `<span class="lang-en">${translations.en.startRitmo}</span><span class="lang-es">${translations.es.startRitmo}</span>`;
            setLang(currentLang);
        }, 1500);
    }

    // Show tier up modal
    function showTierUpModal() {
        document.getElementById('feedbackEmoji').textContent = 'üéµ';
        document.getElementById('feedbackTitle').textContent = t('tierUp');
        document.getElementById('feedbackMessage').textContent = t('amazing');
        document.getElementById('feedbackTier').textContent = state.tier;
        document.getElementById('feedbackLaughs').textContent = state.totalLaughs;
        feedbackOverlay.classList.add('show');
        updateStats();
    }

    // Start game
    function startGame() {
        initAudio();
        actionBtn.disabled = true;
        document.getElementById('tempoSection').style.pointerEvents = 'none';

        state.rhythmPattern = generatePattern();
        updateRhythmVisual();

        setTimeout(() => playRhythm(), 500);
    }

    // Update stats
    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('circuitDisplay').textContent = state.circuit + '/3';
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;

        const progress = (state.circuit / 3) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }

    function showCoachMessage(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(() => coachMessage.classList.remove('show'), 2500);
    }

    // Event Listeners
    actionBtn.addEventListener('click', startGame);

    // Tempo button clicks with BPM lock check
    document.querySelectorAll('.tempo-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (state.gamePhase !== 'idle') return;
            
            const bpm = parseInt(btn.dataset.bpm);
            
            // Check if locked
            if (bpm > 60 && !bpmAccess.allBPM) {
                showUpgradeModal();
                return;
            }
            
            selectTempo(bpm);
        });
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        actionBtn.disabled = false;
        document.getElementById('tempoSection').style.pointerEvents = 'auto';
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.startRitmo}</span><span class="lang-es">${translations.es.startRitmo}</span>`;
        messageText.innerHTML = `<span class="lang-en">üéµ Listen to the rhythm, then tap it back!</span><span class="lang-es">üéµ ¬°Escucha el ritmo, luego rep√≠telo!</span>`;
        messageText.className = 'message-text';
        rhythmVisual.innerHTML = '';
        setLang(currentLang);
        updateStats();
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuit = 0;
        state.streak = 0;
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.disabled = false;
        document.getElementById('tempoSection').style.pointerEvents = 'auto';
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.startRitmo}</span><span class="lang-es">${translations.es.startRitmo}</span>`;
        messageText.innerHTML = `<span class="lang-en">üéµ Listen to the rhythm, then tap it back!</span><span class="lang-es">üéµ ¬°Escucha el ritmo, luego rep√≠telo!</span>`;
        messageText.className = 'message-text';
        rhythmVisual.innerHTML = '';
        setLang(currentLang);
        updateStats();
    });

    // Upgrade modal events
    document.getElementById('upgradeBtn').addEventListener('click', () => {
        window.location.href = 'index.html?upgrade=true';
    });

    document.getElementById('upgradeClose').addEventListener('click', () => {
        hideUpgradeModal();
    });

    document.getElementById('btnEn').addEventListener('click', () => setLang('en'));
    document.getElementById('btnEs').addEventListener('click', () => setLang('es'));

    // Initialize
    initGrid();
    setLang(currentLang);
    updateStats();
    checkBPMAccess(); // Check BPM access on load
})();
</script>
</body>
</html>
