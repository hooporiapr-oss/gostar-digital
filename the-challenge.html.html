<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>THE REACTION CHALLENGE | LaughCourt - Where Joy Meets The Game</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B35;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --purple: #9B59B6;
    --fire: #FF4500;
    --dark: #0a0a0f;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
    --nav-height: 50px;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--dark);color:var(--text);touch-action:manipulation;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}

/* ============ SIMPLIFIED NAV ============ */
.mini-nav{position:fixed;top:0;left:0;right:0;background:var(--card);border-bottom:1px solid var(--border);padding-top:env(safe-area-inset-top);z-index:1000;transition:transform 0.3s ease}
.nav-row{display:flex;align-items:center;justify-content:space-between;height:50px;padding:0 12px}
.back-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;font-family:'Outfit',sans-serif;font-size:0.75rem;font-weight:600;cursor:pointer;text-decoration:none;transition:all 0.2s}
.back-btn:hover,.back-btn:active{border-color:var(--gold);color:var(--gold)}
.nav-title{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--gold);display:flex;align-items:center;gap:6px}
.nav-right{display:flex;align-items:center;gap:6px}
.nav-lang{display:flex;gap:2px}
.nav-lang-btn{padding:5px 8px;border:1px solid var(--border);background:0;color:var(--muted);border-radius:4px;font-size:0.6rem;font-weight:600;cursor:pointer;min-width:28px;min-height:28px}
.nav-lang-btn.active{border-color:var(--gold);color:var(--gold)}
.settings-wrapper{position:relative}
.settings-btn{width:32px;height:32px;border-radius:6px;background:0;border:1px solid var(--border);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.settings-btn.open{background:rgba(255,255,255,0.1);color:var(--gold)}
.settings-dropdown{position:absolute;top:calc(100% + 6px);right:0;width:175px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.settings-dropdown.show{display:block}
.settings-section{margin-bottom:10px}
.settings-section:last-child{margin-bottom:0}
.settings-label{font-size:0.5rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.speed-status{display:flex;gap:4px}
.speed-chip{flex:1;padding:4px 2px;border-radius:4px;font-family:'Bebas Neue',sans-serif;font-size:0.55rem;text-align:center;background:rgba(255,255,255,0.05);color:var(--muted)}
.speed-chip.unlocked{background:rgba(255,215,0,0.15);color:var(--gold)}
.speed-chip.locked{background:rgba(255,215,0,0.1);color:var(--gold)}
.settings-link{display:block;width:100%;padding:8px;border-radius:6px;font-size:0.7rem;text-decoration:none;text-align:center;cursor:pointer;border:none;font-family:'Outfit',sans-serif}
.settings-link.upgrade{background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark);font-weight:600;margin-bottom:6px}
.settings-link.logout{background:0;border:1px solid var(--border);color:var(--muted)}

/* FOCUS MODE BUTTON */
.focus-btn{position:fixed;top:calc(env(safe-area-inset-top, 0px) + 6px);right:12px;width:32px;height:32px;border-radius:6px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1001;transition:all 0.2s}
.focus-btn:active{transform:scale(0.95)}
.focus-btn.active{background:rgba(255,215,0,0.3);border-color:var(--gold);color:var(--gold)}

/* FOCUS MODE STYLES */
body.focus-mode .mini-nav{transform:translateY(-100%)}
body.focus-mode .game-container{padding-top:calc(env(safe-area-inset-top) + 60px)}
body.focus-mode .stats-bar{display:none}
body.focus-mode .challenge-progress{display:none}
body.focus-mode .phase-display{display:none}
body.focus-mode .message-display{display:none}
body.focus-mode .division-display{display:none}
body.focus-mode .court-wrapper{flex:1;position:relative;z-index:10}
body.focus-mode .court-grid{width:min(95vw, calc(100dvh - 200px));height:min(95vw, calc(100dvh - 200px));max-width:500px;max-height:500px;position:relative;z-index:20}
body.focus-mode .action-btn{position:fixed;bottom:calc(env(safe-area-inset-bottom, 10px) + 15px);left:15px;right:15px;z-index:100}
body.focus-mode .coach-message{bottom:120px}
body.focus-mode .challenge-select-screen{padding-top:20px}

.game-container{width:100%;max-width:420px;height:100dvh;margin:0 auto;padding:5px 10px;padding-top:calc(var(--nav-height) + env(safe-area-inset-top) + 8px);padding-bottom:max(5px,env(safe-area-inset-bottom));display:flex;flex-direction:column;overflow:hidden;transition:padding 0.3s ease}

/* CHALLENGE SELECTION SCREEN */
.challenge-select-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;text-align:center}
.challenge-select-screen.hidden{display:none}
.challenge-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;color:var(--gold);margin-bottom:3px}
.challenge-subtitle{font-size:0.7rem;color:var(--muted);margin-bottom:8px}
.challenge-btn{width:100%;max-width:280px;padding:16px;border:3px solid var(--border);background:var(--card);border-radius:14px;cursor:pointer;transition:all 0.2s}
.challenge-btn:active{transform:scale(0.98)}
.challenge-btn-icon{font-size:1.8rem;margin-bottom:6px}
.challenge-btn-title{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:2px;color:var(--text);margin-bottom:3px}
.challenge-btn-desc{font-size:0.6rem;color:var(--muted)}
.challenge-btn.sequence-challenge{border-color:var(--teal)}
.challenge-btn.sequence-challenge .challenge-btn-title{color:var(--teal)}
.challenge-btn.match-challenge{border-color:var(--orange)}
.challenge-btn.match-challenge .challenge-btn-title{color:var(--orange)}
.challenge-progress-badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:0.55rem;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;margin-top:6px}
.challenge-progress-badge.sequence{background:rgba(0,217,165,0.2);color:var(--teal)}
.challenge-progress-badge.match{background:rgba(255,107,53,0.2);color:var(--orange)}
.challenge-progress-badge.champion{background:rgba(255,215,0,0.2);color:var(--gold)}

/* GAME SCREEN */
.game-screen{display:none;flex-direction:column;flex:1}
.game-screen.active{display:flex}

.stats-bar{display:flex;justify-content:center;gap:12px;padding:5px 8px;background:var(--card);border-radius:8px;margin-bottom:4px;flex-shrink:0}
.stat{text-align:center;min-width:40px}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--gold);line-height:1}
.stat-label{font-size:0.42rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}

/* CHALLENGE PROGRESS TRACKER */
.challenge-progress{display:flex;flex-direction:column;gap:3px;padding:6px 8px;background:var(--card);border-radius:8px;margin-bottom:4px;flex-shrink:0;border:1px solid var(--teal)}
.challenge-progress.match-mode{border-color:var(--orange)}
.challenge-type-label{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:0.65rem;letter-spacing:1px;color:var(--teal);margin-bottom:2px}
.challenge-progress.match-mode .challenge-type-label{color:var(--orange)}
.tier-row{display:flex;justify-content:space-between;align-items:center}
.tier-label{font-family:'Bebas Neue',sans-serif;font-size:0.55rem;letter-spacing:1px;width:34px}
.tier-label.d3{color:var(--teal)}
.tier-label.d2{color:var(--gold)}
.tier-label.d1{color:var(--fire)}
.tier-levels{display:flex;gap:3px;flex:1;justify-content:center}
.tier-level{width:18px;height:18px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:0.5rem;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--muted)}
.tier-level.completed{background:var(--teal);border-color:var(--teal);color:var(--dark)}
.tier-level.current{background:var(--gold);border-color:var(--gold);color:var(--dark);animation:currentPulse 1s infinite}
.tier-level.locked{opacity:0.3}
@keyframes currentPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.tier-status{width:22px;text-align:center;font-size:0.7rem}

/* PHASE DISPLAY */
.phase-display{display:flex;align-items:center;justify-content:center;gap:8px;padding:5px;background:var(--card);border-radius:8px;margin-bottom:4px;flex-shrink:0}
.phase-indicator{font-size:0.65rem;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;padding:4px 10px;border-radius:6px;opacity:0.4}
.phase-indicator.active{opacity:1;background:rgba(155,89,182,0.25);color:var(--purple)}
.phase-indicator.complete{opacity:1;background:rgba(0,217,165,0.25);color:var(--teal)}
.phase-arrow{color:var(--muted);font-size:0.75rem}

.message-display{background:var(--card);border:2px solid var(--teal);border-radius:8px;padding:6px;margin-bottom:4px;text-align:center;flex-shrink:0;min-height:34px;display:flex;align-items:center;justify-content:center}
.message-display.match-mode{border-color:var(--orange)}
.message-text{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:2px;color:var(--text)}
.message-text.watch{color:var(--gold)}
.message-text.go{color:var(--teal)}
.message-text.perfect{color:var(--teal)}
.message-text.miss{color:var(--pink)}

.court-wrapper{flex:1;display:flex;align-items:center;justify-content:center;min-height:0;overflow:hidden;transition:all 0.3s ease;position:relative;z-index:10}
.court-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;padding:8px;background-color:#1a1a24;background-image:url('/icon.png');background-size:85%;background-position:center;background-repeat:no-repeat;border-radius:16px;border:3px solid var(--teal);width:min(100%,calc(100dvh - 340px),320px);height:min(100%,calc(100dvh - 340px),320px);min-width:200px;min-height:200px;aspect-ratio:1;position:relative;z-index:20;transition:all 0.3s ease;box-shadow:0 0 25px rgba(0,217,165,0.3)}
.court-grid.match-mode{border-color:var(--orange);box-shadow:0 0 25px rgba(255,107,53,0.3)}
.court-grid::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.6);border-radius:13px;pointer-events:none;z-index:0}

.grid-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.2);min-width:32px;min-height:32px;transition:all 0.15s;position:relative;z-index:1}
.grid-cell:active{transform:scale(0.95)}
.grid-cell.lit{background:var(--purple)!important;border-color:var(--purple)!important;box-shadow:0 0 20px var(--purple);transform:scale(1.05)}
.grid-cell.correct{background:var(--teal)!important;border-color:var(--teal)!important;box-shadow:0 0 15px var(--teal)}
.grid-cell.wrong{background:var(--pink)!important;border-color:var(--pink)!important;box-shadow:0 0 15px var(--pink)}
.grid-cell.found{background:var(--teal)!important;border-color:var(--teal)!important;box-shadow:0 0 10px var(--teal)}
@keyframes correctPulse{50%{transform:scale(1.15)}}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.grid-cell.correct{animation:correctPulse 0.4s}
.grid-cell.wrong{animation:shake 0.4s}

.division-display{display:flex;justify-content:space-between;align-items:center;padding:5px 10px;background:var(--card);border-radius:8px;margin:4px 0;flex-shrink:0;min-height:32px}
.division-badge{font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px;color:var(--teal)}
.division-badge.match-mode{color:var(--orange)}
.taps-counter{font-family:'Bebas Neue',sans-serif;font-size:0.95rem;color:var(--gold)}
.score-display{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--gold)}

.action-btn{width:100%;min-height:46px;padding:11px;border:none;border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:4px;cursor:pointer;background:linear-gradient(135deg,var(--teal),#00B4A0);color:var(--dark);flex-shrink:0;transition:all 0.3s ease;position:relative;z-index:100}
.action-btn.match-mode{background:linear-gradient(135deg,var(--orange),#FF8C5A)}
.action-btn:disabled{opacity:0.5;cursor:not-allowed}

.emoji-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;overflow:hidden}
.burst-emoji{position:absolute;font-size:1.6rem;animation:emojiBurst 1.2s ease-out forwards;pointer-events:none}
@keyframes emojiBurst{0%{opacity:1;transform:translate(-50%,-50%) scale(0.3)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.8) rotate(var(--rot))}}
.burst-emoji.big{font-size:2.2rem}
.court-grid.joy-pulse{animation:joyPulse 0.5s ease-out}
@keyframes joyPulse{0%{box-shadow:0 0 0 0 rgba(255,215,0,0.7)}50%{box-shadow:0 0 25px 8px rgba(255,215,0,0.5)}100%{box-shadow:0 0 25px rgba(0,217,165,0.3)}}

.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);display:none;align-items:center;justify-content:center;z-index:1100;padding:20px}
.overlay.show{display:flex}
.overlay-card{background:var(--card);border:2px solid var(--gold);border-radius:14px;padding:20px;text-align:center;max-width:280px;width:100%}
.overlay-card.tier{border-color:var(--fire)}
.overlay-card.champion{border-color:var(--gold);background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,69,0,0.1))}
.overlay-emoji{font-size:2.5rem;margin-bottom:8px}
.overlay-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;margin-bottom:6px;color:var(--gold)}
.overlay-card.tier .overlay-title{color:var(--fire)}
.overlay-message{color:var(--muted);margin-bottom:12px;font-size:0.85rem}
.overlay-btn{min-height:44px;padding:12px 24px;border:none;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;cursor:pointer;margin:4px;background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark)}

.coach-message{position:fixed;bottom:70px;left:50%;transform:translateX(-50%) translateY(100px);background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark);padding:8px 16px;border-radius:14px;font-weight:700;font-size:0.85rem;opacity:0;transition:all 0.3s;z-index:50}
.coach-message.show{transform:translateX(-50%) translateY(0);opacity:1}

body.en .lang-es{display:none!important}
body.es .lang-en{display:none!important}

@media(min-height:720px){.court-grid{width:min(100%,calc(100dvh - 340px),340px);height:min(100%,calc(100dvh - 340px),340px)}.stat-value{font-size:1.1rem}.message-text{font-size:0.95rem}.action-btn{min-height:50px;font-size:1.35rem}}
@media(max-height:620px){.stat-value{font-size:0.9rem}.challenge-progress{padding:4px 6px}.tier-level{width:16px;height:16px;font-size:0.45rem}.tier-label{font-size:0.5rem;width:30px}.phase-display{padding:4px}.phase-indicator{font-size:0.55rem;padding:3px 8px}.message-display{padding:5px;min-height:30px}.message-text{font-size:0.75rem}.court-grid{min-width:180px;min-height:180px;width:min(100%,calc(100dvh - 300px),280px);height:min(100%,calc(100dvh - 300px),280px);gap:3px;padding:6px}.grid-cell{min-width:28px;min-height:28px}.division-display{padding:4px 8px;min-height:28px}.action-btn{min-height:42px;font-size:1.1rem}.challenge-title{font-size:1.1rem}.challenge-btn{padding:12px}.challenge-btn-icon{font-size:1.5rem}.challenge-btn-title{font-size:0.95rem}}
@media(max-height:540px){.nav-row{height:44px}.stats-bar{padding:3px 5px;margin-bottom:3px}.stat-value{font-size:0.8rem}.stat-label{font-size:0.38rem}.challenge-progress{padding:3px 5px;margin-bottom:3px}.tier-row{margin-bottom:1px}.tier-level{width:14px;height:14px;font-size:0.4rem}.tier-label{font-size:0.45rem;width:26px}.tier-status{font-size:0.6rem;width:18px}.phase-display{padding:3px;margin-bottom:3px}.phase-indicator{font-size:0.5rem;padding:2px 5px}.message-display{padding:4px;margin-bottom:3px;min-height:24px}.message-text{font-size:0.65rem}.court-grid{min-width:150px;min-height:150px;gap:2px;padding:5px}.grid-cell{min-width:24px;min-height:24px}.division-display{padding:3px 6px;min-height:24px;margin:3px 0}.division-badge,.taps-counter{font-size:0.7rem}.score-display{font-size:0.85rem}.action-btn{min-height:38px;padding:8px;font-size:1rem}.challenge-title{font-size:0.95rem}.challenge-subtitle{font-size:0.6rem}.challenge-btn{padding:10px}.challenge-btn-icon{font-size:1.2rem;margin-bottom:4px}.challenge-btn-title{font-size:0.85rem}.challenge-btn-desc{font-size:0.5rem}}
</style>
</head>
<body class="en">

<!-- FOCUS BUTTON -->
<button class="focus-btn" id="focusBtn" title="Focus Mode">‚õ∂</button>

<!-- SIMPLIFIED NAV - NO TABS -->
<nav class="mini-nav">
<div class="nav-row">
<a href="/dashboard.html" class="back-btn">‚Üê <span class="lang-en">BACK</span><span class="lang-es">VOLVER</span></a>
<div class="nav-title">üèÜ THE CHALLENGE</div>
<div class="nav-right">
<div class="nav-lang"><button class="nav-lang-btn active" id="btnEn">EN</button><button class="nav-lang-btn" id="btnEs">ES</button></div>
<div class="settings-wrapper"><button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
<div class="settings-dropdown" id="settingsDropdown">
<div class="settings-section"><div class="settings-label"><span class="lang-en">Division Access</span><span class="lang-es">Acceso</span></div><div class="speed-status" id="speedStatus"><span class="speed-chip unlocked">‚úì D3</span><span class="speed-chip locked">üîí D2</span><span class="speed-chip locked">üîí D1</span></div></div>
<div class="settings-section" id="upgradeSection"><a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="settings-link upgrade">üöÄ UNLOCK ALL</a></div>
<div class="settings-section"><button class="settings-link logout" id="logoutBtn">‚Üê <span class="lang-en">Log Out</span><span class="lang-es">Salir</span></button></div>
</div></div></div></div>
</nav>

<div class="emoji-container" id="emojiContainer"></div>

<div class="game-container">

<!-- CHALLENGE SELECTION SCREEN -->
<div class="challenge-select-screen" id="challengeScreen">
<div class="challenge-title"><span class="lang-en">üèÜ THE REACTION CHALLENGE</span><span class="lang-es">üèÜ EL RETO DE REACCI√ìN</span></div>
<div class="challenge-subtitle"><span class="lang-en">React Fast + Remember = Champion</span><span class="lang-es">Reacciona R√°pido + Recuerda = Campe√≥n</span></div>

<button class="challenge-btn sequence-challenge" id="sequenceChallengeBtn">
<div class="challenge-btn-icon">‚ö° ‚Üí üî¢</div>
<div class="challenge-btn-title">REACTION + SEQUENCE</div>
<div class="challenge-btn-desc"><span class="lang-en">React to cells, then recall the ORDER</span><span class="lang-es">Reacciona, luego recuerda el ORDEN</span></div>
<div class="challenge-progress-badge sequence" id="seqProgressBadge">L1 D3</div>
</button>

<button class="challenge-btn match-challenge" id="matchChallengeBtn">
<div class="challenge-btn-icon">‚ö° ‚Üí üéØ</div>
<div class="challenge-btn-title">REACTION + MATCH</div>
<div class="challenge-btn-desc"><span class="lang-en">React to cells, then FIND them all</span><span class="lang-es">Reacciona, luego ENCUENTRA todas</span></div>
<div class="challenge-progress-badge match" id="matchProgressBadge">L1 D3</div>
</button>
</div>

<!-- GAME SCREEN -->
<div class="game-screen" id="gameScreen">
<div class="stats-bar">
<div class="stat"><div class="stat-value" id="levelDisplay">1</div><div class="stat-label"><span class="lang-en">Level</span><span class="lang-es">Nivel</span></div></div>
<div class="stat"><div class="stat-value" id="streakDisplay">0</div><div class="stat-label">üî•</div></div>
<div class="stat"><div class="stat-value" id="scoreDisplay">0</div><div class="stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
</div>

<div class="challenge-progress" id="challengeProgressBar">
<div class="challenge-type-label" id="challengeTypeLabel">üî¢ REACTION + SEQUENCE</div>
<div class="tier-row">
<div class="tier-label d3">ü•â D3</div>
<div class="tier-levels" id="d3Levels"></div>
<div class="tier-status" id="d3Status">‚¨ú</div>
</div>
<div class="tier-row">
<div class="tier-label d2">ü•à D2</div>
<div class="tier-levels" id="d2Levels"></div>
<div class="tier-status" id="d2Status">üîí</div>
</div>
<div class="tier-row">
<div class="tier-label d1">ü•á D1</div>
<div class="tier-levels" id="d1Levels"></div>
<div class="tier-status" id="d1Status">üîí</div>
</div>
</div>

<div class="phase-display" id="phaseDisplay">
<span class="phase-indicator active" id="reactPhase">‚ö° REACT</span>
<span class="phase-arrow">‚Üí</span>
<span class="phase-indicator" id="recallPhase">üî¢ ORDER</span>
</div>

<div class="message-display" id="messageDisplay"><span class="message-text" id="messageText"><span class="lang-en">TAP GO!</span><span class="lang-es">¬°PULSA IR!</span></span></div>

<div class="court-wrapper"><div class="court-grid" id="courtGrid"></div></div>

<div class="division-display">
<div class="division-badge" id="divisionBadge">L1 D3</div>
<div class="taps-counter" id="tapsCounter">0/5</div>
<div class="score-display" id="totalScore">0</div>
</div>

<button class="action-btn" id="actionBtn"><span class="lang-en">GO</span><span class="lang-es">IR</span></button>
</div>
</div>

<!-- LEVEL UP OVERLAY -->
<div class="overlay" id="levelUpOverlay">
<div class="overlay-card">
<div class="overlay-emoji">‚¨ÜÔ∏è</div>
<h2 class="overlay-title"><span class="lang-en">LEVEL UP!</span><span class="lang-es">¬°SUBISTE!</span></h2>
<p class="overlay-message" id="levelUpMessage"></p>
<button class="overlay-btn" id="levelUpBtn"><span class="lang-en">CONTINUE</span><span class="lang-es">CONTINUAR</span></button>
</div>
</div>

<!-- TIER UNLOCK OVERLAY -->
<div class="overlay" id="tierUpOverlay">
<div class="overlay-card tier">
<div class="overlay-emoji" id="tierUpEmoji">ü•à</div>
<h2 class="overlay-title" id="tierUpTitle">DIVISION 2!</h2>
<p class="overlay-message" id="tierUpMessage"></p>
<button class="overlay-btn" id="tierUpBtn"><span class="lang-en">LET'S GO!</span><span class="lang-es">¬°VAMOS!</span></button>
</div>
</div>

<!-- CHAMPION OVERLAY -->
<div class="overlay" id="championOverlay">
<div class="overlay-card champion">
<div class="overlay-emoji">üëë</div>
<h2 class="overlay-title" id="championTitle">CHAMPION!</h2>
<p class="overlay-message" id="championMessage"></p>
<button class="overlay-btn" id="championBtn"><span class="lang-en">LEGENDARY!</span><span class="lang-es">¬°LEGENDARIO!</span></button>
</div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function(){
    // ===== FOCUS MODE =====
    var focusBtn = document.getElementById('focusBtn');
    var isFocusMode = localStorage.getItem('lc-focus-mode') === 'true';
    
    function applyFocusMode() {
        if (isFocusMode) {
            document.body.classList.add('focus-mode');
            focusBtn.classList.add('active');
        } else {
            document.body.classList.remove('focus-mode');
            focusBtn.classList.remove('active');
        }
    }
    
    focusBtn.onclick = function() {
        isFocusMode = !isFocusMode;
        localStorage.setItem('lc-focus-mode', isFocusMode);
        applyFocusMode();
    };
    applyFocusMode();

    // ===== AUTH CHECK =====
    var host = window.location.hostname;
    var isProduction = host.indexOf('laughcourt') > -1 || host.indexOf('github.io') > -1 || host.indexOf('gostardigital') > -1;
    
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('lc-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) { window.location.replace('/login'); return; }
        var sessionPin = sessionStorage.getItem('lc-pin'), sessionToken = sessionStorage.getItem('lc-token');
        function validateSession() {
            if (!sessionPin || !sessionToken) { window.location.href = '/login'; return; }
            fetch('/api/session/validate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pin: sessionPin, token: sessionToken }) })
            .then(function(r) { return r.json(); })
            .then(function(d) { if (!d.valid) { localStorage.removeItem('lc-user'); localStorage.removeItem('lc-speed-access'); sessionStorage.clear(); window.location.href = '/login'; } })
            .catch(function() {});
        }
        validateSession();
        setInterval(validateSession, 30000);
    }

    // ===== SETTINGS DROPDOWN =====
    var settingsBtn = document.getElementById('settingsBtn'), settingsDropdown = document.getElementById('settingsDropdown');
    settingsBtn.onclick = function(e) { e.stopPropagation(); settingsBtn.classList.toggle('open'); settingsDropdown.classList.toggle('show'); };
    document.addEventListener('click', function(e) { if (!settingsDropdown.contains(e.target) && e.target !== settingsBtn && e.target !== focusBtn) { settingsBtn.classList.remove('open'); settingsDropdown.classList.remove('show'); } });

    document.getElementById('logoutBtn').onclick = function() {
        var p = sessionStorage.getItem('lc-pin'), t = sessionStorage.getItem('lc-token');
        if (p && t) fetch('/api/session/destroy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pin: p, token: t }) }).catch(function() {});
        localStorage.removeItem('lc-user'); localStorage.removeItem('lc-speed-access'); sessionStorage.clear(); window.location.href = '/login';
    };

    // ===== LANGUAGE =====
    var currentLang = localStorage.getItem('laughcourt_lang') || 'en';
    function setLang(l) {
        currentLang = l;
        localStorage.setItem('laughcourt_lang', l);
        document.body.className = l + (isFocusMode ? ' focus-mode' : '');
        document.getElementById('btnEn').className = l === 'en' ? 'nav-lang-btn active' : 'nav-lang-btn';
        document.getElementById('btnEs').className = l === 'es' ? 'nav-lang-btn active' : 'nav-lang-btn';
    }
    document.getElementById('btnEn').onclick = function() { setLang('en'); };
    document.getElementById('btnEs').onclick = function() { setLang('es'); };

    // ===== CONFIG =====
    var TOTAL_CELLS = 25;
    var SPEED_CONFIG = { slow: 1200, med: 800, fast: 500 };
    var LAUGH_EMOJIS = ['üòÇ','üòÜ','ü§£','üòÑ','üòÅ','ü•≥','üòä','üèÜ'];
    var CHAMPION_EMOJIS = ['üëë','üèÜ','üî•','‚ö°','üíé','üåü','‚ú®','üéØ'];

    function getCellCount(level) { return level + 4; }
    function getChallengeSpeed(level) { if (level <= 3) return 'slow'; if (level <= 6) return 'med'; return 'fast'; }
    function getTierForLevel(level) { if (level <= 3) return 'slow'; if (level <= 6) return 'med'; return 'fast'; }
    function getDivisionName(speed) { return speed === 'slow' ? 'D3' : speed === 'med' ? 'D2' : 'D1'; }

    // ===== STATE =====
    var state = {
        challengeType: 'sequence',
        phase: 'react',
        level: 1,
        speed: 'slow',
        score: 0,
        streak: 0,
        sequenceLevel: parseInt(localStorage.getItem('lc-challenge-sequence-level')) || 1,
        matchLevel: parseInt(localStorage.getItem('lc-challenge-match-level')) || 1,
        isSequenceChampion: localStorage.getItem('lc-challenge-sequence-champion') === 'true',
        isMatchChampion: localStorage.getItem('lc-challenge-match-champion') === 'true',
        reactionSequence: [],
        matchFound: [],
        recallIndex: 0,
        currentTap: 0,
        totalTaps: 5,
        isPlaying: false,
        canTap: false,
        cells: [],
        currentCell: -1,
        timer: null,
        timerStart: 0
    };

    var challengeScreen = document.getElementById('challengeScreen');
    var gameScreen = document.getElementById('gameScreen');
    var courtGrid = document.getElementById('courtGrid');
    var messageText = document.getElementById('messageText');
    var messageDisplay = document.getElementById('messageDisplay');
    var actionBtn = document.getElementById('actionBtn');
    var coachMessage = document.getElementById('coachMessage');
    var emojiContainer = document.getElementById('emojiContainer');
    var challengeProgressBar = document.getElementById('challengeProgressBar');

    // ===== AUDIO =====
    var audioCtx = null;
    function getAudioContext() { if (!audioCtx) try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} return audioCtx; }

    function playTone(freq, dur) {
        var c = getAudioContext(); if (!c) return;
        try {
            if (c.state === 'suspended') c.resume();
            var o = c.createOscillator(), g = c.createGain();
            o.type = 'sine'; o.frequency.value = freq;
            o.connect(g); g.connect(c.destination);
            g.gain.setValueAtTime(0.25, c.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + dur);
            o.start(); o.stop(c.currentTime + dur + 0.05);
        } catch(e) {}
    }

    function playBeep() { playTone(880, 0.15); }
    function playTap() { playTone(660, 0.1); }
    function playCorrect() { [523, 659, 784].forEach(function(f, i) { setTimeout(function() { playTone(f, 0.12); }, i * 80); }); }
    function playLevelUp() { [523, 659, 784, 1047].forEach(function(f, i) { setTimeout(function() { playTone(f, 0.2); }, i * 100); }); }
    function playWrong() { playTone(200, 0.3); }

    // ===== CELEBRATIONS =====
    function getCourtCenter() { var r = courtGrid.getBoundingClientRect(); return { x: r.left + r.width / 2, y: r.top + r.height / 2 }; }

    function createEmoji(emoji, x, y, big) {
        var el = document.createElement('div');
        el.className = 'burst-emoji' + (big ? ' big' : '');
        el.textContent = emoji;
        var a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 80;
        el.style.cssText = 'left:' + x + 'px;top:' + y + 'px;--tx:' + Math.cos(a) * d + 'px;--ty:' + Math.sin(a) * d + 'px;--rot:' + (Math.random() - 0.5) * 720 + 'deg';
        emojiContainer.appendChild(el);
        setTimeout(function() { if (el.parentNode) el.remove(); }, 1500);
    }

    function celebrate(count, useChampion) {
        var c = getCourtCenter();
        var emojis = useChampion ? CHAMPION_EMOJIS : LAUGH_EMOJIS;
        for (var i = 0; i < count; i++) {
            (function(idx) {
                setTimeout(function() {
                    createEmoji(emojis[Math.floor(Math.random() * emojis.length)], c.x + (Math.random() - 0.5) * 30, c.y + (Math.random() - 0.5) * 30, useChampion);
                }, idx * 40);
            })(i);
        }
        courtGrid.classList.add('joy-pulse');
        setTimeout(function() { courtGrid.classList.remove('joy-pulse'); }, 500);
    }

    function showCoach(m) {
        coachMessage.textContent = m;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2000);
    }

    // ===== INIT COURT =====
    function initCourt() {
        courtGrid.innerHTML = '';
        state.cells = [];
        for (var i = 0; i < TOTAL_CELLS; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.index = i;
            (function(index) {
                cell.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCellTap(index);
                });
            })(i);
            courtGrid.appendChild(cell);
            state.cells.push(cell);
        }
    }

    // ===== HELPERS =====
    function getCurrentChallengeLevel() { return state.challengeType === 'sequence' ? state.sequenceLevel : state.matchLevel; }
    function setCurrentChallengeLevel(val) { 
        if (state.challengeType === 'sequence') { 
            state.sequenceLevel = val; 
            localStorage.setItem('lc-challenge-sequence-level', val); 
        } else { 
            state.matchLevel = val; 
            localStorage.setItem('lc-challenge-match-level', val); 
        } 
    }
    function isCurrentChampion() { return state.challengeType === 'sequence' ? state.isSequenceChampion : state.isMatchChampion; }
    function setCurrentChampion() {
        if (state.challengeType === 'sequence') {
            state.isSequenceChampion = true;
            localStorage.setItem('lc-challenge-sequence-champion', 'true');
        } else {
            state.isMatchChampion = true;
            localStorage.setItem('lc-challenge-match-champion', 'true');
        }
    }

    // ===== UI UPDATES =====
    function updateChallengeSelection() {
        var seqLevel = state.sequenceLevel;
        var matchLevel = state.matchLevel;
        var seqBadge = document.getElementById('seqProgressBadge');
        var matchBadge = document.getElementById('matchProgressBadge');
        
        if (state.isSequenceChampion) {
            seqBadge.textContent = 'üëë CHAMPION';
            seqBadge.className = 'challenge-progress-badge champion';
        } else {
            seqBadge.textContent = 'L' + seqLevel + ' ' + getDivisionName(getChallengeSpeed(seqLevel));
            seqBadge.className = 'challenge-progress-badge sequence';
        }
        
        if (state.isMatchChampion) {
            matchBadge.textContent = 'üëë CHAMPION';
            matchBadge.className = 'challenge-progress-badge champion';
        } else {
            matchBadge.textContent = 'L' + matchLevel + ' ' + getDivisionName(getChallengeSpeed(matchLevel));
            matchBadge.className = 'challenge-progress-badge match';
        }
    }

    function updateProgressBar() {
        var challengeLevel = getCurrentChallengeLevel();
        
        // D3 levels (1-3)
        var d3Html = '';
        for (var i = 1; i <= 3; i++) {
            var cls = 'tier-level';
            if (i < challengeLevel) cls += ' completed';
            else if (i === challengeLevel) cls += ' current';
            d3Html += '<div class="' + cls + '">' + i + '</div>';
        }
        document.getElementById('d3Levels').innerHTML = d3Html;
        document.getElementById('d3Status').textContent = challengeLevel > 3 ? '‚úÖ' : '‚¨ú';
        
        // D2 levels (4-6)
        var d2Html = '';
        for (var j = 4; j <= 6; j++) {
            var cls2 = 'tier-level';
            if (j < challengeLevel) cls2 += ' completed';
            else if (j === challengeLevel) cls2 += ' current';
            else if (challengeLevel < 4) cls2 += ' locked';
            d2Html += '<div class="' + cls2 + '">' + j + '</div>';
        }
        document.getElementById('d2Levels').innerHTML = d2Html;
        document.getElementById('d2Status').textContent = challengeLevel > 6 ? '‚úÖ' : challengeLevel >= 4 ? '‚¨ú' : 'üîí';
        
        // D1 levels (7-10) - Final Four
        var d1Html = '';
        for (var k = 7; k <= 10; k++) {
            var cls3 = 'tier-level';
            if (k < challengeLevel) cls3 += ' completed';
            else if (k === challengeLevel) cls3 += ' current';
            else if (challengeLevel < 7) cls3 += ' locked';
            d1Html += '<div class="' + cls3 + '">' + k + '</div>';
        }
        document.getElementById('d1Levels').innerHTML = d1Html;
        document.getElementById('d1Status').textContent = isCurrentChampion() ? 'üëë' : challengeLevel >= 7 ? '‚¨ú' : 'üîí';
    }

    function updatePhaseDisplay() {
        var reactPhase = document.getElementById('reactPhase');
        var recallPhase = document.getElementById('recallPhase');
        
        if (state.challengeType === 'sequence') {
            recallPhase.innerHTML = 'üî¢ ORDER';
        } else {
            recallPhase.innerHTML = 'üéØ FIND';
        }
        
        reactPhase.className = 'phase-indicator';
        recallPhase.className = 'phase-indicator';
        
        if (state.phase === 'react') {
            reactPhase.classList.add('active');
        } else {
            reactPhase.classList.add('complete');
            recallPhase.classList.add('active');
        }
    }

    function updateDisplay() {
        var challengeLevel = getCurrentChallengeLevel();
        state.level = challengeLevel;
        state.speed = getChallengeSpeed(challengeLevel);
        
        document.getElementById('levelDisplay').textContent = state.level;
        document.getElementById('streakDisplay').textContent = state.streak;
        document.getElementById('scoreDisplay').textContent = state.score;
        document.getElementById('totalScore').textContent = state.score;
        
        var divBadge = document.getElementById('divisionBadge');
        divBadge.textContent = 'L' + state.level + ' ' + getDivisionName(state.speed);
        
        // Update type label and colors
        var typeLabel = document.getElementById('challengeTypeLabel');
        if (state.challengeType === 'sequence') {
            typeLabel.textContent = 'üî¢ REACTION + SEQUENCE';
            challengeProgressBar.className = 'challenge-progress';
            courtGrid.className = 'court-grid';
            messageDisplay.className = 'message-display';
            divBadge.className = 'division-badge';
            actionBtn.className = 'action-btn';
        } else {
            typeLabel.textContent = 'üéØ REACTION + MATCH';
            challengeProgressBar.className = 'challenge-progress match-mode';
            courtGrid.className = 'court-grid match-mode';
            messageDisplay.className = 'message-display match-mode';
            divBadge.className = 'division-badge match-mode';
            actionBtn.className = 'action-btn match-mode';
        }
        
        updateProgressBar();
        updatePhaseDisplay();
    }

    // ===== CHALLENGE SELECTION =====
    document.getElementById('sequenceChallengeBtn').onclick = function() {
        state.challengeType = 'sequence';
        startChallenge();
    };

    document.getElementById('matchChallengeBtn').onclick = function() {
        state.challengeType = 'match';
        startChallenge();
    };

    function startChallenge() {
        state.phase = 'react';
        state.reactionSequence = [];
        state.matchFound = [];
        state.score = 0;
        state.streak = 0;
        
        challengeScreen.classList.add('hidden');
        gameScreen.classList.add('active');
        
        updateDisplay();
    }

    // ===== GAME START =====
    function startRound() {
        if (state.isPlaying) return;
        
        var challengeLevel = getCurrentChallengeLevel();
        state.level = challengeLevel;
        state.speed = getChallengeSpeed(challengeLevel);
        state.totalTaps = getCellCount(state.level);
        state.currentTap = 0;
        state.isPlaying = true;
        state.canTap = false;
        
        actionBtn.disabled = true;
        state.cells.forEach(function(c) { c.className = 'grid-cell'; });
        
        document.getElementById('tapsCounter').textContent = '0/' + state.totalTaps;
        
        if (state.phase === 'react') {
            // REACTION PHASE - Start fresh
            state.reactionSequence = [];
            state.matchFound = [];
            
            messageText.innerHTML = '<span class="lang-en">GET READY...</span><span class="lang-es">PREP√ÅRATE...</span>';
            messageText.className = 'message-text watch';
            
            setTimeout(function() {
                messageText.innerHTML = '<span class="lang-en">REACT!</span><span class="lang-es">¬°REACCIONA!</span>';
                messageText.className = 'message-text go';
                flashNextCell();
            }, 800);
        } else {
            // RECALL PHASE
            state.recallIndex = 0;
            state.matchFound = [];
            
            if (state.challengeType === 'sequence') {
                messageText.innerHTML = '<span class="lang-en">RECALL THE ORDER!</span><span class="lang-es">¬°RECUERDA EL ORDEN!</span>';
            } else {
                messageText.innerHTML = '<span class="lang-en">FIND ALL ' + state.reactionSequence.length + ' CELLS!</span><span class="lang-es">¬°ENCUENTRA LAS ' + state.reactionSequence.length + '!</span>';
            }
            messageText.className = 'message-text watch';
            
            document.getElementById('tapsCounter').textContent = '0/' + state.reactionSequence.length;
            
            setTimeout(function() {
                if (state.challengeType === 'sequence') {
                    messageText.innerHTML = '<span class="lang-en">TAP IN ORDER!</span><span class="lang-es">¬°EN ORDEN!</span>';
                } else {
                    messageText.innerHTML = '<span class="lang-en">TAP TO FIND!</span><span class="lang-es">¬°TOCA PARA BUSCAR!</span>';
                }
                messageText.className = 'message-text go';
                state.isPlaying = true;
                state.canTap = true;
            }, 1000);
        }
        
        updateDisplay();
    }

    function flashNextCell() {
        if (!state.isPlaying) return;
        
        if (state.currentCell >= 0) {
            state.cells[state.currentCell].classList.remove('lit');
        }
        
        var newCell;
        do { newCell = Math.floor(Math.random() * TOTAL_CELLS); } while (newCell === state.currentCell);
        
        state.currentCell = newCell;
        state.reactionSequence.push(newCell);
        state.cells[state.currentCell].classList.add('lit');
        state.canTap = true;
        
        playBeep();
        
        var duration = SPEED_CONFIG[state.speed];
        state.timerStart = Date.now();
        
        state.timer = setTimeout(function() {
            if (state.canTap && state.isPlaying) {
                state.canTap = false;
                missedTap();
            }
        }, duration);
    }

    // ===== CELL TAP HANDLER =====
    function handleCellTap(index) {
        if (!state.canTap || !state.isPlaying) return;
        
        var cell = state.cells[index];
        
        // === RECALL PHASE ===
        if (state.phase === 'recall') {
            if (state.challengeType === 'sequence') {
                // SEQUENCE: Must tap in exact order
                var expectedCell = state.reactionSequence[state.recallIndex];
                
                if (index === expectedCell) {
                    playTap();
                    cell.classList.add('correct');
                    state.recallIndex++;
                    state.score += 15;
                    
                    document.getElementById('tapsCounter').textContent = state.recallIndex + '/' + state.reactionSequence.length;
                    document.getElementById('scoreDisplay').textContent = state.score;
                    document.getElementById('totalScore').textContent = state.score;
                    
                    if (state.recallIndex >= state.reactionSequence.length) {
                        state.canTap = false;
                        recallComplete();
                    }
                } else {
                    cell.classList.add('wrong');
                    state.cells[expectedCell].classList.add('lit');
                    state.canTap = false;
                    recallFailed();
                }
            } else {
                // MATCH: Can tap in any order, find all
                var isInSequence = state.reactionSequence.indexOf(index) !== -1;
                var alreadyFound = state.matchFound.indexOf(index) !== -1;
                
                if (isInSequence && !alreadyFound) {
                    playTap();
                    cell.classList.add('found');
                    state.matchFound.push(index);
                    state.score += 15;
                    
                    document.getElementById('tapsCounter').textContent = state.matchFound.length + '/' + state.reactionSequence.length;
                    document.getElementById('scoreDisplay').textContent = state.score;
                    document.getElementById('totalScore').textContent = state.score;
                    
                    if (state.matchFound.length >= state.reactionSequence.length) {
                        state.canTap = false;
                        recallComplete();
                    }
                } else if (!isInSequence) {
                    cell.classList.add('wrong');
                    state.canTap = false;
                    recallFailed();
                }
                // If already found, just ignore
            }
            return;
        }
        
        // === REACT PHASE ===
        clearTimeout(state.timer);
        state.canTap = false;
        
        if (index === state.currentCell) {
            playTap();
            cell.classList.remove('lit');
            cell.classList.add('correct');
            state.currentTap++;
            
            var reactionTime = Date.now() - state.timerStart;
            var maxTime = SPEED_CONFIG[state.speed];
            var timeBonus = Math.floor((1 - reactionTime / maxTime) * 10);
            state.score += 10 + timeBonus;
            
            document.getElementById('tapsCounter').textContent = state.currentTap + '/' + state.totalTaps;
            document.getElementById('scoreDisplay').textContent = state.score;
            document.getElementById('totalScore').textContent = state.score;
            
            if (state.currentTap % 3 === 0) celebrate(3);
            
            if (state.currentTap >= state.totalTaps) {
                reactComplete();
            } else {
                setTimeout(function() {
                    cell.classList.remove('correct');
                    flashNextCell();
                }, 200);
            }
        } else {
            cell.classList.add('wrong');
            missedTap();
        }
    }

    function missedTap() {
        state.isPlaying = false;
        state.canTap = false;
        clearTimeout(state.timer);
        playWrong();
        
        if (state.currentCell >= 0) {
            state.cells[state.currentCell].classList.remove('lit');
            state.cells[state.currentCell].classList.add('wrong');
        }
        
        state.streak = 0;
        state.phase = 'react';
        state.reactionSequence = [];
        state.matchFound = [];
        
        updatePhaseDisplay();
        
        messageText.innerHTML = '<span class="lang-en">TOO SLOW!</span><span class="lang-es">¬°MUY LENTO!</span>';
        messageText.className = 'message-text miss';
        
        setTimeout(finishRound, 1500);
    }

    function reactComplete() {
        state.isPlaying = false;
        state.canTap = false;
        clearTimeout(state.timer);
        
        playCorrect();
        state.streak++;
        celebrate(5);
        
        // Move to recall phase
        state.phase = 'recall';
        updatePhaseDisplay();
        
        messageText.innerHTML = '<span class="lang-en">PERFECT! NOW RECALL...</span><span class="lang-es">¬°PERFECTO! AHORA RECUERDA...</span>';
        messageText.className = 'message-text perfect';
        
        showCoach('üòÑ GREAT!');
        
        setTimeout(finishRound, 1500);
    }

    function recallFailed() {
        state.isPlaying = false;
        state.canTap = false;
        playWrong();
        
        state.streak = 0;
        state.phase = 'react';
        state.reactionSequence = [];
        state.matchFound = [];
        
        updatePhaseDisplay();
        
        var failMsg = state.challengeType === 'sequence' 
            ? '<span class="lang-en">WRONG ORDER!</span><span class="lang-es">¬°ORDEN INCORRECTO!</span>'
            : '<span class="lang-en">WRONG CELL!</span><span class="lang-es">¬°CELDA INCORRECTA!</span>';
        messageText.innerHTML = failMsg;
        messageText.className = 'message-text miss';
        
        setTimeout(finishRound, 1500);
    }

    function recallComplete() {
        state.isPlaying = false;
        state.canTap = false;
        
        playCorrect();
        state.streak++;
        celebrate(8, true);
        
        var recallType = state.challengeType === 'sequence' ? 'ORDER' : 'MATCH';
        messageText.innerHTML = '<span class="lang-en">PERFECT ' + recallType + '!</span><span class="lang-es">¬°' + recallType + ' PERFECTO!</span>';
        messageText.className = 'message-text perfect';
        
        showCoach(state.streak >= 5 ? 'üèÜ LEGEND!' : state.streak >= 3 ? 'üòÇ AMAZING!' : 'üòÑ NICE!');
        
        // Level complete!
        var currentLevel = getCurrentChallengeLevel();
        var oldTier = getTierForLevel(currentLevel);
        setCurrentChallengeLevel(currentLevel + 1);
        state.phase = 'react';
        state.reactionSequence = [];
        state.matchFound = [];
        
        var newLevel = getCurrentChallengeLevel();
        
        if (newLevel > 10) {
            setCurrentChampion();
            setTimeout(showChampionOverlay, 1200);
        } else {
            var newTier = getTierForLevel(newLevel);
            if (newTier !== oldTier) {
                setTimeout(function() { showTierUpOverlay(newTier); }, 1200);
            } else {
                setTimeout(showLevelUpOverlay, 1200);
            }
        }
    }

    function showLevelUpOverlay() {
        playLevelUp();
        celebrate(6);
        var newLevel = getCurrentChallengeLevel();
        document.getElementById('levelUpMessage').innerHTML = currentLang === 'es'
            ? 'Avanzando a Nivel ' + newLevel
            : 'Advancing to Level ' + newLevel;
        document.getElementById('levelUpOverlay').classList.add('show');
    }

    document.getElementById('levelUpBtn').onclick = function() {
        document.getElementById('levelUpOverlay').classList.remove('show');
        state.phase = 'react';
        updateDisplay();
        finishRound();
    };

    function showTierUpOverlay(tier) {
        playLevelUp();
        celebrate(10, true);
        
        if (tier === 'med') {
            document.getElementById('tierUpEmoji').textContent = 'ü•à';
            document.getElementById('tierUpTitle').textContent = currentLang === 'es' ? '¬°DIVISI√ìN 2!' : 'DIVISION 2!';
            document.getElementById('tierUpMessage').innerHTML = currentLang === 'es' 
                ? '¬°Ganaste D2! Las cosas se ponen m√°s r√°pidas.' 
                : 'You earned D2! Things get faster now.';
        } else if (tier === 'fast') {
            document.getElementById('tierUpEmoji').textContent = 'ü•á';
            document.getElementById('tierUpTitle').textContent = currentLang === 'es' ? '¬°DIVISI√ìN 1!' : 'DIVISION 1!';
            document.getElementById('tierUpMessage').innerHTML = currentLang === 'es' 
                ? '¬°Bienvenido al Final Four! Territorio √©lite.' 
                : 'Welcome to the Final Four! Elite territory.';
        }
        
        document.getElementById('tierUpOverlay').classList.add('show');
    }

    document.getElementById('tierUpBtn').onclick = function() {
        document.getElementById('tierUpOverlay').classList.remove('show');
        state.phase = 'react';
        updateDisplay();
        finishRound();
    };

    function showChampionOverlay() {
        playLevelUp();
        celebrate(15, true);
        
        var typeName = state.challengeType === 'sequence' ? 'SEQUENCE' : 'MATCH';
        document.getElementById('championTitle').textContent = typeName + ' CHAMPION!';
        document.getElementById('championMessage').innerHTML = currentLang === 'es' 
            ? '¬°Conquistaste el reto con ' + state.score + ' puntos!' 
            : 'You conquered with ' + state.score + ' points!';
        document.getElementById('championOverlay').classList.add('show');
    }

    document.getElementById('championBtn').onclick = function() {
        document.getElementById('championOverlay').classList.remove('show');
        setCurrentChallengeLevel(1);
        state.phase = 'react';
        state.reactionSequence = [];
        state.matchFound = [];
        
        gameScreen.classList.remove('active');
        challengeScreen.classList.remove('hidden');
        updateChallengeSelection();
    };

    function finishRound() {
        state.isPlaying = false;
        state.currentCell = -1;
        state.cells.forEach(function(c) { c.className = 'grid-cell'; });
        
        if (state.phase === 'recall') {
            if (state.challengeType === 'sequence') {
                messageText.innerHTML = '<span class="lang-en">TAP TO RECALL ORDER!</span><span class="lang-es">¬°PULSA PARA RECORDAR!</span>';
                actionBtn.innerHTML = '<span class="lang-en">RECALL</span><span class="lang-es">RECORDAR</span>';
            } else {
                messageText.innerHTML = '<span class="lang-en">TAP TO FIND CELLS!</span><span class="lang-es">¬°PULSA PARA BUSCAR!</span>';
                actionBtn.innerHTML = '<span class="lang-en">FIND</span><span class="lang-es">BUSCAR</span>';
            }
        } else {
            messageText.innerHTML = '<span class="lang-en">TAP GO!</span><span class="lang-es">¬°PULSA IR!</span>';
            actionBtn.innerHTML = '<span class="lang-en">GO</span><span class="lang-es">IR</span>';
        }
        
        messageText.className = 'message-text';
        actionBtn.disabled = false;
    }

    actionBtn.onclick = startRound;

    // ===== INIT =====
    initCourt();
    setLang(currentLang);
    updateChallengeSelection();
})();
</script>
</body>
</html>
