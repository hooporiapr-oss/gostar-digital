<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LAUGH 2: Goofy Sounds | Laughletico‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--orange:#FF6B00;--teal:#00D9A5;--gold:#FFD700;--purple:#9B59B6;--pink:#FF69B4;--dark:#0a0a0f;--card:#111118;--text:#FFFFFF;--muted:#8892a0;--success:#00D9A5;--danger:#FF4757;--laugh2:#F39C12}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',sans-serif;background:var(--dark);color:var(--text)}
body.es .lang-en{display:none!important}
body.en .lang-es{display:none!important}
.game-header{padding:15px 20px;background:linear-gradient(135deg,rgba(243,156,18,0.2),rgba(255,105,180,0.1));border-bottom:2px solid rgba(243,156,18,0.3);display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:12px}
.coach-header-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden}
.coach-header-img{width:100%;height:100%;object-fit:cover}
.coach-label{font-size:0.65rem;color:var(--muted);letter-spacing:1px}
.back-btn{width:40px;height:40px;background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:var(--text);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.game-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px}
.game-title .laugh-title{color:var(--laugh2)}
.game-title .num{color:var(--gold)}
.tier-badge{background:linear-gradient(135deg,var(--laugh2),var(--pink));padding:6px 14px;border-radius:20px;font-weight:700;font-size:0.8rem}
.lang-toggle{display:flex;gap:5px}
.lang-btn{padding:6px 12px;border:2px solid var(--laugh2);background:transparent;color:var(--laugh2);border-radius:15px;font-weight:700;font-size:0.7rem;cursor:pointer}
.lang-btn.active{background:var(--laugh2);color:var(--text)}
.game-container{height:calc(100vh - 80px);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;position:relative}
.intro-screen{text-align:center;max-width:400px}
.intro-coach{margin-bottom:15px}
.intro-coach-img{width:100px;height:100px;border-radius:50%;object-fit:cover;border:4px solid var(--laugh2);animation:wiggle 1s infinite}
@keyframes wiggle{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}
.intro-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:4px;margin-bottom:5px}
.intro-title .laugh-title{color:var(--laugh2)}
.intro-title .num{color:var(--gold)}
.intro-circuit{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;margin-bottom:10px}
.intro-subtitle{color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:2px;margin-bottom:20px}
.intro-desc{color:var(--muted);line-height:1.6;margin-bottom:25px}
.intro-desc strong{color:var(--text)}
.intro-coach-name{margin-top:20px;color:var(--muted);font-size:0.9rem}
.start-btn{padding:18px 50px;font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:4px;background:linear-gradient(135deg,var(--laugh2),var(--pink));color:var(--text);border:none;border-radius:50px;cursor:pointer;box-shadow:0 8px 30px rgba(243,156,18,0.5)}
.test-sound-btn{display:block;margin:10px auto;padding:10px 20px;background:var(--card);border:2px solid var(--laugh2);color:var(--laugh2);border-radius:20px;font-weight:700;cursor:pointer}

.mastery-display{background:var(--card);border:2px solid var(--laugh2);border-radius:20px;padding:20px;margin-bottom:25px}
.mastery-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--gold);margin-bottom:15px}
.mastery-tier{display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:15px}
.mastery-tier-label{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--laugh2)}
.mastery-stars{display:flex;gap:8px}
.mastery-star{font-size:1.8rem;opacity:0.3}
.mastery-star.earned{opacity:1}
.mastery-info{font-size:0.8rem;color:var(--muted)}
.mastery-info strong{color:var(--success)}
.tier-progress{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;margin-top:15px}
.tier-dot{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;color:var(--muted);border:2px solid transparent}
.tier-dot.unlocked{background:var(--success);color:var(--dark)}
.tier-dot.current{background:var(--laugh2);color:var(--text);border-color:var(--gold);animation:pulse 1s infinite}
.tier-dot.locked{opacity:0.4}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

.learn-screen{text-align:center;width:100%}
.phase-label{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;color:var(--gold);margin-bottom:15px}
.sound-card{background:var(--card);border:3px solid var(--laugh2);border-radius:25px;padding:30px;margin:20px auto;max-width:300px;cursor:pointer}
.sound-card:active{transform:scale(0.98)}
.sound-emoji{font-size:5rem;margin-bottom:15px;display:block;animation:popIn 0.5s ease}
@keyframes popIn{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.sound-label{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:2px;color:var(--laugh2)}
.sound-hint{font-size:0.8rem;color:var(--muted);margin-top:10px}
.timer-bar{width:80%;max-width:300px;height:8px;background:rgba(255,255,255,0.1);border-radius:10px;margin:25px auto;overflow:hidden}
.timer-fill{height:100%;background:linear-gradient(90deg,var(--laugh2),var(--pink));border-radius:10px;transition:width 0.1s linear}
.counter{color:var(--muted);font-size:0.9rem;margin-top:10px}

.recall-screen{text-align:center;width:100%}
.recall-prompt{font-size:5rem;margin-bottom:10px;animation:bounce 0.5s ease infinite alternate;cursor:pointer}
@keyframes bounce{0%{transform:translateY(0)}100%{transform:translateY(-10px)}}
.recall-question{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;margin-bottom:15px}
.recall-timer{width:100%;max-width:350px;height:10px;background:rgba(255,255,255,0.1);border-radius:10px;margin:15px auto;overflow:hidden}
.recall-timer-fill{height:100%;background:var(--success);border-radius:10px;transition:width 0.05s linear}
.recall-timer-fill.danger{background:var(--danger)}
.answers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;max-width:320px;margin:0 auto}
.answer-btn{background:var(--card);border:3px solid rgba(255,255,255,0.1);border-radius:20px;padding:18px 15px;cursor:pointer;transition:all 0.15s;text-align:center}
.answer-btn:active{transform:scale(0.95)}
.answer-btn .label{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1px;color:var(--text)}
.answer-btn.correct{border-color:var(--success);background:rgba(0,217,165,0.2)}
.answer-btn.wrong{border-color:var(--danger);background:rgba(255,71,87,0.2)}
.speed-bonus{position:fixed;top:40%;left:50%;transform:translateX(-50%);font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold);animation:floatUp 1s forwards;z-index:100}
@keyframes floatUp{0%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(-50px)}}

.score-display{position:absolute;top:100px;right:20px;text-align:right}
.score-label{font-size:0.7rem;color:var(--muted)}
.score-value{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--laugh2)}
.laugh-counter{position:absolute;top:100px;left:20px;text-align:left}
.laugh-counter-label{font-size:0.7rem;color:var(--muted);letter-spacing:1px}
.laugh-counter-value{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--gold)}

.gameover-screen{text-align:center;max-width:400px}
.gameover-emoji{font-size:5rem;margin-bottom:20px}
.gameover-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:10px}
.gameover-score{font-family:'Bebas Neue',sans-serif;font-size:3rem;color:var(--laugh2);margin:15px 0}
.gameover-stats{color:var(--gold);margin-bottom:20px;font-size:1.1rem}
.gameover-mastery{background:var(--card);border:2px solid var(--gold);border-radius:15px;padding:15px;margin-bottom:20px}
.gameover-mastery-title{font-family:'Bebas Neue',sans-serif;color:var(--gold);margin-bottom:10px}
.gameover-stars{font-size:2rem}
.gameover-mastery-text{font-size:0.85rem;color:var(--muted);margin-top:10px}
.gameover-mastery-text strong{color:var(--success)}
.retry-btn{padding:16px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;background:linear-gradient(135deg,var(--laugh2),var(--pink));color:var(--text);border:none;border-radius:50px;cursor:pointer;margin-bottom:15px;display:block;width:100%}
.home-btn{padding:14px 30px;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;background:transparent;color:var(--muted);border:2px solid var(--muted);border-radius:50px;cursor:pointer;display:block;width:100%}

.coach-bubble{position:fixed;bottom:20px;left:20px;right:20px;background:var(--card);border:2px solid var(--laugh2);border-radius:20px;padding:15px;display:flex;align-items:center;gap:15px;z-index:50}
.coach-avatar{width:50px;height:50px;border-radius:50%;overflow:hidden}
.coach-avatar img{width:100%;height:100%;object-fit:cover}
.coach-text{font-size:0.95rem;line-height:1.4}

.confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}
.confetti{position:absolute;width:10px;height:10px;top:-10px;animation:fall 3s linear forwards}
@keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
.laugh-pop{position:fixed;pointer-events:none;font-size:2rem;animation:laughFloat 1s ease-out forwards;z-index:999}
@keyframes laughFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-50px) scale(1.5)}}

.tier-up-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000}
.tier-up-content{text-align:center;animation:tierUpAppear 0.5s ease}
@keyframes tierUpAppear{0%{transform:scale(0)}100%{transform:scale(1)}}
.tier-up-emoji{font-size:5rem;margin-bottom:20px}
.tier-up-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--gold);letter-spacing:4px;margin-bottom:10px}
.tier-up-subtitle{font-size:1.2rem;color:var(--muted);margin-bottom:30px}
.tier-up-btn{padding:15px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;background:linear-gradient(135deg,var(--laugh2),var(--pink));color:var(--text);border:none;border-radius:50px;cursor:pointer}

.hidden{display:none!important}
</style>
</head>
<body class="en">
<div class="confetti-container" id="confettiContainer"></div>

<div class="game-header">
<div class="header-left">
<button class="back-btn" id="backBtn">‚Üê</button>
<div class="coach-header-avatar"><img src="go_chat.png" alt="Coach" class="coach-header-img"></div>
<div>
<div class="game-title"><span class="laugh-title">LAUGH</span> <span class="num">2</span></div>
<div class="coach-label">w/ Coach GoTrotter AI</div>
</div>
<div class="tier-badge" id="tierBadge">TIER 1</div>
</div>
<div class="lang-toggle">
<button class="lang-btn active" data-lang="en">EN</button>
<button class="lang-btn" data-lang="es">ES</button>
</div>
</div>

<div class="game-container">

<div class="intro-screen" id="introScreen">
<div class="intro-coach"><img src="go_chat.png" alt="Coach" class="intro-coach-img"></div>
<div class="intro-title"><span class="laugh-title">LAUGH</span> <span class="num">2</span></div>
<div class="intro-circuit">GOOFY SOUNDS üîä</div>
<div class="intro-subtitle">
<span class="lang-en">SPEED & RECALL</span>
<span class="lang-es">VELOCIDAD Y MEMORIA</span>
</div>

<div class="mastery-display" id="masteryDisplay">
<div class="mastery-title">
<span class="lang-en">YOUR JOURNEY</span>
<span class="lang-es">TU PROGRESO</span>
</div>
<div class="mastery-tier">
<span class="mastery-tier-label" id="currentTierLabel">TIER 1</span>
<div class="mastery-stars">
<span class="mastery-star" id="star1">‚≠ê</span>
<span class="mastery-star" id="star2">‚≠ê</span>
</div>
</div>
<div class="mastery-info">
<span class="lang-en"><strong>2 perfect rounds</strong> to unlock next tier</span>
<span class="lang-es"><strong>2 rondas perfectas</strong> para desbloquear</span>
</div>
<div class="tier-progress" id="tierProgress"></div>
</div>

<div class="intro-desc">
<span class="lang-en">Hear <strong>goofy sounds</strong> ‚Äî then name them FAST! üîä‚ö°</span>
<span class="lang-es">Escucha <strong>sonidos locos</strong> ‚Äî ¬°y n√≥mbralos R√ÅPIDO! üîä‚ö°</span>
</div>
<button class="test-sound-btn" id="testSoundBtn">üîä TEST SOUND</button>
<button class="start-btn" id="startBtn">
<span class="lang-en">START SOUNDS! üîä</span>
<span class="lang-es">¬°ESCUCHAR! üîä</span>
</button>
<div class="intro-coach-name">
<span class="lang-en">with Coach GoTrotter AI üèÄ</span>
<span class="lang-es">con Coach GoTrotter AI üèÄ</span>
</div>
</div>

<div class="learn-screen hidden" id="learnScreen">
<div class="phase-label">
<span class="lang-en">üîä LEARN THE SOUND!</span>
<span class="lang-es">üîä ¬°APRENDE EL SONIDO!</span>
</div>
<div class="sound-card" id="soundCard">
<span class="sound-emoji" id="learnEmoji">üê∑</span>
<div class="sound-label" id="learnLabel">OINK</div>
<div class="sound-hint">
<span class="lang-en">üëÜ Tap to hear again</span>
<span class="lang-es">üëÜ Toca para escuchar</span>
</div>
</div>
<div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
<div class="counter" id="pairCounter">Sound 1 of 3</div>
</div>

<div class="recall-screen hidden" id="recallScreen">
<div class="recall-prompt" id="recallPrompt">üîä</div>
<div class="recall-question">
<span class="lang-en">ü§î WHAT SOUND WAS THAT?</span>
<span class="lang-es">ü§î ¬øQU√â SONIDO FUE ESE?</span>
</div>
<div class="recall-timer"><div class="recall-timer-fill" id="recallTimerFill"></div></div>
<div class="answers-grid" id="answersGrid"></div>
</div>

<div class="gameover-screen hidden" id="gameoverScreen">
<div class="gameover-emoji" id="gameoverEmoji">üîä</div>
<div class="gameover-title">
<span class="lang-en">ROUND COMPLETE!</span>
<span class="lang-es">¬°RONDA COMPLETA!</span>
</div>
<div class="gameover-score" id="finalScore">0</div>
<div class="gameover-stats" id="gameStats">üòÇ Laugh Moments: 0</div>
<div class="gameover-mastery">
<div class="gameover-mastery-title">TIER <span id="gameoverTier">1</span> <span class="lang-en">PROGRESS</span><span class="lang-es">PROGRESO</span></div>
<div class="gameover-stars" id="gameoverStars">‚≠ê‚≠ê</div>
<div class="gameover-mastery-text" id="gameoverMasteryText"></div>
</div>
<button class="retry-btn" id="retryBtn">
<span class="lang-en">CONTINUE üîä</span>
<span class="lang-es">CONTINUAR üîä</span>
</button>
<button class="home-btn" id="homeBtn">
<span class="lang-en">‚Üê BACK</span>
<span class="lang-es">‚Üê VOLVER</span>
</button>
</div>

<div class="score-display hidden" id="scoreDisplay">
<div class="score-label">SCORE</div>
<div class="score-value" id="currentScore">0</div>
</div>

<div class="laugh-counter hidden" id="laughCounter">
<div class="laugh-counter-label">üòÇ LAUGHS</div>
<div class="laugh-counter-value" id="laughCounterValue">0</div>
</div>

</div>

<div class="tier-up-overlay hidden" id="tierUpOverlay">
<div class="tier-up-content">
<div class="tier-up-emoji">üèÜ</div>
<div class="tier-up-title">TIER UP!</div>
<div class="tier-up-subtitle" id="tierUpSubtitle">You've unlocked Tier 2!</div>
<button class="tier-up-btn" id="tierUpBtn">CONTINUE!</button>
</div>
</div>

<div class="coach-bubble hidden" id="coachBubble">
<div class="coach-avatar"><img src="go_chat.png" alt="Coach"></div>
<div class="coach-text" id="coachText">Great!</div>
</div>

<script>
(function(){
var lang = localStorage.getItem('lw-lang') || 'en';
function setLang(l){
    lang = l;
    localStorage.setItem('lw-lang', l);
    document.body.className = l;
    document.querySelectorAll('.lang-btn').forEach(function(b){
        b.classList.toggle('active', b.dataset.lang === l);
    });
}
setLang(lang);
document.querySelectorAll('.lang-btn').forEach(function(b){
    b.addEventListener('click', function(e){ e.preventDefault(); setLang(this.dataset.lang); });
});

// ============ WEB AUDIO ============
var audioCtx = null;
var audioUnlocked = false;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (!audioUnlocked) {
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        gain.gain.value = 0.001;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
        audioUnlocked = true;
    }
}

function playSound(name) {
    initAudio();
    if (!audioCtx || audioCtx.state !== 'running') return;
    var sounds = {
        'BOING': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(150,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(600,audioCtx.currentTime+0.1);o.frequency.exponentialRampToValueAtTime(150,audioCtx.currentTime+0.2);g.gain.setValueAtTime(0.8,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.3);},
        'SPLAT': function(){var bufferSize=audioCtx.sampleRate*0.3,buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate),data=buffer.getChannelData(0);for(var i=0;i<bufferSize;i++)data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.1));var s=audioCtx.createBufferSource(),g=audioCtx.createGain(),f=audioCtx.createBiquadFilter();f.type='lowpass';f.frequency.value=800;s.buffer=buffer;g.gain.value=0.7;s.connect(f);f.connect(g);g.connect(audioCtx.destination);s.start();},
        'HONK': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.setValueAtTime(200,audioCtx.currentTime);o.frequency.setValueAtTime(180,audioCtx.currentTime+0.1);g.gain.setValueAtTime(0.6,audioCtx.currentTime);g.gain.setValueAtTime(0.6,audioCtx.currentTime+0.15);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.3);},
        'OINK': function(){for(var i=0;i<3;i++){setTimeout(function(idx){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.setValueAtTime(200+idx*30,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(150+idx*30,audioCtx.currentTime+0.1);g.gain.setValueAtTime(0.4,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1);}.bind(null,i),i*80);}},
        'QUACK': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.setValueAtTime(500,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(200,audioCtx.currentTime+0.15);g.gain.setValueAtTime(0.6,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.2);},
        'DING': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=1200;g.gain.setValueAtTime(0.6,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.8);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.8);},
        'BOOM': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(150,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(30,audioCtx.currentTime+0.5);g.gain.setValueAtTime(0.8,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.5);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.5);var bufferSize=audioCtx.sampleRate*0.3,buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate),data=buffer.getChannelData(0);for(var i=0;i<bufferSize;i++)data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.05));var s=audioCtx.createBufferSource(),g2=audioCtx.createGain();s.buffer=buffer;g2.gain.value=0.5;s.connect(g2);g2.connect(audioCtx.destination);s.start();},
        'POP': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(400,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(100,audioCtx.currentTime+0.05);g.gain.setValueAtTime(0.5,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1);},
        'WHOOSH': function(){var bufferSize=audioCtx.sampleRate*0.5,buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate),data=buffer.getChannelData(0);for(var i=0;i<bufferSize;i++){var t=i/bufferSize;data[i]=(Math.random()*2-1)*Math.sin(t*Math.PI);}var s=audioCtx.createBufferSource(),f=audioCtx.createBiquadFilter(),g=audioCtx.createGain();f.type='bandpass';f.frequency.setValueAtTime(500,audioCtx.currentTime);f.frequency.linearRampToValueAtTime(2000,audioCtx.currentTime+0.3);f.Q.value=1;s.buffer=buffer;g.gain.value=0.4;s.connect(f);f.connect(g);g.connect(audioCtx.destination);s.start();},
        'TOOT': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.value=400;g.gain.setValueAtTime(0.3,audioCtx.currentTime);g.gain.setValueAtTime(0.3,audioCtx.currentTime+0.2);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.3);},
        'MOO': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.setValueAtTime(150,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(120,audioCtx.currentTime+0.5);o.frequency.linearRampToValueAtTime(150,audioCtx.currentTime+1);g.gain.setValueAtTime(0.4,audioCtx.currentTime);g.gain.setValueAtTime(0.4,audioCtx.currentTime+0.8);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+1);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+1);},
        'RIBBIT': function(){for(var i=0;i<2;i++){setTimeout(function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.setValueAtTime(200,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(80,audioCtx.currentTime+0.1);g.gain.setValueAtTime(0.4,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.15);},i*180);}},
        'BUZZ': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.value=150;var lfo=audioCtx.createOscillator();lfo.frequency.value=25;var lfoGain=audioCtx.createGain();lfoGain.gain.value=50;lfo.connect(lfoGain);lfoGain.connect(o.frequency);g.gain.setValueAtTime(0.2,audioCtx.currentTime);g.gain.setValueAtTime(0.2,audioCtx.currentTime+0.4);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.5);o.connect(g);g.connect(audioCtx.destination);o.start();lfo.start();o.stop(audioCtx.currentTime+0.5);lfo.stop(audioCtx.currentTime+0.5);},
        'BEEP': function(){var o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.value=800;g.gain.setValueAtTime(0.4,audioCtx.currentTime);g.gain.setValueAtTime(0.4,audioCtx.currentTime+0.1);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.15);}
    };
    if(sounds[name])sounds[name]();
}

// ============ MASTERY SYSTEM ============
var GAME_KEY = 'laugh2';
var MAX_TIER = 10;

function getMasteryData() {
    var data = JSON.parse(localStorage.getItem(GAME_KEY + '-mastery') || '{}');
    if (!data.currentTier) data.currentTier = 1;
    if (!data.stars) data.stars = 0;
    if (!data.unlockedTiers) data.unlockedTiers = [1];
    return data;
}

function saveMasteryData(data) { localStorage.setItem(GAME_KEY + '-mastery', JSON.stringify(data)); }

function addStar() {
    var data = getMasteryData();
    data.stars++;
    if (data.stars >= 2 && data.currentTier < MAX_TIER) {
        data.currentTier++;
        data.stars = 0;
        if (data.unlockedTiers.indexOf(data.currentTier) === -1) data.unlockedTiers.push(data.currentTier);
        saveMasteryData(data);
        return { tierUp: true, newTier: data.currentTier };
    }
    saveMasteryData(data);
    return { tierUp: false };
}

function updateMasteryDisplay() {
    var data = getMasteryData();
    document.getElementById('currentTierLabel').textContent = 'TIER ' + data.currentTier;
    document.getElementById('tierBadge').textContent = 'TIER ' + data.currentTier;
    document.getElementById('star1').classList.toggle('earned', data.stars >= 1);
    document.getElementById('star2').classList.toggle('earned', data.stars >= 2);
    var progressHtml = '';
    for (var i = 1; i <= MAX_TIER; i++) {
        var cls = 'tier-dot';
        if (data.unlockedTiers.indexOf(i) !== -1) cls += ' unlocked';
        if (i === data.currentTier) cls += ' current';
        if (data.unlockedTiers.indexOf(i) === -1 && i !== data.currentTier) cls += ' locked';
        progressHtml += '<div class="' + cls + '">' + i + '</div>';
    }
    document.getElementById('tierProgress').innerHTML = progressHtml;
}

// ============ LAUGH TRACKING ============
var circuitLaughs = 0;
function getDateString(date) { return date.toISOString().split('T')[0]; }
function getWeekStart(date) { var d = new Date(date); var day = d.getDay(); var diff = d.getDate() - day + (day === 0 ? -6 : 1); d.setDate(diff); return getDateString(d); }
function addLaughs(count) {
    circuitLaughs += count;
    updateLaughDisplay();
    var today = getDateString(new Date()), weekStart = getWeekStart(new Date());
    var todayData = JSON.parse(localStorage.getItem('lw-laughs-today') || '{}');
    if (todayData.date !== today) todayData = { date: today, count: 0 };
    todayData.count += count;
    localStorage.setItem('lw-laughs-today', JSON.stringify(todayData));
    var weekData = JSON.parse(localStorage.getItem('lw-laughs-week') || '{}');
    if (weekData.weekStart !== weekStart) weekData = { weekStart: weekStart, count: 0 };
    weekData.count += count;
    localStorage.setItem('lw-laughs-week', JSON.stringify(weekData));
    var total = parseInt(localStorage.getItem('lw-laughs-total') || '0');
    localStorage.setItem('lw-laughs-total', (total + count).toString());
    showLaughPop(count);
}
function updateLaughDisplay() { document.getElementById('laughCounterValue').textContent = circuitLaughs; }
function showLaughPop(count) { for (var i = 0; i < Math.min(count, 3); i++) { setTimeout(function() { var pop = document.createElement('div'); pop.className = 'laugh-pop'; pop.textContent = 'üòÇ'; pop.style.left = (20 + Math.random() * 60) + '%'; pop.style.top = (30 + Math.random() * 40) + '%'; document.body.appendChild(pop); setTimeout(function() { if (pop.parentNode) pop.remove(); }, 1000); }, i * 150); } }

// ============ SOUNDS DATABASE ============
var soundPairs = [
    {sound:'BOING',emoji:'ü¶ò',en:'Boing',es:'Boing'},{sound:'OINK',emoji:'üê∑',en:'Oink',es:'Oink'},
    {sound:'QUACK',emoji:'ü¶Ü',en:'Quack',es:'Cuac'},{sound:'MOO',emoji:'üêÑ',en:'Moo',es:'Muu'},
    {sound:'RIBBIT',emoji:'üê∏',en:'Ribbit',es:'Croac'},{sound:'BUZZ',emoji:'üêù',en:'Buzz',es:'Bzz'},
    {sound:'SPLAT',emoji:'üí¶',en:'Splat',es:'Plaf'},{sound:'HONK',emoji:'üöó',en:'Honk',es:'Claxon'},
    {sound:'BOOM',emoji:'üí•',en:'Boom',es:'Boom'},{sound:'POP',emoji:'üéà',en:'Pop',es:'Pop'},
    {sound:'WHOOSH',emoji:'üí®',en:'Whoosh',es:'Fuu'},{sound:'DING',emoji:'üîî',en:'Ding',es:'Din'},
    {sound:'TOOT',emoji:'üé∫',en:'Toot',es:'Tuut'},{sound:'BEEP',emoji:'ü§ñ',en:'Beep',es:'Bip'}
];

var coachMsgs = {
    start:{en:"Listen to these GOOFY sounds! üîäüòÇ",es:"¬°Escucha estos sonidos LOCOS! üîäüòÇ"},
    learn:[{en:"What a silly sound! üòÇ",es:"¬°Qu√© sonido tonto! üòÇ"},{en:"Remember this one! üß†",es:"¬°Recuerda este! üß†"}],
    recall:[{en:"Quick! What was that? ü§î",es:"¬°R√°pido! ¬øQu√© fue eso? ü§î"}],
    correct:[{en:"YES! You got it! üéâ",es:"¬°S√ç! ¬°Lo tienes! üéâ"},{en:"Great ears! üëÇ",es:"¬°Buen o√≠do! üëÇ"}],
    speed:[{en:"SPEED BONUS! +5! üî•",es:"¬°BONO VELOCIDAD! +5! üî•"}],
    wrong:[{en:"Tricky sound! üòÖ",es:"¬°Sonido dif√≠cil! üòÖ"}],
    timeout:{en:"Too slow! ‚è∞",es:"¬°Muy lento! ‚è∞"},
    perfect:{en:"PERFECT ROUND! ‚≠ê Star earned!",es:"¬°RONDA PERFECTA! ‚≠ê ¬°Estrella ganada!"},
    notPerfect:{en:"Keep practicing for that ‚≠ê!",es:"¬°Sigue practicando para esa ‚≠ê!"}
};

// ============ GAME STATE ============
var score = 0, correctCount = 0, totalCount = 0;
var soundsToLearn = [], currentIdx = 0, recallIdx = 0;
var learnTimer = null, recallTimer = null, recallStart = 0;

var tierSettings = [
    {sounds:2,learnTime:3500,recallTime:4500},{sounds:2,learnTime:3200,recallTime:4000},
    {sounds:3,learnTime:3000,recallTime:3700},{sounds:3,learnTime:2800,recallTime:3500},
    {sounds:3,learnTime:2600,recallTime:3200},{sounds:4,learnTime:2600,recallTime:3000},
    {sounds:4,learnTime:2400,recallTime:2800},{sounds:4,learnTime:2400,recallTime:2600},
    {sounds:5,learnTime:2200,recallTime:2400},{sounds:5,learnTime:2000,recallTime:2200}
];

var introScreen = document.getElementById('introScreen');
var learnScreen = document.getElementById('learnScreen');
var recallScreen = document.getElementById('recallScreen');
var gameoverScreen = document.getElementById('gameoverScreen');
var scoreDisplay = document.getElementById('scoreDisplay');
var laughCounter = document.getElementById('laughCounter');
var coachBubble = document.getElementById('coachBubble');
var coachText = document.getElementById('coachText');
var tierUpOverlay = document.getElementById('tierUpOverlay');

function shuffle(a){ var arr=a.slice(); for(var i=arr.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=arr[i];arr[i]=arr[j];arr[j]=t; } return arr; }
function showScreen(s){ [introScreen,learnScreen,recallScreen,gameoverScreen].forEach(function(x){x.classList.add('hidden');}); s.classList.remove('hidden'); }
function updateScore(){ document.getElementById('currentScore').textContent=score; }
function showCoach(msg,dur){ coachText.innerHTML=msg; coachBubble.classList.remove('hidden'); setTimeout(function(){coachBubble.classList.add('hidden');},dur||2500); }
function showSpeedBonus(){var b=document.createElement('div');b.className='speed-bonus';b.textContent='+5 SPEED!';document.body.appendChild(b);setTimeout(function(){if(b.parentNode)b.remove();},1000);}
function confetti(){var c=document.getElementById('confettiContainer');for(var i=0;i<50;i++){setTimeout(function(){var p=document.createElement('div');p.className='confetti';p.style.left=Math.random()*100+'vw';p.style.background=['#F39C12','#FF69B4','#FFD700','#00D9A5'][Math.floor(Math.random()*4)];p.style.animationDuration=(2+Math.random()*2)+'s';c.appendChild(p);setTimeout(function(){if(p.parentNode)p.remove();},4000);},i*40);}}

function startGame(){
    initAudio();
    var data = getMasteryData();
    score=0;correctCount=0;totalCount=0;circuitLaughs=0;
    updateScore();updateLaughDisplay();updateMasteryDisplay();
    scoreDisplay.classList.remove('hidden');
    laughCounter.classList.remove('hidden');
    showCoach(lang==='es'?coachMsgs.start.es:coachMsgs.start.en,2500);
    setTimeout(startRound,2000);
}

function startRound(){
    var data = getMasteryData();
    var s=tierSettings[data.currentTier-1];
    currentIdx=0;
    soundsToLearn=shuffle(soundPairs).slice(0,s.sounds);
    totalCount=soundsToLearn.length;
    showScreen(learnScreen);
    showNextLearn();
}

function showNextLearn(){
    var data = getMasteryData();
    if(currentIdx>=soundsToLearn.length){ setTimeout(startRecall,500); return; }
    var s=tierSettings[data.currentTier-1];
    var sound=soundsToLearn[currentIdx];
    addLaughs(1);
    document.getElementById('learnEmoji').textContent=sound.emoji;
    document.getElementById('learnLabel').textContent=lang==='es'?sound.es:sound.en;
    document.getElementById('pairCounter').textContent=(lang==='es'?'Sonido ':'Sound ')+(currentIdx+1)+' / '+soundsToLearn.length;
    var msg=coachMsgs.learn[Math.floor(Math.random()*coachMsgs.learn.length)];
    showCoach(lang==='es'?msg.es:msg.en,s.learnTime-500);
    setTimeout(function(){playSound(sound.sound);},300);
    var fill=document.getElementById('timerFill');
    fill.style.width='100%';
    var start=Date.now();
    clearInterval(learnTimer);
    learnTimer=setInterval(function(){
        var pct=Math.max(0,100-((Date.now()-start)/s.learnTime*100));
        fill.style.width=pct+'%';
        if(pct<=0){ clearInterval(learnTimer); currentIdx++; showNextLearn(); }
    },50);
}

document.getElementById('soundCard').onclick=function(){
    if(currentIdx<soundsToLearn.length) playSound(soundsToLearn[currentIdx].sound);
};

function startRecall(){
    recallIdx=0;
    soundsToLearn=shuffle(soundsToLearn);
    var msg=coachMsgs.recall[0];
    showCoach(lang==='es'?msg.es:msg.en,1500);
    setTimeout(showNextRecall,1500);
}

function showNextRecall(){
    var data = getMasteryData();
    if(recallIdx>=soundsToLearn.length){ endRound(); return; }
    showScreen(recallScreen);
    var s=tierSettings[data.currentTier-1];
    var correct=soundsToLearn[recallIdx];
    document.getElementById('recallPrompt').textContent='üîä';
    playSound(correct.sound);
    document.getElementById('recallPrompt').onclick=function(){playSound(correct.sound);};
    var grid=document.getElementById('answersGrid');
    grid.innerHTML='';
    var wrongs=shuffle(soundPairs.filter(function(p){return p.sound!==correct.sound;})).slice(0,3);
    var opts=shuffle([correct].concat(wrongs));
    opts.forEach(function(opt){
        var btn=document.createElement('div');
        btn.className='answer-btn';
        btn.innerHTML='<span class="label">'+(lang==='es'?opt.es:opt.en)+'</span>';
        btn.dataset.correct=opt.sound===correct.sound?'1':'0';
        btn.onclick=function(){handleAnswer(btn,correct);};
        grid.appendChild(btn);
    });
    recallStart=Date.now();
    var fill=document.getElementById('recallTimerFill');
    fill.style.width='100%';
    fill.classList.remove('danger');
    clearInterval(recallTimer);
    recallTimer=setInterval(function(){
        var pct=Math.max(0,100-((Date.now()-recallStart)/s.recallTime*100));
        fill.style.width=pct+'%';
        if(pct<30)fill.classList.add('danger');
        if(pct<=0){ clearInterval(recallTimer); handleTimeout(correct); }
    },50);
}

function handleAnswer(btn,correct){
    var data = getMasteryData();
    clearInterval(recallTimer);
    document.querySelectorAll('.answer-btn').forEach(function(b){b.onclick=null;});
    var isCorrect=btn.dataset.correct==='1';
    var time=Date.now()-recallStart;
    var s=tierSettings[data.currentTier-1];
    if(isCorrect){
        btn.classList.add('correct');
        correctCount++;
        addLaughs(1);
        var pts=10;
        if(time<s.recallTime*0.4){pts+=5;addLaughs(2);showSpeedBonus();var m=coachMsgs.speed[0];showCoach(lang==='es'?m.es:m.en,1500);}
        else{var m=coachMsgs.correct[Math.floor(Math.random()*coachMsgs.correct.length)];showCoach(lang==='es'?m.es:m.en,1500);}
        score+=pts;
        updateScore();
    }else{
        btn.classList.add('wrong');
        document.querySelectorAll('.answer-btn').forEach(function(b){if(b.dataset.correct==='1')b.classList.add('correct');});
        var m=coachMsgs.wrong[0];
        showCoach(lang==='es'?m.es:m.en,1500);
    }
    recallIdx++;
    setTimeout(showNextRecall,1500);
}

function handleTimeout(correct){
    document.querySelectorAll('.answer-btn').forEach(function(b){b.onclick=null;if(b.dataset.correct==='1')b.classList.add('correct');});
    var m=coachMsgs.timeout;
    showCoach(lang==='es'?m.es:m.en,1500);
    recallIdx++;
    setTimeout(showNextRecall,1500);
}

function endRound(){
    var data = getMasteryData();
    var isPerfect = correctCount === totalCount;
    addLaughs(3);
    showScreen(gameoverScreen);
    scoreDisplay.classList.add('hidden');
    laughCounter.classList.add('hidden');
    document.getElementById('finalScore').textContent=score;
    document.getElementById('gameStats').textContent=(lang==='es'?'üòÇ Momentos de Risa: ':'üòÇ Laugh Moments: ')+circuitLaughs;
    document.getElementById('gameoverTier').textContent=data.currentTier;
    if(isPerfect){
        confetti();
        var result=addStar();
        data=getMasteryData();
        if(result.tierUp){
            addLaughs(5);
            document.getElementById('gameoverStars').textContent='‚≠ê‚≠ê';
            document.getElementById('gameoverMasteryText').innerHTML=lang==='es'?'<strong>¬°PERFECTO!</strong> ¬°Desbloqueaste Tier '+result.newTier+'!':'<strong>PERFECT!</strong> You unlocked Tier '+result.newTier+'!';
            setTimeout(function(){
                tierUpOverlay.classList.remove('hidden');
                document.getElementById('tierUpSubtitle').textContent=lang==='es'?'¬°Desbloqueaste Tier '+result.newTier+'!':"You've unlocked Tier "+result.newTier+'!';
                confetti();
            },1000);
        }else{
            document.getElementById('gameoverStars').textContent=data.stars>=1?'‚≠ê‚òÜ':'‚òÜ‚òÜ';
            document.getElementById('gameoverMasteryText').innerHTML=lang==='es'?'<strong>¬°PERFECTO!</strong> '+data.stars+'/2 estrellas para Tier '+(data.currentTier+1):'<strong>PERFECT!</strong> '+data.stars+'/2 stars toward Tier '+(data.currentTier+1);
        }
        showCoach(lang==='es'?coachMsgs.perfect.es:coachMsgs.perfect.en,3000);
    }else{
        document.getElementById('gameoverStars').textContent=data.stars>=1?'‚≠ê‚òÜ':'‚òÜ‚òÜ';
        document.getElementById('gameoverMasteryText').innerHTML=lang==='es'?'Necesitas <strong>100% correcto</strong> para ganar ‚≠ê':'Need <strong>100% correct</strong> to earn ‚≠ê';
        showCoach(lang==='es'?coachMsgs.notPerfect.es:coachMsgs.notPerfect.en,3000);
    }
    document.getElementById('gameoverEmoji').textContent=isPerfect?'üåü':'üîä';
}

document.getElementById('testSoundBtn').onclick=function(){initAudio();playSound('BOING');};
document.getElementById('startBtn').onclick=function(){updateMasteryDisplay();startGame();};
document.getElementById('retryBtn').onclick=function(){updateMasteryDisplay();startGame();};
document.getElementById('tierUpBtn').onclick=function(){tierUpOverlay.classList.add('hidden');updateMasteryDisplay();};
document.getElementById('homeBtn').onclick=function(){window.location.href='laugh-hub.html';};
document.getElementById('backBtn').onclick=function(){if(confirm(lang==='es'?'¬øSalir?':'Exit?')){clearInterval(learnTimer);clearInterval(recallTimer);window.location.href='laugh-hub.html';}};

updateMasteryDisplay();
})();
</script>
</body>
</html>
