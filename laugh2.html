<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Laughleticoâ„¢ - LAUGH 3: LOL Lights</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;overflow-y:scroll}
:root{--purple:#6B21A8;--purple-dark:#581C87;--purple-light:#9333EA;--gold:#FFD700;--gold-dark:#CC9900;--bg-dark:#0a0a0f;--bg-card:#111118;--text-light:#FFFFFF;--text-muted:#8892a0;--success:#00D9A5;--danger:#FF4757;--teal:#00D9A5;--tile1:#FF6B9D;--tile2:#00D9A5;--tile3:#FFD700;--tile4:#9333EA;--tile5:#00BCD4;--tile6:#FF6B00;--tile7:#E91E63;--tile8:#4CAF50;--tile9:#03A9F4}
body{font-family:'Outfit',sans-serif;background:var(--bg-dark);color:var(--text-light);min-height:100%}
body[data-lang="es"] .lang-en{display:none!important}
body[data-lang="en"] .lang-es{display:none!important}
.court-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center top,rgba(107,33,168,0.2) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(255,215,0,0.1) 0%,transparent 40%),var(--bg-dark);z-index:-1}
.top-controls{position:fixed;top:0;left:0;right:0;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;z-index:100;background:linear-gradient(180deg,rgba(10,10,15,0.95) 0%,transparent 100%)}
.back-link{padding:8px 16px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:20px;color:var(--text-muted);text-decoration:none;font-weight:600;font-size:0.85rem;cursor:pointer;transition:all 0.3s}
.back-link:hover{border-color:var(--gold);color:var(--gold)}
.lang-toggle{display:flex;gap:6px}
.lang-btn{padding:6px 12px;border:2px solid var(--gold);background:transparent;color:var(--gold);border-radius:15px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer;transition:all 0.3s}
.lang-btn.active{background:var(--gold);color:var(--bg-dark)}
.screen{display:none;flex-direction:column;align-items:center;min-height:100vh;width:100%;padding:80px 20px 40px 20px;text-align:center}
.screen.active{display:flex}
.main-logo{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:3px;margin-bottom:5px}
.main-logo .laugh{color:var(--gold)}
.main-logo .letico{color:var(--text-light)}
.main-subtitle{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:4px;color:var(--purple-light);margin-bottom:5px}
.main-icon{font-size:3rem;margin:12px 0}
.mastery-badge{background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);padding:10px 20px;border-radius:25px;font-weight:800;font-size:0.85rem;margin-bottom:15px;display:inline-block}
.game-description{max-width:340px;padding:15px;background:rgba(107,33,168,0.1);border-left:4px solid var(--purple);border-radius:0 15px 15px 0;margin-bottom:20px;text-align:left}
.game-description p{font-size:0.9rem;color:var(--text-muted);line-height:1.5;margin-bottom:8px}
.game-description strong{color:var(--text-light)}

/* Tier Selection */
.tier-section{width:100%;max-width:380px;margin-bottom:15px}
.section-label{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:10px}
.tier-grid{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow-y:auto;padding-right:5px}
.tier-grid::-webkit-scrollbar{width:4px}
.tier-grid::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:2px}
.tier-grid::-webkit-scrollbar-thumb{background:var(--purple);border-radius:2px}
.tier-btn{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg-card);border:2px solid transparent;border-radius:10px;cursor:pointer;transition:all 0.3s ease;text-align:left}
.tier-btn:hover:not(.locked){border-color:var(--gold);transform:translateX(5px)}
.tier-btn.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.tier-btn.locked{opacity:0.4;cursor:not-allowed}
.tier-btn.mastered{border-color:var(--success);background:rgba(0,217,165,0.08)}
.tier-btn.practice{border-color:var(--purple);background:rgba(107,33,168,0.15)}
.tier-icon{font-size:1.3rem;min-width:35px;text-align:center}
.tier-info{flex:1}
.tier-name{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;color:var(--text-light)}
.tier-desc{font-size:0.65rem;color:var(--text-muted)}
.tier-status{font-size:0.6rem;padding:2px 6px;border-radius:6px;font-weight:700}
.tier-status.mastered{background:var(--success);color:var(--bg-dark)}
.tier-status.locked{background:rgba(255,255,255,0.1);color:var(--text-muted)}
.tier-status.current{background:var(--gold);color:var(--bg-dark)}
.tier-status.practice{background:var(--purple);color:var(--text-light)}

/* Speed Selection */
.speed-section{width:100%;max-width:380px;margin-bottom:15px}
.speed-grid{display:flex;gap:8px;justify-content:center}
.speed-btn{padding:10px 14px;background:var(--bg-card);border:2px solid transparent;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:85px;transition:all 0.3s}
.speed-btn:hover{border-color:var(--gold)}
.speed-btn.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.speed-icon{font-size:1.3rem}
.speed-label{font-size:0.75rem;font-weight:700;color:var(--text-light)}
.speed-bpm{font-size:0.65rem;color:var(--text-muted)}

.start-btn{padding:16px 45px;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:4px;background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;box-shadow:0 5px 25px rgba(255,215,0,0.4);margin-top:10px;transition:all 0.3s}
.start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(255,215,0,0.5)}
.stats-summary{margin-top:15px;padding:12px 20px;background:var(--bg-card);border-radius:12px;display:flex;gap:25px}
.stat-item{text-align:center}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--gold)}
.stat-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}

/* Laugh Counter */
.laugh-counter{position:fixed;top:70px;right:20px;background:rgba(0,0,0,0.8);border:2px solid var(--gold);border-radius:20px;padding:8px 14px;display:flex;align-items:center;gap:8px;z-index:90}
.laugh-counter-icon{font-size:1.2rem}
.laugh-counter-value{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--gold)}

/* Countdown */
#countdownScreen{justify-content:center}
.countdown-tier{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:10px}
.countdown-number{font-family:'Bebas Neue',sans-serif;font-size:7rem;color:var(--gold);text-shadow:0 0 50px rgba(255,215,0,0.5)}
.countdown-text{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:5px;color:var(--text-muted)}

/* Game Screen */
#gameScreen{justify-content:flex-start;padding-top:70px}
.scoreboard{width:100%;max-width:380px;background:linear-gradient(180deg,#0a0a0a 0%,#050505 100%);border:3px solid #222;border-radius:12px;padding:12px 18px;margin-bottom:12px}
.scoreboard-main{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.scoreboard-tier{font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px;color:var(--text-muted);padding:4px 10px;background:rgba(255,255,255,0.05);border-radius:8px}
.scoreboard-score{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,0.4)}
.sequence-counter{display:flex;justify-content:center;gap:15px;margin-bottom:8px}
.seq-stat{text-align:center}
.seq-stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold)}
.seq-stat-label{font-size:0.65rem;color:var(--text-muted)}
.half-display{display:flex;justify-content:center;gap:10px;margin-bottom:8px}
.half-indicator{padding:6px 16px;border-radius:15px;font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px}
.half-indicator.active{background:var(--purple);color:var(--text-light)}
.half-indicator.inactive{background:rgba(255,255,255,0.05);color:var(--text-muted)}
.half-indicator.completed{background:var(--success);color:var(--bg-dark)}
.accuracy-display{text-align:center}
.accuracy-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:3px}
.accuracy-value{font-family:'Bebas Neue',sans-serif;font-size:1.6rem}
.accuracy-value.perfect{color:var(--success)}
.accuracy-value.good{color:var(--gold)}
.accuracy-value.miss{color:var(--danger)}

.message-area{height:50px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.game-message{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;color:var(--text-light)}
.game-message.success{color:var(--success)}
.game-message.error{color:var(--danger)}
.game-message.watch{color:var(--gold)}

/* Tile Grid */
.tile-grid{width:min(90vw,340px);height:min(90vw,340px);display:grid;gap:8px;margin-bottom:15px}
.tile-grid.grid-2x2{grid-template-columns:repeat(2,1fr)}
.tile-grid.grid-3x3{grid-template-columns:repeat(3,1fr)}
.tile{background:var(--bg-card);border:3px solid #333;border-radius:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:2.5rem;transition:all 0.15s ease;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
.tile:active:not(.disabled){transform:scale(0.95)}
.tile.disabled{pointer-events:none;opacity:0.7}

/* Tile colors - fun laughing colors */
.tile[data-tile="0"]{border-color:#FF6B9D}.tile[data-tile="0"].lit{background:#FF6B9D;box-shadow:0 0 30px #FF6B9D}
.tile[data-tile="1"]{border-color:#00D9A5}.tile[data-tile="1"].lit{background:#00D9A5;box-shadow:0 0 30px #00D9A5}
.tile[data-tile="2"]{border-color:#FFD700}.tile[data-tile="2"].lit{background:#FFD700;box-shadow:0 0 30px #FFD700}
.tile[data-tile="3"]{border-color:#9333EA}.tile[data-tile="3"].lit{background:#9333EA;box-shadow:0 0 30px #9333EA}
.tile[data-tile="4"]{border-color:#00BCD4}.tile[data-tile="4"].lit{background:#00BCD4;box-shadow:0 0 30px #00BCD4}
.tile[data-tile="5"]{border-color:#FF6B00}.tile[data-tile="5"].lit{background:#FF6B00;box-shadow:0 0 30px #FF6B00}
.tile[data-tile="6"]{border-color:#E91E63}.tile[data-tile="6"].lit{background:#E91E63;box-shadow:0 0 30px #E91E63}
.tile[data-tile="7"]{border-color:#4CAF50}.tile[data-tile="7"].lit{background:#4CAF50;box-shadow:0 0 30px #4CAF50}
.tile[data-tile="8"]{border-color:#03A9F4}.tile[data-tile="8"].lit{background:#03A9F4;box-shadow:0 0 30px #03A9F4}

.tile.correct{background:var(--success)!important;border-color:var(--success)!important}
.tile.wrong{background:var(--danger)!important;border-color:var(--danger)!important;animation:shake 0.3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

/* Halftime */
#halftimeScreen{justify-content:center}

/* Results */
#resultScreen{justify-content:center}
.result-icon{font-size:4.5rem;margin-bottom:12px}
.result-title{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:4px;margin-bottom:8px}
.result-title.success{color:var(--success)}
.result-title.retry{color:var(--gold)}
.result-message{font-size:1rem;color:var(--text-muted);margin-bottom:20px;max-width:300px;line-height:1.5}
.result-stats{display:flex;gap:20px;margin-bottom:20px}
.result-stat{text-align:center}
.result-stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--text-light)}
.result-stat-label{font-size:0.7rem;color:var(--text-muted)}
.result-accuracy{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;margin-bottom:8px}
.result-accuracy.perfect{color:var(--success)}
.result-accuracy.miss{color:var(--danger)}
.next-level-preview{background:var(--bg-card);border:2px solid var(--success);border-radius:12px;padding:16px;margin-bottom:20px;max-width:300px}
.next-level-label{font-size:0.75rem;color:var(--success);margin-bottom:6px}
.next-level-name{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--text-light)}
.squad-welcome{background:linear-gradient(135deg,var(--gold) 0%,var(--purple) 100%);border-radius:12px;padding:16px;margin-bottom:20px;max-width:300px}
.squad-welcome-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--bg-dark);margin-bottom:5px}
.squad-welcome-text{font-size:0.85rem;color:var(--bg-dark)}
.continue-timer{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--text-muted);margin-bottom:18px}
.continue-timer span{color:var(--gold);font-size:1.4rem}
.action-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:260px}
.continue-btn{padding:14px 35px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;transition:all 0.3s}
.continue-btn:hover{transform:scale(1.05)}
.retry-btn{padding:14px 35px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;transition:all 0.3s}
.retry-btn:hover{transform:scale(1.05)}
.home-btn{padding:12px 35px;font-family:'Outfit',sans-serif;font-size:0.9rem;font-weight:700;background:transparent;color:var(--text-muted);border:2px solid rgba(255,255,255,0.15);border-radius:50px;cursor:pointer;transition:all 0.3s}
.home-btn:hover{border-color:var(--gold);color:var(--gold)}

.speed-badge{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);border:2px solid var(--purple);border-radius:20px;padding:6px 14px;display:none;align-items:center;gap:6px;z-index:100}
.speed-badge.visible{display:flex}
.speed-badge-text{font-size:0.65rem;color:var(--gold);font-weight:700;letter-spacing:1px}

/* Coach Bubble */
.coach-bubble{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:2px solid var(--teal);border-radius:20px;padding:12px 20px;display:none;align-items:center;gap:10px;z-index:150;max-width:320px;box-shadow:0 10px 40px rgba(0,217,165,0.3);animation:coachIn 0.3s ease}
.coach-bubble.visible{display:flex}
.coach-bubble-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0}
.coach-bubble-text{font-size:0.9rem;color:var(--text-light);line-height:1.4}
.coach-bubble-text strong{color:var(--teal)}
@keyframes coachIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* Chat FAB */
.chat-fab{position:fixed;bottom:30px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--purple-dark));border:3px solid var(--gold);cursor:pointer;box-shadow:0 6px 25px rgba(107,33,168,0.5);z-index:200;display:flex;align-items:center;justify-content:center;transition:all 0.3s;text-decoration:none}
.chat-fab:hover{transform:scale(1.1)}
.chat-fab img{width:38px;height:38px;border-radius:50%}

@media(max-width:380px){.main-logo{font-size:2rem}.tile-grid{width:min(88vw,300px);height:min(88vw,300px)}.tile{font-size:2rem}.chat-fab{width:50px;height:50px;bottom:20px;right:15px}.chat-fab img{width:32px;height:32px}.coach-bubble{max-width:280px;bottom:90px}.laugh-counter{top:65px;right:15px;padding:6px 10px}}
</style>
</head>
<body data-lang="en">
<div class="court-bg"></div>
<div class="top-controls">
<a class="back-link" href="laugh-hub.html"><span class="lang-en">â† Circuits</span><span class="lang-es">â† Circuitos</span></a>
<div class="lang-toggle">
<button class="lang-btn active" onclick="setLang('en')">EN</button>
<button class="lang-btn" onclick="setLang('es')">ES</button>
</div>
</div>

<!-- Laugh Counter -->
<div class="laugh-counter" id="laughCounter" style="display:none">
<span class="laugh-counter-icon">ğŸ˜‚</span>
<span class="laugh-counter-value" id="laughCounterValue">0</span>
</div>

<!-- COACH BUBBLE -->
<div class="coach-bubble" id="coachBubble">
<img src="go_chat.png" alt="Coach" class="coach-bubble-avatar">
<div class="coach-bubble-text" id="coachText"></div>
</div>

<!-- CHAT FAB -->
<a class="chat-fab" href="index.html" title="Chat with Coach GoTrotter AI">
<img src="go_chat.png" alt="GoTrotter AI">
</a>

<!-- WELCOME SCREEN -->
<div class="screen active" id="welcomeScreen">
<div class="main-logo"><span class="laugh">LAUGH</span><span class="letico">LETICO</span>â„¢</div>
<div class="main-subtitle"><span class="lang-en">LAUGH 3 â€¢ LOL LIGHTS</span><span class="lang-es">RISA 3 â€¢ LUCES LOL</span></div>
<div class="main-icon">ğŸ’¡</div>
<div class="mastery-badge"><span class="lang-en">ğŸ¯ 100% ACCURACY TO ADVANCE</span><span class="lang-es">ğŸ¯ 100% PARA AVANZAR</span></div>

<div class="game-description">
<p><span class="lang-en"><strong>Watch the laughing lights!</strong> Repeat the sequence. <strong>It grows longer each time!</strong></span><span class="lang-es"><strong>Â¡Mira las luces de risa!</strong> Repite la secuencia. <strong>Â¡Crece cada vez!</strong></span></p>
<p><span class="lang-en">How many giggles can you remember? ğŸ˜‚</span><span class="lang-es">Â¿CuÃ¡ntas risas puedes recordar? ğŸ˜‚</span></p>
</div>

<div class="tier-section">
<div class="section-label"><span class="lang-en">SELECT YOUR TIER</span><span class="lang-es">SELECCIONA TU NIVEL</span></div>
<div class="tier-grid" id="tierGrid"></div>
</div>

<div class="speed-section">
<div class="section-label"><span class="lang-en">SPEED</span><span class="lang-es">VELOCIDAD</span></div>
<div class="speed-grid">
<div class="speed-btn" data-speed="slow" onclick="selectSpeed('slow')"><span class="speed-icon">ğŸ¢</span><span class="speed-label"><span class="lang-en">Gentle</span><span class="lang-es">Suave</span></span><span class="speed-bpm">600ms</span></div>
<div class="speed-btn selected" data-speed="normal" onclick="selectSpeed('normal')"><span class="speed-icon">ğŸ˜Š</span><span class="speed-label"><span class="lang-en">Happy</span><span class="lang-es">Feliz</span></span><span class="speed-bpm">450ms</span></div>
<div class="speed-btn" data-speed="fast" onclick="selectSpeed('fast')"><span class="speed-icon">ğŸ”¥</span><span class="speed-label"><span class="lang-en">Hyper</span><span class="lang-es">Hiper</span></span><span class="speed-bpm">300ms</span></div>
</div>
</div>

<button class="start-btn" onclick="startGame()"><span class="lang-en">START LAUGHING!</span><span class="lang-es">Â¡A REÃR!</span></button>

<div class="stats-summary">
<div class="stat-item"><div class="stat-value" id="currentTier">1</div><div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div></div>
<div class="stat-item"><div class="stat-value" id="perfectGames">0</div><div class="stat-label"><span class="lang-en">Perfect</span><span class="lang-es">Perfectos</span></div></div>
<div class="stat-item"><div class="stat-value" id="bestStreak">0</div><div class="stat-label"><span class="lang-en">Longest</span><span class="lang-es">MÃ¡ximo</span></div></div>
</div>
</div>

<!-- COUNTDOWN SCREEN -->
<div class="screen" id="countdownScreen">
<div class="countdown-tier" id="countdownTier">TIER 1</div>
<div class="main-icon">ğŸ’¡</div>
<div class="countdown-number" id="countdownNum">3</div>
<div class="countdown-text"><span class="lang-en">GET READY TO LAUGH!</span><span class="lang-es">Â¡PREPÃRATE PARA REÃR!</span></div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="gameScreen">
<div class="scoreboard">
<div class="scoreboard-main">
<div class="scoreboard-tier" id="gameTier">TIER 1</div>
<div class="scoreboard-score" id="scoreDisplay">0</div>
</div>
<div class="sequence-counter">
<div class="seq-stat"><div class="seq-stat-value" id="seqLength">1</div><div class="seq-stat-label"><span class="lang-en">Laughs</span><span class="lang-es">Risas</span></div></div>
<div class="seq-stat"><div class="seq-stat-value" id="seqTarget">4</div><div class="seq-stat-label"><span class="lang-en">Target</span><span class="lang-es">Meta</span></div></div>
</div>
<div class="half-display">
<div class="half-indicator active" id="half1"><span class="lang-en">1ST HALF</span><span class="lang-es">1RA MITAD</span></div>
<div class="half-indicator inactive" id="half2"><span class="lang-en">2ND HALF</span><span class="lang-es">2DA MITAD</span></div>
</div>
<div class="accuracy-display">
<div class="accuracy-label"><span class="lang-en">ACCURACY</span><span class="lang-es">PRECISIÃ“N</span></div>
<div class="accuracy-value perfect" id="accuracyDisplay">100%</div>
</div>
</div>

<div class="message-area"><div class="game-message" id="gameMessage"></div></div>

<div class="tile-grid grid-2x2" id="tileGrid"></div>
</div>

<!-- HALFTIME SCREEN -->
<div class="screen" id="halftimeScreen">
<div class="main-icon">â¸ï¸</div>
<div class="main-logo" style="font-size:2rem"><span class="lang-en">HALFTIME</span><span class="lang-es">MEDIO TIEMPO</span></div>
<div class="result-stats">
<div class="result-stat"><div class="result-stat-value" id="htScore">0</div><div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="htAccuracy">100%</div><div class="result-stat-label"><span class="lang-en">Accuracy</span><span class="lang-es">PrecisiÃ³n</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="htLongest">0</div><div class="result-stat-label"><span class="lang-en">Longest</span><span class="lang-es">MÃ¡ximo</span></div></div>
</div>
<p style="color:var(--text-muted);margin-bottom:20px;max-width:280px;font-size:0.95rem">
<span class="lang-en">Keep 100% in 2nd half to advance!</span>
<span class="lang-es">Â¡MantÃ©n 100% en la 2da mitad!</span>
</p>
<button class="retry-btn" onclick="continueToSecondHalf()"><span class="lang-en">2ND HALF â†’</span><span class="lang-es">2DA MITAD â†’</span></button>
</div>

<!-- RESULT SCREEN -->
<div class="screen" id="resultScreen">
<div class="result-icon" id="resultIcon">ğŸ†</div>
<div class="result-title" id="resultTitle">PERFECT!</div>
<div class="result-accuracy" id="resultAccuracy">100%</div>
<div class="result-message" id="resultMessage"></div>
<div class="result-stats">
<div class="result-stat"><div class="result-stat-value" id="finalScore">0</div><div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="finalLongest">0</div><div class="result-stat-label"><span class="lang-en">Longest</span><span class="lang-es">MÃ¡ximo</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="finalCorrect">0/0</div><div class="result-stat-label"><span class="lang-en">Correct</span><span class="lang-es">Correctos</span></div></div>
</div>
<div class="squad-welcome" id="squadWelcome" style="display:none">
<div class="squad-welcome-title">ğŸ˜‚ <span class="lang-en">LOL LIGHTS MASTER!</span><span class="lang-es">Â¡MAESTRO DE LUCES LOL!</span></div>
<div class="squad-welcome-text"><span class="lang-en">You passed practice! Keep laughing!</span><span class="lang-es">Â¡Pasaste la prÃ¡ctica! Â¡Sigue riendo!</span></div>
</div>
<div class="next-level-preview" id="nextLevelBox" style="display:none">
<div class="next-level-label"><span class="lang-en">NEXT TIER</span><span class="lang-es">SIGUIENTE NIVEL</span></div>
<div class="next-level-name" id="nextLevelName">TIER 2</div>
</div>
<div class="continue-timer" id="continueTimer"><span class="lang-en">Continuing in <span id="timerCount">5</span>...</span><span class="lang-es">Continuando en <span id="timerCountEs">5</span>...</span></div>
<div class="action-buttons">
<button class="continue-btn" id="advanceBtn" onclick="advanceNow()" style="display:none"><span class="lang-en">ADVANCE NOW</span><span class="lang-es">AVANZAR</span></button>
<button class="retry-btn" id="retryBtn" onclick="retryNow()" style="display:none"><span class="lang-en">RETRY NOW</span><span class="lang-es">REINTENTAR</span></button>
<button class="home-btn" onclick="window.location.href='laugh-hub.html'"><span class="lang-en">â† Circuits</span><span class="lang-es">â† Circuitos</span></button>
</div>
</div>

<div class="speed-badge" id="speedBadge"><span class="speed-badge-text" id="speedBadgeText">HAPPY â€¢ 450ms</span></div>

<script>
// Language
var currentLang = localStorage.getItem('lw-lang') || 'en';
function setLang(l) {
    currentLang = l;
    localStorage.setItem('lw-lang', l);
    document.body.setAttribute('data-lang', l);
    document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.toggle('active', b.textContent.trim() === l.toUpperCase());
    });
}
document.body.setAttribute('data-lang', currentLang);

// Laughing emoji tiles
var tileEmojis = ['ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜†', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ˜„', 'ğŸ¥³', 'ğŸ˜'];

// Audio - pleasant tones
var audioCtx = null;
var tileFreqs = [261.63, 329.63, 392.00, 493.88, 523.25, 587.33, 659.25, 783.99, 880.00];
function playTone(tileIdx, dur) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = tileFreqs[tileIdx % tileFreqs.length];
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}
function playBeep(freq, dur) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

// ========== LAUGH MOMENTS TRACKING ==========
var circuitLaughs = 0;

function addLaughs(n) {
    circuitLaughs += n;
    
    var today = new Date().toDateString();
    var storedDate = localStorage.getItem('lw-laughs-date');
    
    if (storedDate !== today) {
        localStorage.setItem('lw-laughs-today', '0');
        localStorage.setItem('lw-laughs-date', today);
    }
    
    var todayLaughs = parseInt(localStorage.getItem('lw-laughs-today') || '0') + n;
    var weekLaughs = parseInt(localStorage.getItem('lw-laughs-week') || '0') + n;
    var totalLaughs = parseInt(localStorage.getItem('lw-laughs-total') || '0') + n;
    
    localStorage.setItem('lw-laughs-today', todayLaughs.toString());
    localStorage.setItem('lw-laughs-week', weekLaughs.toString());
    localStorage.setItem('lw-laughs-total', totalLaughs.toString());
    
    updateLaughCounter();
}

function updateLaughCounter() {
    var el = document.getElementById('laughCounterValue');
    if (el) el.textContent = circuitLaughs;
}

// ========== COACH GOTROTTER AI ==========
var coachTimer = null;
var coachMessages = {
    welcome: {en: "Let's light up those giggles! ğŸ’¡ğŸ˜‚", es: "Â¡Vamos a encender esas risas! ğŸ’¡ğŸ˜‚"},
    watch: {en: "Focus... watch the laughing lights!", es: "EnfÃ³cate... Â¡mira las luces de risa!"},
    yourTurn: {en: "Your turn! Tap the giggles!", es: "Â¡Tu turno! Â¡Toca las risas!"},
    growing: {en: "More laughs! Stay sharp! ğŸ˜‚ğŸ‘€", es: "Â¡MÃ¡s risas! Â¡Mantente alerta! ğŸ˜‚ğŸ‘€"},
    perfect: [
        {en: "Ha ha! Perfect! ğŸ˜‚", es: "Â¡Ja ja! Â¡Perfecto! ğŸ˜‚"},
        {en: "LOL! Nailed it! ğŸ’¡", es: "Â¡LOL! Â¡Clavado! ğŸ’¡"},
        {en: "Giggle genius! ğŸ§ ğŸ˜‚", es: "Â¡Genio de risas! ğŸ§ ğŸ˜‚"},
        {en: "You're on fire! ğŸ”¥", es: "Â¡EstÃ¡s en llamas! ğŸ”¥"},
        {en: "Amazing memory! ğŸ¯", es: "Â¡Memoria increÃ­ble! ğŸ¯"}
    ],
    targetReached: [
        {en: "TARGET REACHED! LOL! ğŸ†ğŸ˜‚", es: "Â¡META ALCANZADA! Â¡LOL! ğŸ†ğŸ˜‚"},
        {en: "You got all the giggles! ğŸ¯", es: "Â¡Conseguiste todas las risas! ğŸ¯"}
    ],
    mistake: [
        {en: "Oops! Laugh it off! ğŸ˜„", es: "Â¡Ups! Â¡RÃ­ete! ğŸ˜„"},
        {en: "Almost! Keep giggling!", es: "Â¡Casi! Â¡Sigue riendo!"},
        {en: "Ha! Try again! ğŸ˜‚", es: "Â¡Ja! Â¡Otra vez! ğŸ˜‚"},
        {en: "Stay focused on the laughs!", es: "Â¡MantÃ©n el enfoque en las risas!"}
    ],
    halftime: {en: "Great first half! More giggles coming! ğŸ˜‚ğŸ’ª", es: "Â¡Gran primera mitad! Â¡MÃ¡s risas vienen! ğŸ˜‚ğŸ’ª"},
    tierUp: {en: "TIER UP! Your giggle memory is growing! ğŸ†ğŸ˜‚", es: "Â¡SUBISTE! Â¡Tu memoria de risas crece! ğŸ†ğŸ˜‚"},
    perfectGame: {en: "PERFECT CIRCUIT! LOL Legend! ğŸ†ğŸ¤£", es: "Â¡CIRCUITO PERFECTO! Â¡Leyenda LOL! ğŸ†ğŸ¤£"},
    keepTrying: {en: "Good giggles! 100% unlocks more laughs! ğŸ˜Š", es: "Â¡Buenas risas! Â¡100% desbloquea mÃ¡s! ğŸ˜Š"},
    squadWelcome: {en: "LOL Lights Master! Keep those giggles coming! ğŸ˜‚ğŸ‰", es: "Â¡Maestro de Luces LOL! Â¡Sigue riendo! ğŸ˜‚ğŸ‰"}
};

function showCoach(msgKey, duration) {
    if (coachTimer) clearTimeout(coachTimer);
    var bubble = document.getElementById('coachBubble');
    var textEl = document.getElementById('coachText');
    var msg;
    
    if (Array.isArray(coachMessages[msgKey])) {
        var arr = coachMessages[msgKey];
        msg = arr[Math.floor(Math.random() * arr.length)];
    } else {
        msg = coachMessages[msgKey];
    }
    
    textEl.innerHTML = '<span class="lang-en">' + msg.en + '</span><span class="lang-es">' + msg.es + '</span>';
    bubble.classList.add('visible');
    
    if (duration) {
        coachTimer = setTimeout(function() {
            bubble.classList.remove('visible');
        }, duration);
    }
}

function hideCoach() {
    if (coachTimer) clearTimeout(coachTimer);
    document.getElementById('coachBubble').classList.remove('visible');
}

// Speeds
var speeds = {
    slow: {ms: 600, label: 'GENTLE â€¢ 600ms'},
    normal: {ms: 450, label: 'HAPPY â€¢ 450ms'},
    fast: {ms: 300, label: 'HYPER â€¢ 300ms'}
};

// 10 TIER SYSTEM
var tiers = {
    tier1: {name: 'TIER 1', icon: 'ğŸ˜Š', tiles: 4, targetSeq: 3, plays: 2, isPractice: true},
    tier2: {name: 'TIER 2', icon: 'ğŸ˜„', tiles: 4, targetSeq: 4, plays: 2, isPractice: true},
    tier3: {name: 'TIER 3', icon: 'ğŸ˜†', tiles: 4, targetSeq: 5, plays: 2, isPractice: false},
    tier4: {name: 'TIER 4', icon: 'ğŸ˜‚', tiles: 4, targetSeq: 6, plays: 3, isPractice: false},
    tier5: {name: 'TIER 5', icon: 'ğŸ¤£', tiles: 9, targetSeq: 6, plays: 3, isPractice: false},
    tier6: {name: 'TIER 6', icon: 'ğŸ˜œ', tiles: 9, targetSeq: 7, plays: 3, isPractice: false},
    tier7: {name: 'TIER 7', icon: 'ğŸ¤ª', tiles: 9, targetSeq: 8, plays: 3, isPractice: false},
    tier8: {name: 'TIER 8', icon: 'ğŸ¥³', tiles: 9, targetSeq: 9, plays: 4, isPractice: false},
    tier9: {name: 'TIER 9', icon: 'ğŸ†', tiles: 9, targetSeq: 10, plays: 4, isPractice: false},
    tier10: {name: 'MASTER 10', icon: 'ğŸ‘‘', tiles: 9, targetSeq: 12, plays: 4, isPractice: false}
};
var tierList = ['tier1', 'tier2', 'tier3', 'tier4', 'tier5', 'tier6', 'tier7', 'tier8', 'tier9', 'tier10'];

function getProgress() {
    try { return JSON.parse(localStorage.getItem('laughletico-laugh3-mastery')) || {unlockedTier: 0, perfect: {}, best: 0}; }
    catch (e) { return {unlockedTier: 0, perfect: {}, best: 0}; }
}
function saveProgress(p) { localStorage.setItem('laughletico-laugh3-mastery', JSON.stringify(p)); }

// State
var selTier = 'tier1', selSpeed = 'normal';
var currentHalf = 1, play = 1, score = 0;
var sequence = [], userIdx = 0;
var correct = 0, attempts = 0, longestSeq = 0;
var autoTimer = null, showing = false;
var tileCount = 4;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
    document.getElementById(id).classList.add('active');
}

function selectSpeed(s) {
    selSpeed = s;
    document.querySelectorAll('.speed-btn').forEach(function(b) {
        b.classList.toggle('selected', b.dataset.speed === s);
    });
}

// Render tiers
function renderTiers() {
    var grid = document.getElementById('tierGrid');
    grid.innerHTML = '';
    var prog = getProgress();
    var unlockedIdx = prog.unlockedTier || 0;
    
    tierList.forEach(function(id, idx) {
        var t = tiers[id];
        var unlocked = idx <= unlockedIdx;
        var mastered = idx < unlockedIdx;
        
        var btn = document.createElement('div');
        var classes = 'tier-btn';
        if (id === selTier) classes += ' selected';
        if (!unlocked) classes += ' locked';
        if (mastered) classes += ' mastered';
        if (t.isPractice && unlocked && !mastered) classes += ' practice';
        btn.className = classes;
        
        if (unlocked) {
            btn.onclick = function() {
                selTier = id;
                renderTiers();
            };
        }
        
        var statusHtml = '';
        if (mastered) {
            statusHtml = '<span class="tier-status mastered">âœ“</span>';
        } else if (!unlocked) {
            statusHtml = '<span class="tier-status locked">ğŸ”’</span>';
        } else if (t.isPractice) {
            statusHtml = '<span class="tier-status practice">' + (currentLang === 'es' ? 'PRÃCTICA' : 'PRACTICE') + '</span>';
        } else if (idx === unlockedIdx) {
            statusHtml = '<span class="tier-status current">' + (currentLang === 'es' ? 'ACTUAL' : 'CURRENT') + '</span>';
        }
        
        var gridType = t.tiles === 4 ? '2Ã—2' : '3Ã—3';
        btn.innerHTML = '<span class="tier-icon">' + t.icon + '</span>' +
            '<div class="tier-info"><div class="tier-name">' + t.name + '</div>' +
            '<div class="tier-desc">' + gridType + ' â€¢ ' + (currentLang === 'es' ? 'meta' : 'target') + ' ' + t.targetSeq + '</div></div>' + statusHtml;
        
        grid.appendChild(btn);
    });
    
    // Update stats
    var totalPerfect = 0;
    for (var k in prog.perfect) totalPerfect += prog.perfect[k];
    document.getElementById('currentTier').textContent = unlockedIdx + 1;
    document.getElementById('perfectGames').textContent = totalPerfect;
    document.getElementById('bestStreak').textContent = prog.best || 0;
    
    // Auto-select current tier
    selTier = tierList[Math.min(unlockedIdx, tierList.length - 1)];
}

function buildTileGrid() {
    var t = tiers[selTier];
    tileCount = t.tiles;
    var grid = document.getElementById('tileGrid');
    grid.innerHTML = '';
    grid.className = 'tile-grid ' + (tileCount === 4 ? 'grid-2x2' : 'grid-3x3');
    
    for (var i = 0; i < tileCount; i++) {
        var tile = document.createElement('div');
        tile.className = 'tile disabled';
        tile.setAttribute('data-tile', i);
        tile.textContent = tileEmojis[i];
        tile.onclick = (function(idx) { return function() { handleTileClick(idx); }; })(i);
        grid.appendChild(tile);
    }
    
    // +1 laugh for seeing the tile grid
    addLaughs(1);
}

function startGame() {
    currentHalf = 1; play = 1; score = 0; correct = 0; attempts = 0; longestSeq = 0;
    circuitLaughs = 0;
    updateLaughCounter();
    document.getElementById('laughCounter').style.display = 'flex';
    
    document.getElementById('speedBadgeText').textContent = speeds[selSpeed].label;
    document.getElementById('speedBadge').classList.add('visible');
    document.getElementById('countdownTier').textContent = tiers[selTier].name;
    document.getElementById('gameTier').textContent = tiers[selTier].name;
    document.getElementById('seqTarget').textContent = tiers[selTier].targetSeq;
    
    buildTileGrid();
    updateHalfDisplay();
    showScreen('countdownScreen');
    
    // Coach welcome + laugh for starting
    showCoach('welcome', 3000);
    addLaughs(1);
    
    countdown(3);
}

function countdown(n) {
    document.getElementById('countdownNum').textContent = n;
    if (n > 0) {
        playBeep(440, 0.1);
        setTimeout(function() { countdown(n - 1); }, 1000);
    } else {
        playBeep(880, 0.3);
        showScreen('gameScreen');
        startPlay();
    }
}

function updateHalfDisplay() {
    var h1 = document.getElementById('half1');
    var h2 = document.getElementById('half2');
    if (currentHalf === 1) {
        h1.className = 'half-indicator active';
        h2.className = 'half-indicator inactive';
    } else {
        h1.className = 'half-indicator completed';
        h2.className = 'half-indicator active';
    }
}

function updateAccuracy() {
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var el = document.getElementById('accuracyDisplay');
    el.textContent = pct + '%';
    el.className = 'accuracy-value ' + (pct === 100 ? 'perfect' : (pct >= 80 ? 'good' : 'miss'));
}

function updateScore() { document.getElementById('scoreDisplay').textContent = score; }

function setMsg(txt, type) {
    var el = document.getElementById('gameMessage');
    el.textContent = txt;
    el.className = 'game-message' + (type ? ' ' + type : '');
}

function startPlay() {
    sequence = [];
    userIdx = 0;
    addToSequence();
}

function addToSequence() {
    var newTile = Math.floor(Math.random() * tileCount);
    sequence.push(newTile);
    
    document.getElementById('seqLength').textContent = sequence.length;
    
    // Coach growing message + laugh
    if (sequence.length > 2) {
        showCoach('growing', 2000);
        addLaughs(1);
    }
    
    showSequence();
}

function showSequence() {
    showing = true;
    setTilesDisabled(true);
    setMsg(currentLang === 'es' ? 'Â¡Mira las risas!' : 'Watch the laughs!', 'watch');
    
    if (sequence.length <= 2) {
        showCoach('watch', 2500);
    }
    
    var i = 0;
    var spd = speeds[selSpeed].ms;
    
    function showNext() {
        if (i > 0) {
            var prevTile = document.querySelector('.tile[data-tile="' + sequence[i-1] + '"]');
            if (prevTile) prevTile.classList.remove('lit');
        }
        if (i >= sequence.length) {
            showing = false;
            userIdx = 0;
            setTilesDisabled(false);
            setMsg(currentLang === 'es' ? 'Â¡Te toca!' : 'Your turn!');
            showCoach('yourTurn', 2500);
            return;
        }
        
        var tile = document.querySelector('.tile[data-tile="' + sequence[i] + '"]');
        if (tile) {
            tile.classList.add('lit');
            playTone(sequence[i], 0.3);
        }
        i++;
        setTimeout(showNext, spd);
    }
    
    setTimeout(showNext, 400);
}

function setTilesDisabled(disabled) {
    document.querySelectorAll('.tile').forEach(function(t) {
        t.classList.toggle('disabled', disabled);
    });
}

function handleTileClick(idx) {
    if (showing) return;
    
    var tile = document.querySelector('.tile[data-tile="' + idx + '"]');
    playTone(idx, 0.2);
    
    if (idx === sequence[userIdx]) {
        // Correct!
        tile.classList.add('lit');
        setTimeout(function() { tile.classList.remove('lit'); }, 200);
        
        userIdx++;
        addLaughs(1); // +1 for correct tap
        
        if (userIdx >= sequence.length) {
            var t = tiers[selTier];
            
            if (sequence.length > longestSeq) longestSeq = sequence.length;
            
            if (sequence.length >= t.targetSeq) {
                // Reached target!
                correct++;
                attempts++;
                var pts = sequence.length * 20;
                score += pts;
                updateScore();
                updateAccuracy();
                setTilesDisabled(true);
                setMsg((currentLang === 'es' ? 'Â¡LOL! +' : 'LOL! +') + pts, 'success');
                
                showCoach('targetReached', 2500);
                addLaughs(3); // +3 for reaching target
                
                setTimeout(nextPlay, 1200);
            } else {
                // Keep growing
                var pts = sequence.length * 10;
                score += pts;
                updateScore();
                setTilesDisabled(true);
                setMsg((currentLang === 'es' ? 'Â¡Ja ja! +' : 'Ha ha! +') + pts, 'success');
                
                showCoach('perfect', 2000);
                addLaughs(1); // +1 for completing sequence
                
                setTimeout(function() {
                    addToSequence();
                }, 800);
            }
        }
    } else {
        // Wrong!
        tile.classList.add('wrong');
        playBeep(150, 0.25);
        attempts++;
        updateAccuracy();
        setTilesDisabled(true);
        
        var correctTile = document.querySelector('.tile[data-tile="' + sequence[userIdx] + '"]');
        if (correctTile) correctTile.classList.add('lit');
        
        setMsg(currentLang === 'es' ? 'Â¡Oops!' : 'Oops!', 'error');
        showCoach('mistake', 2000);
        
        setTimeout(function() {
            tile.classList.remove('wrong');
            if (correctTile) correctTile.classList.remove('lit');
            nextPlay();
        }, 1200);
    }
}

function nextPlay() {
    play++;
    var t = tiers[selTier];
    if (play > t.plays) {
        if (currentHalf === 1) { showHalftime(); }
        else { endGame(); }
        return;
    }
    setTimeout(startPlay, 600);
}

function showHalftime() {
    document.getElementById('speedBadge').classList.remove('visible');
    document.getElementById('htScore').textContent = score;
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    document.getElementById('htAccuracy').textContent = pct + '%';
    document.getElementById('htLongest').textContent = longestSeq;
    
    showCoach('halftime', 4000);
    showScreen('halftimeScreen');
}

function continueToSecondHalf() {
    hideCoach();
    currentHalf = 2;
    play = 1;
    document.getElementById('speedBadge').classList.add('visible');
    updateHalfDisplay();
    showScreen('gameScreen');
    setMsg(currentLang === 'es' ? 'Â¡Segunda mitad!' : '2nd Half!');
    setTimeout(startPlay, 800);
}

function endGame() {
    document.getElementById('speedBadge').classList.remove('visible');
    document.getElementById('laughCounter').style.display = 'none';
    
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var isPerfect = pct === 100;
    
    // +5 laughs for circuit complete
    addLaughs(5);
    
    // +3 laughs for tier up
    if (isPerfect) addLaughs(3);
    
    var prog = getProgress();
    if (longestSeq > prog.best) prog.best = longestSeq;
    
    var currentIdx = tierList.indexOf(selTier);
    var canAdvance = isPerfect && currentIdx < tierList.length - 1;
    var joiningSquad = isPerfect && selTier === 'tier2';
    
    if (isPerfect) {
        prog.perfect[selTier] = (prog.perfect[selTier] || 0) + 1;
        var unlockedIdx = prog.unlockedTier || 0;
        if (currentIdx >= unlockedIdx && currentIdx < tierList.length - 1) {
            prog.unlockedTier = currentIdx + 1;
        }
    }
    saveProgress(prog);
    
    // Update result screen
    document.getElementById('resultIcon').textContent = isPerfect ? 'ğŸ†' : 'ğŸ’¡';
    document.getElementById('resultTitle').textContent = isPerfect ? 
        (currentLang === 'es' ? 'Â¡PERFECTO!' : 'PERFECT!') : 
        (currentLang === 'es' ? 'SIGUE RIENDO' : 'KEEP LAUGHING');
    document.getElementById('resultTitle').className = 'result-title ' + (isPerfect ? 'success' : 'retry');
    
    document.getElementById('resultAccuracy').textContent = pct + '%';
    document.getElementById('resultAccuracy').className = 'result-accuracy ' + (isPerfect ? 'perfect' : 'miss');
    
    var msgEN = isPerfect ? 'LOL Lights mastered at this tier!' : 'You need 100% to advance. Keep giggling!';
    var msgES = isPerfect ? 'Â¡Luces LOL dominadas en este nivel!' : 'Necesitas 100% para avanzar. Â¡Sigue riendo!';
    document.getElementById('resultMessage').innerHTML = '<span class="lang-en">' + msgEN + '</span><span class="lang-es">' + msgES + '</span>';
    
    document.getElementById('finalScore').textContent = score;
    document.getElementById('finalLongest').textContent = longestSeq;
    document.getElementById('finalCorrect').textContent = correct + '/' + attempts;
    
    document.getElementById('squadWelcome').style.display = joiningSquad ? 'block' : 'none';
    
    // Coach messages
    if (joiningSquad) {
        showCoach('squadWelcome', 5000);
    } else if (canAdvance) {
        showCoach('tierUp', 4000);
    } else if (isPerfect) {
        showCoach('perfectGame', 4000);
    } else {
        showCoach('keepTrying', 4000);
    }
    
    if (canAdvance) {
        var nextTier = tierList[currentIdx + 1];
        document.getElementById('nextLevelName').textContent = tiers[nextTier].icon + ' ' + tiers[nextTier].name;
        document.getElementById('nextLevelBox').style.display = 'block';
        document.getElementById('advanceBtn').style.display = 'block';
        document.getElementById('retryBtn').style.display = 'none';
    } else {
        document.getElementById('nextLevelBox').style.display = 'none';
        document.getElementById('advanceBtn').style.display = 'none';
        document.getElementById('retryBtn').style.display = 'block';
    }
    
    showScreen('resultScreen');
    startAutoTimer(isPerfect, canAdvance);
    
    // Save to server if logged in
    var pin = sessionStorage.getItem('lw-user-pin');
    if (pin) {
        var data = {game: 'laugh3', score: score, tier: selTier, accuracy: pct, perfect: isPerfect, longest: longestSeq, pin: pin};
        fetch('/api/game/session', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).catch(function(){});
    }
}

function startAutoTimer(isPerfect, canAdvance) {
    var count = 5;
    document.getElementById('timerCount').textContent = count;
    document.getElementById('timerCountEs').textContent = count;
    document.getElementById('continueTimer').style.display = 'block';
    
    autoTimer = setInterval(function() {
        count--;
        document.getElementById('timerCount').textContent = count;
        document.getElementById('timerCountEs').textContent = count;
        if (count <= 0) {
            clearInterval(autoTimer);
            if (isPerfect && canAdvance) advanceNow();
            else retryNow();
        }
    }, 1000);
}

function advanceNow() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    var currentIdx = tierList.indexOf(selTier);
    if (currentIdx < tierList.length - 1) selTier = tierList[currentIdx + 1];
    startGame();
}

function retryNow() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    startGame();
}

function goHome() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    document.getElementById('speedBadge').classList.remove('visible');
    document.getElementById('laughCounter').style.display = 'none';
    renderTiers();
    showScreen('welcomeScreen');
}

// Init
document.querySelectorAll('.lang-btn').forEach(function(b) {
    b.classList.toggle('active', b.textContent.trim() === currentLang.toUpperCase());
});
renderTiers();
</script>
</body>
</html>
