<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Master Challenge - GoStar Digital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-dark: #000000;
            --bg-card: #1A1A1A;
            --bg-card-light: #242424;
            --primary: #6C5CE7;
            --primary-light: #A29BFE;
            --secondary: #FFD93D;
            --secondary-light: #FFE566;
            --success: #00D9A5;
            --danger: #FF6B6B;
            --text-primary: #FFFFFF;
            --text-muted: #888888;
            --q1: #FF6B6B;
            --q2: #4ECDC4;
            --q3: #FFE66D;
            --q4: #95E1D3;
            --game1: #FFD93D;
            --game2: #00D9A5;
            --game3: #FF6B6B;
            --game4: #4ECDC4;
            --game5: #A29BFE;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
        }
        
        body[data-lang="es"] .lang-en { display: none !important; }
        body[data-lang="en"] .lang-es { display: none !important; }
        body[data-lang="es"] .lang-es { display: inline !important; }
        body[data-lang="en"] .lang-en { display: inline !important; }
        
        /* Header */
        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        
        .logo {
            font-size: 1.3rem;
            font-weight: 900;
        }
        
        .logo span {
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .lang-toggle {
            display: flex;
            gap: 5px;
        }
        
        .lang-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lang-btn.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: var(--bg-dark);
        }
        
        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }
        
        .screen.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome Screen */
        .challenge-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .challenge-title {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .challenge-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        
        /* Game Icons Row */
        .game-icons-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .game-icon-preview {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        /* Tier Selection */
        .section-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .tier-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            margin-bottom: 25px;
        }
        
        .tier-btn {
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .tier-btn:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .tier-btn.selected {
            border-color: var(--secondary);
            background: rgba(255, 217, 61, 0.1);
        }
        
        .tier-medal {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .tier-name {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .tier-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 3px;
        }
        
        /* Rhythm Selection */
        .rhythm-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .rhythm-btn {
            padding: 10px 18px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .rhythm-btn:hover {
            border-color: var(--success);
        }
        
        .rhythm-btn.selected {
            border-color: var(--success);
            background: rgba(0, 217, 165, 0.15);
        }
        
        /* Start Button */
        .start-btn {
            padding: 18px 60px;
            font-size: 1.3rem;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            color: var(--bg-dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 25px rgba(255, 217, 61, 0.3);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 35px rgba(255, 217, 61, 0.4);
        }
        
        /* Progress Bar */
        .progress-bar {
            position: fixed;
            top: 70px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 99;
        }
        
        .progress-dot {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            opacity: 0.4;
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            opacity: 1;
            border-color: var(--secondary);
            box-shadow: 0 0 15px rgba(255, 217, 61, 0.3);
            transform: scale(1.1);
        }
        
        .progress-dot.completed {
            opacity: 1;
            background: var(--success);
            border-color: var(--success);
        }
        
        /* Game Container */
        .game-container {
            width: 100%;
            max-width: 400px;
            margin-top: 60px;
        }
        
        /* Current Game Info */
        .current-game-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .current-game-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .current-game-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 3px;
        }
        
        .current-game-skill {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Score Display */
        .score-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .score-item {
            text-align: center;
        }
        
        .score-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .score-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--secondary);
        }
        
        /* Quarter Progress */
        .quarter-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quarter-dot {
            width: 60px;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .quarter-dot.q1.active { background: var(--q1); }
        .quarter-dot.q2.active { background: var(--q2); }
        .quarter-dot.q3.active { background: var(--q3); }
        .quarter-dot.q4.active { background: var(--q4); }
        
        /* Game Areas */
        .game-area {
            width: 100%;
            aspect-ratio: 1;
            max-width: 320px;
            background: var(--bg-card);
            border-radius: 20px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Sequence Memory Game */
        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
            width: 100%;
            height: 100%;
        }
        
        .seq-tile {
            background: var(--bg-card-light);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
        }
        
        .seq-tile.lit {
            background: var(--secondary);
            border-color: var(--secondary-light);
            box-shadow: 0 0 30px rgba(255, 217, 61, 0.5);
        }
        
        .seq-tile.correct {
            background: var(--success);
            border-color: var(--success);
        }
        
        .seq-tile.wrong {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        /* Trail Game */
        .trail-area {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .trail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star-node {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: translate(-50%, -50%);
        }
        
        .star-node svg {
            width: 100%;
            height: 100%;
            fill: var(--bg-card-light);
            transition: all 0.2s ease;
        }
        
        .star-node.color-0 svg { fill: #FF6B6B; }
        .star-node.color-1 svg { fill: #4ECDC4; }
        .star-node.color-2 svg { fill: #00D9A5; }
        .star-node.color-3 svg { fill: #FFD93D; }
        .star-node.color-4 svg { fill: #A29BFE; }
        .star-node.color-5 svg { fill: #FF85A2; }
        
        .star-node.lit svg {
            transform: scale(1.2);
        }
        
        .star-node.lit.color-0 svg { filter: drop-shadow(0 0 20px #FF6B6B); }
        .star-node.lit.color-1 svg { filter: drop-shadow(0 0 20px #4ECDC4); }
        .star-node.lit.color-2 svg { filter: drop-shadow(0 0 20px #00D9A5); }
        .star-node.lit.color-3 svg { filter: drop-shadow(0 0 20px #FFD93D); }
        .star-node.lit.color-4 svg { filter: drop-shadow(0 0 20px #A29BFE); }
        .star-node.lit.color-5 svg { filter: drop-shadow(0 0 20px #FF85A2); }
        
        .star-node.completed svg {
            fill: var(--success);
            filter: drop-shadow(0 0 10px var(--success));
        }
        
        .star-node.error svg {
            fill: var(--danger);
            filter: drop-shadow(0 0 10px var(--danger));
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-10deg); }
            75% { transform: translate(-50%, -50%) rotate(10deg); }
        }
        
        /* Reaction Game */
        .reaction-area {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .reaction-star {
            font-size: 6rem;
            opacity: 0;
            transition: all 0.1s ease;
        }
        
        .reaction-star.visible {
            opacity: 1;
            animation: popIn 0.2s ease;
        }
        
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .reaction-feedback {
            font-size: 2rem;
            font-weight: 900;
        }
        
        .reaction-feedback.fast { color: var(--success); }
        .reaction-feedback.medium { color: var(--secondary); }
        .reaction-feedback.slow { color: var(--danger); }
        
        /* Go/No-Go Game */
        .gonogo-target {
            font-size: 7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gonogo-target.go {
            filter: drop-shadow(0 0 30px rgba(255, 217, 61, 0.5));
        }
        
        .gonogo-target.nogo {
            filter: grayscale(100%) brightness(0.5);
        }
        
        /* Stroop Game */
        .stroop-display {
            text-align: center;
        }
        
        .stroop-star {
            font-size: 5rem;
            margin-bottom: 10px;
        }
        
        .stroop-word {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
        }
        
        .stroop-options {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .stroop-btn {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            border: 3px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stroop-btn:hover {
            transform: scale(1.1);
            border-color: white;
        }
        
        .stroop-btn.correct {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(0, 217, 165, 0.5);
        }
        
        .stroop-btn.wrong {
            border-color: var(--danger);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }
        
        /* Transition Screen */
        .transition-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .transition-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .transition-score {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .next-game-preview {
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .next-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .next-game-name {
            font-size: 1.2rem;
            font-weight: 800;
        }
        
        .countdown-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            margin: 0 auto;
            border: 4px solid var(--secondary);
        }
        
        /* Final Screen */
        .final-trophy {
            font-size: 5rem;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .final-title {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .final-subtitle {
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        
        /* Score Breakdown */
        .score-breakdown {
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .score-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .score-row:last-child {
            border-bottom: none;
        }
        
        .score-row-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .score-row-icon {
            font-size: 1.5rem;
        }
        
        .score-row-name {
            font-weight: 700;
        }
        
        .score-row-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--secondary);
        }
        
        .total-row {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        
        .total-row .score-row-name {
            font-size: 1.2rem;
        }
        
        .total-row .score-row-value {
            font-size: 1.8rem;
            color: var(--success);
        }
        
        /* Cognitive Radar */
        .radar-container {
            width: 100%;
            max-width: 280px;
            margin: 0 auto 25px;
        }
        
        .radar-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 15px;
        }
        
        .radar-chart {
            width: 100%;
            aspect-ratio: 1;
        }
        
        /* Final Buttons */
        .final-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .play-again-btn {
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            color: var(--bg-dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-again-btn:hover {
            transform: scale(1.03);
        }
        
        .home-btn {
            padding: 14px 40px;
            font-size: 1rem;
            font-weight: 700;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .home-btn:hover {
            border-color: var(--secondary);
        }
        
        /* Countdown Screen */
        .countdown-display {
            font-size: 8rem;
            font-weight: 900;
            color: var(--secondary);
            text-shadow: 0 0 50px rgba(255, 217, 61, 0.5);
        }
        
        .countdown-text {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
        
        /* Instructions */
        .game-instruction {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-bottom: 15px;
            min-height: 50px;
        }
        
        /* Floating Home */
        .floating-home {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .floating-home:hover {
            transform: scale(1.1);
            border-color: var(--secondary);
        }
        
        /* Responsive */
        @media (max-width: 380px) {
            .challenge-title { font-size: 1.6rem; }
            .game-area { max-width: 280px; }
            .progress-dot { width: 38px; height: 38px; font-size: 1rem; }
            .tier-grid { gap: 8px; }
            .tier-btn { padding: 12px; }
        }
    </style>
</head>
<body data-lang="en">

<!-- Header -->
<div class="game-header">
    <div class="logo">Go<span>Star</span></div>
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('es')">ES</button>
    </div>
</div>

<!-- Progress Bar (hidden initially) -->
<div class="progress-bar" id="progressBar" style="display: none;">
    <div class="progress-dot" data-game="0">‚≠ê</div>
    <div class="progress-dot" data-game="1">üõ§Ô∏è</div>
    <div class="progress-dot" data-game="2">‚ö°</div>
    <div class="progress-dot" data-game="3">üõë</div>
    <div class="progress-dot" data-game="4">üîÄ</div>
</div>

<!-- Welcome Screen -->
<div class="screen active" id="welcomeScreen">
    <div class="challenge-icon">üèÜ</div>
    <div class="challenge-title">
        <span class="lang-en">MASTER CHALLENGE</span>
        <span class="lang-es">DESAF√çO MAESTRO</span>
    </div>
    <div class="challenge-subtitle">
        <span class="lang-en">The Starting Five - All Games Combined</span>
        <span class="lang-es">Los Cinco Iniciales - Todos los Juegos</span>
    </div>
    
    <div class="game-icons-row">
        <div class="game-icon-preview">‚≠ê</div>
        <div class="game-icon-preview">üõ§Ô∏è</div>
        <div class="game-icon-preview">‚ö°</div>
        <div class="game-icon-preview">üõë</div>
        <div class="game-icon-preview">üîÄ</div>
    </div>
    
    <div class="section-label">
        <span class="lang-en">Select Difficulty</span>
        <span class="lang-es">Selecciona Dificultad</span>
    </div>
    
    <div class="tier-grid">
        <div class="tier-btn" data-tier="rookie" onclick="selectTier('rookie')">
            <div class="tier-medal">ü•â</div>
            <div class="tier-name">Rookie</div>
            <div class="tier-desc">
                <span class="lang-en">1 quarter each</span>
                <span class="lang-es">1 cuarto cada uno</span>
            </div>
        </div>
        <div class="tier-btn selected" data-tier="pro" onclick="selectTier('pro')">
            <div class="tier-medal">ü•à</div>
            <div class="tier-name">Pro</div>
            <div class="tier-desc">
                <span class="lang-en">2 quarters each</span>
                <span class="lang-es">2 cuartos cada uno</span>
            </div>
        </div>
        <div class="tier-btn" data-tier="elite" onclick="selectTier('elite')">
            <div class="tier-medal">ü•á</div>
            <div class="tier-name">Elite</div>
            <div class="tier-desc">
                <span class="lang-en">4 quarters each</span>
                <span class="lang-es">4 cuartos cada uno</span>
            </div>
        </div>
        <div class="tier-btn" data-tier="legend" onclick="selectTier('legend')">
            <div class="tier-medal">üíé</div>
            <div class="tier-name">Legend</div>
            <div class="tier-desc">
                <span class="lang-en">4 quarters + fast</span>
                <span class="lang-es">4 cuartos + r√°pido</span>
            </div>
        </div>
    </div>
    
    <div class="section-label">
        <span class="lang-en">Select Rhythm</span>
        <span class="lang-es">Selecciona Ritmo</span>
    </div>
    
    <div class="rhythm-grid">
        <button class="rhythm-btn" data-rhythm="relaxed" onclick="selectRhythm('relaxed')">
            üßò <span class="lang-en">Relaxed</span><span class="lang-es">Relajado</span>
        </button>
        <button class="rhythm-btn selected" data-rhythm="standard" onclick="selectRhythm('standard')">
            ‚öñÔ∏è <span class="lang-en">Standard</span><span class="lang-es">Normal</span>
        </button>
        <button class="rhythm-btn" data-rhythm="intense" onclick="selectRhythm('intense')">
            üî• <span class="lang-en">Intense</span><span class="lang-es">Intenso</span>
        </button>
    </div>
    
    <button class="start-btn" onclick="startChallenge()">
        <span class="lang-en">BEGIN CHALLENGE</span>
        <span class="lang-es">INICIAR DESAF√çO</span>
    </button>
</div>

<!-- Countdown Screen -->
<div class="screen" id="countdownScreen">
    <div class="current-game-icon" id="countdownIcon">‚≠ê</div>
    <div class="current-game-name" id="countdownGame">Sequence Memory</div>
    <div class="countdown-display" id="countdownNum">3</div>
    <div class="countdown-text">
        <span class="lang-en">Get Ready!</span>
        <span class="lang-es">¬°Prep√°rate!</span>
    </div>
</div>

<!-- Game Screen -->
<div class="screen" id="gameScreen">
    <div class="game-container">
        <div class="current-game-info">
            <div class="current-game-icon" id="gameIcon">‚≠ê</div>
            <div class="current-game-name" id="gameName">Sequence Memory</div>
            <div class="current-game-skill" id="gameSkill">Working Memory</div>
        </div>
        
        <div class="score-display">
            <div class="score-item">
                <div class="score-label">
                    <span class="lang-en">Score</span>
                    <span class="lang-es">Puntos</span>
                </div>
                <div class="score-value" id="currentScore">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">
                    <span class="lang-en">Round</span>
                    <span class="lang-es">Ronda</span>
                </div>
                <div class="score-value" id="currentRound">1</div>
            </div>
        </div>
        
        <div class="quarter-progress" id="quarterProgress">
            <div class="quarter-dot q1"></div>
            <div class="quarter-dot q2"></div>
            <div class="quarter-dot q3"></div>
            <div class="quarter-dot q4"></div>
        </div>
        
        <div class="game-instruction" id="gameInstruction">
            <span class="lang-en">Watch the sequence...</span>
            <span class="lang-es">Observa la secuencia...</span>
        </div>
        
        <div class="game-area" id="gameArea">
            <!-- Game content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Transition Screen -->
<div class="screen" id="transitionScreen">
    <div class="transition-icon" id="transitionIcon">‚úÖ</div>
    <div class="transition-title" id="transitionTitle">
        <span class="lang-en">Game Complete!</span>
        <span class="lang-es">¬°Juego Completado!</span>
    </div>
    <div class="transition-score" id="transitionScore">0</div>
    
    <div class="next-game-preview" id="nextGamePreview">
        <div class="next-label">
            <span class="lang-en">Next Up</span>
            <span class="lang-es">Siguiente</span>
        </div>
        <div class="next-game-name" id="nextGameName">üõ§Ô∏è Memory StarTrail</div>
    </div>
    
    <div class="countdown-circle" id="transitionCountdown">5</div>
</div>

<!-- Final Screen -->
<div class="screen" id="finalScreen">
    <div class="final-trophy">üèÜ</div>
    <div class="final-title">
        <span class="lang-en">CHALLENGE COMPLETE!</span>
        <span class="lang-es">¬°DESAF√çO COMPLETADO!</span>
    </div>
    <div class="final-subtitle">
        <span class="lang-en">You conquered The Starting Five!</span>
        <span class="lang-es">¬°Conquistaste Los Cinco Iniciales!</span>
    </div>
    
    <div class="score-breakdown">
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">‚≠ê</span>
                <span class="score-row-name">Sequence Memory</span>
            </div>
            <span class="score-row-value" id="finalScore1">0</span>
        </div>
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">üõ§Ô∏è</span>
                <span class="score-row-name">Memory StarTrail</span>
            </div>
            <span class="score-row-value" id="finalScore2">0</span>
        </div>
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">‚ö°</span>
                <span class="score-row-name">KwikStar</span>
            </div>
            <span class="score-row-value" id="finalScore3">0</span>
        </div>
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">üõë</span>
                <span class="score-row-name">Go-No-GoStar</span>
            </div>
            <span class="score-row-value" id="finalScore4">0</span>
        </div>
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">üîÄ</span>
                <span class="score-row-name">StarStroop</span>
            </div>
            <span class="score-row-value" id="finalScore5">0</span>
        </div>
        <div class="score-row total-row">
            <div class="score-row-left">
                <span class="score-row-icon">üèÜ</span>
                <span class="score-row-name">
                    <span class="lang-en">GRAND TOTAL</span>
                    <span class="lang-es">TOTAL FINAL</span>
                </span>
            </div>
            <span class="score-row-value" id="finalTotal">0</span>
        </div>
    </div>
    
    <div class="radar-container">
        <div class="radar-title">
            <span class="lang-en">Cognitive Profile</span>
            <span class="lang-es">Perfil Cognitivo</span>
        </div>
        <canvas id="radarChart" class="radar-chart"></canvas>
    </div>
    
    <div class="final-buttons">
        <button class="play-again-btn" onclick="restartChallenge()">
            <span class="lang-en">üîÑ Play Again</span>
            <span class="lang-es">üîÑ Jugar de Nuevo</span>
        </button>
        <a href="/game" class="home-btn">
            <span class="lang-en">üéÆ Game Hub</span>
            <span class="lang-es">üéÆ Centro de Juegos</span>
        </a>
    </div>
</div>

<!-- Floating Home -->
<a href="/game" class="floating-home" title="Game Hub">üè†</a>

<script>
// =====================================================
// MASTER CHALLENGE - ALL 5 GAMES COMBINED
// =====================================================

// Language
var currentLang = localStorage.getItem('gostar-lang') || 'en';
document.body.setAttribute('data-lang', currentLang);

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('gostar-lang', lang);
    document.body.setAttribute('data-lang', lang);
    document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.textContent.trim() === lang.toUpperCase());
    });
}

// Game Configuration
var games = [
    { id: 'sequence', icon: '‚≠ê', name: 'Sequence Memory', nameEs: 'Memoria Secuencial', skill: 'Working Memory', skillEs: 'Memoria de Trabajo' },
    { id: 'trail', icon: 'üõ§Ô∏è', name: 'Memory StarTrail', nameEs: 'Ruta Estelar', skill: 'Visual-Spatial', skillEs: 'Visual-Espacial' },
    { id: 'reaction', icon: '‚ö°', name: 'KwikStar', nameEs: 'KwikStar', skill: 'Processing Speed', skillEs: 'Velocidad de Procesamiento' },
    { id: 'gonogo', icon: 'üõë', name: 'Go-No-GoStar', nameEs: 'Go-No-GoStar', skill: 'Inhibition Control', skillEs: 'Control de Inhibici√≥n' },
    { id: 'stroop', icon: 'üîÄ', name: 'StarStroop', nameEs: 'StarStroop', skill: 'Selective Attention', skillEs: 'Atenci√≥n Selectiva' }
];

var tierConfig = {
    rookie: { quarters: 1, speedMod: 1.3, roundsPerQuarter: 3 },
    pro: { quarters: 2, speedMod: 1.0, roundsPerQuarter: 4 },
    elite: { quarters: 4, speedMod: 1.0, roundsPerQuarter: 5 },
    legend: { quarters: 4, speedMod: 0.7, roundsPerQuarter: 6 }
};

var rhythmConfig = {
    relaxed: { transition: 8, betweenRounds: 2000 },
    standard: { transition: 5, betweenRounds: 1500 },
    intense: { transition: 3, betweenRounds: 1000 }
};

// State
var selectedTier = 'pro';
var selectedRhythm = 'standard';
var currentGameIndex = 0;
var currentQuarter = 1;
var currentRound = 1;
var gameScores = [0, 0, 0, 0, 0];
var currentGameScore = 0;
var gameActive = false;

// UI Functions
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(function(s) {
        s.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

function selectTier(tier) {
    selectedTier = tier;
    document.querySelectorAll('.tier-btn').forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.tier === tier);
    });
}

function selectRhythm(rhythm) {
    selectedRhythm = rhythm;
    document.querySelectorAll('.rhythm-btn').forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.rhythm === rhythm);
    });
}

function updateProgress() {
    document.querySelectorAll('.progress-dot').forEach(function(dot, i) {
        dot.classList.remove('active', 'completed');
        if (i < currentGameIndex) {
            dot.classList.add('completed');
        } else if (i === currentGameIndex) {
            dot.classList.add('active');
        }
    });
}

function updateQuarterProgress() {
    var quarters = tierConfig[selectedTier].quarters;
    var progressEl = document.getElementById('quarterProgress');
    progressEl.innerHTML = '';
    for (var i = 1; i <= quarters; i++) {
        var dot = document.createElement('div');
        dot.className = 'quarter-dot q' + i;
        if (i <= currentQuarter) dot.classList.add('active');
        progressEl.appendChild(dot);
    }
}

// Start Challenge
function startChallenge() {
    currentGameIndex = 0;
    currentQuarter = 1;
    currentRound = 1;
    gameScores = [0, 0, 0, 0, 0];
    currentGameScore = 0;
    
    document.getElementById('progressBar').style.display = 'flex';
    updateProgress();
    
    showCountdown();
}

function showCountdown() {
    var game = games[currentGameIndex];
    document.getElementById('countdownIcon').textContent = game.icon;
    document.getElementById('countdownGame').textContent = currentLang === 'es' ? game.nameEs : game.name;
    showScreen('countdownScreen');
    
    var count = 3;
    document.getElementById('countdownNum').textContent = count;
    
    var interval = setInterval(function() {
        count--;
        if (count > 0) {
            document.getElementById('countdownNum').textContent = count;
        } else {
            clearInterval(interval);
            startCurrentGame();
        }
    }, 1000);
}

function startCurrentGame() {
    var game = games[currentGameIndex];
    currentGameScore = 0;
    currentQuarter = 1;
    currentRound = 1;
    
    document.getElementById('gameIcon').textContent = game.icon;
    document.getElementById('gameName').textContent = currentLang === 'es' ? game.nameEs : game.name;
    document.getElementById('gameSkill').textContent = currentLang === 'es' ? game.skillEs : game.skill;
    document.getElementById('currentScore').textContent = '0';
    document.getElementById('currentRound').textContent = '1';
    
    updateQuarterProgress();
    showScreen('gameScreen');
    
    // Start the appropriate game
    switch(game.id) {
        case 'sequence': startSequenceGame(); break;
        case 'trail': startTrailGame(); break;
        case 'reaction': startReactionGame(); break;
        case 'gonogo': startGoNoGoGame(); break;
        case 'stroop': startStroopGame(); break;
    }
}

// =====================================================
// GAME 1: SEQUENCE MEMORY
// =====================================================
var seqTiles = [];
var seqSequence = [];
var seqPlayerIndex = 0;
var seqShowingSequence = false;

function startSequenceGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="sequence-grid" id="seqGrid"></div>';
    
    var grid = document.getElementById('seqGrid');
    seqTiles = [];
    
    for (var i = 0; i < 9; i++) {
        var tile = document.createElement('div');
        tile.className = 'seq-tile';
        tile.dataset.index = i;
        tile.textContent = '‚≠ê';
        tile.onclick = function() { seqTileClick(parseInt(this.dataset.index)); };
        grid.appendChild(tile);
        seqTiles.push(tile);
    }
    
    gameActive = true;
    seqNewRound();
}

function seqNewRound() {
    if (!gameActive) return;
    
    setInstruction(
        currentLang === 'es' ? 'Observa la secuencia...' : 'Watch the sequence...'
    );
    
    var length = 2 + Math.floor(currentRound / 2);
    seqSequence = [];
    for (var i = 0; i < length; i++) {
        seqSequence.push(Math.floor(Math.random() * 9));
    }
    
    seqShowingSequence = true;
    seqPlayerIndex = 0;
    
    var speed = 600 * tierConfig[selectedTier].speedMod;
    var i = 0;
    
    function showNext() {
        if (i > 0) seqTiles[seqSequence[i-1]].classList.remove('lit');
        if (i < seqSequence.length) {
            seqTiles[seqSequence[i]].classList.add('lit');
            i++;
            setTimeout(showNext, speed);
        } else {
            setTimeout(function() {
                seqTiles[seqSequence[seqSequence.length-1]].classList.remove('lit');
                seqShowingSequence = false;
                setInstruction(
                    currentLang === 'es' ? '¬°Tu turno! Repite la secuencia' : 'Your turn! Repeat the sequence'
                );
            }, speed);
        }
    }
    
    setTimeout(showNext, 500);
}

function seqTileClick(index) {
    if (seqShowingSequence || !gameActive) return;
    
    var tile = seqTiles[index];
    
    if (seqSequence[seqPlayerIndex] === index) {
        tile.classList.add('correct');
        setTimeout(function() { tile.classList.remove('correct'); }, 200);
        
        seqPlayerIndex++;
        
        if (seqPlayerIndex === seqSequence.length) {
            var points = seqSequence.length * 10;
            addScore(points);
            nextRound();
        }
    } else {
        tile.classList.add('wrong');
        setTimeout(function() { tile.classList.remove('wrong'); }, 300);
        nextRound();
    }
}

// =====================================================
// GAME 2: MEMORY STARTRAIL (Star Sequence with Trail)
// =====================================================
var starSVG = '<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,97 50,75 21,97 32,62 2,40 39,40"/></svg>';
var starNodes = [];
var trailSequence = [];
var trailPlayerIndex = 0;
var completedStars = [];
var trailShowingSequence = false;
var starColors = ['color-0', 'color-1', 'color-2', 'color-3', 'color-4', 'color-5'];
var starFreqs = [262, 294, 330, 349, 392, 440];

function playStarSound(colorIndex) {
    try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = starFreqs[colorIndex % starFreqs.length];
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
    } catch(e) {}
}

function startTrailGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="trail-area" id="trailArea"><canvas class="trail-canvas" id="trailCanvas"></canvas></div>';
    
    starNodes = [];
    trailSequence = [];
    trailPlayerIndex = 0;
    completedStars = [];
    trailShowingSequence = false;
    
    gameActive = true;
    setTimeout(trailNewRound, 100);
}

function trailNewRound() {
    if (!gameActive) return;
    
    // Clear state FIRST
    completedStars = [];
    trailPlayerIndex = 0;
    trailShowingSequence = false;
    
    // Clear canvas
    var canvas = document.getElementById('trailCanvas');
    if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    setInstruction(currentLang === 'es' ? 'Observa las estrellas...' : 'Watch the stars...');
    
    var numStars = 5 + Math.floor(currentRound / 2);
    if (numStars > 8) numStars = 8;
    
    generateStarPositions(numStars);
    renderStars();
    
    // Generate sequence
    trailSequence = [];
    var available = [];
    for (var i = 0; i < numStars; i++) available.push(i);
    
    var seqLen = 3 + Math.floor(currentRound / 2);
    if (seqLen > numStars) seqLen = numStars;
    
    for (var i = 0; i < seqLen; i++) {
        if (available.length === 0) break;
        var idx = Math.floor(Math.random() * available.length);
        trailSequence.push(available[idx]);
        available.splice(idx, 1);
    }
    
    trailShowingSequence = true;
    disableStars(true);
    
    setTimeout(showTrailSequence, 600);
}

function generateStarPositions(numStars) {
    var area = document.getElementById('trailArea');
    var width = area.offsetWidth || 300;
    var height = area.offsetHeight || 300;
    var padding = 40;
    
    starNodes = [];
    
    for (var i = 0; i < numStars; i++) {
        var attempts = 0;
        var x, y, valid;
        
        do {
            x = padding + Math.random() * (width - padding * 2);
            y = padding + Math.random() * (height - padding * 2);
            valid = true;
            
            for (var j = 0; j < starNodes.length; j++) {
                var dx = x - starNodes[j].x;
                var dy = y - starNodes[j].y;
                if (Math.sqrt(dx*dx + dy*dy) < 60) {
                    valid = false;
                    break;
                }
            }
            attempts++;
        } while (!valid && attempts < 50);
        
        starNodes.push({ x: x, y: y, colorIndex: i % starColors.length });
    }
}

function renderStars() {
    var area = document.getElementById('trailArea');
    if (!area) return;
    
    var oldStars = area.querySelectorAll('.star-node');
    oldStars.forEach(function(s) { s.remove(); });
    
    for (var i = 0; i < starNodes.length; i++) {
        var star = document.createElement('div');
        star.className = 'star-node ' + starColors[starNodes[i].colorIndex];
        star.dataset.index = i;
        star.style.left = starNodes[i].x + 'px';
        star.style.top = starNodes[i].y + 'px';
        star.innerHTML = starSVG;
        
        (function(idx) {
            star.addEventListener('click', function() {
                handleStarClick(idx);
            });
        })(i);
        
        area.appendChild(star);
    }
    
    clearTrailCanvas();
}

function clearTrailCanvas() {
    var canvas = document.getElementById('trailCanvas');
    var area = document.getElementById('trailArea');
    if (!canvas || !area) return;
    canvas.width = area.offsetWidth;
    canvas.height = area.offsetHeight;
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function drawTrailLines() {
    var canvas = document.getElementById('trailCanvas');
    var area = document.getElementById('trailArea');
    if (!canvas || !area) return;
    
    canvas.width = area.offsetWidth;
    canvas.height = area.offsetHeight;
    
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (completedStars.length < 2) return;
    
    ctx.strokeStyle = '#00D9A5';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.shadowColor = '#00D9A5';
    ctx.shadowBlur = 10;
    
    ctx.beginPath();
    
    for (var i = 0; i < completedStars.length; i++) {
        var starIdx = completedStars[i];
        var node = starNodes[starIdx];
        if (!node) continue;
        
        if (i === 0) {
            ctx.moveTo(node.x, node.y);
        } else {
            ctx.lineTo(node.x, node.y);
        }
    }
    
    ctx.stroke();
}

function showTrailSequence() {
    if (!gameActive || trailSequence.length === 0) {
        trailShowingSequence = false;
        disableStars(false);
        return;
    }
    
    var speed = 500 * tierConfig[selectedTier].speedMod;
    var i = 0;
    
    function showNext() {
        if (!gameActive) return;
        
        if (i > 0 && i <= trailSequence.length) {
            var prevIdx = trailSequence[i-1];
            var prevStar = document.querySelector('.star-node[data-index="' + prevIdx + '"]');
            if (prevStar) prevStar.classList.remove('lit');
        }
        
        if (i < trailSequence.length) {
            var starIdx = trailSequence[i];
            var starEl = document.querySelector('.star-node[data-index="' + starIdx + '"]');
            
            if (starEl && starNodes[starIdx]) {
                starEl.classList.add('lit');
                playStarSound(starNodes[starIdx].colorIndex);
            }
            
            i++;
            setTimeout(showNext, speed);
        } else {
            setTimeout(function() {
                if (trailSequence.length > 0) {
                    var lastIdx = trailSequence[trailSequence.length - 1];
                    var lastStar = document.querySelector('.star-node[data-index="' + lastIdx + '"]');
                    if (lastStar) lastStar.classList.remove('lit');
                }
                
                trailShowingSequence = false;
                setInstruction(currentLang === 'es' ? '¬°Tu turno! Conecta las estrellas' : 'Your turn! Connect the stars');
                disableStars(false);
            }, speed);
        }
    }
    
    showNext();
}

function handleStarClick(index) {
    if (trailShowingSequence || !gameActive) return;
    if (trailSequence.length === 0) return;
    
    var starEl = document.querySelector('.star-node[data-index="' + index + '"]');
    if (!starEl) return;
    
    var expectedIdx = trailSequence[trailPlayerIndex];
    
    if (index === expectedIdx) {
        completedStars.push(index);
        starEl.classList.add('completed');
        if (starNodes[index]) playStarSound(starNodes[index].colorIndex);
        drawTrailLines();
        
        trailPlayerIndex++;
        
        if (trailPlayerIndex >= trailSequence.length) {
            var points = trailSequence.length * 15;
            addScore(points);
            disableStars(true);
            setTimeout(nextRound, 1000);
        }
    } else {
        starEl.classList.add('error');
        setTimeout(function() { starEl.classList.remove('error'); }, 300);
        var partial = trailPlayerIndex * 5;
        if (partial > 0) addScore(partial);
        setTimeout(nextRound, 800);
    }
}

function disableStars(disabled) {
    var stars = document.querySelectorAll('.star-node');
    stars.forEach(function(s) {
        s.style.pointerEvents = disabled ? 'none' : 'auto';
    });
}

// =====================================================
// GAME 3: KWIKSTAR (Reaction Time)
// =====================================================
var reactionTimeout = null;
var reactionStartTime = 0;
var reactionWaiting = false;

function startReactionGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="reaction-area" id="reactionArea" onclick="reactionTap()"><div class="reaction-star" id="reactionStar">‚≠ê</div><div class="reaction-feedback" id="reactionFeedback"></div></div>';
    
    gameActive = true;
    reactionNewRound();
}

function reactionNewRound() {
    if (!gameActive) return;
    
    setInstruction(
        currentLang === 'es' ? 'Toca cuando aparezca la estrella!' : 'Tap when the star appears!'
    );
    
    document.getElementById('reactionStar').classList.remove('visible');
    document.getElementById('reactionFeedback').textContent = '';
    
    var delay = 1000 + Math.random() * 2000;
    delay *= tierConfig[selectedTier].speedMod;
    
    reactionWaiting = true;
    
    reactionTimeout = setTimeout(function() {
        if (!gameActive) return;
        document.getElementById('reactionStar').classList.add('visible');
        reactionStartTime = Date.now();
        reactionWaiting = false;
    }, delay);
}

function reactionTap() {
    if (!gameActive) return;
    
    if (reactionWaiting) {
        // Too early!
        clearTimeout(reactionTimeout);
        showReactionFeedback(currentLang === 'es' ? '¬°Muy pronto!' : 'Too early!', 'slow');
        addScore(-10);
        setTimeout(reactionNewRound, 1500);
        return;
    }
    
    if (reactionStartTime === 0) return;
    
    var reaction = Date.now() - reactionStartTime;
    reactionStartTime = 0;
    
    document.getElementById('reactionStar').classList.remove('visible');
    
    var points = 0;
    var feedbackClass = 'slow';
    
    if (reaction < 250) {
        points = 30;
        feedbackClass = 'fast';
    } else if (reaction < 400) {
        points = 20;
        feedbackClass = 'medium';
    } else {
        points = 10;
        feedbackClass = 'slow';
    }
    
    showReactionFeedback(reaction + 'ms', feedbackClass);
    addScore(points);
    
    setTimeout(nextRound, rhythmConfig[selectedRhythm].betweenRounds);
}

function showReactionFeedback(text, className) {
    var fb = document.getElementById('reactionFeedback');
    fb.textContent = text;
    fb.className = 'reaction-feedback ' + className;
}

// =====================================================
// GAME 4: GO-NO-GO
// =====================================================
var gonogoTimeout = null;
var gonogoIsGo = true;
var gonogoCanTap = false;

function startGoNoGoGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="reaction-area" onclick="gonogoTap()"><div class="gonogo-target" id="gonogoTarget">‚≠ê</div></div>';
    
    gameActive = true;
    gonogoNewRound();
}

function gonogoNewRound() {
    if (!gameActive) return;
    
    setInstruction(
        currentLang === 'es' ? 'Toca ‚≠ê dorada, NO toques ‚≠ê gris' : 'Tap gold ‚≠ê, DON\'T tap gray ‚≠ê'
    );
    
    var target = document.getElementById('gonogoTarget');
    target.style.opacity = '0';
    gonogoCanTap = false;
    
    var delay = 500 + Math.random() * 1000;
    delay *= tierConfig[selectedTier].speedMod;
    
    setTimeout(function() {
        if (!gameActive) return;
        
        gonogoIsGo = Math.random() > 0.3; // 70% go, 30% no-go
        target.className = 'gonogo-target ' + (gonogoIsGo ? 'go' : 'nogo');
        target.style.opacity = '1';
        gonogoCanTap = true;
        
        // Auto advance for no-go
        gonogoTimeout = setTimeout(function() {
            if (!gameActive || !gonogoCanTap) return;
            
            if (!gonogoIsGo) {
                // Correct: didn't tap no-go
                addScore(15);
            }
            // Missed go - no penalty, just move on
            nextRound();
        }, 1500 * tierConfig[selectedTier].speedMod);
        
    }, delay);
}

function gonogoTap() {
    if (!gameActive || !gonogoCanTap) return;
    
    clearTimeout(gonogoTimeout);
    gonogoCanTap = false;
    
    if (gonogoIsGo) {
        addScore(20);
    } else {
        addScore(-15);
    }
    
    setTimeout(nextRound, rhythmConfig[selectedRhythm].betweenRounds);
}

// =====================================================
// GAME 5: STROOP
// =====================================================
var stroopColors = [
    { name: 'Red', nameEs: 'Rojo', hex: '#FF6B6B' },
    { name: 'Blue', nameEs: 'Azul', hex: '#4ECDC4' },
    { name: 'Yellow', nameEs: 'Amarillo', hex: '#FFE66D' },
    { name: 'Green', nameEs: 'Verde', hex: '#95E1D3' }
];
var stroopCorrectColor = 0;
var stroopCanAnswer = false;

function startStroopGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="stroop-display"><div class="stroop-star" id="stroopStar">‚≠ê</div><div class="stroop-word" id="stroopWord">RED</div><div class="stroop-options" id="stroopOptions"></div></div>';
    
    gameActive = true;
    stroopNewRound();
}

function stroopNewRound() {
    if (!gameActive) return;
    
    setInstruction(
        currentLang === 'es' ? 'Toca el COLOR de la estrella (ignora la palabra)' : 'Tap the star\'s COLOR (ignore the word)'
    );
    
    stroopCanAnswer = false;
    
    // Random color for star
    stroopCorrectColor = Math.floor(Math.random() * stroopColors.length);
    var starColor = stroopColors[stroopCorrectColor];
    
    // Random word (different from color for incongruence)
    var wordIndex = (stroopCorrectColor + 1 + Math.floor(Math.random() * 3)) % stroopColors.length;
    var wordColor = stroopColors[wordIndex];
    
    document.getElementById('stroopStar').style.color = starColor.hex;
    document.getElementById('stroopWord').textContent = currentLang === 'es' ? wordColor.nameEs.toUpperCase() : wordColor.name.toUpperCase();
    document.getElementById('stroopWord').style.color = starColor.hex;
    
    // Create buttons
    var optionsEl = document.getElementById('stroopOptions');
    optionsEl.innerHTML = '';
    
    stroopColors.forEach(function(c, i) {
        var btn = document.createElement('div');
        btn.className = 'stroop-btn';
        btn.style.background = c.hex;
        btn.dataset.index = i;
        btn.onclick = function() { stroopAnswer(parseInt(this.dataset.index)); };
        optionsEl.appendChild(btn);
    });
    
    setTimeout(function() {
        stroopCanAnswer = true;
    }, 300);
}

function stroopAnswer(index) {
    if (!gameActive || !stroopCanAnswer) return;
    stroopCanAnswer = false;
    
    var btns = document.querySelectorAll('.stroop-btn');
    
    if (index === stroopCorrectColor) {
        btns[index].classList.add('correct');
        addScore(25);
    } else {
        btns[index].classList.add('wrong');
        btns[stroopCorrectColor].classList.add('correct');
        addScore(-5);
    }
    
    setTimeout(nextRound, rhythmConfig[selectedRhythm].betweenRounds);
}

// =====================================================
// GAME FLOW CONTROL
// =====================================================

function setInstruction(text) {
    document.getElementById('gameInstruction').textContent = text;
}

function addScore(points) {
    currentGameScore += points;
    if (currentGameScore < 0) currentGameScore = 0;
    document.getElementById('currentScore').textContent = currentGameScore;
}

function nextRound() {
    if (!gameActive) return;
    
    var config = tierConfig[selectedTier];
    currentRound++;
    
    if (currentRound > config.roundsPerQuarter) {
        currentRound = 1;
        currentQuarter++;
        
        if (currentQuarter > config.quarters) {
            // Game complete
            endCurrentGame();
            return;
        }
    }
    
    document.getElementById('currentRound').textContent = currentRound;
    updateQuarterProgress();
    
    // Start next round of current game
    var game = games[currentGameIndex];
    setTimeout(function() {
        switch(game.id) {
            case 'sequence': seqNewRound(); break;
            case 'trail': trailNewRound(); break;
            case 'reaction': reactionNewRound(); break;
            case 'gonogo': gonogoNewRound(); break;
            case 'stroop': stroopNewRound(); break;
        }
    }, rhythmConfig[selectedRhythm].betweenRounds);
}

function endCurrentGame() {
    gameActive = false;
    clearTimeout(reactionTimeout);
    clearTimeout(gonogoTimeout);
    
    gameScores[currentGameIndex] = currentGameScore;
    
    currentGameIndex++;
    updateProgress();
    
    if (currentGameIndex >= games.length) {
        showFinalScreen();
    } else {
        showTransition();
    }
}

function showTransition() {
    var prevGame = games[currentGameIndex - 1];
    var nextGame = games[currentGameIndex];
    
    document.getElementById('transitionIcon').textContent = '‚úÖ';
    document.getElementById('transitionScore').textContent = gameScores[currentGameIndex - 1];
    document.getElementById('nextGameName').textContent = nextGame.icon + ' ' + (currentLang === 'es' ? nextGame.nameEs : nextGame.name);
    document.getElementById('nextGamePreview').style.display = 'block';
    
    showScreen('transitionScreen');
    
    var countdown = rhythmConfig[selectedRhythm].transition;
    document.getElementById('transitionCountdown').textContent = countdown;
    
    var interval = setInterval(function() {
        countdown--;
        if (countdown > 0) {
            document.getElementById('transitionCountdown').textContent = countdown;
        } else {
            clearInterval(interval);
            showCountdown();
        }
    }, 1000);
}

function showFinalScreen() {
    document.getElementById('progressBar').style.display = 'none';
    
    var total = 0;
    for (var i = 0; i < gameScores.length; i++) {
        document.getElementById('finalScore' + (i + 1)).textContent = gameScores[i];
        total += gameScores[i];
    }
    document.getElementById('finalTotal').textContent = total;
    
    showScreen('finalScreen');
    drawRadarChart();
    
    // Record to API
    recordMasterChallenge(total);
}

function drawRadarChart() {
    var canvas = document.getElementById('radarChart');
    var ctx = canvas.getContext('2d');
    var size = canvas.offsetWidth;
    canvas.width = size;
    canvas.height = size;
    
    var center = size / 2;
    var radius = size * 0.35;
    var maxScore = Math.max.apply(null, gameScores) || 100;
    
    // Background
    ctx.fillStyle = '#1A1A1A';
    ctx.beginPath();
    ctx.arc(center, center, radius + 10, 0, Math.PI * 2);
    ctx.fill();
    
    // Grid lines
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.lineWidth = 1;
    for (var r = 0.25; r <= 1; r += 0.25) {
        ctx.beginPath();
        ctx.arc(center, center, radius * r, 0, Math.PI * 2);
        ctx.stroke();
    }
    
    // Axes
    for (var i = 0; i < 5; i++) {
        var angle = (Math.PI * 2 * i / 5) - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.lineTo(center + Math.cos(angle) * radius, center + Math.sin(angle) * radius);
        ctx.stroke();
    }
    
    // Data polygon
    ctx.fillStyle = 'rgba(255, 217, 61, 0.3)';
    ctx.strokeStyle = '#FFD93D';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    for (var i = 0; i < 5; i++) {
        var angle = (Math.PI * 2 * i / 5) - Math.PI / 2;
        var value = gameScores[i] / maxScore;
        var x = center + Math.cos(angle) * radius * value;
        var y = center + Math.sin(angle) * radius * value;
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
    
    // Labels
    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 14px Nunito';
    ctx.textAlign = 'center';
    
    var labels = ['‚≠ê', 'üõ§Ô∏è', '‚ö°', 'üõë', 'üîÄ'];
    for (var i = 0; i < 5; i++) {
        var angle = (Math.PI * 2 * i / 5) - Math.PI / 2;
        var x = center + Math.cos(angle) * (radius + 25);
        var y = center + Math.sin(angle) * (radius + 25);
        ctx.fillText(labels[i], x, y + 5);
    }
}

function recordMasterChallenge(total) {
    var accessCode = sessionStorage.getItem('gostar-user-code');
    var username = sessionStorage.getItem('gostar-user-name');
    
    if (!accessCode || !username) return;
    
    // Record as a special "master" game type
    fetch('/api/game/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            accessCode: accessCode,
            username: username,
            game: 'master',
            score: total
        })
    }).catch(function() {});
}

function restartChallenge() {
    showScreen('welcomeScreen');
    document.getElementById('progressBar').style.display = 'none';
}

// Initialize
document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.textContent.trim() === currentLang.toUpperCase());
});
</script>

</body>
</html>
