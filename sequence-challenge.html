<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sequence Challenge - GoStar Digital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-dark: #000000;
            --bg-card: #1A1A1A;
            --bg-card-light: #242424;
            --primary: #6C5CE7;
            --primary-light: #A29BFE;
            --secondary: #FFD93D;
            --secondary-light: #FFE566;
            --success: #00D9A5;
            --danger: #FF6B6B;
            --text-primary: #FFFFFF;
            --text-muted: #888888;
            --q1: #FF6B6B;
            --q2: #4ECDC4;
            --q3: #FFE66D;
            --q4: #95E1D3;
            --trail-color: #00D9A5;
            
            /* Star colors */
            --star-red: #FF6B6B;
            --star-blue: #4ECDC4;
            --star-green: #00D9A5;
            --star-yellow: #FFD93D;
            --star-purple: #A29BFE;
            --star-pink: #FF85A2;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
        }
        
        body[data-lang="es"] .lang-en { display: none !important; }
        body[data-lang="en"] .lang-es { display: none !important; }
        body[data-lang="es"] .lang-es { display: inline !important; }
        body[data-lang="en"] .lang-en { display: inline !important; }
        
        /* Header */
        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        
        .logo {
            font-size: 1.3rem;
            font-weight: 900;
        }
        
        .logo span {
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .lang-toggle {
            display: flex;
            gap: 5px;
        }
        
        .lang-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lang-btn.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: var(--bg-dark);
        }
        
        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }
        
        .screen.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome Screen */
        .challenge-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .challenge-title {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .challenge-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        
        /* Game Icons Row */
        .game-icons-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-icon-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .game-icon-circle {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: var(--bg-card);
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .game-icon-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .game-arrow {
            font-size: 2rem;
            color: var(--secondary);
            align-self: center;
            margin-top: -20px;
        }
        
        /* Tier Selection */
        .section-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .tier-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            margin-bottom: 25px;
        }
        
        .tier-btn {
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .tier-btn:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .tier-btn.selected {
            border-color: var(--secondary);
            background: rgba(255, 217, 61, 0.1);
        }
        
        .tier-medal {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .tier-name {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .tier-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 3px;
        }
        
        /* Rhythm Selection */
        .rhythm-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .rhythm-btn {
            padding: 10px 18px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .rhythm-btn:hover {
            border-color: var(--success);
        }
        
        .rhythm-btn.selected {
            border-color: var(--success);
            background: rgba(0, 217, 165, 0.15);
        }
        
        /* Start Button */
        .start-btn {
            padding: 18px 60px;
            font-size: 1.3rem;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            color: var(--bg-dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 25px rgba(255, 217, 61, 0.3);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 35px rgba(255, 217, 61, 0.4);
        }
        
        /* Progress Bar */
        .progress-bar {
            position: fixed;
            top: 70px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 99;
        }
        
        .progress-dot {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--bg-card);
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            opacity: 0.4;
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            opacity: 1;
            border-color: var(--secondary);
            box-shadow: 0 0 20px rgba(255, 217, 61, 0.3);
            transform: scale(1.1);
        }
        
        .progress-dot.completed {
            opacity: 1;
            background: var(--success);
            border-color: var(--success);
        }
        
        /* Game Container */
        .game-container {
            width: 100%;
            max-width: 400px;
            margin-top: 80px;
        }
        
        /* Current Game Info */
        .current-game-info {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .current-game-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .current-game-name {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 3px;
        }
        
        .current-game-skill {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Score Display */
        .score-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }
        
        .score-item {
            text-align: center;
        }
        
        .score-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .score-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--secondary);
        }
        
        /* Quarter Progress */
        .quarter-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quarter-dot {
            width: 60px;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .quarter-dot.q1.active { background: var(--q1); }
        .quarter-dot.q2.active { background: var(--q2); }
        .quarter-dot.q3.active { background: var(--q3); }
        .quarter-dot.q4.active { background: var(--q4); }
        
        /* Game Instruction */
        .game-instruction {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-bottom: 15px;
            min-height: 30px;
        }
        
        /* Game Areas */
        .game-area {
            width: 100%;
            aspect-ratio: 1;
            max-width: 320px;
            background: var(--bg-card);
            border-radius: 20px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ===== SEQUENCE MEMORY GAME ===== */
        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            width: 100%;
            height: 100%;
        }
        
        .seq-tile {
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .seq-tile svg {
            width: 60%;
            height: 60%;
            transition: transform 0.1s ease, fill 0.1s ease;
        }
        
        /* Base tile colors - dimmer when not lit */
        .seq-tile.seq-red {
            background: linear-gradient(135deg, #cc5555 0%, #aa4444 100%);
        }
        .seq-tile.seq-red svg { fill: #993333; }
        
        .seq-tile.seq-blue {
            background: linear-gradient(135deg, #3eb8b0 0%, #2da8a0 100%);
        }
        .seq-tile.seq-blue svg { fill: #208880; }
        
        .seq-tile.seq-green {
            background: linear-gradient(135deg, #00b890 0%, #009a78 100%);
        }
        .seq-tile.seq-green svg { fill: #007a60; }
        
        .seq-tile.seq-yellow {
            background: linear-gradient(135deg, #e0c030 0%, #c8a828 100%);
        }
        .seq-tile.seq-yellow svg { fill: #a88820; }
        
        /* LIT STATE - bright and glowing */
        .seq-tile.lit {
            transform: scale(1.08);
            z-index: 10;
        }
        
        .seq-tile.seq-red.lit {
            background: linear-gradient(135deg, #FF6B6B 0%, #ff5252 100%);
            box-shadow: 0 0 50px rgba(255, 107, 107, 0.9), 0 0 100px rgba(255, 107, 107, 0.5);
        }
        .seq-tile.seq-red.lit svg { 
            fill: #ffffff; 
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
        
        .seq-tile.seq-blue.lit {
            background: linear-gradient(135deg, #4ECDC4 0%, #3fc4bb 100%);
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.9), 0 0 100px rgba(78, 205, 196, 0.5);
        }
        .seq-tile.seq-blue.lit svg { 
            fill: #ffffff; 
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
        
        .seq-tile.seq-green.lit {
            background: linear-gradient(135deg, #00D9A5 0%, #00c896 100%);
            box-shadow: 0 0 50px rgba(0, 217, 165, 0.9), 0 0 100px rgba(0, 217, 165, 0.5);
        }
        .seq-tile.seq-green.lit svg { 
            fill: #ffffff; 
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
        
        .seq-tile.seq-yellow.lit {
            background: linear-gradient(135deg, #FFD93D 0%, #ffcc00 100%);
            box-shadow: 0 0 50px rgba(255, 217, 61, 0.9), 0 0 100px rgba(255, 217, 61, 0.5);
        }
        .seq-tile.seq-yellow.lit svg { 
            fill: #ffffff; 
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
        }
        
        /* Correct feedback - brief flash */
        .seq-tile.correct {
            transform: scale(1.05);
        }
        .seq-tile.correct svg { 
            fill: #ffffff !important; 
        }
        
        /* Wrong feedback - shake */
        .seq-tile.wrong {
            animation: tileShake 0.4s ease;
            background: linear-gradient(135deg, #FF6B6B 0%, #ff5252 100%) !important;
        }
        .seq-tile.wrong svg {
            fill: #ffffff !important;
        }
        
        @keyframes tileShake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            20% { transform: translateX(-10px) rotate(-3deg); }
            40% { transform: translateX(10px) rotate(3deg); }
            60% { transform: translateX(-10px) rotate(-3deg); }
            80% { transform: translateX(10px) rotate(3deg); }
        }
        
        /* Touch feedback */
        .seq-tile:active {
            transform: scale(0.95);
        }
        
        /* ===== TRAIL GAME ===== */
        .trail-area {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .trail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star-node {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: translate(-50%, -50%);
        }
        
        .star-node svg {
            width: 100%;
            height: 100%;
            fill: var(--bg-card-light);
            transition: all 0.2s ease;
        }
        
        .star-node.color-0 svg { fill: var(--star-red); }
        .star-node.color-1 svg { fill: var(--star-blue); }
        .star-node.color-2 svg { fill: var(--star-green); }
        .star-node.color-3 svg { fill: var(--star-yellow); }
        .star-node.color-4 svg { fill: var(--star-purple); }
        .star-node.color-5 svg { fill: var(--star-pink); }
        
        .star-node.lit svg {
            filter: drop-shadow(0 0 15px currentColor) brightness(1.3);
            transform: scale(1.2);
        }
        
        .star-node.lit.color-0 svg { filter: drop-shadow(0 0 20px var(--star-red)); }
        .star-node.lit.color-1 svg { filter: drop-shadow(0 0 20px var(--star-blue)); }
        .star-node.lit.color-2 svg { filter: drop-shadow(0 0 20px var(--star-green)); }
        .star-node.lit.color-3 svg { filter: drop-shadow(0 0 20px var(--star-yellow)); }
        .star-node.lit.color-4 svg { filter: drop-shadow(0 0 20px var(--star-purple)); }
        .star-node.lit.color-5 svg { filter: drop-shadow(0 0 20px var(--star-pink)); }
        
        .star-node.completed svg {
            fill: var(--success);
            filter: drop-shadow(0 0 10px var(--success));
        }
        
        .star-node.error svg {
            fill: var(--danger);
            filter: drop-shadow(0 0 10px var(--danger));
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-10deg); }
            75% { transform: translate(-50%, -50%) rotate(10deg); }
        }
        
        /* Transition Screen */
        .transition-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .transition-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .transition-score {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .next-game-preview {
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .next-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .next-game-name {
            font-size: 1.2rem;
            font-weight: 800;
        }
        
        .countdown-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 900;
            margin: 0 auto;
            border: 4px solid var(--secondary);
        }
        
        /* Countdown Screen */
        .countdown-display {
            font-size: 8rem;
            font-weight: 900;
            color: var(--secondary);
            text-shadow: 0 0 50px rgba(255, 217, 61, 0.5);
        }
        
        .countdown-text {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
        
        /* Final Screen */
        .final-trophy {
            font-size: 5rem;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .final-title {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .final-subtitle {
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        
        /* Score Breakdown */
        .score-breakdown {
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .score-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .score-row:last-child {
            border-bottom: none;
        }
        
        .score-row-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .score-row-icon {
            font-size: 1.8rem;
        }
        
        .score-row-name {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .score-row-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--secondary);
        }
        
        .total-row {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        
        .total-row .score-row-name {
            font-size: 1.3rem;
        }
        
        .total-row .score-row-value {
            font-size: 2rem;
            color: var(--success);
        }
        
        /* Final Buttons */
        .final-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .play-again-btn {
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #FF9F1C 100%);
            color: var(--bg-dark);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-again-btn:hover {
            transform: scale(1.03);
        }
        
        .home-btn {
            padding: 14px 40px;
            font-size: 1rem;
            font-weight: 700;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .home-btn:hover {
            border-color: var(--secondary);
        }
        
        /* Floating Home */
        .floating-home {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .floating-home:hover {
            transform: scale(1.1);
            border-color: var(--secondary);
        }
        
        /* Responsive */
        @media (max-width: 380px) {
            .challenge-title { font-size: 1.5rem; }
            .game-area { max-width: 280px; }
            .progress-dot { width: 50px; height: 50px; font-size: 1.2rem; }
            .game-icon-circle { width: 60px; height: 60px; }
            .star-node { width: 40px; height: 40px; }
        }
    </style>
</head>
<body data-lang="en">

<!-- Header -->
<div class="game-header">
    <div class="logo">Go<span>Star</span></div>
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('es')">ES</button>
    </div>
</div>

<!-- Progress Bar (hidden initially) -->
<div class="progress-bar" id="progressBar" style="display: none;">
    <div class="progress-dot" data-game="0">‚≠ê</div>
    <div class="progress-dot" data-game="1">üõ§Ô∏è</div>
</div>

<!-- Welcome Screen -->
<div class="screen active" id="welcomeScreen">
    <div class="challenge-icon">üß†</div>
    <div class="challenge-title">
        <span class="lang-en">SEQUENCE CHALLENGE</span>
        <span class="lang-es">DESAF√çO SECUENCIAL</span>
    </div>
    <div class="challenge-subtitle">
        <span class="lang-en">Memory Duo - Pattern Recognition Training</span>
        <span class="lang-es">D√∫o de Memoria - Entrenamiento de Patrones</span>
    </div>
    
    <div class="game-icons-row">
        <div class="game-icon-preview">
            <div class="game-icon-circle">‚≠ê</div>
            <div class="game-icon-label">
                <span class="lang-en">Sequence</span>
                <span class="lang-es">Secuencia</span>
            </div>
        </div>
        <div class="game-arrow">‚Üí</div>
        <div class="game-icon-preview">
            <div class="game-icon-circle">üõ§Ô∏è</div>
            <div class="game-icon-label">
                <span class="lang-en">StarTrail</span>
                <span class="lang-es">Ruta Estelar</span>
            </div>
        </div>
    </div>
    
    <div class="section-label">
        <span class="lang-en">Select Difficulty</span>
        <span class="lang-es">Selecciona Dificultad</span>
    </div>
    
    <div class="tier-grid">
        <div class="tier-btn" data-tier="rookie" onclick="selectTier('rookie')">
            <div class="tier-medal">ü•â</div>
            <div class="tier-name">Rookie</div>
            <div class="tier-desc">
                <span class="lang-en">2 quarters each</span>
                <span class="lang-es">2 cuartos cada uno</span>
            </div>
        </div>
        <div class="tier-btn selected" data-tier="pro" onclick="selectTier('pro')">
            <div class="tier-medal">ü•à</div>
            <div class="tier-name">Pro</div>
            <div class="tier-desc">
                <span class="lang-en">4 quarters each</span>
                <span class="lang-es">4 cuartos cada uno</span>
            </div>
        </div>
        <div class="tier-btn" data-tier="elite" onclick="selectTier('elite')">
            <div class="tier-medal">ü•á</div>
            <div class="tier-name">Elite</div>
            <div class="tier-desc">
                <span class="lang-en">4 quarters + longer</span>
                <span class="lang-es">4 cuartos + largo</span>
            </div>
        </div>
        <div class="tier-btn" data-tier="legend" onclick="selectTier('legend')">
            <div class="tier-medal">üíé</div>
            <div class="tier-name">Legend</div>
            <div class="tier-desc">
                <span class="lang-en">4 quarters + fast</span>
                <span class="lang-es">4 cuartos + r√°pido</span>
            </div>
        </div>
    </div>
    
    <div class="section-label">
        <span class="lang-en">Select Rhythm</span>
        <span class="lang-es">Selecciona Ritmo</span>
    </div>
    
    <div class="rhythm-grid">
        <button class="rhythm-btn" data-rhythm="relaxed" onclick="selectRhythm('relaxed')">
            üßò <span class="lang-en">Relaxed</span><span class="lang-es">Relajado</span>
        </button>
        <button class="rhythm-btn selected" data-rhythm="standard" onclick="selectRhythm('standard')">
            ‚öñÔ∏è <span class="lang-en">Standard</span><span class="lang-es">Normal</span>
        </button>
        <button class="rhythm-btn" data-rhythm="intense" onclick="selectRhythm('intense')">
            üî• <span class="lang-en">Intense</span><span class="lang-es">Intenso</span>
        </button>
    </div>
    
    <button class="start-btn" onclick="startChallenge()">
        <span class="lang-en">BEGIN CHALLENGE</span>
        <span class="lang-es">INICIAR DESAF√çO</span>
    </button>
</div>

<!-- Countdown Screen -->
<div class="screen" id="countdownScreen">
    <div class="current-game-icon" id="countdownIcon">‚≠ê</div>
    <div class="current-game-name" id="countdownGame">Sequence Memory</div>
    <div class="countdown-display" id="countdownNum">3</div>
    <div class="countdown-text">
        <span class="lang-en">Get Ready!</span>
        <span class="lang-es">¬°Prep√°rate!</span>
    </div>
</div>

<!-- Game Screen -->
<div class="screen" id="gameScreen">
    <div class="game-container">
        <div class="current-game-info">
            <div class="current-game-icon" id="gameIcon">‚≠ê</div>
            <div class="current-game-name" id="gameName">Sequence Memory</div>
            <div class="current-game-skill" id="gameSkill">Working Memory</div>
        </div>
        
        <div class="score-display">
            <div class="score-item">
                <div class="score-label">
                    <span class="lang-en">Score</span>
                    <span class="lang-es">Puntos</span>
                </div>
                <div class="score-value" id="currentScore">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">
                    <span class="lang-en">Round</span>
                    <span class="lang-es">Ronda</span>
                </div>
                <div class="score-value" id="currentRound">1</div>
            </div>
        </div>
        
        <div class="quarter-progress" id="quarterProgress">
            <div class="quarter-dot q1"></div>
            <div class="quarter-dot q2"></div>
            <div class="quarter-dot q3"></div>
            <div class="quarter-dot q4"></div>
        </div>
        
        <div class="game-instruction" id="gameInstruction">
            <span class="lang-en">Watch the sequence...</span>
            <span class="lang-es">Observa la secuencia...</span>
        </div>
        
        <div class="game-area" id="gameArea">
            <!-- Game content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Transition Screen -->
<div class="screen" id="transitionScreen">
    <div class="transition-icon" id="transitionIcon">‚úÖ</div>
    <div class="transition-title" id="transitionTitle">
        <span class="lang-en">Game Complete!</span>
        <span class="lang-es">¬°Juego Completado!</span>
    </div>
    <div class="transition-score" id="transitionScore">0</div>
    
    <div class="next-game-preview" id="nextGamePreview">
        <div class="next-label">
            <span class="lang-en">Next Up</span>
            <span class="lang-es">Siguiente</span>
        </div>
        <div class="next-game-name" id="nextGameName">üõ§Ô∏è Memory StarTrail</div>
    </div>
    
    <div class="countdown-circle" id="transitionCountdown">5</div>
</div>

<!-- Final Screen -->
<div class="screen" id="finalScreen">
    <div class="final-trophy">üß†</div>
    <div class="final-title">
        <span class="lang-en">SEQUENCE MASTERED!</span>
        <span class="lang-es">¬°SECUENCIA DOMINADA!</span>
    </div>
    <div class="final-subtitle">
        <span class="lang-en">Memory Duo Complete!</span>
        <span class="lang-es">¬°D√∫o de Memoria Completado!</span>
    </div>
    
    <div class="score-breakdown">
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">‚≠ê</span>
                <span class="score-row-name">Sequence Memory</span>
            </div>
            <span class="score-row-value" id="finalScore1">0</span>
        </div>
        <div class="score-row">
            <div class="score-row-left">
                <span class="score-row-icon">üõ§Ô∏è</span>
                <span class="score-row-name">Memory StarTrail</span>
            </div>
            <span class="score-row-value" id="finalScore2">0</span>
        </div>
        <div class="score-row total-row">
            <div class="score-row-left">
                <span class="score-row-icon">üß†</span>
                <span class="score-row-name">
                    <span class="lang-en">TOTAL</span>
                    <span class="lang-es">TOTAL</span>
                </span>
            </div>
            <span class="score-row-value" id="finalTotal">0</span>
        </div>
    </div>
    
    <div class="final-buttons">
        <button class="play-again-btn" onclick="restartChallenge()">
            <span class="lang-en">üîÑ Play Again</span>
            <span class="lang-es">üîÑ Jugar de Nuevo</span>
        </button>
        <a href="/game" class="home-btn">
            <span class="lang-en">üéÆ Game Hub</span>
            <span class="lang-es">üéÆ Centro de Juegos</span>
        </a>
    </div>
</div>

<!-- Floating Home -->
<a href="/game" class="floating-home" title="Game Hub">üè†</a>

<script>
// =====================================================
// SEQUENCE CHALLENGE - MEMORY DUO
// =====================================================

// Star SVG
var starSVG = '<svg viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 68,62 79,97 50,75 21,97 32,62 2,40 39,40"/></svg>';

// Audio Context
var audioCtx = null;
function getAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
}

function playTone(freq, duration, type) {
    try {
        var ctx = getAudioContext();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = type || 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + duration);
    } catch(e) {}
}

// Star color sounds
var starFreqs = [262, 294, 330, 349, 392, 440]; // C D E F G A
function playStarSound(colorIndex) {
    playTone(starFreqs[colorIndex % starFreqs.length], 0.3, 'sine');
}

function playSuccessSound() {
    playTone(523, 0.1, 'sine');
    setTimeout(function() { playTone(659, 0.1, 'sine'); }, 100);
    setTimeout(function() { playTone(784, 0.2, 'sine'); }, 200);
}

function playErrorSound() {
    playTone(200, 0.3, 'sawtooth');
}

// Language
var currentLang = localStorage.getItem('gostar-lang') || 'en';
document.body.setAttribute('data-lang', currentLang);

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('gostar-lang', lang);
    document.body.setAttribute('data-lang', lang);
    document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.textContent.trim() === lang.toUpperCase());
    });
}

// Game Configuration
var games = [
    { id: 'sequence', icon: '‚≠ê', name: 'Sequence Memory', nameEs: 'Memoria Secuencial', skill: 'Working Memory', skillEs: 'Memoria de Trabajo' },
    { id: 'trail', icon: 'üõ§Ô∏è', name: 'Memory StarTrail', nameEs: 'Ruta Estelar', skill: 'Visual-Spatial', skillEs: 'Visual-Espacial' }
];

var tierConfig = {
    rookie: { quarters: 2, speedMod: 1.3, roundsPerQuarter: 3, seqStart: 2 },
    pro: { quarters: 4, speedMod: 1.0, roundsPerQuarter: 4, seqStart: 3 },
    elite: { quarters: 4, speedMod: 1.0, roundsPerQuarter: 5, seqStart: 4 },
    legend: { quarters: 4, speedMod: 0.7, roundsPerQuarter: 5, seqStart: 4 }
};

var rhythmConfig = {
    relaxed: { transition: 8, noteLength: 700, pauseAfter: 400 },
    standard: { transition: 5, noteLength: 500, pauseAfter: 300 },
    intense: { transition: 3, noteLength: 350, pauseAfter: 200 }
};

// State
var selectedTier = 'pro';
var selectedRhythm = 'standard';
var currentGameIndex = 0;
var currentQuarter = 1;
var currentRound = 1;
var gameScores = [0, 0];
var currentGameScore = 0;
var gameActive = false;

// UI Functions
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(function(s) {
        s.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

function selectTier(tier) {
    selectedTier = tier;
    document.querySelectorAll('.tier-btn').forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.tier === tier);
    });
}

function selectRhythm(rhythm) {
    selectedRhythm = rhythm;
    document.querySelectorAll('.rhythm-btn').forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.rhythm === rhythm);
    });
}

function updateProgress() {
    document.querySelectorAll('.progress-dot').forEach(function(dot, i) {
        dot.classList.remove('active', 'completed');
        if (i < currentGameIndex) {
            dot.classList.add('completed');
        } else if (i === currentGameIndex) {
            dot.classList.add('active');
        }
    });
}

function updateQuarterProgress() {
    var quarters = tierConfig[selectedTier].quarters;
    var progressEl = document.getElementById('quarterProgress');
    progressEl.innerHTML = '';
    for (var i = 1; i <= quarters; i++) {
        var dot = document.createElement('div');
        dot.className = 'quarter-dot q' + i;
        if (i <= currentQuarter) dot.classList.add('active');
        progressEl.appendChild(dot);
    }
}

// Start Challenge
function startChallenge() {
    currentGameIndex = 0;
    currentQuarter = 1;
    currentRound = 1;
    gameScores = [0, 0];
    currentGameScore = 0;
    
    document.getElementById('progressBar').style.display = 'flex';
    updateProgress();
    
    showCountdown();
}

function showCountdown() {
    var game = games[currentGameIndex];
    document.getElementById('countdownIcon').textContent = game.icon;
    document.getElementById('countdownGame').textContent = currentLang === 'es' ? game.nameEs : game.name;
    showScreen('countdownScreen');
    
    var count = 3;
    document.getElementById('countdownNum').textContent = count;
    
    var interval = setInterval(function() {
        count--;
        if (count > 0) {
            document.getElementById('countdownNum').textContent = count;
            playTone(440, 0.1, 'sine');
        } else {
            clearInterval(interval);
            playTone(880, 0.2, 'sine');
            startCurrentGame();
        }
    }, 1000);
}

function startCurrentGame() {
    var game = games[currentGameIndex];
    currentGameScore = 0;
    currentQuarter = 1;
    currentRound = 1;
    
    document.getElementById('gameIcon').textContent = game.icon;
    document.getElementById('gameName').textContent = currentLang === 'es' ? game.nameEs : game.name;
    document.getElementById('gameSkill').textContent = currentLang === 'es' ? game.skillEs : game.skill;
    document.getElementById('currentScore').textContent = '0';
    document.getElementById('currentRound').textContent = '1';
    
    updateQuarterProgress();
    showScreen('gameScreen');
    
    if (game.id === 'sequence') {
        startSequenceGame();
    } else {
        startTrailGame();
    }
}

// =====================================================
// GAME 1: SEQUENCE MEMORY (4 Colored Star Tiles)
// =====================================================
var seqTiles = [];
var seqSequence = [];
var seqPlayerIndex = 0;
var seqShowingSequence = false;
var seqColors = ['red', 'blue', 'green', 'yellow'];
var seqNoteFreqs = [261.63, 329.63, 392.00, 523.25]; // C4, E4, G4, C5

function startSequenceGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="sequence-grid" id="seqGrid"></div>';
    
    var grid = document.getElementById('seqGrid');
    seqTiles = [];
    seqSequence = [];
    seqPlayerIndex = 0;
    seqShowingSequence = false;
    
    // Create 4 colored star tiles
    for (var i = 0; i < 4; i++) {
        var tile = document.createElement('div');
        tile.className = 'seq-tile seq-' + seqColors[i];
        tile.dataset.index = i;
        tile.innerHTML = starSVG;
        
        (function(idx) {
            tile.addEventListener('click', function() {
                seqTileClick(idx);
            });
            tile.addEventListener('touchstart', function(e) {
                e.preventDefault();
                seqTileClick(idx);
            }, {passive: false});
        })(i);
        
        grid.appendChild(tile);
        seqTiles.push(tile);
    }
    
    gameActive = true;
    seqDisableTiles(true);
    
    // Start first round after brief delay
    setTimeout(seqNewRound, 800);
}

function seqDisableTiles(disabled) {
    for (var i = 0; i < seqTiles.length; i++) {
        seqTiles[i].style.pointerEvents = disabled ? 'none' : 'auto';
        seqTiles[i].style.opacity = disabled ? '0.7' : '1';
    }
}

function seqPlaySound(tileIndex) {
    try {
        var ctx = getAudioContext();
        if (!ctx) return;
        
        if (ctx.state === 'suspended') {
            ctx.resume();
        }
        
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        
        osc.type = 'sine';
        osc.frequency.value = seqNoteFreqs[tileIndex % 4];
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.25);
    } catch(e) {
        console.log('Sound error:', e);
    }
}

function seqNewRound() {
    if (!gameActive) return;
    
    // Reset state
    seqPlayerIndex = 0;
    seqShowingSequence = false;
    
    // Clear all tile states
    for (var i = 0; i < seqTiles.length; i++) {
        seqTiles[i].classList.remove('lit', 'correct', 'wrong');
    }
    
    setInstruction(currentLang === 'es' ? 'Observa la secuencia...' : 'Watch the sequence...');
    seqDisableTiles(true);
    
    // Generate sequence - length increases with rounds
    var config = tierConfig[selectedTier];
    var length = config.seqStart + Math.floor(currentRound / 2);
    if (length < 2) length = 2;
    if (length > 10) length = 10;
    
    seqSequence = [];
    for (var i = 0; i < length; i++) {
        seqSequence.push(Math.floor(Math.random() * 4));
    }
    
    // Show sequence after pause
    setTimeout(seqShowSequence, 1000);
}

function seqShowSequence() {
    if (!gameActive) return;
    
    seqShowingSequence = true;
    
    var rhythm = rhythmConfig[selectedRhythm];
    var speedMod = tierConfig[selectedTier].speedMod;
    
    // Calculate timing - make sure it's reasonable
    var noteLen = Math.max(300, rhythm.noteLength * speedMod);
    var pauseLen = Math.max(150, rhythm.pauseAfter * speedMod);
    
    var currentIndex = 0;
    
    function lightTile() {
        if (!gameActive) return;
        if (currentIndex >= seqSequence.length) {
            // Done showing sequence
            finishSequence();
            return;
        }
        
        var tileIdx = seqSequence[currentIndex];
        var tile = seqTiles[tileIdx];
        
        if (!tile) {
            finishSequence();
            return;
        }
        
        // Light up
        tile.classList.add('lit');
        seqPlaySound(tileIdx);
        
        // Schedule turn off
        setTimeout(function() {
            tile.classList.remove('lit');
            currentIndex++;
            
            // Schedule next tile
            setTimeout(lightTile, pauseLen);
        }, noteLen);
    }
    
    function finishSequence() {
        seqShowingSequence = false;
        setInstruction(currentLang === 'es' ? '¬°Tu turno!' : 'Your turn!');
        seqDisableTiles(false);
    }
    
    // Start showing
    lightTile();
}

function seqTileClick(index) {
    // Ignore clicks during sequence or when inactive
    if (seqShowingSequence) return;
    if (!gameActive) return;
    if (seqSequence.length === 0) return;
    if (index < 0 || index >= seqTiles.length) return;
    
    var tile = seqTiles[index];
    if (!tile) return;
    
    // Visual and audio feedback
    tile.classList.add('lit');
    seqPlaySound(index);
    
    // Remove lit after short delay
    setTimeout(function() {
        tile.classList.remove('lit');
    }, 150);
    
    // Check answer
    var expected = seqSequence[seqPlayerIndex];
    
    if (index === expected) {
        // Correct!
        tile.classList.add('correct');
        setTimeout(function() { 
            tile.classList.remove('correct'); 
        }, 200);
        
        seqPlayerIndex++;
        
        // Check if complete
        if (seqPlayerIndex >= seqSequence.length) {
            // Round complete!
            seqDisableTiles(true);
            
            var points = seqSequence.length * 15;
            addScore(points);
            playSuccessSound();
            setInstruction('‚úì +' + points + '!');
            
            setTimeout(nextRound, 1500);
        }
    } else {
        // Wrong!
        tile.classList.add('wrong');
        playErrorSound();
        seqDisableTiles(true);
        
        setTimeout(function() { 
            tile.classList.remove('wrong'); 
        }, 400);
        
        // Partial points
        var partial = seqPlayerIndex * 5;
        if (partial > 0) {
            addScore(partial);
            setInstruction('+' + partial);
        } else {
            setInstruction(currentLang === 'es' ? '¬°Int√©ntalo!' : 'Try again!');
        }
        
        setTimeout(nextRound, 1200);
    }
}

// =====================================================
// GAME 2: MEMORY STARTRAIL (Colored Stars with Trail)
// =====================================================
var starNodes = [];
var trailSequence = [];
var trailPlayerIndex = 0;
var completedStars = [];
var trailShowingSequence = false;
var starColors = ['color-0', 'color-1', 'color-2', 'color-3', 'color-4', 'color-5'];

function startTrailGame() {
    var area = document.getElementById('gameArea');
    area.innerHTML = '<div class="trail-area" id="trailArea"><canvas class="trail-canvas" id="trailCanvas"></canvas></div>';
    
    // Reset all trail state
    starNodes = [];
    trailSequence = [];
    trailPlayerIndex = 0;
    completedStars = [];
    trailShowingSequence = false;
    
    gameActive = true;
    
    // Small delay to ensure DOM is ready
    setTimeout(trailNewRound, 100);
}

function trailNewRound() {
    if (!gameActive) return;
    
    // FIRST: Clear completed stars and trail BEFORE anything else
    completedStars = [];
    trailPlayerIndex = 0;
    trailShowingSequence = false;
    
    // Clear the canvas immediately
    var canvas = document.getElementById('trailCanvas');
    if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    setInstruction(currentLang === 'es' ? 'Observa las estrellas...' : 'Watch the stars...');
    
    var config = tierConfig[selectedTier];
    var numStars = config.seqStart + 2 + Math.floor((currentRound - 1) / 2);
    if (numStars > 8) numStars = 8;
    if (numStars < 4) numStars = 4;
    
    // Generate star positions
    generateStarPositions(numStars);
    
    // NOW render (completedStars is already empty)
    renderStars();
    
    // Generate sequence - ensure we have valid indices
    trailSequence = [];
    var available = [];
    for (var i = 0; i < numStars; i++) available.push(i);
    
    var seqLen = Math.min(numStars, config.seqStart + Math.floor(currentRound / 2));
    if (seqLen < 2) seqLen = 2;
    
    for (var i = 0; i < seqLen; i++) {
        if (available.length === 0) break;
        var idx = Math.floor(Math.random() * available.length);
        trailSequence.push(available[idx]);
        available.splice(idx, 1);
    }
    
    // Safety check - must have at least 2 items in sequence
    if (trailSequence.length < 2) {
        console.error('Invalid sequence generated');
        trailSequence = [0, 1];
    }
    
    trailShowingSequence = true;
    
    // Disable stars during sequence
    disableStars(true);
    
    setTimeout(showTrailSequence, 600);
}

function generateStarPositions(numStars) {
    var area = document.getElementById('trailArea');
    var width = area.offsetWidth || 300;
    var height = area.offsetHeight || 300;
    var padding = 40;
    
    starNodes = [];
    
    for (var i = 0; i < numStars; i++) {
        var attempts = 0;
        var x, y, valid;
        
        do {
            x = padding + Math.random() * (width - padding * 2);
            y = padding + Math.random() * (height - padding * 2);
            valid = true;
            
            for (var j = 0; j < starNodes.length; j++) {
                var dx = x - starNodes[j].x;
                var dy = y - starNodes[j].y;
                if (Math.sqrt(dx*dx + dy*dy) < 60) {
                    valid = false;
                    break;
                }
            }
            attempts++;
        } while (!valid && attempts < 50);
        
        starNodes.push({
            x: x,
            y: y,
            colorIndex: i % starColors.length
        });
    }
}

function renderStars() {
    var area = document.getElementById('trailArea');
    if (!area) return;
    
    // Remove old stars
    var oldStars = area.querySelectorAll('.star-node');
    oldStars.forEach(function(s) { s.remove(); });
    
    // Create new stars (fresh - no completed state on new round)
    for (var i = 0; i < starNodes.length; i++) {
        var star = document.createElement('div');
        star.className = 'star-node ' + starColors[starNodes[i].colorIndex];
        star.dataset.index = i;
        star.style.left = starNodes[i].x + 'px';
        star.style.top = starNodes[i].y + 'px';
        star.innerHTML = starSVG;
        
        (function(idx) {
            star.addEventListener('click', function() {
                handleStarClick(idx);
            });
        })(i);
        
        area.appendChild(star);
    }
    
    // Clear trail lines (fresh round = no trail)
    clearTrailLines();
}

function clearTrailLines() {
    var canvas = document.getElementById('trailCanvas');
    var area = document.getElementById('trailArea');
    if (!canvas || !area) return;
    
    canvas.width = area.offsetWidth;
    canvas.height = area.offsetHeight;
    
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function drawTrailLines() {
    var canvas = document.getElementById('trailCanvas');
    var area = document.getElementById('trailArea');
    if (!canvas || !area) return;
    
    canvas.width = area.offsetWidth;
    canvas.height = area.offsetHeight;
    
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Need at least 2 completed stars to draw a line
    if (completedStars.length < 2) return;
    
    ctx.strokeStyle = '#00D9A5';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.shadowColor = '#00D9A5';
    ctx.shadowBlur = 10;
    
    ctx.beginPath();
    
    for (var i = 0; i < completedStars.length; i++) {
        var starIdx = completedStars[i];
        var node = starNodes[starIdx];
        
        if (!node) continue;
        
        if (i === 0) {
            ctx.moveTo(node.x, node.y);
        } else {
            ctx.lineTo(node.x, node.y);
        }
    }
    
    ctx.stroke();
}

function showTrailSequence() {
    if (!gameActive || trailSequence.length === 0) {
        trailShowingSequence = false;
        disableStars(false);
        return;
    }
    
    var rhythm = rhythmConfig[selectedRhythm];
    var speed = rhythm.noteLength * tierConfig[selectedTier].speedMod;
    var i = 0;
    
    function showNext() {
        if (!gameActive) return;
        
        // Remove previous lit state
        if (i > 0 && i <= trailSequence.length) {
            var prevIdx = trailSequence[i-1];
            var prevStar = document.querySelector('.star-node[data-index="' + prevIdx + '"]');
            if (prevStar) prevStar.classList.remove('lit');
        }
        
        if (i < trailSequence.length) {
            var starIdx = trailSequence[i];
            var starEl = document.querySelector('.star-node[data-index="' + starIdx + '"]');
            
            if (starEl && starNodes[starIdx]) {
                starEl.classList.add('lit');
                playStarSound(starNodes[starIdx].colorIndex);
            }
            
            i++;
            setTimeout(showNext, speed);
        } else {
            // Sequence complete - enable player input
            setTimeout(function() {
                // Remove last lit state
                if (trailSequence.length > 0) {
                    var lastIdx = trailSequence[trailSequence.length - 1];
                    var lastStar = document.querySelector('.star-node[data-index="' + lastIdx + '"]');
                    if (lastStar) lastStar.classList.remove('lit');
                }
                
                trailShowingSequence = false;
                setInstruction(currentLang === 'es' ? '¬°Tu turno! Conecta las estrellas' : 'Your turn! Connect the stars');
                disableStars(false);
            }, speed);
        }
    }
    
    showNext();
}

function handleStarClick(index) {
    if (trailShowingSequence || !gameActive) return;
    if (trailSequence.length === 0) return;
    
    var starEl = document.querySelector('.star-node[data-index="' + index + '"]');
    if (!starEl) return;
    
    var expectedIdx = trailSequence[trailPlayerIndex];
    
    if (index === expectedIdx) {
        // Correct!
        completedStars.push(index);
        starEl.classList.add('completed');
        
        if (starNodes[index]) {
            playStarSound(starNodes[index].colorIndex);
        }
        
        // Draw trail line to this star
        drawTrailLines();
        
        trailPlayerIndex++;
        
        if (trailPlayerIndex >= trailSequence.length) {
            // Round complete!
            var points = trailSequence.length * 20;
            addScore(points);
            playSuccessSound();
            setInstruction('+' + points + '!');
            disableStars(true);
            
            setTimeout(nextRound, 1000);
        }
    } else {
        // Wrong!
        starEl.classList.add('error');
        playErrorSound();
        
        setTimeout(function() {
            starEl.classList.remove('error');
        }, 300);
        
        // Partial points and move on
        var partial = trailPlayerIndex * 8;
        if (partial > 0) addScore(partial);
        
        setTimeout(nextRound, 800);
    }
}

function disableStars(disabled) {
    var stars = document.querySelectorAll('.star-node');
    stars.forEach(function(s) {
        s.style.pointerEvents = disabled ? 'none' : 'auto';
    });
}

// =====================================================
// GAME FLOW CONTROL
// =====================================================

function setInstruction(text) {
    document.getElementById('gameInstruction').textContent = text;
}

function addScore(points) {
    currentGameScore += points;
    if (currentGameScore < 0) currentGameScore = 0;
    document.getElementById('currentScore').textContent = currentGameScore;
}

function nextRound() {
    if (!gameActive) return;
    
    var config = tierConfig[selectedTier];
    currentRound++;
    
    if (currentRound > config.roundsPerQuarter) {
        currentRound = 1;
        currentQuarter++;
        
        if (currentQuarter > config.quarters) {
            endCurrentGame();
            return;
        }
    }
    
    document.getElementById('currentRound').textContent = currentRound;
    updateQuarterProgress();
    
    var game = games[currentGameIndex];
    var delay = rhythmConfig[selectedRhythm].pauseAfter + 500;
    
    setTimeout(function() {
        if (game.id === 'sequence') {
            seqNewRound();
        } else {
            trailNewRound();
        }
    }, delay);
}

function endCurrentGame() {
    gameActive = false;
    gameScores[currentGameIndex] = currentGameScore;
    
    currentGameIndex++;
    updateProgress();
    
    if (currentGameIndex >= games.length) {
        showFinalScreen();
    } else {
        showTransition();
    }
}

function showTransition() {
    var nextGame = games[currentGameIndex];
    
    document.getElementById('transitionIcon').textContent = '‚úÖ';
    document.getElementById('transitionScore').textContent = gameScores[currentGameIndex - 1];
    document.getElementById('nextGameName').textContent = nextGame.icon + ' ' + (currentLang === 'es' ? nextGame.nameEs : nextGame.name);
    document.getElementById('nextGamePreview').style.display = 'block';
    
    showScreen('transitionScreen');
    
    var countdown = rhythmConfig[selectedRhythm].transition;
    document.getElementById('transitionCountdown').textContent = countdown;
    
    var interval = setInterval(function() {
        countdown--;
        if (countdown > 0) {
            document.getElementById('transitionCountdown').textContent = countdown;
        } else {
            clearInterval(interval);
            showCountdown();
        }
    }, 1000);
}

function showFinalScreen() {
    document.getElementById('progressBar').style.display = 'none';
    
    var total = gameScores[0] + gameScores[1];
    document.getElementById('finalScore1').textContent = gameScores[0];
    document.getElementById('finalScore2').textContent = gameScores[1];
    document.getElementById('finalTotal').textContent = total;
    
    showScreen('finalScreen');
    
    // Record to API
    recordChallenge(total);
}

function recordChallenge(total) {
    var accessCode = sessionStorage.getItem('gostar-user-code');
    var username = sessionStorage.getItem('gostar-user-name');
    
    if (!accessCode || !username) return;
    
    fetch('/api/game/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            accessCode: accessCode,
            username: username,
            game: 'sequence-challenge',
            score: total
        })
    }).catch(function() {});
}

function restartChallenge() {
    showScreen('welcomeScreen');
    document.getElementById('progressBar').style.display = 'none';
}

// Initialize
document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.textContent.trim() === currentLang.toUpperCase());
});
</script>

</body>
</html>
