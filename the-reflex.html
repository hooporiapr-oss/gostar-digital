<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>THE REFLEX | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --green: #00E676;
    --green-dark: #00C853;
    --lime: #C6FF00;
    --gold: #FFD700;
    --teal: #00D9A5;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --danger: #FF4757;
    --border: rgba(255,255,255,0.08);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    height: 100%;
    overflow: hidden;
}
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100vh;
    height: 100dvh;
}
body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

/* Main Container - NO SCROLL */
.game-container {
    max-width: 420px;
    margin: 0 auto;
    padding: 8px 12px;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Language Toggle */
.lang-toggle {
    position: absolute;
    top: 8px;
    right: 12px;
    display: flex;
    gap: 4px;
    z-index: 10;
}
.lang-btn {
    padding: 4px 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.lang-btn.active {
    background: var(--green);
    color: var(--dark);
    border-color: var(--green);
}

/* Back Button */
.back-btn {
    position: absolute;
    top: 8px;
    left: 12px;
    color: var(--muted);
    text-decoration: none;
    font-size: 0.7rem;
    z-index: 10;
}
.back-btn:hover { color: var(--text); }

/* Header - Compact */
.header {
    text-align: center;
    padding: 6px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--green), var(--lime));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.powered-by {
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
}
.powered-by .ritnome { color: var(--gold); font-weight: 700; }

/* Stats Bar - Compact */
.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 6px 10px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--gold);
}
.stat-value.green { color: var(--green); }
.stat-label {
    font-size: 0.5rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Message Display */
.message-display {
    background: linear-gradient(135deg, var(--card), var(--darker));
    border: 2px solid var(--green);
    border-radius: 10px;
    padding: 8px 12px;
    margin: 4px 0;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}
.message-display::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, rgba(0,230,118,0.1), transparent);
    pointer-events: none;
}
.message-text {
    font-size: 0.75rem;
    color: var(--muted);
    text-align: center;
}
.message-text.success { color: var(--green); }
.message-text.fail { color: var(--danger); }
.reaction-time {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    color: var(--lime);
    text-shadow: 0 0 20px rgba(198,255,0,0.5);
}

/* Ritnome‚Ñ¢ Tempo Selector - Inline */
.tempo-section {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tempo-label {
    font-size: 0.55rem;
    color: var(--muted);
    white-space: nowrap;
}
.tempo-label .ritnome { color: var(--gold); font-weight: 700; }
.tempo-buttons {
    display: flex;
    gap: 4px;
    flex: 1;
}
.tempo-btn {
    flex: 1;
    padding: 6px 4px;
    border: 1px solid var(--card);
    background: var(--card);
    border-radius: 6px;
    color: var(--muted);
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
}
.tempo-btn .icon { font-size: 0.8rem; }
.tempo-btn .bpm { font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; }
.tempo-btn.active {
    border-color: var(--gold);
    color: var(--gold);
    background: rgba(255,215,0,0.1);
}

/* Court Grid - VISIBLE CELLS */
.court-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 8px;
    background: linear-gradient(145deg, var(--card), var(--darker));
    border-radius: 12px;
    border: 2px solid rgba(0,230,118,0.3);
    min-height: 0;
    aspect-ratio: 1;
    margin: 4px 0;
}
.grid-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
    background: linear-gradient(145deg, #1a1a24, #12121a);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
}
.grid-cell::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.15s;
    border-radius: 5px;
}
.grid-cell.lit {
    animation: pulse 0.5s ease-in-out infinite;
}
.grid-cell.lit::before {
    opacity: 1;
    background: linear-gradient(135deg, var(--green), var(--lime));
}
.grid-cell.hit::before {
    opacity: 1;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    animation: hitFlash 0.3s ease;
}
.grid-cell.miss::before {
    opacity: 1;
    background: linear-gradient(135deg, var(--danger), #FF6B6B);
    animation: missShake 0.4s ease;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 15px var(--green); }
    50% { transform: scale(0.95); box-shadow: 0 0 30px var(--green); }
}
@keyframes hitFlash {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
}
@keyframes missShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

/* Timer Ring inside cell */
.timer-container {
    position: absolute;
    width: 30px;
    height: 30px;
    display: none;
}
.grid-cell.lit .timer-container { display: block; }
.timer-ring {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: var(--gold);
    animation: timerSpin linear forwards;
}
@keyframes timerSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Progress Bar */
.progress-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tier-badge {
    background: linear-gradient(135deg, var(--green), var(--lime));
    padding: 4px 10px;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 1px;
    white-space: nowrap;
    color: var(--dark);
}
.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--card);
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--green), var(--lime));
    border-radius: 4px;
    transition: width 0.3s ease-out;
}

/* Action Button */
.action-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
    background: linear-gradient(135deg, var(--green), var(--green-dark));
    color: var(--dark);
    flex-shrink: 0;
}
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(0,230,118,0.5);
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Feedback Overlay */
.feedback-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 90%;
    animation: slideUp 0.3s ease-out;
    border: 2px solid var(--green);
}
@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.feedback-emoji { font-size: 3rem; margin-bottom: 10px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 2px;
    margin-bottom: 8px;
}
.feedback-title.success { color: var(--green); }
.feedback-title.fail { color: var(--danger); }
.feedback-laughs {
    font-size: 1.3rem;
    color: var(--gold);
    margin-bottom: 8px;
}
.feedback-ritnome {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 15px;
}
.feedback-ritnome .ritnome { color: var(--gold); }
.feedback-stats {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 20px;
    line-height: 1.5;
}
.feedback-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 4px;
}
.feedback-btn.primary {
    background: linear-gradient(135deg, var(--green), var(--green-dark));
    color: var(--dark);
}
.feedback-btn.secondary {
    background: var(--darker);
    color: var(--muted);
    border: 1px solid var(--muted);
}

/* Tier Up Overlay */
.tier-up-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.tier-up-overlay.show { display: flex; }
.tier-up-content {
    text-align: center;
    animation: tierUpBounce 0.5s ease;
}
@keyframes tierUpBounce {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}
.tier-up-emoji { font-size: 3rem; margin-bottom: 10px; }
.tier-up-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    letter-spacing: 3px;
    color: var(--green);
    margin-bottom: 8px;
}
.tier-up-sub {
    font-size: 1rem;
    color: var(--gold);
    margin-bottom: 20px;
}
.tier-up-ritnome {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 15px;
}
.tier-up-ritnome .ritnome { color: var(--gold); }
.tier-up-btn {
    padding: 12px 30px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    border: none;
    border-radius: 10px;
    cursor: pointer;
}

/* Coach Message Toast */
.coach-message {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--green), var(--lime));
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--dark);
    opacity: 0;
    transition: all 0.4s ease-out;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Desktop */
@media (min-width: 700px) {
    .game-container {
        max-width: 480px;
        padding: 15px 20px;
    }
    .header { padding: 10px 0; }
    .logo { font-size: 1.2rem; }
    .court-name { font-size: 1.8rem; }
    .stats-bar { padding: 10px 15px; gap: 25px; }
    .stat-value { font-size: 1.4rem; }
    .court-grid { gap: 6px; padding: 12px; }
    .grid-cell { border-radius: 8px; }
    .action-btn { padding: 16px; font-size: 1.3rem; }
}
</style>
</head>
<body class="en">

<!-- Language Toggle -->
<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<!-- Back Button -->
<a href="laugh-hub.html" class="back-btn">‚Üê <span class="lang-en">Back</span><span class="lang-es">Volver</span></a>

<div class="game-container">
    <!-- Header -->
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT<sup style="font-size:0.5em">‚Ñ¢</sup></div>
        <div class="court-name">‚ö° THE REFLEX</div>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value green" id="currentTier">1</div>
            <div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
        <div class="stat">
            <div class="stat-value green" id="avgTime">---</div>
            <div class="stat-label">‚ö° MS</div>
        </div>
    </div>

    <!-- Message Display -->
    <div class="message-display" id="messageDisplay">
        <span class="message-text" id="messageText">
            <span class="lang-en">‚ö° React FAST! Tap the green squares before they vanish!</span>
            <span class="lang-es">‚ö° ¬°Reacciona R√ÅPIDO! ¬°Toca los cuadros verdes!</span>
        </span>
    </div>

    <!-- Ritnome‚Ñ¢ Tempo Selector -->
    <div class="tempo-section">
        <div class="tempo-label">üéµ <span class="ritnome">Ritnome‚Ñ¢</span></div>
        <div class="tempo-buttons">
            <button class="tempo-btn" data-bpm="60">
                <span class="icon">üê¢</span>
                <span class="bpm">60</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn active" data-bpm="90">
                <span class="icon">üèÉ</span>
                <span class="bpm">90</span>
                <span>BPM</span>
            </button>
            <button class="tempo-btn" data-bpm="120">
                <span class="icon">‚ö°</span>
                <span class="bpm">120</span>
                <span>BPM</span>
            </button>
        </div>
    </div>

    <!-- Court Grid -->
    <div class="court-grid" id="courtGrid"></div>

    <!-- Progress Bar -->
    <div class="progress-section">
        <div class="tier-badge">
            <span class="lang-en">TIER</span><span class="lang-es">NIVEL</span> 
            <span id="tierDisplay">1</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Action Button -->
    <button class="action-btn" id="actionBtn">
        <span class="lang-en">START REFLEX ‚ö°</span>
        <span class="lang-es">INICIAR REFLEJOS ‚ö°</span>
    </button>
</div>

<!-- Feedback Overlay -->
<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">‚ö°</div>
        <h2 class="feedback-title" id="feedbackTitle">LIGHTNING FAST!</h2>
        <div class="feedback-laughs" id="feedbackLaughs">+5 üòÇ</div>
        <div class="feedback-ritnome"><span class="ritnome">Ritnome‚Ñ¢</span> Training</div>
        <div class="feedback-stats" id="feedbackStats"></div>
        <button class="feedback-btn primary" id="continueBtn">
            <span class="lang-en">NEXT ROUND ‚ö°</span>
            <span class="lang-es">SIGUIENTE ‚ö°</span>
        </button>
        <button class="feedback-btn secondary" id="restartBtn">
            <span class="lang-en">RESTART</span>
            <span class="lang-es">REINICIAR</span>
        </button>
    </div>
</div>

<!-- Tier Up Overlay -->
<div class="tier-up-overlay" id="tierUpOverlay">
    <div class="tier-up-content">
        <div class="tier-up-emoji">‚ö°üèÜ‚ö°</div>
        <div class="tier-up-text">
            <span class="lang-en">TIER UP!</span>
            <span class="lang-es">¬°SUBISTE DE NIVEL!</span>
        </div>
        <div class="tier-up-sub" id="tierUpSub"></div>
        <div class="tier-up-ritnome"><span class="ritnome">Ritnome‚Ñ¢</span> Training</div>
        <button class="tier-up-btn" id="tierUpBtn">
            <span class="lang-en">KEEP GOING!</span>
            <span class="lang-es">¬°CONTINUAR!</span>
        </button>
    </div>
</div>

<!-- Coach Message Toast -->
<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // Translations
    const translations = {
        en: {
            startReflex: 'START REFLEX ‚ö°',
            nextRound: 'NEXT ROUND ‚ö°',
            ready: 'GET READY...',
            go: 'GO! TAP THE GREEN! ‚ö°',
            hit: 'NICE! Keep going!',
            miss: 'Too slow! Try again!',
            wrongCell: 'Wrong cell! Focus!',
            lightningFast: 'LIGHTNING FAST! ‚ö°',
            perfectRound: 'PERFECT ROUND! üéØ',
            goodReflexes: 'Good reflexes! üí™',
            keepPracticing: 'Keep practicing! üèÄ',
            failed: 'ROUND FAILED',
            avgReaction: 'Avg Reaction',
            circuit: 'Circuit',
            caught: 'Caught',
            tierUp: 'TIER UP!',
            nowTier: 'Now TIER',
            catch: 'Catch',
            squares: 'squares!',
            startTier: 'START TIER'
        },
        es: {
            startReflex: 'INICIAR REFLEJOS ‚ö°',
            nextRound: 'SIGUIENTE ‚ö°',
            ready: 'PREP√ÅRATE...',
            go: '¬°YA! ¬°TOCA EL VERDE! ‚ö°',
            hit: '¬°BIEN! ¬°Sigue as√≠!',
            miss: '¬°Muy lento! ¬°Intenta de nuevo!',
            wrongCell: '¬°Celda incorrecta! ¬°Enf√≥cate!',
            lightningFast: '¬°VELOZ COMO RAYO! ‚ö°',
            perfectRound: '¬°RONDA PERFECTA! üéØ',
            goodReflexes: '¬°Buenos reflejos! üí™',
            keepPracticing: '¬°Sigue practicando! üèÄ',
            failed: 'RONDA FALLIDA',
            avgReaction: 'Reacci√≥n Promedio',
            circuit: 'Circuito',
            caught: 'Capturados',
            tierUp: '¬°SUBISTE DE NIVEL!',
            nowTier: 'Ahora NIVEL',
            catch: 'Atrapa',
            squares: 'cuadros!',
            startTier: 'INICIAR NIVEL'
        }
    };

    let currentLang = 'en';
    const t = (key) => translations[currentLang][key] || key;

    function setLang(lang) {
        currentLang = lang;
        document.body.className = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.id === 'btn' + lang.charAt(0).toUpperCase() + lang.slice(1));
        });
    }

    // Game State
    const state = {
        tier: 1,
        totalLaughs: 0,
        streak: 0,
        circuitsCompleted: 0,
        bpm: 90,
        playing: false,
        currentIndex: 0,
        targetCell: null,
        reactionTimes: [],
        roundStartTime: 0,
        cellTimeout: null
    };

    // BPM to cell lit duration (faster BPM = less time)
    const getBpmDuration = (bpm) => {
        if (bpm === 60) return 1500;  // Slow
        if (bpm === 90) return 1000;  // Medium
        return 600;                    // Fast (120)
    };

    // Get targets for current tier (tier 1 = 5, tier 2 = 6, etc.)
    const getTargetCount = () => 4 + state.tier;

    // DOM Elements
    const courtGrid = document.getElementById('courtGrid');
    const messageDisplay = document.getElementById('messageDisplay');
    const messageText = document.getElementById('messageText');
    const actionBtn = document.getElementById('actionBtn');
    const feedbackOverlay = document.getElementById('feedbackOverlay');
    const tierUpOverlay = document.getElementById('tierUpOverlay');
    const coachMessage = document.getElementById('coachMessage');

    // Initialize grid
    function initGrid() {
        courtGrid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.index = i;
            
            const timerContainer = document.createElement('div');
            timerContainer.className = 'timer-container';
            const timerRing = document.createElement('div');
            timerRing.className = 'timer-ring';
            timerContainer.appendChild(timerRing);
            cell.appendChild(timerContainer);
            
            cell.addEventListener('click', () => handleCellClick(i, cell));
            courtGrid.appendChild(cell);
        }
    }

    // Light up random cell
    function lightCell() {
        // Clear any previously lit cell
        const cells = document.querySelectorAll('.grid-cell');
        cells.forEach(c => c.classList.remove('lit', 'hit', 'miss'));

        // Pick random cell
        const randomIndex = Math.floor(Math.random() * 25);
        state.targetCell = randomIndex;
        state.roundStartTime = Date.now();

        const cell = cells[randomIndex];
        cell.classList.add('lit');

        // Set timer animation duration based on BPM
        const duration = getBpmDuration(state.bpm);
        const timerRing = cell.querySelector('.timer-ring');
        timerRing.style.animationDuration = duration + 'ms';

        // Start timeout for miss
        state.cellTimeout = setTimeout(() => {
            if (state.playing && cell.classList.contains('lit')) {
                handleMiss(cell);
            }
        }, duration);
    }

    // Handle cell click
    function handleCellClick(index, cell) {
        if (!state.playing) return;

        if (index === state.targetCell && cell.classList.contains('lit')) {
            // HIT!
            clearTimeout(state.cellTimeout);
            const reactionTime = Date.now() - state.roundStartTime;
            state.reactionTimes.push(reactionTime);

            cell.classList.remove('lit');
            cell.classList.add('hit');

            // Show reaction time in message display
            messageDisplay.innerHTML = `<span class="reaction-time">${reactionTime}ms</span>`;

            // Calculate laughs with BPM bonus
            let laughsEarned = state.tier;
            if (state.bpm === 120) laughsEarned += 2;
            else if (state.bpm === 90) laughsEarned += 1;
            if (reactionTime < 300) laughsEarned += 2; // Quick reaction bonus

            state.totalLaughs += laughsEarned;
            state.currentIndex++;

            // Update progress
            const progress = (state.currentIndex / getTargetCount()) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            updateStats();

            // Check if round complete
            if (state.currentIndex >= getTargetCount()) {
                setTimeout(() => roundComplete(true), 300);
            } else {
                setTimeout(() => {
                    if (state.playing) lightCell();
                }, 400);
            }
        } else if (!cell.classList.contains('lit') && state.targetCell !== null) {
            // Wrong cell
            showCoachMessage(t('wrongCell'));
        }
    }

    // Handle miss (timeout)
    function handleMiss(cell) {
        cell.classList.remove('lit');
        cell.classList.add('miss');

        state.playing = false;
        state.streak = 0;

        messageDisplay.innerHTML = `<span class="message-text fail">${t('miss')}</span>`;

        setTimeout(() => roundComplete(false), 500);
    }

    // Round complete
    function roundComplete(success) {
        state.playing = false;
        clearTimeout(state.cellTimeout);

        const cells = document.querySelectorAll('.grid-cell');
        cells.forEach(c => c.classList.remove('lit', 'hit', 'miss'));

        if (success) {
            state.streak++;
            state.circuitsCompleted++;

            // Calculate average reaction time
            const avgTime = Math.round(state.reactionTimes.reduce((a, b) => a + b, 0) / state.reactionTimes.length);

            // Bonus laughs for fast average
            let bonusLaughs = 0;
            if (avgTime < 350) bonusLaughs = state.tier * 2;
            else if (avgTime < 500) bonusLaughs = state.tier;
            state.totalLaughs += bonusLaughs;

            // Show feedback
            const emoji = avgTime < 350 ? '‚ö°' : avgTime < 500 ? 'üéØ' : 'üí™';
            const title = avgTime < 350 ? t('lightningFast') : avgTime < 500 ? t('perfectRound') : t('goodReflexes');

            document.getElementById('feedbackEmoji').textContent = emoji;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackTitle').className = 'feedback-title success';
            document.getElementById('feedbackLaughs').textContent = '+' + (state.tier + bonusLaughs) + ' üòÇ';
            document.getElementById('feedbackStats').innerHTML = 
                t('avgReaction') + ': <strong>' + avgTime + 'ms</strong><br>' +
                t('circuit') + ': ' + state.circuitsCompleted + '/3';

            // Check for tier up
            if (state.circuitsCompleted >= 3 && state.tier < 10) {
                showTierUp();
            } else {
                feedbackOverlay.classList.add('show');
            }
        } else {
            document.getElementById('feedbackEmoji').textContent = 'üòÖ';
            document.getElementById('feedbackTitle').textContent = t('failed');
            document.getElementById('feedbackTitle').className = 'feedback-title fail';
            document.getElementById('feedbackLaughs').textContent = t('keepPracticing');
            document.getElementById('feedbackStats').innerHTML = 
                t('caught') + ': ' + state.currentIndex + '/' + getTargetCount();

            feedbackOverlay.classList.add('show');
        }

        updateStats();
    }

    // Show tier up
    function showTierUp() {
        state.tier++;
        state.circuitsCompleted = 0;

        document.getElementById('tierUpSub').innerHTML = 
            t('nowTier') + ' ' + state.tier + '!<br>' +
            t('catch') + ' ' + getTargetCount() + ' ' + t('squares');

        tierUpOverlay.classList.add('show');
        updateStats();
    }

    // Start game
    function startGame() {
        state.playing = true;
        state.currentIndex = 0;
        state.targetCell = null;
        state.reactionTimes = [];

        document.getElementById('progressFill').style.width = '0%';

        const cells = document.querySelectorAll('.grid-cell');
        cells.forEach(c => c.classList.remove('lit', 'hit', 'miss'));

        actionBtn.disabled = true;
        messageDisplay.innerHTML = `<span class="message-text">${t('ready')}</span>`;

        setTimeout(() => {
            messageDisplay.innerHTML = `<span class="message-text success">${t('go')}</span>`;
            lightCell();
        }, 1000);
    }

    // Update stats
    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;

        if (state.reactionTimes.length > 0) {
            const avg = Math.round(state.reactionTimes.reduce((a, b) => a + b, 0) / state.reactionTimes.length);
            document.getElementById('avgTime').textContent = avg;
        }
    }

    function showCoachMessage(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(() => coachMessage.classList.remove('show'), 2500);
    }

    // Event Listeners
    actionBtn.addEventListener('click', startGame);

    document.querySelectorAll('.tempo-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (state.playing) return;
            document.querySelectorAll('.tempo-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.bpm = parseInt(btn.dataset.bpm);
        });
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        actionBtn.disabled = false;
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.nextRound}</span><span class="lang-es">${translations.es.nextRound}</span>`;
        messageDisplay.innerHTML = `<span class="message-text"><span class="lang-en">Ready for round!</span><span class="lang-es">¬°Listo para la ronda!</span></span>`;
        setLang(currentLang);
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuitsCompleted = 0;
        state.streak = 0;
        state.reactionTimes = [];
        document.getElementById('avgTime').textContent = '---';
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.disabled = false;
        actionBtn.innerHTML = `<span class="lang-en">${translations.en.startReflex}</span><span class="lang-es">${translations.es.startReflex}</span>`;
        messageDisplay.innerHTML = `<span class="message-text"><span class="lang-en">‚ö° React FAST! Tap the green squares before they vanish!</span><span class="lang-es">‚ö° ¬°Reacciona R√ÅPIDO! ¬°Toca los cuadros verdes!</span></span>`;
        setLang(currentLang);
        updateStats();
    });

    document.getElementById('tierUpBtn').addEventListener('click', () => {
        tierUpOverlay.classList.remove('show');
        actionBtn.disabled = false;
        actionBtn.innerHTML = `<span class="lang-en">${t('startTier')} ${state.tier} ‚ö°</span><span class="lang-es">${translations.es.startTier} ${state.tier} ‚ö°</span>`;
        setLang(currentLang);
    });

    document.getElementById('btnEn').addEventListener('click', () => setLang('en'));
    document.getElementById('btnEs').addEventListener('click', () => setLang('es'));

    // Initialize
    initGrid();
    setLang(currentLang);
    updateStats();
})();
</script>
</body>
</html>
