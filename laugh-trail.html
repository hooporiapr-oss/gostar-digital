<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LAUGH TRAIL üòÇ | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--purple:#6B21A8;--purple-dark:#581C87;--purple-light:#9333EA;--orange:#FF6B00;--teal:#00D9A5;--gold:#FFD700;--pink:#FF69B4;--dark:#0a0a0f;--card:#111118;--text:#FFFFFF;--muted:#8892a0;--success:#00D9A5;--danger:#FF4757;--trail:#FF6B00}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',sans-serif;background:var(--dark);color:var(--text);user-select:none;-webkit-user-select:none}
body.es .lang-en{display:none!important}
body.en .lang-es{display:none!important}

.game-header{padding:12px 15px;background:linear-gradient(135deg,rgba(255,107,0,0.2),rgba(255,215,0,0.1));border-bottom:2px solid rgba(255,107,0,0.3);display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:10px}
.back-btn{width:36px;height:36px;background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.coach-avatar{width:36px;height:36px;border-radius:50%;overflow:hidden}
.coach-avatar img{width:100%;height:100%;object-fit:cover}
.game-title{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px}
.game-title .laugh{color:var(--trail)}
.game-title .trail{color:var(--gold)}
.tier-badge{background:linear-gradient(135deg,var(--trail),var(--gold));padding:5px 12px;border-radius:15px;font-weight:700;font-size:0.7rem;color:var(--dark)}
.lang-toggle{display:flex;gap:4px}
.lang-btn{padding:5px 10px;border:2px solid var(--trail);background:transparent;color:var(--trail);border-radius:12px;font-weight:700;font-size:0.65rem;cursor:pointer}
.lang-btn.active{background:var(--trail);color:var(--text)}

.game-container{height:calc(100vh - 70px);display:flex;flex-direction:column;align-items:center;padding:15px;position:relative;overflow:hidden}

/* Intro Screen */
.intro-screen{text-align:center;max-width:380px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
.intro-icon{font-size:4rem;margin-bottom:10px;animation:bounce 2s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.intro-title{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:3px;margin-bottom:5px}
.intro-title .laugh{color:var(--trail)}
.intro-title .trail{color:var(--gold)}
.intro-subtitle{color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:2px;margin-bottom:15px;font-size:0.9rem}
.intro-desc{color:var(--muted);line-height:1.5;margin-bottom:20px;font-size:0.9rem}
.intro-desc strong{color:var(--text)}

.tier-section{width:100%;max-width:320px;margin-bottom:15px}
.section-label{font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px;color:var(--muted);margin-bottom:8px;text-align:center}
.tier-select{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.tier-btn{padding:8px 12px;background:var(--card);border:2px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--muted);font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:1px;cursor:pointer;transition:all 0.2s}
.tier-btn:hover:not(.locked){border-color:var(--trail)}
.tier-btn.selected{border-color:var(--gold);background:rgba(255,215,0,0.1);color:var(--gold)}
.tier-btn.locked{opacity:0.4;cursor:not-allowed}
.tier-btn.mastered{border-color:var(--success);color:var(--success)}

.start-btn{padding:16px 45px;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark);border:none;border-radius:40px;cursor:pointer;box-shadow:0 6px 25px rgba(255,215,0,0.4);margin-top:10px}

/* Game Screen */
.game-screen{width:100%;height:100%;display:flex;flex-direction:column;align-items:center}

.status-box{background:linear-gradient(135deg,rgba(255,107,0,0.2),rgba(255,215,0,0.1));border:2px solid var(--trail);border-radius:15px;padding:12px 25px;margin-bottom:15px;text-align:center}
.status-text{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;color:var(--gold)}
.status-sub{font-size:0.75rem;color:var(--muted);margin-top:3px}

.round-info{display:flex;gap:20px;margin-bottom:12px}
.round-box{text-align:center}
.round-value{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--trail)}
.round-label{font-size:0.65rem;color:var(--muted)}

.grid-container{position:relative}
.trail-grid{display:grid;gap:4px;background:var(--card);border:3px solid var(--trail);border-radius:15px;padding:10px}
.grid-box{width:36px;height:36px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;transition:all 0.15s}
.grid-box:hover:not(.disabled){background:rgba(255,107,0,0.15)}
.grid-box.disabled{cursor:default}
.grid-box.lit{background:linear-gradient(135deg,var(--trail),var(--gold));border-color:var(--gold);box-shadow:0 0 15px rgba(255,107,0,0.6);transform:scale(1.05)}
.grid-box.selected{background:rgba(0,217,165,0.4);border-color:var(--success)}
.grid-box.correct{background:linear-gradient(135deg,var(--success),var(--teal));border-color:var(--success);box-shadow:0 0 12px rgba(0,217,165,0.5)}
.grid-box.wrong{background:rgba(255,71,87,0.5);border-color:var(--danger);animation:shake 0.3s}
.grid-box.reveal{animation:revealPop 0.4s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
@keyframes revealPop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

.emoji-reveal{font-size:1.1rem;animation:emojiPop 0.3s ease}
@keyframes emojiPop{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}

.stats-row{display:flex;gap:25px;margin-top:15px}
.stat-box{text-align:center}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--gold)}
.stat-label{font-size:0.65rem;color:var(--muted)}

/* Laugh Counter */
.laugh-counter{position:fixed;top:75px;right:15px;background:var(--card);border:2px solid var(--gold);border-radius:12px;padding:8px 12px;z-index:100;text-align:center}
.laugh-counter-label{font-size:0.6rem;color:var(--muted);letter-spacing:1px}
.laugh-counter-row{display:flex;align-items:center;gap:5px}
.laugh-counter-icon{font-size:1.3rem;transition:all 0.3s}
.laugh-counter-icon.bounce{animation:laughBounce 0.5s ease}
.laugh-counter-icon.evolve{animation:laughEvolve 0.6s ease}
@keyframes laughBounce{0%{transform:scale(1)}30%{transform:scale(1.4)}50%{transform:scale(0.9)}70%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes laughEvolve{0%{transform:scale(1) rotate(0)}50%{transform:scale(1.5) rotate(10deg)}100%{transform:scale(1) rotate(0)}}
.laugh-counter-value{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--gold)}

/* Laugh Burst */
.laugh-burst{position:fixed;pointer-events:none;font-size:1.5rem;z-index:999}
.laugh-burst.burst-1{animation:burst1 1s ease-out forwards}
.laugh-burst.burst-2{animation:burst2 1s ease-out forwards}
.laugh-burst.burst-3{animation:burst3 1s ease-out forwards}
.laugh-burst.burst-4{animation:burst4 1s ease-out forwards}
.laugh-burst.burst-5{animation:burst5 1s ease-out forwards}
@keyframes burst1{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(-50px,-60px) scale(0.5)}}
@keyframes burst2{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(50px,-70px) scale(0.5)}}
@keyframes burst3{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(-30px,-80px) scale(0.5)}}
@keyframes burst4{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(60px,-50px) scale(0.5)}}
@keyframes burst5{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(0,-90px) scale(0.5)}}

/* Laugh Rain */
.laugh-rain{position:fixed;top:-50px;font-size:2rem;z-index:1000;animation:rainFall 2s ease-in forwards;pointer-events:none}
@keyframes rainFall{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(100vh) rotate(360deg)}}

/* Coach Bubble */
.coach-bubble{position:fixed;bottom:15px;left:15px;right:15px;background:var(--card);border:2px solid var(--trail);border-radius:15px;padding:12px;display:flex;align-items:center;gap:12px;z-index:50;transform:translateY(100px);opacity:0;transition:all 0.3s ease}
.coach-bubble.visible{transform:translateY(0);opacity:1}
.coach-bubble-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0}
.coach-bubble-avatar img{width:100%;height:100%;object-fit:cover}
.coach-bubble-text{font-size:0.85rem;line-height:1.4}

/* Result Screen */
.result-screen{text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
.result-icon{font-size:4rem;margin-bottom:15px}
.result-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:10px}
.result-title.success{color:var(--success)}
.result-title.fail{color:var(--danger)}
.result-stats{display:flex;gap:25px;margin:20px 0}
.result-stat{text-align:center}
.result-stat-value{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold)}
.result-stat-label{font-size:0.7rem;color:var(--muted)}
.result-btn{padding:14px 35px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark);border:none;border-radius:30px;cursor:pointer;margin:8px}
.result-btn.secondary{background:transparent;border:2px solid var(--muted);color:var(--muted)}

/* Confetti */
.confetti{position:fixed;width:10px;height:10px;top:-10px;z-index:1000;animation:fall 3s linear forwards}
@keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}

.hidden{display:none!important}

@media(max-width:360px){
.grid-box{width:30px;height:30px;font-size:1rem}
}
</style>
</head>
<body class="en">

<div class="game-header">
<div class="header-left">
<button class="back-btn" id="backBtn">‚Üê</button>
<div class="coach-avatar"><img src="go_chat.png" alt="Coach"></div>
<div>
<div class="game-title"><span class="laugh">LAUGH</span> <span class="trail">TRAIL</span></div>
</div>
</div>
<div class="tier-badge" id="tierBadge">TIER 1</div>
<div class="lang-toggle">
<button class="lang-btn active" data-lang="en">EN</button>
<button class="lang-btn" data-lang="es">ES</button>
</div>
</div>

<div class="game-container">
<!-- Intro Screen -->
<div class="intro-screen" id="introScreen">
<div class="intro-icon">üõ§Ô∏è</div>
<div class="intro-title"><span class="laugh">LAUGH</span> <span class="trail">TRAIL</span></div>
<div class="intro-subtitle">
<span class="lang-en">FOLLOW THE FUNNY PATH</span>
<span class="lang-es">SIGUE EL CAMINO GRACIOSO</span>
</div>
<div class="intro-desc">
<span class="lang-en"><strong>Watch the trail light up!</strong> Then tap the boxes in the same order. Each correct tap reveals a surprise! üòÇüß†</span>
<span class="lang-es"><strong>¬°Mira el camino iluminarse!</strong> Luego toca las cajas en el mismo orden. ¬°Cada toque correcto revela una sorpresa! üòÇüß†</span>
</div>

<div class="tier-section">
<div class="section-label"><span class="lang-en">SELECT TIER</span><span class="lang-es">SELECCIONA NIVEL</span></div>
<div class="tier-select" id="tierSelect"></div>
</div>

<button class="start-btn" id="startBtn">
<span class="lang-en">START TRAIL! üõ§Ô∏è</span>
<span class="lang-es">¬°COMENZAR! üõ§Ô∏è</span>
</button>
</div>

<!-- Game Screen -->
<div class="game-screen hidden" id="gameScreen">
<div class="status-box">
<div class="status-text" id="statusText">WATCH THE TRAIL!</div>
<div class="status-sub" id="statusSub">Memorize the path</div>
</div>

<div class="round-info">
<div class="round-box">
<div class="round-value" id="roundNum">1</div>
<div class="round-label"><span class="lang-en">ROUND</span><span class="lang-es">RONDA</span></div>
</div>
<div class="round-box">
<div class="round-value" id="trailLength">3</div>
<div class="round-label"><span class="lang-en">TRAIL</span><span class="lang-es">CAMINO</span></div>
</div>
<div class="round-box">
<div class="round-value" id="bestRound">0</div>
<div class="round-label"><span class="lang-en">BEST</span><span class="lang-es">MEJOR</span></div>
</div>
</div>

<div class="grid-container" id="gridContainer">
<div class="trail-grid" id="trailGrid"></div>
</div>

<div class="stats-row">
<div class="stat-box">
<div class="stat-value" id="streakCount">0</div>
<div class="stat-label"><span class="lang-en">STREAK</span><span class="lang-es">RACHA</span></div>
</div>
<div class="stat-box">
<div class="stat-value" id="tapProgress">0/3</div>
<div class="stat-label"><span class="lang-en">PROGRESS</span><span class="lang-es">PROGRESO</span></div>
</div>
</div>
</div>

<!-- Result Screen -->
<div class="result-screen hidden" id="resultScreen">
<div class="result-icon" id="resultIcon">üéâ</div>
<div class="result-title" id="resultTitle">GREAT RUN!</div>
<div class="result-stats">
<div class="result-stat">
<div class="result-stat-value" id="finalRound">5</div>
<div class="result-stat-label"><span class="lang-en">ROUNDS</span><span class="lang-es">RONDAS</span></div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="finalLaughs">0</div>
<div class="result-stat-label">üòÇ LAUGHS</div>
</div>
</div>
<button class="result-btn" id="retryBtn">
<span class="lang-en">TRY AGAIN ‚Üí</span>
<span class="lang-es">INTENTAR ‚Üí</span>
</button>
<button class="result-btn secondary" id="homeBtn">
<span class="lang-en">‚Üê BACK</span>
<span class="lang-es">‚Üê VOLVER</span>
</button>
</div>
</div>

<div class="laugh-counter" id="laughCounter">
<div class="laugh-counter-label">üòÇ LAUGHS</div>
<div class="laugh-counter-row">
<span class="laugh-counter-icon" id="laughIcon">üòä</span>
<span class="laugh-counter-value" id="laughValue">0</span>
</div>
</div>

<div class="coach-bubble" id="coachBubble">
<div class="coach-bubble-avatar"><img src="go_chat.png" alt="Coach"></div>
<div class="coach-bubble-text" id="coachText"></div>
</div>

<script>
(function(){
// ============ AUTH GATE ============
var host = window.location.hostname;
var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '');
if (!isLocal) {
    var sessionPin = sessionStorage.getItem('lw-user-pin');
    var userData = null;
    try { userData = JSON.parse(localStorage.getItem('lw-user')); } catch(e) {}
    var hasValidSession = sessionPin && sessionPin.length >= 4;
    var hasValidUser = userData && userData.pin && userData.type === 'subscriber';
    if (!hasValidSession && !hasValidUser) {
        document.documentElement.style.display = 'none';
        window.location.replace('index.html');
        throw new Error('Auth required');
    }
}

// Language
var lang = localStorage.getItem('lw-lang') || 'en';
function setLang(l) {
    lang = l;
    localStorage.setItem('lw-lang', l);
    document.body.className = l;
    document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.lang === l);
    });
}
setLang(lang);
document.querySelectorAll('.lang-btn').forEach(function(b) {
    b.addEventListener('click', function(e) { e.preventDefault(); setLang(this.dataset.lang); });
});

// ============ FUNNY EMOJIS FOR REVEALS ============
var funnyEmojis = [
    'üòÇ', 'ü§£', 'üòÜ', 'üòú', 'ü§™', 'üòù', 'üôÉ', 'üòè', 
    'ü•≥', 'üéâ', 'üéä', 'ü§©', 'üòé', 'ü§ì', 'ü•∏', 'ü§°',
    'üëª', 'üíÄ', 'üéÉ', 'ü§ñ', 'üëΩ', 'ü¶Ñ', 'üê∏', 'üêî',
    'üçï', 'üåÆ', 'üç©', 'üç¶', 'üé∏', 'üöÄ', '‚≠ê', 'üí•',
    'üî•', 'üí™', 'üß†', 'üëÄ', 'üëÖ', 'ü¶∂', 'üôà', 'üôâ'
];

var coachMessages = {
    watch: [
        {en: "Watch closely! üëÄ", es: "¬°Mira bien! üëÄ"},
        {en: "Here comes the trail! üõ§Ô∏è", es: "¬°Aqu√≠ viene el camino! üõ§Ô∏è"}
    ],
    go: [
        {en: "Your turn! Tap it back! üëÜ", es: "¬°Tu turno! ¬°Rep√≠telo! üëÜ"},
        {en: "Now YOU trace the path! üß†", es: "¬°Ahora T√ö traza el camino! üß†"}
    ],
    correct: [
        {en: "YES! Keep going! üî•", es: "¬°S√ç! ¬°Sigue as√≠! üî•"},
        {en: "Brain power! üí™üß†", es: "¬°Poder cerebral! üí™üß†"},
        {en: "You're on FIRE! üî•", es: "¬°Est√°s EN LLAMAS! üî•"}
    ],
    roundComplete: [
        {en: "PERFECT! Next round! üéØ", es: "¬°PERFECTO! ¬°Siguiente ronda! üéØ"},
        {en: "Nailed it! Trail grows! üòÇ", es: "¬°Lo lograste! ¬°El camino crece! üòÇ"}
    ],
    fail: [
        {en: "Oops! So close! üòÖ", es: "¬°Ups! ¬°Casi! üòÖ"},
        {en: "Nice try! Go again? üí™", es: "¬°Buen intento! ¬øOtra vez? üí™"}
    ],
    milestone: [
        {en: "INCREDIBLE! Round 5! üèÜ", es: "¬°INCRE√çBLE! ¬°Ronda 5! üèÜ"},
        {en: "LEGEND! Round 10! üåü", es: "¬°LEYENDA! ¬°Ronda 10! üåü"}
    ]
};

// ============ GAME STATE ============
var selectedTier = 0;
var gridSize = 6;
var trail = [];
var playerIndex = 0;
var round = 1;
var streak = 0;
var bestRound = 0;
var gameLaughs = 0;
var isWatching = true;
var canTap = false;

var introScreen = document.getElementById('introScreen');
var gameScreen = document.getElementById('gameScreen');
var resultScreen = document.getElementById('resultScreen');
var coachBubble = document.getElementById('coachBubble');
var coachText = document.getElementById('coachText');

// ============ MASTERY ============
function getMastery() {
    try { return JSON.parse(localStorage.getItem('laughtrail-mastery')) || {currentTier:1, unlockedTiers:[1], bestRounds:{}}; }
    catch(e) { return {currentTier:1, unlockedTiers:[1], bestRounds:{}}; }
}
function saveMastery(m) { localStorage.setItem('laughtrail-mastery', JSON.stringify(m)); }

// ============ LAUGH TRACKING ============
function getLaughEmoji(count) {
    if (count >= 30) return 'ü§£';
    if (count >= 15) return 'üòÇ';
    if (count >= 5) return 'üòÑ';
    return 'üòä';
}

function addLaughs(count) {
    var oldEmoji = getLaughEmoji(gameLaughs);
    gameLaughs += count;
    var newEmoji = getLaughEmoji(gameLaughs);
    
    document.getElementById('laughValue').textContent = gameLaughs;
    
    var icon = document.getElementById('laughIcon');
    icon.classList.remove('bounce', 'evolve');
    void icon.offsetWidth;
    
    if (newEmoji !== oldEmoji) {
        icon.textContent = newEmoji;
        icon.classList.add('evolve');
    } else {
        icon.classList.add('bounce');
    }
    
    createLaughBurst(count);
    
    // Save to localStorage
    var today = new Date().toISOString().split('T')[0];
    var todayData = JSON.parse(localStorage.getItem('lw-laughs-today') || '{}');
    if (todayData.date !== today) todayData = {date: today, count: 0};
    todayData.count += count;
    localStorage.setItem('lw-laughs-today', JSON.stringify(todayData));
    
    var total = parseInt(localStorage.getItem('lw-laughs-total') || '0') + count;
    localStorage.setItem('lw-laughs-total', String(total));
}

function createLaughBurst(count) {
    var emojis = ['üòÇ', 'ü§£', 'üòÜ', 'üòÑ', 'üòú'];
    var burstCount = Math.min(count + 2, 5);
    for (var i = 0; i < burstCount; i++) {
        setTimeout(function(idx) {
            return function() {
                var burst = document.createElement('div');
                burst.className = 'laugh-burst burst-' + (idx + 1);
                burst.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                burst.style.left = (40 + Math.random() * 30) + '%';
                burst.style.top = (30 + Math.random() * 20) + '%';
                document.body.appendChild(burst);
                setTimeout(function() { if (burst.parentNode) burst.remove(); }, 1000);
            };
        }(i), i * 80);
    }
}

function createLaughRain() {
    var emojis = ['üòÇ', 'ü§£', 'üòÜ', 'üòÑ', 'ü•≥', 'üéâ'];
    for (var i = 0; i < 30; i++) {
        setTimeout(function() {
            var rain = document.createElement('div');
            rain.className = 'laugh-rain';
            rain.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            rain.style.left = Math.random() * 100 + 'vw';
            rain.style.animationDuration = (1.5 + Math.random() * 1.5) + 's';
            document.body.appendChild(rain);
            setTimeout(function() { if (rain.parentNode) rain.remove(); }, 3000);
        }, i * 60);
    }
}

function createConfetti() {
    var colors = ['#FF6B00', '#FFD700', '#00D9A5', '#6B21A8'];
    for (var i = 0; i < 50; i++) {
        setTimeout(function() {
            var conf = document.createElement('div');
            conf.className = 'confetti';
            conf.style.left = Math.random() * 100 + 'vw';
            conf.style.background = colors[Math.floor(Math.random() * colors.length)];
            conf.style.animationDuration = (2 + Math.random() * 2) + 's';
            document.body.appendChild(conf);
            setTimeout(function() { if (conf.parentNode) conf.remove(); }, 4000);
        }, i * 40);
    }
}

// ============ COACH ============
function showCoach(key, duration) {
    var msgs = coachMessages[key];
    var msg = msgs[Math.floor(Math.random() * msgs.length)];
    coachText.textContent = lang === 'es' ? msg.es : msg.en;
    coachBubble.classList.add('visible');
    setTimeout(function() { coachBubble.classList.remove('visible'); }, duration || 2000);
}

// ============ SCREENS ============
function showScreen(screen) {
    introScreen.classList.add('hidden');
    gameScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    screen.classList.remove('hidden');
}

// ============ TIER SELECT ============
function buildTierSelect() {
    var container = document.getElementById('tierSelect');
    container.innerHTML = '';
    var mastery = getMastery();
    
    for (var i = 1; i <= 10; i++) {
        var btn = document.createElement('button');
        btn.className = 'tier-btn';
        btn.textContent = i;
        btn.dataset.tier = i;
        
        var unlocked = mastery.unlockedTiers.indexOf(i) !== -1;
        if (!unlocked) btn.classList.add('locked');
        if (i === selectedTier + 1) btn.classList.add('selected');
        
        if (unlocked) {
            btn.onclick = function() {
                selectedTier = parseInt(this.dataset.tier) - 1;
                buildTierSelect();
            };
        }
        container.appendChild(btn);
    }
    
    document.getElementById('tierBadge').textContent = 'TIER ' + (selectedTier + 1);
}

// ============ GRID ============
function getGridSize(tier) {
    if (tier < 3) return 6;
    if (tier < 6) return 8;
    return 10;
}

function getStartingTrailLength(tier) {
    return 3 + Math.floor(tier / 2);
}

function buildGrid() {
    gridSize = getGridSize(selectedTier);
    var gridEl = document.getElementById('trailGrid');
    gridEl.innerHTML = '';
    gridEl.style.gridTemplateColumns = 'repeat(' + gridSize + ', 1fr)';
    
    for (var i = 0; i < gridSize; i++) {
        for (var j = 0; j < gridSize; j++) {
            var box = document.createElement('div');
            box.className = 'grid-box disabled';
            box.dataset.row = i;
            box.dataset.col = j;
            box.dataset.index = i * gridSize + j;
            gridEl.appendChild(box);
        }
    }
}

function generateTrail(length) {
    trail = [];
    var used = {};
    
    // Start at random position
    var startRow = Math.floor(Math.random() * gridSize);
    var startCol = Math.floor(Math.random() * gridSize);
    trail.push({row: startRow, col: startCol});
    used[startRow + ',' + startCol] = true;
    
    var directions = [
        {dr: -1, dc: 0}, {dr: 1, dc: 0}, {dr: 0, dc: -1}, {dr: 0, dc: 1},
        {dr: -1, dc: -1}, {dr: -1, dc: 1}, {dr: 1, dc: -1}, {dr: 1, dc: 1}
    ];
    
    while (trail.length < length) {
        var last = trail[trail.length - 1];
        var shuffled = directions.slice().sort(function() { return Math.random() - 0.5; });
        var found = false;
        
        for (var i = 0; i < shuffled.length; i++) {
            var newRow = last.row + shuffled[i].dr;
            var newCol = last.col + shuffled[i].dc;
            var key = newRow + ',' + newCol;
            
            if (newRow >= 0 && newRow < gridSize && newCol >= 0 && newCol < gridSize && !used[key]) {
                trail.push({row: newRow, col: newCol});
                used[key] = true;
                found = true;
                break;
            }
        }
        
        if (!found) {
            // Dead end, start over
            trail = [];
            used = {};
            startRow = Math.floor(Math.random() * gridSize);
            startCol = Math.floor(Math.random() * gridSize);
            trail.push({row: startRow, col: startCol});
            used[startRow + ',' + startCol] = true;
        }
    }
    
    // Assign random emojis to trail
    for (var i = 0; i < trail.length; i++) {
        trail[i].emoji = funnyEmojis[Math.floor(Math.random() * funnyEmojis.length)];
    }
}

function playTrail() {
    isWatching = true;
    canTap = false;
    
    document.getElementById('statusText').textContent = lang === 'es' ? '¬°MIRA EL CAMINO!' : 'WATCH THE TRAIL!';
    document.getElementById('statusSub').textContent = lang === 'es' ? 'Memoriza el camino' : 'Memorize the path';
    
    // Disable all boxes
    document.querySelectorAll('.grid-box').forEach(function(b) {
        b.classList.add('disabled');
        b.classList.remove('lit', 'selected', 'correct');
        b.textContent = '';
    });
    
    showCoach('watch', 1500);
    
    // Light up trail one by one
    trail.forEach(function(pos, idx) {
        setTimeout(function() {
            var box = document.querySelector('[data-row="' + pos.row + '"][data-col="' + pos.col + '"]');
            if (box) {
                box.classList.add('lit');
                // Remove lit after short delay
                setTimeout(function() {
                    box.classList.remove('lit');
                }, 400);
            }
        }, idx * 600);
    });
    
    // After trail plays, enable tapping
    setTimeout(function() {
        isWatching = false;
        canTap = true;
        playerIndex = 0;
        
        document.getElementById('statusText').textContent = lang === 'es' ? '¬°TU TURNO!' : 'YOUR TURN!';
        document.getElementById('statusSub').textContent = lang === 'es' ? 'Toca el camino' : 'Tap the trail';
        document.getElementById('tapProgress').textContent = '0/' + trail.length;
        
        document.querySelectorAll('.grid-box').forEach(function(b) {
            b.classList.remove('disabled');
        });
        
        showCoach('go', 2000);
        
    }, trail.length * 600 + 500);
}

function handleTap(box) {
    if (!canTap || isWatching) return;
    
    var row = parseInt(box.dataset.row);
    var col = parseInt(box.dataset.col);
    var expected = trail[playerIndex];
    
    if (row === expected.row && col === expected.col) {
        // CORRECT!
        box.classList.add('correct', 'reveal');
        box.innerHTML = '<span class="emoji-reveal">' + expected.emoji + '</span>';
        
        playerIndex++;
        streak++;
        document.getElementById('streakCount').textContent = streak;
        document.getElementById('tapProgress').textContent = playerIndex + '/' + trail.length;
        
        addLaughs(1);
        
        if (playerIndex >= trail.length) {
            // ROUND COMPLETE!
            canTap = false;
            roundComplete();
        } else if (playerIndex % 3 === 0) {
            showCoach('correct', 1200);
        }
    } else {
        // WRONG!
        box.classList.add('wrong');
        setTimeout(function() { box.classList.remove('wrong'); }, 300);
        canTap = false;
        gameOver();
    }
}

function roundComplete() {
    addLaughs(3);
    createLaughBurst(5);
    
    if (round === 5 || round === 10) {
        showCoach('milestone', 2500);
        createConfetti();
    } else {
        showCoach('roundComplete', 2000);
    }
    
    // Update best
    if (round > bestRound) {
        bestRound = round;
        document.getElementById('bestRound').textContent = bestRound;
        
        var mastery = getMastery();
        mastery.bestRounds[selectedTier] = bestRound;
        if (bestRound >= 5 && selectedTier + 2 <= 10 && mastery.unlockedTiers.indexOf(selectedTier + 2) === -1) {
            mastery.unlockedTiers.push(selectedTier + 2);
        }
        saveMastery(mastery);
    }
    
    // Next round after delay
    setTimeout(function() {
        round++;
        document.getElementById('roundNum').textContent = round;
        
        var newLength = getStartingTrailLength(selectedTier) + round - 1;
        document.getElementById('trailLength').textContent = newLength;
        
        generateTrail(newLength);
        playTrail();
    }, 2000);
}

function gameOver() {
    showCoach('fail', 2500);
    
    // Show correct path
    trail.forEach(function(pos, idx) {
        setTimeout(function() {
            var box = document.querySelector('[data-row="' + pos.row + '"][data-col="' + pos.col + '"]');
            if (box && !box.classList.contains('correct')) {
                box.classList.add('lit');
                box.innerHTML = '<span class="emoji-reveal">' + pos.emoji + '</span>';
            }
        }, idx * 200);
    });
    
    setTimeout(function() {
        document.getElementById('resultIcon').textContent = round >= 5 ? 'üéâ' : 'üòÖ';
        document.getElementById('resultTitle').textContent = round >= 5 ? 
            (lang === 'es' ? '¬°GRAN CARRERA!' : 'GREAT RUN!') : 
            (lang === 'es' ? '¬°BUEN INTENTO!' : 'GOOD TRY!');
        document.getElementById('resultTitle').className = 'result-title ' + (round >= 5 ? 'success' : 'fail');
        document.getElementById('finalRound').textContent = round;
        document.getElementById('finalLaughs').textContent = gameLaughs;
        
        if (round >= 5) createConfetti();
        
        showScreen(resultScreen);
    }, trail.length * 200 + 1500);
}

// ============ GAME FLOW ============
function startGame() {
    round = 1;
    streak = 0;
    gameLaughs = 0;
    playerIndex = 0;
    
    document.getElementById('laughIcon').textContent = 'üòä';
    document.getElementById('laughValue').textContent = '0';
    document.getElementById('roundNum').textContent = '1';
    document.getElementById('streakCount').textContent = '0';
    
    var mastery = getMastery();
    bestRound = mastery.bestRounds[selectedTier] || 0;
    document.getElementById('bestRound').textContent = bestRound;
    
    var startLength = getStartingTrailLength(selectedTier);
    document.getElementById('trailLength').textContent = startLength;
    
    buildGrid();
    generateTrail(startLength);
    
    showScreen(gameScreen);
    
    addLaughs(1);
    
    setTimeout(function() {
        playTrail();
    }, 500);
}

function setupGridEvents() {
    document.getElementById('trailGrid').addEventListener('click', function(e) {
        var box = e.target.closest('.grid-box');
        if (box && !box.classList.contains('disabled')) {
            handleTap(box);
        }
    });
}

// ============ EVENT LISTENERS ============
document.getElementById('startBtn').onclick = startGame;
document.getElementById('retryBtn').onclick = startGame;
document.getElementById('homeBtn').onclick = function() {
    buildTierSelect();
    showScreen(introScreen);
};
document.getElementById('backBtn').onclick = function() {
    if (confirm(lang === 'es' ? '¬øSalir?' : 'Exit?')) {
        window.location.href = 'laugh-hub.html';
    }
};

// Init
buildTierSelect();
setupGridEvents();

})();
</script>
</body>
</html>
