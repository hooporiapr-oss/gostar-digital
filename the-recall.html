<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>THE RECALL | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B00;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --purple: #9D4EDD;
    --cyan: #00CED1;
    --red: #FF1744;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.08);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
}
.game-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 15px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Header */
.header {
    text-align: center;
    padding: 10px 0 15px;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    margin-bottom: 5px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.2rem;
    letter-spacing: 4px;
    background: linear-gradient(135deg, var(--orange), var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.court-subtitle {
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
}
.powered-by {
    margin-top: 8px;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
}
.powered-by .ritnome {
    color: var(--gold);
    font-weight: 700;
}

/* Stats Bar */
.stats-bar {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 12px;
    background: var(--card);
    border-radius: 12px;
    margin-bottom: 15px;
}
.stat {
    text-align: center;
}
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: var(--gold);
}
.stat-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Message Display */
.message-display {
    background: linear-gradient(135deg, var(--card), var(--darker));
    border: 2px solid var(--orange);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    min-height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}
.message-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255,107,0,0.1), transparent);
    pointer-events: none;
}
.message-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 2px;
    color: var(--text);
    text-align: center;
}
.message-text.watch { color: var(--gold); }
.message-text.go { color: var(--teal); }
.message-text.success { color: var(--teal); }
.message-text.error { color: var(--pink); }
.countdown-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3rem;
    color: var(--gold);
    animation: countPop 0.4s ease-out;
}
@keyframes countPop {
    0% { transform: scale(1.5); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}

/* Ritnome‚Ñ¢ BPM Speed Selection */
.ritnome-tempo {
    margin-bottom: 15px;
}
.tempo-label {
    text-align: center;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
}
.tempo-label .ritnome-mark {
    color: var(--gold);
    font-weight: 700;
}
.speed-selector {
    display: flex;
    gap: 8px;
}
.speed-btn {
    flex: 1;
    padding: 12px 8px;
    border: 2px solid var(--border);
    background: var(--card);
    border-radius: 12px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.speed-btn .bpm {
    font-size: 1.3rem;
    font-weight: 700;
}
.speed-btn .bpm-label {
    font-family: 'Outfit', sans-serif;
    font-size: 0.55rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.7;
}
.speed-btn.active {
    border-color: var(--orange);
    color: var(--orange);
    background: rgba(255,107,0,0.15);
}
.speed-btn:hover:not(.active) { 
    border-color: var(--orange); 
    color: var(--text);
}

/* 5x5 Court Grid */
.court-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    padding: 15px;
    background: linear-gradient(145deg, var(--card), var(--darker));
    border-radius: 16px;
    border: 2px solid rgba(255,107,0,0.3);
    margin-bottom: 15px;
}
.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s;
    background: rgba(255,255,255,0.08);
    color: var(--muted);
    position: relative;
    overflow: hidden;
}
.grid-cell:hover:not(.disabled) { 
    background: rgba(255,255,255,0.15);
    transform: scale(1.02);
}
.grid-cell:active:not(.disabled) { transform: scale(0.95); }
.grid-cell.disabled { 
    pointer-events: none;
    opacity: 0.6;
}

/* Cell flash/lit state */
.grid-cell.lit {
    background: linear-gradient(135deg, var(--orange), var(--gold)) !important;
    color: var(--dark) !important;
    transform: scale(1.1);
    box-shadow: 0 0 30px var(--orange), 0 0 50px rgba(255,107,0,0.5);
}

/* Correct tap */
.grid-cell.correct {
    background: linear-gradient(135deg, var(--teal), #00E5B0) !important;
    color: var(--dark) !important;
    animation: correctPulse 0.4s ease-out;
    box-shadow: 0 0 20px var(--teal);
}

/* Wrong tap */
.grid-cell.wrong {
    background: linear-gradient(135deg, var(--pink), #FF69B4) !important;
    color: var(--dark) !important;
    animation: wrongShake 0.4s ease-out;
    box-shadow: 0 0 20px var(--pink);
}

/* Sequence position indicator */
.grid-cell.completed {
    background: rgba(0,217,165,0.3) !important;
    border: 2px solid var(--teal);
}

@keyframes correctPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}
@keyframes wrongShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Progress & Tier */
.progress-section {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}
.tier-badge {
    background: linear-gradient(135deg, var(--orange), var(--gold));
    padding: 8px 15px;
    border-radius: 20px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--dark);
    white-space: nowrap;
}
.progress-bar {
    flex: 1;
    height: 12px;
    background: var(--card);
    border-radius: 6px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--orange), var(--gold));
    border-radius: 6px;
    transition: width 0.3s ease-out;
}

/* Action Button */
.action-btn {
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 10px;
}
.action-btn.start {
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
}
.action-btn.start:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(255,107,0,0.5);
}
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Laugh Meter */
.laugh-meter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: var(--card);
    border-radius: 10px;
}
.laugh-meter-label {
    font-size: 0.8rem;
    color: var(--muted);
}
.laugh-meter-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    color: var(--pink);
}

/* Feedback Overlay */
.feedback-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 24px;
    padding: 40px;
    text-align: center;
    max-width: 350px;
    width: 90%;
    animation: slideUp 0.3s ease-out;
}
@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.feedback-emoji {
    font-size: 4rem;
    margin-bottom: 15px;
}
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    letter-spacing: 3px;
    margin-bottom: 10px;
}
.feedback-title.success { color: var(--teal); }
.feedback-title.fail { color: var(--pink); }
.feedback-title.tierup { color: var(--gold); }
.feedback-message {
    color: var(--muted);
    margin-bottom: 25px;
    line-height: 1.5;
}
.feedback-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-bottom: 25px;
}
.feedback-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
}
.feedback-stat-label {
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
}
.feedback-btn {
    padding: 14px 40px;
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 5px;
}
.feedback-btn.primary {
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
}
.feedback-btn.secondary {
    background: var(--darker);
    color: var(--muted);
    border: 1px solid var(--muted);
}

/* Coach Message */
.coach-message {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
    padding: 12px 25px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 0.9rem;
    opacity: 0;
    transition: all 0.4s ease-out;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Language Toggle */
.lang-toggle {
    position: fixed;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 5px;
    z-index: 100;
}
.lang-btn {
    padding: 6px 12px;
    border: 1px solid var(--muted);
    background: transparent;
    color: var(--muted);
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
}
.lang-btn.active {
    border-color: var(--gold);
    color: var(--gold);
}

/* Back Button */
.back-btn {
    position: fixed;
    top: 15px;
    left: 15px;
    padding: 8px 15px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 20px;
    color: var(--muted);
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: none;
    z-index: 100;
}
.back-btn:hover { color: var(--text); }

/* Ritnome‚Ñ¢ Footer */
.ritnome-footer {
    margin-top: auto;
    padding: 25px 20px;
    text-align: center;
    border-top: 1px solid var(--border);
}
.footer-brand { margin-bottom: 10px; }
.ritnome-tm {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    letter-spacing: 4px;
    background: linear-gradient(135deg, var(--red), var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
}
.footer-tagline {
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    display: block;
    margin-top: 3px;
}
.footer-company {
    font-size: 0.7rem;
    color: var(--muted);
    margin: 8px 0;
}
.footer-company a {
    color: var(--gold);
    text-decoration: none;
}
.footer-copyright {
    font-size: 0.55rem;
    color: var(--muted);
    opacity: 0.6;
}
</style>
</head>
<body>
<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<a href="laugh-hub.html" class="back-btn">‚Üê Back</a>

<div class="game-container">
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT</div>
        <h1 class="court-name">üß† THE RECALL</h1>
        <p class="court-subtitle" id="subtitleText">Sequence Memory Training</p>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="currentTier">1</div>
            <div class="stat-label">Tier</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="bestTier">0</div>
            <div class="stat-label">Best</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
    </div>

    <div class="message-display" id="messageDisplay">
        <span class="message-text" id="messageText">Select tempo & START!</span>
    </div>

    <div class="ritnome-tempo">
        <div class="tempo-label">üéµ <span class="ritnome-mark">Ritnome‚Ñ¢</span> Tempo</div>
        <div class="speed-selector">
            <button class="speed-btn" id="slowBtn" data-speed="slow" data-bpm="60">
                <span>üê¢</span>
                <span class="bpm">60</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn active" id="mediumBtn" data-speed="medium" data-bpm="90">
                <span>üèÉ</span>
                <span class="bpm">90</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn" id="fastBtn" data-speed="fast" data-bpm="120">
                <span>‚ö°</span>
                <span class="bpm">120</span>
                <span class="bpm-label">BPM</span>
            </button>
        </div>
    </div>

    <div class="court-grid" id="courtGrid"></div>

    <div class="progress-section">
        <div class="tier-badge">TIER <span id="tierDisplay">1</span></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <button class="action-btn start" id="actionBtn">START RECALL üß†</button>

    <div class="laugh-meter">
        <span class="laugh-meter-label">Laugh Meter:</span>
        <span class="laugh-meter-value" id="laughMeter">üòä</span>
    </div>

    <footer class="ritnome-footer">
        <div class="footer-brand">
            <span class="ritnome-tm">Ritnome‚Ñ¢</span>
            <span class="footer-tagline">Rhythm-Based Cognitive Training</span>
        </div>
        <div class="footer-company">by <a href="https://gostar.digital">GoStar Digital LLC</a> üáµüá∑</div>
        <div class="footer-copyright">¬© 2025 GoStar Digital LLC. All rights reserved.</div>
    </footer>
</div>

<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üéâ</div>
        <h2 class="feedback-title" id="feedbackTitle">GREAT JOB!</h2>
        <p class="feedback-message" id="feedbackMessage">You completed the sequence!</p>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackTier">1</div>
                <div class="feedback-stat-label">Tier</div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackLaughs">0</div>
                <div class="feedback-stat-label">üòÇ Earned</div>
            </div>
        </div>
        <div class="feedback-ritnome">Ritnome‚Ñ¢ Training</div>
        <button class="feedback-btn primary" id="continueBtn">CONTINUE üß†</button>
        <button class="feedback-btn secondary" id="restartBtn">RESTART</button>
    </div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // Language
    var currentLang = localStorage.getItem('lc-lang') || 'en';
    
    // Game State
    var state = {
        tier: 1,
        bestTier: parseInt(localStorage.getItem('lc-recall-best')) || 0,
        totalLaughs: parseInt(localStorage.getItem('lc-recall-laughs')) || 0,
        sessionLaughs: 0,
        streak: 0,
        speed: 'medium',
        bpm: 90,
        sequence: [],
        userSequence: [],
        isPlaying: false,
        isShowingSequence: false,
        circuitsCompleted: 0
    };

    // Ritnome‚Ñ¢ BPM-based speed configs
    // 60 BPM = 1000ms per beat, 90 BPM = 667ms, 120 BPM = 500ms
    var speeds = {
        slow: { bpm: 60, flash: 800, pause: 400 },
        medium: { bpm: 90, flash: 500, pause: 300 },
        fast: { bpm: 120, flash: 350, pause: 200 }
    };

    // Tier = sequence length (tier 1 = 2 items, tier 10 = 11 items)
    var getSequenceLength = function(tier) { return tier + 1; };

    // DOM Elements
    var courtGrid = document.getElementById('courtGrid');
    var messageDisplay = document.getElementById('messageDisplay');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var feedbackOverlay = document.getElementById('feedbackOverlay');
    var coachMessage = document.getElementById('coachMessage');

    // Text content
    var texts = {
        en: {
            subtitle: 'Sequence Memory Training',
            selectStart: 'Select tempo & START!',
            watch: 'WATCH THE SEQUENCE...',
            yourTurn: 'YOUR TURN! Tap in order',
            perfect: 'PERFECT!',
            almost: 'ALMOST!',
            tierUp: 'TIER UP!',
            tryAgain: 'Shake it off, try again!',
            circuitsTo: 'circuits to next tier!',
            movingTo: 'Moving to Tier',
            continue: 'CONTINUE üß†',
            nextRound: 'NEXT ROUND üß†',
            tryAgainBtn: 'TRY AGAIN üß†',
            startRecall: 'START RECALL üß†'
        },
        es: {
            subtitle: 'Entrenamiento de Secuencia',
            selectStart: '¬°Selecciona tempo e INICIA!',
            watch: 'OBSERVA LA SECUENCIA...',
            yourTurn: '¬°TU TURNO! Toca en orden',
            perfect: '¬°PERFECTO!',
            almost: '¬°CASI!',
            tierUp: '¬°SUBISTE DE NIVEL!',
            tryAgain: '¬°Sac√∫dete e intenta de nuevo!',
            circuitsTo: 'circuitos para subir!',
            movingTo: 'Avanzando a Tier',
            continue: 'CONTINUAR üß†',
            nextRound: 'SIGUIENTE üß†',
            tryAgainBtn: 'INTENTAR üß†',
            startRecall: 'INICIAR üß†'
        }
    };

    function t(key) { return texts[currentLang][key] || texts['en'][key]; }

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('lc-lang', lang);
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('subtitleText').textContent = t('subtitle');
        if (!state.isPlaying && !state.isShowingSequence) {
            messageText.textContent = t('selectStart');
            actionBtn.textContent = t('startRecall');
        }
    }

    // Initialize 5x5 grid
    function initGrid() {
        courtGrid.innerHTML = '';
        for (var i = 1; i <= 25; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell disabled';
            cell.dataset.index = i;
            cell.addEventListener('click', function() {
                handleCellClick(parseInt(this.dataset.index));
            });
            courtGrid.appendChild(cell);
        }
    }

    // Generate random sequence of grid positions
    function generateSequence(length) {
        var seq = [];
        var available = [];
        for (var i = 1; i <= 25; i++) available.push(i);
        
        for (var i = 0; i < length; i++) {
            var idx = Math.floor(Math.random() * available.length);
            seq.push(available.splice(idx, 1)[0]);
        }
        return seq;
    }

    // Show sequence to user
    function showSequence() {
        state.isShowingSequence = true;
        actionBtn.disabled = true;
        disableGrid(true);
        
        messageText.textContent = t('watch');
        messageText.className = 'message-text watch';
        
        var i = 0;
        var spd = speeds[state.speed];
        
        function flashNext() {
            if (i >= state.sequence.length) {
                state.isShowingSequence = false;
                messageText.textContent = t('yourTurn');
                messageText.className = 'message-text go';
                disableGrid(false);
                return;
            }
            
            var cellIndex = state.sequence[i];
            var cell = courtGrid.querySelector('[data-index="' + cellIndex + '"]');
            
            cell.classList.add('lit');
            playTone(i);
            
            setTimeout(function() {
                cell.classList.remove('lit');
                i++;
                setTimeout(flashNext, spd.pause);
            }, spd.flash);
        }
        
        setTimeout(flashNext, 500);
    }

    // Handle cell click
    function handleCellClick(index) {
        if (state.isShowingSequence || !state.isPlaying) return;
        
        var cell = courtGrid.querySelector('[data-index="' + index + '"]');
        state.userSequence.push(index);
        
        var currentIndex = state.userSequence.length - 1;
        var expected = state.sequence[currentIndex];
        
        if (index === expected) {
            // Correct!
            cell.classList.add('correct');
            playTone(currentIndex);
            setTimeout(function() { 
                cell.classList.remove('correct');
                cell.classList.add('completed');
            }, 300);
            
            if (state.userSequence.length === state.sequence.length) {
                // Completed sequence!
                handleSuccess();
            }
        } else {
            // Wrong!
            cell.classList.add('wrong');
            playErrorTone();
            setTimeout(function() { cell.classList.remove('wrong'); }, 400);
            handleFailure(expected);
        }
    }

    // Handle success
    function handleSuccess() {
        state.isPlaying = false;
        disableGrid(true);
        
        // Calculate laughs (bonus for faster BPM)
        var baseLaughs = state.tier;
        var bpmBonus = state.bpm === 120 ? 2 : state.bpm === 90 ? 1 : 0;
        var laughsEarned = baseLaughs + bpmBonus;
        
        state.sessionLaughs += laughsEarned;
        state.totalLaughs += laughsEarned;
        state.streak++;
        state.circuitsCompleted++;
        
        if (state.tier > state.bestTier) {
            state.bestTier = state.tier;
            localStorage.setItem('lc-recall-best', state.bestTier);
        }
        localStorage.setItem('lc-recall-laughs', state.totalLaughs);
        
        updateStats();
        
        // Coach message
        var messages = [
            "PERFECT RECALL! üß†",
            "MEMORY MASTER! üí™",
            "SEQUENCE LOCKED! üî•",
            "BRAIN GAINS! üòÇ",
            "COACH IS PROUD! üèÜ",
            "RITNOME RHYTHM! üéµ"
        ];
        showCoachMessage(messages[Math.floor(Math.random() * messages.length)]);
        
        // Update progress (3 circuits to tier up)
        var progress = (state.circuitsCompleted % 3) / 3 * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        
        // Tier up every 3 circuits
        if (state.circuitsCompleted % 3 === 0 && state.tier < 10) {
            setTimeout(function() {
                showFeedback(true, laughsEarned, true);
            }, 1000);
        } else {
            setTimeout(function() {
                showFeedback(true, laughsEarned, false);
            }, 800);
        }
    }

    // Handle failure
    function handleFailure(expected) {
        state.isPlaying = false;
        disableGrid(true);
        state.streak = 0;
        
        // Show correct cell
        var correctCell = courtGrid.querySelector('[data-index="' + expected + '"]');
        correctCell.classList.add('lit');
        setTimeout(function() { correctCell.classList.remove('lit'); }, 800);
        
        showCoachMessage("That was " + expected + "! Keep going! üí™");
        
        updateStats();
        
        setTimeout(function() {
            showFeedback(false, 0, false);
        }, 1500);
    }

    // Show feedback overlay
    function showFeedback(success, laughs, tierUp) {
        var emoji = document.getElementById('feedbackEmoji');
        var title = document.getElementById('feedbackTitle');
        var message = document.getElementById('feedbackMessage');
        var tierStat = document.getElementById('feedbackTier');
        var laughsStat = document.getElementById('feedbackLaughs');
        var continueBtn = document.getElementById('continueBtn');
        
        if (success) {
            if (tierUp) {
                emoji.textContent = 'üöÄ';
                title.textContent = t('tierUp');
                title.className = 'feedback-title tierup';
                message.textContent = t('movingTo') + ' ' + (state.tier + 1) + '!';
                state.tier++;
            } else {
                emoji.textContent = 'üòÇ';
                title.textContent = t('perfect');
                title.className = 'feedback-title success';
                message.textContent = (state.circuitsCompleted % 3) + '/3 ' + t('circuitsTo');
            }
            continueBtn.textContent = tierUp ? t('continue') : t('nextRound');
        } else {
            emoji.textContent = 'üòÖ';
            title.textContent = t('almost');
            title.className = 'feedback-title fail';
            message.textContent = t('tryAgain');
            continueBtn.textContent = t('tryAgainBtn');
        }
        
        tierStat.textContent = state.tier;
        laughsStat.textContent = laughs;
        
        feedbackOverlay.classList.add('show');
        updateStats();
    }

    // Start round
    function startRound() {
        state.sequence = generateSequence(getSequenceLength(state.tier));
        state.userSequence = [];
        state.isPlaying = true;
        state.sessionLaughs = 0;
        
        // Clear completed markers
        var cells = courtGrid.querySelectorAll('.grid-cell');
        for (var i = 0; i < cells.length; i++) {
            cells[i].classList.remove('completed');
        }
        
        actionBtn.textContent = 'WATCH... üëÄ';
        actionBtn.disabled = true;
        
        showSequence();
    }

    // UI Helpers
    function disableGrid(disabled) {
        var cells = courtGrid.querySelectorAll('.grid-cell');
        for (var i = 0; i < cells.length; i++) {
            if (disabled) {
                cells[i].classList.add('disabled');
            } else {
                cells[i].classList.remove('disabled');
            }
        }
    }

    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('bestTier').textContent = state.bestTier;
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;
        
        // Update laugh meter
        var laughMeter = document.getElementById('laughMeter');
        if (state.streak >= 5) laughMeter.textContent = 'ü§£ü§£ü§£';
        else if (state.streak >= 3) laughMeter.textContent = 'üòÇüòÇ';
        else if (state.streak >= 1) laughMeter.textContent = 'üòÑ';
        else laughMeter.textContent = 'üòä';
    }

    function showCoachMessage(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2500);
    }

    // Audio
    var audioCtx = null;
    function getAudioContext() {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) { return null; }
        }
        return audioCtx;
    }

    var noteFreqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25, 698.46];
    
    function playTone(index) {
        var ctx = getAudioContext();
        if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = noteFreqs[index % noteFreqs.length];
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.25);
        } catch (e) {}
    }

    function playErrorTone() {
        var ctx = getAudioContext();
        if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = 180;
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.25, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
        } catch (e) {}
    }

    // Event Listeners
    actionBtn.addEventListener('click', function() {
        if (!state.isPlaying && !state.isShowingSequence) {
            startRound();
        }
    });

    document.querySelectorAll('.speed-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (state.isPlaying) return;
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.speed = btn.dataset.speed;
            state.bpm = parseInt(btn.dataset.bpm);
        });
    });

    document.getElementById('continueBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        actionBtn.textContent = t('startRecall');
        actionBtn.disabled = false;
        messageText.textContent = 'Ready for Tier ' + state.tier + '!';
        messageText.className = 'message-text';
    });

    document.getElementById('restartBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuitsCompleted = 0;
        state.streak = 0;
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.textContent = t('startRecall');
        actionBtn.disabled = false;
        messageText.textContent = 'Back to Tier 1 - Let\'s go!';
        messageText.className = 'message-text';
        updateStats();
    });

    document.getElementById('btnEn').addEventListener('click', function() { setLang('en'); });
    document.getElementById('btnEs').addEventListener('click', function() { setLang('es'); });

    // Initialize
    initGrid();
    setLang(currentLang);
    updateStats();
})();
</script>
</body>
</html>
