<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>THE RECALL | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B00;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --red: #FF1744;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html {
    height: 100%;
    overflow: hidden;
}
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

/* MOBILE-FIRST PERFECT FIT */
.game-container {
    width: 100%;
    max-width: 420px;
    height: 100vh;
    height: 100dvh;
    margin: 0 auto;
    padding: 6px 10px;
    padding-top: max(6px, env(safe-area-inset-top));
    padding-bottom: max(6px, env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    text-align: center;
    padding: 2px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 2px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--orange), var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
}
.powered-by {
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
}
.powered-by .ritnome { color: var(--gold); font-weight: 700; }

.stats-bar {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 5px 8px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    color: var(--gold);
    line-height: 1;
}
.stat-label {
    font-size: 0.45rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.message-display {
    background: var(--card);
    border: 2px solid var(--orange);
    border-radius: 8px;
    padding: 6px 8px;
    margin-bottom: 4px;
    text-align: center;
    flex-shrink: 0;
}
.message-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    color: var(--text);
}
.message-text.watch { color: var(--gold); }
.message-text.go { color: var(--teal); }

.ritnome-tempo {
    margin-bottom: 4px;
    flex-shrink: 0;
}
.tempo-label {
    text-align: center;
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 3px;
}
.tempo-label .ritnome-mark { color: var(--gold); font-weight: 700; }
.speed-selector {
    display: flex;
    gap: 5px;
}
.speed-btn {
    flex: 1;
    padding: 5px 3px;
    border: 2px solid var(--border);
    background: var(--card);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    position: relative;
}
.speed-btn .icon { font-size: 0.85rem; line-height: 1; }
.speed-btn .bpm { font-size: 0.95rem; line-height: 1; }
.speed-btn .bpm-label {
    font-family: 'Outfit', sans-serif;
    font-size: 0.4rem;
    text-transform: uppercase;
    opacity: 0.7;
}
.speed-btn.active {
    border-color: var(--orange);
    color: var(--orange);
    background: rgba(255,107,0,0.1);
}
.speed-btn.locked {
    opacity: 0.5;
    cursor: pointer;
    position: relative;
}
.speed-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: 1px;
    right: 3px;
    font-size: 0.5rem;
}
.speed-btn.locked .icon { opacity: 0.5; }

/* COURT GRID - THE KEY TO MOBILE FIT */
.court-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    overflow: hidden;
}
.court-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 8px;
    background: linear-gradient(145deg, #0d0d12, #080810);
    border-radius: 12px;
    border: 2px solid rgba(255,107,0,0.2);
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    width: 100%;
    height: 100%;
    max-width: min(100%, 70vh);
    max-height: 100%;
    aspect-ratio: 1;
}
.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    background: linear-gradient(145deg, #1e1e2a, #151520);
    border: 2px solid rgba(255,107,0,0.25);
    box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
}
.grid-cell:active:not(.disabled) { transform: scale(0.95); }
.grid-cell.disabled { pointer-events: none; opacity: 0.5; }
.grid-cell.lit {
    background: linear-gradient(135deg, var(--orange), var(--gold)) !important;
    border-color: var(--gold) !important;
    transform: scale(1.08);
    box-shadow: 0 0 25px var(--orange);
}
.grid-cell.correct {
    background: var(--teal) !important;
    border-color: var(--teal) !important;
    animation: pulse 0.3s;
}
.grid-cell.wrong {
    background: var(--pink) !important;
    border-color: var(--pink) !important;
    animation: shake 0.3s;
}
.grid-cell.completed {
    background: rgba(0,217,165,0.3) !important;
    border-color: var(--teal) !important;
}
@keyframes pulse { 50% { transform: scale(1.1); } }
@keyframes shake { 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

.progress-section {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.tier-badge {
    background: linear-gradient(135deg, var(--orange), var(--gold));
    padding: 4px 10px;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: var(--dark);
    white-space: nowrap;
}
.progress-bar {
    flex: 1;
    height: 8px;
    background: var(--card);
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--orange), var(--gold));
    border-radius: 4px;
    transition: width 0.3s;
}

.action-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.2s;
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
    flex-shrink: 0;
    margin-top: 4px;
}
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* OVERLAYS */
.feedback-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    max-width: 300px;
    width: 100%;
}
.feedback-emoji { font-size: 2.5rem; margin-bottom: 8px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 3px;
    margin-bottom: 6px;
}
.feedback-title.success { color: var(--teal); }
.feedback-title.fail { color: var(--pink); }
.feedback-title.tierup { color: var(--gold); }
.feedback-message { color: var(--muted); margin-bottom: 12px; font-size: 0.85rem; }
.feedback-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 12px; }
.feedback-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--gold); }
.feedback-stat-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; }
.feedback-ritnome { font-size: 0.55rem; color: var(--gold); letter-spacing: 2px; margin-bottom: 12px; opacity: 0.8; }
.feedback-btn {
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 3px;
}
.feedback-btn.primary { background: linear-gradient(135deg, var(--orange), var(--gold)); color: var(--dark); }
.feedback-btn.secondary { background: transparent; color: var(--muted); border: 1px solid var(--muted); }

.upgrade-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 20px;
}
.upgrade-overlay.show { display: flex; }
.upgrade-card {
    background: linear-gradient(145deg, var(--card), #0a0a12);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 25px 20px;
    text-align: center;
    max-width: 320px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(255,215,0,0.2);
}
.upgrade-icon { font-size: 2.5rem; margin-bottom: 12px; }
.upgrade-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 8px;
}
.upgrade-text {
    color: var(--muted);
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 15px;
}
.upgrade-text strong { color: var(--text); }
.upgrade-bpm-preview {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 15px;
}
.upgrade-bpm-chip {
    padding: 6px 12px;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 1px;
}
.upgrade-bpm-chip.current {
    background: rgba(0,217,165,0.2);
    color: var(--teal);
    border: 1px solid var(--teal);
}
.upgrade-bpm-chip.locked {
    background: rgba(255,215,0,0.15);
    color: var(--gold);
    border: 1px solid var(--gold);
}
.upgrade-price {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 5px;
}
.upgrade-price span { font-size: 0.9rem; color: var(--muted); }
.upgrade-btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    text-decoration: none;
    margin-bottom: 10px;
}
.upgrade-close {
    background: transparent;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 8px 20px;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 1px;
    cursor: pointer;
}

.coach-message {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.8rem;
    opacity: 0;
    transition: all 0.3s;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }

.lang-toggle {
    position: fixed;
    top: 6px;
    right: 8px;
    display: flex;
    gap: 3px;
    z-index: 100;
}
.lang-btn {
    padding: 3px 8px;
    border: 1px solid var(--muted);
    background: transparent;
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.6rem;
    font-weight: 600;
    cursor: pointer;
}
.lang-btn.active { border-color: var(--gold); color: var(--gold); }

.back-btn {
    position: fixed;
    top: 6px;
    left: 8px;
    padding: 4px 10px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 12px;
    color: var(--muted);
    font-size: 0.65rem;
    cursor: pointer;
    text-decoration: none;
    z-index: 100;
}

body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

/* LARGER SCREENS */
@media (min-height: 750px) {
    .game-container { padding: 10px 15px; }
    .header { padding: 5px 0; }
    .court-name { font-size: 1.5rem; }
    .stats-bar { padding: 8px 12px; gap: 15px; }
    .stat-value { font-size: 1.2rem; }
    .message-display { padding: 10px; }
    .message-text { font-size: 1.1rem; }
    .court-grid { gap: 6px; padding: 10px; }
    .action-btn { padding: 14px; font-size: 1.2rem; }
}

/* VERY SHORT SCREENS (iPhone SE, etc) */
@media (max-height: 600px) {
    .game-container { padding: 4px 8px; }
    .header { padding: 1px 0; }
    .logo { font-size: 0.8rem; }
    .court-name { font-size: 1.1rem; }
    .powered-by { font-size: 0.45rem; }
    .stats-bar { padding: 4px 6px; gap: 10px; margin: 3px 0; }
    .stat-value { font-size: 0.9rem; }
    .stat-label { font-size: 0.4rem; }
    .message-display { padding: 5px; margin-bottom: 3px; }
    .message-text { font-size: 0.85rem; }
    .ritnome-tempo { margin-bottom: 3px; }
    .tempo-label { font-size: 0.45rem; margin-bottom: 2px; }
    .speed-btn { padding: 4px 2px; border-radius: 6px; }
    .speed-btn .icon { font-size: 0.75rem; }
    .speed-btn .bpm { font-size: 0.85rem; }
    .court-grid { padding: 6px; gap: 3px; border-radius: 10px; }
    .grid-cell { border-radius: 6px; border-width: 1px; }
    .progress-section { margin: 3px 0; gap: 6px; }
    .tier-badge { padding: 3px 8px; font-size: 0.6rem; }
    .progress-bar { height: 6px; }
    .action-btn { padding: 10px; font-size: 1rem; margin-top: 3px; }
}
</style>
</head>
<body class="en">

<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<a href="laugh-hub.html" class="back-btn">‚Üê Back</a>

<div class="game-container">
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT</div>
        <h1 class="court-name">üß† THE RECALL</h1>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="currentTier">1</div>
            <div class="stat-label">Tier</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="bestTier">0</div>
            <div class="stat-label">Best</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
    </div>

    <div class="message-display">
        <span class="message-text" id="messageText">
            <span class="lang-en">Select tempo & START!</span>
            <span class="lang-es">¬°Selecciona tempo e INICIA!</span>
        </span>
    </div>

    <div class="ritnome-tempo">
        <div class="tempo-label">üéµ <span class="ritnome-mark">Ritnome‚Ñ¢</span> Tempo</div>
        <div class="speed-selector">
            <button class="speed-btn active" data-speed="slow" data-bpm="60">
                <span class="icon">üê¢</span>
                <span class="bpm">60</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn" data-speed="medium" data-bpm="90">
                <span class="icon">üèÉ</span>
                <span class="bpm">90</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn" data-speed="fast" data-bpm="120">
                <span class="icon">‚ö°</span>
                <span class="bpm">120</span>
                <span class="bpm-label">BPM</span>
            </button>
        </div>
    </div>

    <div class="court-wrapper">
        <div class="court-grid" id="courtGrid"></div>
    </div>

    <div class="progress-section">
        <div class="tier-badge">TIER <span id="tierDisplay">1</span></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <button class="action-btn" id="actionBtn">
        <span class="lang-en">START RECALL üß†</span>
        <span class="lang-es">INICIAR üß†</span>
    </button>
</div>

<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üéâ</div>
        <h2 class="feedback-title" id="feedbackTitle">GREAT JOB!</h2>
        <p class="feedback-message" id="feedbackMessage">You completed the sequence!</p>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackTier">1</div>
                <div class="feedback-stat-label">Tier</div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackLaughs">0</div>
                <div class="feedback-stat-label">üòÇ Earned</div>
            </div>
        </div>
        <div class="feedback-ritnome">Ritnome‚Ñ¢ Training</div>
        <button class="feedback-btn primary" id="continueBtn">CONTINUE üß†</button>
        <button class="feedback-btn secondary" id="restartBtn">RESTART</button>
    </div>
</div>

<div class="upgrade-overlay" id="upgradeOverlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">üîìüéµ</div>
        <h2 class="upgrade-title">
            <span class="lang-en">UNLOCK ALL TEMPOS</span>
            <span class="lang-es">DESBLOQUEAR TODOS</span>
        </h2>
        <p class="upgrade-text">
            <span class="lang-en">You're training at <strong>60 BPM</strong>. Upgrade to unlock <strong>90 BPM</strong> and <strong>120 BPM</strong> for maximum brain training!</span>
            <span class="lang-es">Est√°s entrenando a <strong>60 BPM</strong>. ¬°Actualiza para desbloquear <strong>90 BPM</strong> y <strong>120 BPM</strong>!</span>
        </p>
        <div class="upgrade-bpm-preview">
            <span class="upgrade-bpm-chip current">‚úì 60</span>
            <span class="upgrade-bpm-chip locked">üîí 90</span>
            <span class="upgrade-bpm-chip locked">üîí 120</span>
        </div>
        <div class="upgrade-price">$5<span>/mo</span></div>
        <a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="upgrade-btn">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </a>
        <button class="upgrade-close" id="upgradeClose">
            <span class="lang-en">CONTINUE AT 60 BPM</span>
            <span class="lang-es">CONTINUAR A 60 BPM</span>
        </button>
    </div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // ==================== ENVIRONMENT DETECTION ====================
    var host = window.location.hostname;
    var isProduction = (host.indexOf('laughcourt') > -1 || host.indexOf('github.io') > -1);
    var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '');
    var isPreview = !isProduction && !isLocal;

    // ==================== PRODUCTION AUTH & HEARTBEAT ====================
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('lc-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) {
            window.location.replace('index.html');
            return;
        }

        var sessionPin = sessionStorage.getItem('lc-pin');
        var sessionToken = sessionStorage.getItem('lc-token');

        function validateSession() {
            if (!sessionPin || !sessionToken) {
                window.location.href = 'index.html';
                return;
            }
            fetch('/api/session/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: sessionPin, token: sessionToken })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.valid) {
                    alert(d.message || 'Session ended. Please log in again.');
                    localStorage.removeItem('lc-user');
                    localStorage.removeItem('lc-bpm-access');
                    sessionStorage.removeItem('lc-pin');
                    sessionStorage.removeItem('lc-token');
                    window.location.href = 'index.html';
                }
            })
            .catch(function(err) {
                console.log('Session validation error:', err);
            });
        }

        validateSession();
        setInterval(validateSession, 30000);
    }
    // ==================== END PRODUCTION AUTH & HEARTBEAT ====================

    var currentLang = localStorage.getItem('lc-lang') || 'en';
    
    var bpmAccess = { allBPM: false, userType: 'guest' };
    try {
        var storedAccess = localStorage.getItem('lc-bpm-access');
        if (storedAccess) bpmAccess = JSON.parse(storedAccess);
    } catch(e) {}

    var state = {
        tier: parseInt(localStorage.getItem('lc-recall-tier')) || 1,
        bestTier: parseInt(localStorage.getItem('lc-recall-best')) || 0,
        totalLaughs: parseInt(localStorage.getItem('lc-recall-laughs')) || 0,
        streak: 0,
        speed: 'slow',
        bpm: 60,
        sequence: [],
        userSequence: [],
        isPlaying: false,
        isShowing: false,
        circuitsCompleted: parseInt(localStorage.getItem('lc-recall-circuits')) || 0,
        cells: []
    };

    var speeds = {
        slow: { bpm: 60, flash: 800, pause: 400 },
        medium: { bpm: 90, flash: 500, pause: 300 },
        fast: { bpm: 120, flash: 350, pause: 200 }
    };

    var getSequenceLength = function(tier) { return tier + 1; };

    var courtGrid = document.getElementById('courtGrid');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var feedbackOverlay = document.getElementById('feedbackOverlay');
    var coachMessage = document.getElementById('coachMessage');
    var upgradeOverlay = document.getElementById('upgradeOverlay');

    var texts = {
        en: {
            selectStart: 'Select tempo & START!',
            watch: 'WATCH THE SEQUENCE...',
            yourTurn: 'YOUR TURN! Tap in order',
            perfect: 'PERFECT!',
            almost: 'ALMOST!',
            tierUp: 'TIER UP!',
            tryAgain: 'Shake it off, try again!',
            circuitsTo: 'circuits to next tier!',
            movingTo: 'Moving to Tier',
            continue: 'CONTINUE üß†',
            nextRound: 'NEXT üß†',
            tryAgainBtn: 'TRY AGAIN üß†',
            startRecall: 'START RECALL üß†',
            ready: 'Ready for Tier'
        },
        es: {
            selectStart: '¬°Selecciona tempo e INICIA!',
            watch: 'OBSERVA LA SECUENCIA...',
            yourTurn: '¬°TU TURNO! Toca en orden',
            perfect: '¬°PERFECTO!',
            almost: '¬°CASI!',
            tierUp: '¬°SUBISTE DE NIVEL!',
            tryAgain: '¬°Sac√∫dete e intenta!',
            circuitsTo: 'circuitos para subir!',
            movingTo: 'Avanzando a Tier',
            continue: 'CONTINUAR üß†',
            nextRound: 'SIGUIENTE üß†',
            tryAgainBtn: 'INTENTAR üß†',
            startRecall: 'INICIAR üß†',
            ready: 'Listo para Tier'
        }
    };

    function t(key) { return texts[currentLang][key] || texts['en'][key]; }

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('lc-lang', lang);
        document.body.className = lang;
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
    }

    function initBpmButtons() {
        var speedBtns = document.querySelectorAll('.speed-btn');
        speedBtns.forEach(function(btn) {
            var bpm = parseInt(btn.dataset.bpm);
            if (!bpmAccess.allBPM && bpm > 60) btn.classList.add('locked');
            else btn.classList.remove('locked');
        });
        if (!bpmAccess.allBPM) {
            state.speed = 'slow';
            state.bpm = 60;
            speedBtns.forEach(function(b) { b.classList.remove('active'); });
            document.querySelector('.speed-btn[data-bpm="60"]').classList.add('active');
        }
    }

    function showUpgradeModal() { upgradeOverlay.classList.add('show'); }
    function hideUpgradeModal() { upgradeOverlay.classList.remove('show'); }

    function initGrid() {
        courtGrid.innerHTML = '';
        state.cells = [];
        for (var i = 0; i < 25; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell disabled';
            cell.dataset.index = i;
            cell.addEventListener('click', function() { handleCellClick(parseInt(this.dataset.index)); });
            courtGrid.appendChild(cell);
            state.cells.push(cell);
        }
    }

    function generateSequence(length) {
        var seq = [];
        var available = [];
        for (var i = 0; i < 25; i++) available.push(i);
        for (var i = 0; i < length; i++) {
            var idx = Math.floor(Math.random() * available.length);
            seq.push(available.splice(idx, 1)[0]);
        }
        return seq;
    }

    function showSequence() {
        state.isShowing = true;
        actionBtn.disabled = true;
        state.cells.forEach(function(c) { c.classList.add('disabled'); c.classList.remove('completed'); });
        
        messageText.innerHTML = '<span class="lang-en">' + texts.en.watch + '</span><span class="lang-es">' + texts.es.watch + '</span>';
        messageText.className = 'message-text watch';
        
        var i = 0;
        var spd = speeds[state.speed];
        
        function flashNext() {
            if (i >= state.sequence.length) {
                state.isShowing = false;
                state.cells.forEach(function(c) { c.classList.remove('disabled'); });
                messageText.innerHTML = '<span class="lang-en">' + texts.en.yourTurn + '</span><span class="lang-es">' + texts.es.yourTurn + '</span>';
                messageText.className = 'message-text go';
                return;
            }
            var cell = state.cells[state.sequence[i]];
            cell.classList.add('lit');
            playTone(i);
            setTimeout(function() {
                cell.classList.remove('lit');
                i++;
                setTimeout(flashNext, spd.pause);
            }, spd.flash);
        }
        setTimeout(flashNext, 400);
    }

    function handleCellClick(index) {
        if (state.isShowing || !state.isPlaying) return;
        
        var cell = state.cells[index];
        state.userSequence.push(index);
        var currentIndex = state.userSequence.length - 1;
        var expected = state.sequence[currentIndex];
        
        if (index === expected) {
            cell.classList.add('correct');
            playTone(currentIndex);
            setTimeout(function() { 
                cell.classList.remove('correct');
                cell.classList.add('completed');
            }, 250);
            
            if (state.userSequence.length === state.sequence.length) handleSuccess();
        } else {
            cell.classList.add('wrong');
            playErrorTone();
            setTimeout(function() { cell.classList.remove('wrong'); }, 300);
            handleFailure(expected);
        }
    }

    function handleSuccess() {
        state.isPlaying = false;
        state.cells.forEach(function(c) { c.classList.add('disabled'); });
        
        var bpmBonus = state.bpm === 120 ? 2 : state.bpm === 90 ? 1 : 0;
        var laughsEarned = state.tier + bpmBonus;
        state.totalLaughs += laughsEarned;
        state.streak++;
        state.circuitsCompleted++;
        
        if (state.tier > state.bestTier) {
            state.bestTier = state.tier;
            localStorage.setItem('lc-recall-best', state.bestTier);
        }
        localStorage.setItem('lc-recall-laughs', state.totalLaughs);
        localStorage.setItem('lc-recall-circuits', state.circuitsCompleted);
        
        updateStats();
        showCoach(['PERFECT! üß†', 'MEMORY MASTER! üí™', 'SEQUENCE LOCKED! üî•', 'RITNOME! üéµ'][Math.floor(Math.random() * 4)]);
        
        var progress = (state.circuitsCompleted % 3) / 3 * 100;
        document.getElementById('progressFill').style.width = progress + '%';
        
        var tierUp = state.circuitsCompleted % 3 === 0 && state.tier < 10;
        setTimeout(function() { showFeedback(true, laughsEarned, tierUp); }, 800);
    }

    function handleFailure(expected) {
        state.isPlaying = false;
        state.cells.forEach(function(c) { c.classList.add('disabled'); });
        state.streak = 0;
        
        state.cells[expected].classList.add('lit');
        setTimeout(function() { state.cells[expected].classList.remove('lit'); }, 600);
        
        updateStats();
        showCoach(currentLang === 'es' ? '¬°Casi! üòÖ' : 'Close! üòÖ');
        setTimeout(function() { showFeedback(false, 0, false); }, 1200);
    }

    function showFeedback(success, laughs, tierUp) {
        var emoji = document.getElementById('feedbackEmoji');
        var title = document.getElementById('feedbackTitle');
        var message = document.getElementById('feedbackMessage');
        var continueBtn = document.getElementById('continueBtn');
        
        if (success) {
            if (tierUp) {
                emoji.textContent = 'üöÄ';
                title.textContent = t('tierUp');
                title.className = 'feedback-title tierup';
                message.textContent = t('movingTo') + ' ' + (state.tier + 1) + '!';
                state.tier++;
                localStorage.setItem('lc-recall-tier', state.tier);
            } else {
                emoji.textContent = 'üòÇ';
                title.textContent = t('perfect');
                title.className = 'feedback-title success';
                message.textContent = (state.circuitsCompleted % 3) + '/3 ' + t('circuitsTo');
            }
            continueBtn.textContent = tierUp ? t('continue') : t('nextRound');
        } else {
            emoji.textContent = 'üòÖ';
            title.textContent = t('almost');
            title.className = 'feedback-title fail';
            message.textContent = t('tryAgain');
            continueBtn.textContent = t('tryAgainBtn');
        }
        
        document.getElementById('feedbackTier').textContent = state.tier;
        document.getElementById('feedbackLaughs').textContent = laughs;
        feedbackOverlay.classList.add('show');
        updateStats();
    }

    function startRound() {
        state.sequence = generateSequence(getSequenceLength(state.tier));
        state.userSequence = [];
        state.isPlaying = true;
        actionBtn.disabled = true;
        showSequence();
    }

    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('bestTier').textContent = state.bestTier;
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;
    }

    function showCoach(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2000);
    }

    var audioCtx = null;
    function getAudioContext() {
        if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return null; } }
        return audioCtx;
    }
    var noteFreqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25, 698.46];
    function playTone(index) {
        var ctx = getAudioContext(); if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.type = 'sine'; osc.frequency.value = noteFreqs[index % noteFreqs.length];
            osc.connect(gain); gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.25);
        } catch(e) {}
    }
    function playErrorTone() {
        var ctx = getAudioContext(); if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator(), gain = ctx.createGain();
            osc.type = 'triangle'; osc.frequency.value = 180;
            osc.connect(gain); gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.25, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
        } catch(e) {}
    }

    actionBtn.addEventListener('click', function() {
        if (!state.isPlaying && !state.isShowing) startRound();
    });

    document.querySelectorAll('.speed-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (state.isPlaying) return;
            var bpm = parseInt(btn.dataset.bpm);
            if (!bpmAccess.allBPM && bpm > 60) { showUpgradeModal(); return; }
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.speed = btn.dataset.speed;
            state.bpm = bpm;
        });
    });

    document.getElementById('upgradeClose').addEventListener('click', hideUpgradeModal);

    document.getElementById('continueBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        actionBtn.disabled = false;
        messageText.innerHTML = '<span class="lang-en">' + t('ready') + ' ' + state.tier + '!</span><span class="lang-es">' + texts.es.ready + ' ' + state.tier + '!</span>';
        messageText.className = 'message-text';
    });

    document.getElementById('restartBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuitsCompleted = 0;
        state.streak = 0;
        localStorage.setItem('lc-recall-tier', 1);
        localStorage.setItem('lc-recall-circuits', 0);
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.disabled = false;
        messageText.innerHTML = '<span class="lang-en">Back to Tier 1!</span><span class="lang-es">¬°De vuelta al Tier 1!</span>';
        messageText.className = 'message-text';
        updateStats();
    });

    document.getElementById('btnEn').addEventListener('click', function() { setLang('en'); });
    document.getElementById('btnEs').addEventListener('click', function() { setLang('es'); });

    initGrid();
    initBpmButtons();
    setLang(currentLang);
    updateStats();
})();
</script>
</body>
</html>
