<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Hey Bori‚Ñ¢ ‚Äî Dashboard de Organizaci√≥n</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#F8F7F4;--card:#FFFFFF;--text:#111827;--muted:#5A6172;--light:#9CA3AF;--green:#10B981;--gold:#B8860B;--purple:#7C3AED;--red:#EF4444;--border:1px solid rgba(26,29,43,.08);--shadow:0 2px 12px rgba(26,29,43,.06);--radius:18px;--head:'Bebas Neue',sans-serif;--body:'Outfit',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--body);background:var(--bg);color:var(--text);min-height:100vh;-webkit-tap-highlight-color:transparent}

/* Nav */
.nav{background:white;border-bottom:var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.nav-brand{font-family:var(--head);font-size:1.3rem;letter-spacing:3px;color:var(--purple)}
.nav-badge{font-size:10px;font-weight:700;color:white;background:var(--green);padding:3px 10px;border-radius:100px;letter-spacing:1px}

/* Container */
.container{max-width:600px;margin:0 auto;padding:20px 16px}

/* Auth screens */
.auth-screen{display:none}
.auth-screen.active{display:block}
.auth-hero{text-align:center;padding:40px 0 20px}
.auth-icon{font-size:48px;margin-bottom:12px}
.auth-title{font-family:var(--head);font-size:2rem;letter-spacing:3px;color:var(--text)}
.auth-sub{color:var(--muted);font-size:14px;margin-top:6px;line-height:1.5}

.auth-card{background:var(--card);border-radius:var(--radius);padding:28px 24px;box-shadow:var(--shadow);border:var(--border);margin-top:20px}
.auth-label{font-size:12px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.auth-input{width:100%;padding:14px 16px;border:2px solid rgba(26,29,43,.1);border-radius:12px;font-family:var(--body);font-size:16px;font-weight:600;color:var(--text);outline:none;transition:border .2s;margin-bottom:16px}
.auth-input:focus{border-color:var(--purple)}
.auth-input::placeholder{color:var(--light);font-weight:400}

.auth-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:var(--body);font-size:17px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:4px}
.auth-btn-primary{background:linear-gradient(135deg,var(--purple),#9333EA);color:white;box-shadow:0 4px 20px rgba(107,33,168,.25)}
.auth-btn-primary:active{transform:scale(.98)}
.auth-btn-secondary{background:rgba(17,24,39,.05);color:var(--text);margin-top:12px}

.auth-switch{text-align:center;margin-top:20px;font-size:14px;color:var(--muted)}
.auth-switch a{color:var(--purple);font-weight:700;text-decoration:none}

.auth-msg{text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600;margin-top:12px;display:none}
.auth-msg.error{display:block;background:rgba(239,68,68,.1);color:var(--red)}
.auth-msg.success{display:block;background:rgba(16,185,129,.1);color:var(--green)}

/* Dashboard */
.dash{display:none}
.dash.active{display:block}

.dash-header{background:linear-gradient(135deg,var(--purple),#6D28D9);border-radius:var(--radius);padding:24px;color:white;margin-bottom:16px;position:relative;overflow:hidden}
.dash-header::after{content:'';position:absolute;top:-20px;right:-20px;width:120px;height:120px;background:rgba(255,255,255,.06);border-radius:50%}
.dash-name{font-family:var(--head);font-size:1.6rem;letter-spacing:3px}
.dash-code-row{display:flex;align-items:center;gap:10px;margin-top:8px}
.dash-code{font-family:var(--head);font-size:1.2rem;letter-spacing:4px;background:rgba(255,255,255,.15);padding:6px 14px;border-radius:8px}
.dash-code-label{font-size:12px;opacity:.7}
.dash-residents{font-size:13px;opacity:.7;margin-top:8px}

/* Stats cards */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
.stat-card{background:var(--card);border-radius:14px;padding:16px 12px;text-align:center;box-shadow:var(--shadow);border:var(--border)}
.stat-num{font-family:var(--head);font-size:2rem;letter-spacing:2px}
.stat-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.5px;margin-top:2px}
.stat-num.green{color:var(--green)}
.stat-num.purple{color:var(--purple)}
.stat-num.gold{color:var(--gold)}

/* Section card */
.section{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border:var(--border);margin-bottom:16px}
.section-title{font-family:var(--head);font-size:1.1rem;letter-spacing:2px;color:var(--text);margin-bottom:14px}

/* Week chart */
.week-chart{display:flex;gap:6px;align-items:flex-end;height:120px}
.week-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.week-bar{width:100%;border-radius:8px 8px 4px 4px;min-height:4px;transition:height .4s}
.week-bar.games{background:linear-gradient(to top,var(--purple),#A78BFA)}
.week-bar.chats{background:linear-gradient(to top,var(--green),#6EE7B7)}
.week-day{font-size:10px;font-weight:700;color:var(--light);letter-spacing:.5px}
.week-legend{display:flex;gap:16px;margin-top:12px;justify-content:center}
.legend-item{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:var(--muted)}
.legend-dot{width:10px;height:10px;border-radius:3px}
.legend-dot.games{background:var(--purple)}
.legend-dot.chats{background:var(--green)}

/* Popular games */
.game-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(26,29,43,.05)}
.game-row:last-child{border-bottom:none}
.game-rank{font-family:var(--head);font-size:1.2rem;color:var(--light);width:24px;text-align:center}
.game-name{flex:1;font-weight:600;font-size:14px}
.game-count{font-family:var(--head);font-size:1rem;color:var(--purple);letter-spacing:1px}

/* Mood summary */
.mood-row{display:flex;gap:8px;flex-wrap:wrap}
.mood-chip{padding:6px 14px;border-radius:100px;font-size:13px;font-weight:600;background:rgba(26,29,43,.04)}

/* Code share card */
.code-share{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border-radius:var(--radius);padding:20px;text-align:center;margin-bottom:16px;border:2px solid rgba(184,134,11,.15)}
.code-share-title{font-family:var(--head);font-size:1rem;letter-spacing:2px;color:var(--gold);margin-bottom:6px}
.code-share-code{font-family:var(--head);font-size:2.2rem;letter-spacing:6px;color:var(--text);margin:8px 0}
.code-share-desc{font-size:12px;color:var(--muted);line-height:1.5}
.code-copy-btn{margin-top:12px;padding:10px 24px;border:2px solid var(--gold);border-radius:100px;background:white;font-family:var(--body);font-size:13px;font-weight:700;color:var(--gold);cursor:pointer}
.code-copy-btn:active{background:var(--gold);color:white}

/* Logout */
.logout-btn{width:100%;padding:14px;border:2px solid rgba(26,29,43,.08);border-radius:14px;background:transparent;font-family:var(--body);font-size:14px;font-weight:600;color:var(--muted);cursor:pointer;margin-top:8px;margin-bottom:40px}

/* Footer */
.footer{text-align:center;padding:20px 0 30px;font-size:11px;color:var(--light);letter-spacing:.5px}
.footer a{color:var(--purple);text-decoration:none;font-weight:600}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--muted);font-size:14px}
</style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">HEY BORI‚Ñ¢ ORGANIZACIONES</div>
    <div class="nav-badge">GRATIS</div>
</nav>

<div class="container">

<!-- WELCOME / CHOICE SCREEN -->
<div class="auth-screen active" id="welcomeScreen">
    <div class="auth-hero">
        <div class="auth-icon">ü§ù</div>
        <div class="auth-title">DASHBOARD DE ORGANIZACI√ìN</div>
        <div class="auth-sub">Monitoreo de actividad cognitiva para sus participantes. Hogares de cuido, centros de rehabilitaci√≥n, programas comunitarios, iglesias ‚Äî todos bienvenidos. Totalmente gratis.</div>
    </div>
    <div class="auth-card">
        <button class="auth-btn auth-btn-primary" onclick="showScreen('loginScreen')">Ya tengo cuenta</button>
        <button class="auth-btn auth-btn-secondary" onclick="showScreen('signupScreen')">Registrar mi organizaci√≥n</button>
    </div>
</div>

<!-- SIGNUP SCREEN -->
<div class="auth-screen" id="signupScreen">
    <div class="auth-hero">
        <div class="auth-icon">üìã</div>
        <div class="auth-title">REGISTRAR ORGANIZACI√ìN</div>
        <div class="auth-sub">Solo necesitamos el nombre de su organizaci√≥n y un n√∫mero de contacto.</div>
    </div>
    <div class="auth-card">
        <div class="auth-label">Nombre de la Organizaci√≥n</div>
        <input class="auth-input" id="signupName" type="text" placeholder="Ej: Centro Vida Plena, Hogar Santa Mar√≠a...">
        <div class="auth-label">Tel√©fono de Contacto</div>
        <input class="auth-input" id="signupPhone" type="tel" placeholder="787-555-1234">
        <button class="auth-btn auth-btn-primary" onclick="doSignup()">Registrar Organizaci√≥n</button>
        <div class="auth-msg" id="signupMsg"></div>
    </div>
    <div class="auth-switch"><a href="#" onclick="event.preventDefault();showScreen('loginScreen')">¬øYa tiene cuenta? Entrar ‚Üí</a></div>
</div>

<!-- LOGIN SCREEN -->
<div class="auth-screen" id="loginScreen">
    <div class="auth-hero">
        <div class="auth-icon">üîë</div>
        <div class="auth-title">ACCEDER</div>
        <div class="auth-sub">Entre con el n√∫mero de tel√©fono registrado.</div>
    </div>
    <div class="auth-card">
        <div class="auth-label">Tel√©fono de Contacto</div>
        <input class="auth-input" id="loginPhone" type="tel" placeholder="787-555-1234">
        <button class="auth-btn auth-btn-primary" onclick="doLogin()">Entrar</button>
        <div class="auth-msg" id="loginMsg"></div>
    </div>
    <div class="auth-switch"><a href="#" onclick="event.preventDefault();showScreen('signupScreen')">¬øNueva organizaci√≥n? Registrarse ‚Üí</a></div>
</div>

<!-- SIGNUP SUCCESS -->
<div class="auth-screen" id="successScreen">
    <div class="auth-hero">
        <div class="auth-icon">üéâ</div>
        <div class="auth-title">¬°ORGANIZACI√ìN REGISTRADA!</div>
        <div class="auth-sub">Este es el c√≥digo de su organizaci√≥n. Los participantes lo usan para conectarse.</div>
    </div>
    <div class="code-share">
        <div class="code-share-title">C√ìDIGO DE ORGANIZACI√ìN</div>
        <div class="code-share-code" id="successCode">---</div>
        <div class="code-share-desc">Comparta este c√≥digo con los participantes o sus familias.<br>Ellos lo entran en heybori.com para conectarse a su organizaci√≥n.</div>
        <button class="code-copy-btn" onclick="copyCode()">üìã Copiar C√≥digo</button>
    </div>
    <div class="auth-card">
        <button class="auth-btn auth-btn-primary" onclick="loadDashboard()">Ver Mi Dashboard ‚Üí</button>
    </div>
</div>

<!-- DASHBOARD -->
<div class="dash" id="dashboard">
    
    <div class="dash-header">
        <div class="dash-name" id="dashName">---</div>
        <div class="dash-code-row">
            <div class="dash-code-label">C√≥digo:</div>
            <div class="dash-code" id="dashCode">---</div>
        </div>
        <div class="dash-residents" id="dashResidents">0 participantes conectados</div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-num green" id="statActive">0</div>
            <div class="stat-label">Activos Hoy</div>
        </div>
        <div class="stat-card">
            <div class="stat-num purple" id="statGames">0</div>
            <div class="stat-label">Juegos Hoy</div>
        </div>
        <div class="stat-card">
            <div class="stat-num gold" id="statChats">0</div>
            <div class="stat-label">Chats Hoy</div>
        </div>
    </div>

    <div class="section" id="moodSection" style="display:none">
        <div class="section-title">ESTADO DE √ÅNIMO HOY</div>
        <div class="mood-row" id="moodRow"></div>
    </div>

    <div class="section">
        <div class="section-title">ACTIVIDAD SEMANAL</div>
        <div class="week-chart" id="weekChart"></div>
        <div class="week-legend">
            <div class="legend-item"><div class="legend-dot games"></div>Juegos</div>
            <div class="legend-item"><div class="legend-dot chats"></div>Conversaciones</div>
        </div>
    </div>

    <div class="section" id="gamesSection" style="display:none">
        <div class="section-title">JUEGOS M√ÅS POPULARES</div>
        <div id="gamesList"></div>
    </div>

    <div class="section">
        <div class="section-title">TOTALES</div>
        <div class="stats-row" style="margin-bottom:0">
            <div class="stat-card">
                <div class="stat-num purple" id="totalGames">0</div>
                <div class="stat-label">Juegos Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-num gold" id="totalChats">0</div>
                <div class="stat-label">Chats Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-num green" id="totalResidents">0</div>
                <div class="stat-label">Participantes</div>
            </div>
        </div>
    </div>

    <div class="code-share">
        <div class="code-share-title">C√ìDIGO PARA PARTICIPANTES</div>
        <div class="code-share-code" id="dashShareCode">---</div>
        <div class="code-share-desc">Comparta este c√≥digo con participantes o imprima para el √°rea de actividades.</div>
        <button class="code-copy-btn" onclick="copyCode()">üìã Copiar C√≥digo</button>
    </div>

    <button class="logout-btn" onclick="doLogout()">Cerrar Sesi√≥n</button>

    <div class="footer">
        <a href="/">‚Üê Volver a Hey Bori</a><br><br>
        Hey Bori‚Ñ¢ ¬∑ Ritnome‚Ñ¢<br>
        ¬© 2026 GoStar Digital LLC. All Rights Reserved.
    </div>
</div>

</div>

<script>
var DAY_NAMES = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
var facilityPhone = localStorage.getItem('boriFacilityPhone') || '';
var facilityCode = '';

function showScreen(id) {
    document.querySelectorAll('.auth-screen').forEach(function(s) { s.classList.remove('active'); });
    document.getElementById('dashboard').classList.remove('active');
    document.getElementById(id).classList.add('active');
}

function showMsg(elId, msg, type) {
    var el = document.getElementById(elId);
    el.textContent = msg;
    el.className = 'auth-msg ' + type;
}

function cleanPhone(p) { return (p || '').replace(/[^0-9]/g, ''); }

function doSignup() {
    var name = document.getElementById('signupName').value.trim();
    var phone = cleanPhone(document.getElementById('signupPhone').value);
    if (!name) { showMsg('signupMsg', 'Escriba el nombre de la organizaci√≥n', 'error'); return; }
    if (phone.length < 7) { showMsg('signupMsg', 'N√∫mero de tel√©fono inv√°lido', 'error'); return; }

    fetch('/api/facility/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, phone: phone })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            facilityPhone = phone;
            facilityCode = data.code;
            localStorage.setItem('boriFacilityPhone', phone);
            document.getElementById('successCode').textContent = data.code;
            showScreen('successScreen');
        } else if (data.existing) {
            facilityPhone = phone;
            facilityCode = data.facilityCode;
            localStorage.setItem('boriFacilityPhone', phone);
            showMsg('signupMsg', 'Este n√∫mero ya est√° registrado. C√≥digo: ' + data.facilityCode, 'success');
        } else {
            showMsg('signupMsg', data.error || 'Error', 'error');
        }
    })
    .catch(function() { showMsg('signupMsg', 'Error de conexi√≥n', 'error'); });
}

function doLogin() {
    var phone = cleanPhone(document.getElementById('loginPhone').value);
    if (phone.length < 7) { showMsg('loginMsg', 'N√∫mero de tel√©fono inv√°lido', 'error'); return; }

    fetch('/api/facility/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: phone })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            facilityPhone = phone;
            facilityCode = data.code;
            localStorage.setItem('boriFacilityPhone', phone);
            loadDashboard();
        } else {
            showMsg('loginMsg', data.error || 'Error', 'error');
        }
    })
    .catch(function() { showMsg('loginMsg', 'Error de conexi√≥n', 'error'); });
}

function loadDashboard() {
    document.querySelectorAll('.auth-screen').forEach(function(s) { s.classList.remove('active'); });
    var dash = document.getElementById('dashboard');
    dash.classList.add('active');

    fetch('/api/facility/dashboard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: facilityPhone })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { doLogout(); return; }
        renderDashboard(data);
    })
    .catch(function() { });
}

function renderDashboard(data) {
    var f = data.facility;
    facilityCode = f.code;
    
    document.getElementById('dashName').textContent = f.name;
    document.getElementById('dashCode').textContent = f.code;
    document.getElementById('dashResidents').textContent = f.totalResidents + ' participante' + (f.totalResidents !== 1 ? 's' : '') + ' conectado' + (f.totalResidents !== 1 ? 's' : '');
    document.getElementById('dashShareCode').textContent = f.code;

    // Today stats
    document.getElementById('statActive').textContent = data.today.activeResidents;
    document.getElementById('statGames').textContent = data.today.games;
    document.getElementById('statChats').textContent = data.today.chats;

    // Moods
    if (data.today.moods && data.today.moods.length > 0) {
        document.getElementById('moodSection').style.display = 'block';
        var moodRow = document.getElementById('moodRow');
        moodRow.innerHTML = '';
        var moodMap = {};
        data.today.moods.forEach(function(m) {
            var label = (m && m.mood) || m || 'desconocido';
            moodMap[label] = (moodMap[label] || 0) + 1;
        });
        Object.keys(moodMap).forEach(function(mood) {
            var chip = document.createElement('div');
            chip.className = 'mood-chip';
            chip.textContent = mood + ' (' + moodMap[mood] + ')';
            moodRow.appendChild(chip);
        });
    }

    // Week chart
    var weekChart = document.getElementById('weekChart');
    weekChart.innerHTML = '';
    var maxVal = 1;
    data.week.forEach(function(d) {
        var total = d.games + d.chats;
        if (total > maxVal) maxVal = total;
    });
    data.week.forEach(function(d) {
        var dt = new Date(d.date + 'T12:00:00');
        var dayName = DAY_NAMES[dt.getDay()];
        var gamesH = Math.max(4, (d.games / maxVal) * 80);
        var chatsH = Math.max(4, (d.chats / maxVal) * 80);
        if (d.games === 0) gamesH = 4;
        if (d.chats === 0) chatsH = 4;

        var col = document.createElement('div');
        col.className = 'week-bar-col';
        col.innerHTML = '<div class="week-bar chats" style="height:' + chatsH + 'px"></div>' +
            '<div class="week-bar games" style="height:' + gamesH + 'px"></div>' +
            '<div class="week-day">' + dayName + '</div>';
        weekChart.appendChild(col);
    });

    // Popular games
    if (data.popularGames && data.popularGames.length > 0) {
        document.getElementById('gamesSection').style.display = 'block';
        var list = document.getElementById('gamesList');
        list.innerHTML = '';
        data.popularGames.slice(0, 5).forEach(function(g, i) {
            var row = document.createElement('div');
            row.className = 'game-row';
            row.innerHTML = '<div class="game-rank">' + (i + 1) + '</div>' +
                '<div class="game-name">' + g.game + '</div>' +
                '<div class="game-count">' + g.count + '</div>';
            list.appendChild(row);
        });
    }

    // Totals
    document.getElementById('totalGames').textContent = data.totals.totalGames;
    document.getElementById('totalChats').textContent = data.totals.totalChats;
    document.getElementById('totalResidents').textContent = data.totals.activeResidents;
}

function copyCode() {
    var code = facilityCode;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(function() {
            var btns = document.querySelectorAll('.code-copy-btn');
            btns.forEach(function(b) { b.textContent = '‚úÖ ¬°Copiado!'; });
            setTimeout(function() { btns.forEach(function(b) { b.textContent = 'üìã Copiar C√≥digo'; }); }, 2000);
        });
    }
}

function doLogout() {
    facilityPhone = '';
    facilityCode = '';
    localStorage.removeItem('boriFacilityPhone');
    document.getElementById('dashboard').classList.remove('active');
    showScreen('welcomeScreen');
}

// Auto-login if saved
if (facilityPhone) {
    fetch('/api/facility/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: facilityPhone })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.ok) {
            facilityCode = data.code;
            loadDashboard();
        } else {
            showScreen('welcomeScreen');
        }
    })
    .catch(function() { showScreen('welcomeScreen'); });
} else {
    showScreen('welcomeScreen');
}

// Auto-refresh every 60 seconds
setInterval(function() {
    if (facilityPhone && document.getElementById('dashboard').classList.contains('active')) {
        loadDashboard();
    }
}, 60000);
</script>
</body>
</html>