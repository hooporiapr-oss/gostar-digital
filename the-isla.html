<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>La Isla üáµüá∑ ‚Äî Hey Bori</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0B0B14;
  --bg-surface: #1A1726;
  --bg-card: #231F30;
  --purple: #8B5CF6;
  --purple-glow: rgba(139, 92, 246, 0.3);
  --gold: #D4A843;
  --gold-bright: #FFD700;
  --teal: #2DD4A8;
  --text-primary: #FFFFFF;
  --text-secondary: rgba(255,255,255,0.7);
  --text-muted: rgba(255,255,255,0.4);
  --success: #22C55E;
  --radius: 16px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: 'Instrument Sans', sans-serif;
  min-height: 100dvh;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(ellipse at 30% 20%, rgba(139,92,246,0.08) 0%, transparent 50%),
              radial-gradient(ellipse at 70% 80%, rgba(45,212,168,0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(11,11,20,0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(139,92,246,0.15);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-back {
  background: none;
  border: none;
  color: var(--purple);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
}

.header-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  background: linear-gradient(135deg, var(--gold), var(--gold-bright));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-flag {
  font-size: 20px;
}

.header-badge {
  background: var(--bg-card);
  border: 1px solid rgba(139,92,246,0.3);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 11px;
  color: var(--teal);
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* ‚ïê‚ïê‚ïê SCENE SELECT SCREEN ‚ïê‚ïê‚ïê */
.screen { display: none; position: relative; z-index: 1; }
.screen.active { display: block; }

.scene-select {
  padding: 20px 16px 100px;
  max-width: 600px;
  margin: 0 auto;
}

.scene-intro {
  text-align: center;
  margin-bottom: 28px;
}

.scene-intro h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 26px;
  margin-bottom: 6px;
}

.scene-intro p {
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.5;
}

.difficulty-selector {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 24px;
}

.diff-btn {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 8px 18px;
  color: var(--text-secondary);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.diff-btn.active {
  background: linear-gradient(135deg, var(--purple), #6D3BF5);
  border-color: var(--purple);
  color: white;
  box-shadow: 0 4px 15px var(--purple-glow);
}

.scene-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
}

.scene-card {
  position: relative;
  border-radius: var(--radius);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s;
  border: 2px solid rgba(255,255,255,0.06);
  aspect-ratio: 1;
}

.scene-card:hover {
  border-color: var(--purple);
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(139,92,246,0.2);
}

.scene-card.locked {
  opacity: 0.5;
  pointer-events: none;
}

.scene-card.locked::after {
  content: 'üîí';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px;
  z-index: 3;
}

.scene-canvas-preview {
  width: 100%;
  height: 100%;
  display: block;
}

.scene-label {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 28px 10px 10px;
  background: linear-gradient(to top, rgba(11,11,20,0.95), transparent);
  text-align: center;
}

.scene-label span {
  font-family: 'DM Serif Display', serif;
  font-size: 14px;
  color: white;
}

.scene-label small {
  display: block;
  font-size: 10px;
  color: var(--gold);
  margin-top: 2px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.completed-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--success);
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 10px;
  z-index: 2;
}

/* ‚ïê‚ïê‚ïê PUZZLE SCREEN ‚ïê‚ïê‚ïê */
.puzzle-screen {
  padding: 12px;
  max-width: 700px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  min-height: calc(100dvh - 60px);
}

.puzzle-top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.puzzle-scene-name {
  font-family: 'DM Serif Display', serif;
  font-size: 16px;
  color: var(--gold);
}

.puzzle-stats {
  display: flex;
  gap: 14px;
  font-size: 12px;
  color: var(--text-secondary);
}

.puzzle-stats span { display: flex; align-items: center; gap: 4px; }

.puzzle-reference {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 10px;
  border: 1px solid rgba(139,92,246,0.2);
  transition: all 0.3s;
}

.puzzle-reference canvas {
  width: 100%;
  display: block;
  border-radius: 12px;
}

.ref-toggle {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(11,11,20,0.8);
  border: 1px solid rgba(139,92,246,0.3);
  border-radius: 8px;
  color: white;
  font-size: 11px;
  padding: 4px 10px;
  cursor: pointer;
  font-family: 'Instrument Sans', sans-serif;
}

.puzzle-board-container {
  flex: 1;
  position: relative;
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 2px solid rgba(139,92,246,0.15);
  overflow: hidden;
  min-height: 300px;
  touch-action: none;
}

.puzzle-board {
  position: relative;
  width: 100%;
  height: 100%;
}

.puzzle-piece {
  position: absolute;
  cursor: grab;
  transition: box-shadow 0.2s;
  border-radius: 3px;
  image-rendering: auto;
}

.puzzle-piece:active { cursor: grabbing; }

.puzzle-piece.placed {
  cursor: default;
  box-shadow: none !important;
}

.puzzle-piece.near-target {
  box-shadow: 0 0 15px var(--teal), 0 0 30px rgba(45,212,168,0.3) !important;
}

.puzzle-piece:not(.placed):hover {
  box-shadow: 0 4px 20px rgba(139,92,246,0.4);
  z-index: 999 !important;
}

/* ‚ïê‚ïê‚ïê COMPLETION MODAL ‚ïê‚ïê‚ïê */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(11,11,20,0.92);
  backdrop-filter: blur(10px);
  z-index: 200;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-card);
  border-radius: 24px;
  border: 1px solid rgba(139,92,246,0.3);
  padding: 30px 24px;
  text-align: center;
  max-width: 380px;
  width: 100%;
  animation: modalIn 0.5s ease;
}

@keyframes modalIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal-art {
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
  border: 3px solid var(--gold);
  box-shadow: 0 0 40px rgba(212,168,67,0.2);
}

.modal-art canvas {
  width: 100%;
  display: block;
}

.modal h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 28px;
  margin-bottom: 4px;
  background: linear-gradient(135deg, var(--gold), var(--gold-bright));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.modal .modal-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 6px;
}

.modal .modal-stats-line {
  color: var(--teal);
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 20px;
}

.modal-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--purple), #6D3BF5);
  border: none;
  border-radius: 14px;
  color: white;
  font-family: 'Instrument Sans', sans-serif;
  font-size: 15px;
  font-weight: 600;
  padding: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--purple-glow); }

.btn-secondary {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 14px;
  color: var(--text-secondary);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 14px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-secondary:hover { border-color: var(--purple); color: white; }

/* ‚ïê‚ïê‚ïê CONFETTI ‚ïê‚ïê‚ïê */
.confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 250;
  overflow: hidden;
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  top: -10px;
  animation: confettiFall linear forwards;
}

@keyframes confettiFall {
  to { top: 110vh; transform: rotate(720deg); }
}

/* ‚ïê‚ïê‚ïê TIER UPSELL ‚ïê‚ïê‚ïê */
.upsell-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background: linear-gradient(135deg, var(--gold), var(--gold-bright));
  color: #0B0B14;
  font-size: 9px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 8px;
  z-index: 2;
  letter-spacing: 0.5px;
}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media (max-width: 400px) {
  .scene-grid { gap: 10px; }
  .scene-intro h2 { font-size: 22px; }
  .puzzle-screen { padding: 8px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<div class="header">
  <div class="header-left">
    <button class="header-back" id="backBtn" onclick="goBack()">‚Üê</button>
    <span class="header-title">La Isla</span>
    <span class="header-flag">üáµüá∑</span>
  </div>
  <span class="header-badge" id="tierBadge">LIBRE</span>
</div>

<!-- ‚ïê‚ïê‚ïê SCENE SELECT ‚ïê‚ïê‚ïê -->
<div class="screen active" id="selectScreen">
  <div class="scene-select">
    <div class="scene-intro">
      <h2>Escoge Tu Escena</h2>
      <p>Arma el rompecabezas y descubre la belleza de Puerto Rico üáµüá∑</p>
    </div>
    <div class="difficulty-selector">
      <button class="diff-btn active" data-pieces="9" onclick="setDifficulty(this, 9)">F√°cil (9)</button>
      <button class="diff-btn" data-pieces="16" onclick="setDifficulty(this, 16)">Medio (16)</button>
      <button class="diff-btn" data-pieces="25" onclick="setDifficulty(this, 25)">Dif√≠cil (25)</button>
    </div>
    <div class="scene-grid" id="sceneGrid"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PUZZLE SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="puzzleScreen">
  <div class="puzzle-screen">
    <div class="puzzle-top-bar">
      <span class="puzzle-scene-name" id="puzzleSceneName"></span>
      <div class="puzzle-stats">
        <span>üß© <span id="piecesPlaced">0</span>/<span id="piecesTotal">9</span></span>
        <span>‚è±Ô∏è <span id="timer">0:00</span></span>
      </div>
    </div>
    <div class="puzzle-reference" id="puzzleReference">
      <canvas id="referenceCanvas"></canvas>
      <button class="ref-toggle" id="refToggle" onclick="toggleReference()">Esconder</button>
    </div>
    <div class="puzzle-board-container" id="boardContainer">
      <div class="puzzle-board" id="puzzleBoard"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê COMPLETION MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="completionModal">
  <div class="modal">
    <div class="modal-art">
      <canvas id="completionCanvas"></canvas>
    </div>
    <h2>¬°WEPA! üéâ</h2>
    <p class="modal-subtitle" id="completionScene"></p>
    <p class="modal-stats-line" id="completionStats"></p>
    <div class="modal-actions">
      <button class="btn-primary" onclick="nextPuzzle()">Pr√≥ximo Rompecabezas ‚Üí</button>
      <button class="btn-secondary" onclick="backToSelect()">Ver Todas las Escenas</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONFETTI ‚ïê‚ïê‚ïê -->
<div class="confetti-container" id="confettiContainer"></div>

<script>
// ‚ïê‚ïê‚ïê PUERTO RICO SCENE DATA ‚ïê‚ïê‚ïê
const SCENES = [
  {
    id: 'el-morro',
    name: 'El Morro',
    subtitle: 'San Juan',
    free: true,
    colors: {
      sky: ['#1a6fc4','#4a9de6','#87ceeb','#b0dff7'],
      ocean: ['#0a4a7a','#1565a0','#2080c0','#60b0e0'],
      wall: ['#c4a66a','#d4b87a','#b8976a','#a88a5a'],
      grass: ['#2d8f4e','#3ba55e','#4dbd6e','#68d080']
    },
    draw: function(ctx, w, h) {
      // Sky gradient
      let skyGrad = ctx.createLinearGradient(0,0,0,h*0.5);
      skyGrad.addColorStop(0,'#1a6fc4');
      skyGrad.addColorStop(0.5,'#4a9de6');
      skyGrad.addColorStop(1,'#87ceeb');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0,0,w,h*0.55);

      // Clouds
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      drawCloud(ctx, w*0.15, h*0.12, 40);
      drawCloud(ctx, w*0.6, h*0.08, 55);
      drawCloud(ctx, w*0.85, h*0.18, 35);

      // Ocean
      let oceanGrad = ctx.createLinearGradient(0,h*0.5,0,h*0.72);
      oceanGrad.addColorStop(0,'#1565a0');
      oceanGrad.addColorStop(1,'#0a4a7a');
      ctx.fillStyle = oceanGrad;
      ctx.fillRect(0,h*0.5,w,h*0.22);

      // Ocean waves
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1.5;
      for(let i=0;i<6;i++){
        ctx.beginPath();
        let y = h*0.52 + i*h*0.035;
        for(let x=0;x<w;x+=3){
          ctx.lineTo(x, y + Math.sin(x*0.02+i)*4);
        }
        ctx.stroke();
      }

      // Grass hill
      ctx.fillStyle = '#2d8f4e';
      ctx.beginPath();
      ctx.moveTo(0, h*0.72);
      ctx.quadraticCurveTo(w*0.3, h*0.62, w*0.5, h*0.65);
      ctx.quadraticCurveTo(w*0.7, h*0.68, w, h*0.7);
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.fill();

      // Grass detail
      let grassGrad = ctx.createLinearGradient(0,h*0.7,0,h);
      grassGrad.addColorStop(0,'#3ba55e');
      grassGrad.addColorStop(1,'#1a6030');
      ctx.fillStyle = grassGrad;
      ctx.fillRect(0,h*0.75,w,h*0.25);

      // El Morro fortress
      let fx = w*0.25, fy = h*0.38, fw = w*0.5, fh = h*0.35;
      // Main wall
      let wallGrad = ctx.createLinearGradient(fx,fy,fx,fy+fh);
      wallGrad.addColorStop(0,'#d4b87a');
      wallGrad.addColorStop(0.5,'#c4a66a');
      wallGrad.addColorStop(1,'#a88a5a');
      ctx.fillStyle = wallGrad;
      ctx.fillRect(fx, fy, fw, fh);

      // Wall texture lines
      ctx.strokeStyle = 'rgba(0,0,0,0.08)';
      ctx.lineWidth = 0.5;
      for(let i=0;i<8;i++){
        let y = fy + i*(fh/8);
        ctx.beginPath();
        ctx.moveTo(fx,y);
        ctx.lineTo(fx+fw,y);
        ctx.stroke();
      }

      // Tower left
      ctx.fillStyle = '#c4a66a';
      ctx.fillRect(fx-w*0.02, fy-h*0.08, w*0.12, h*0.08);
      // Tower right
      ctx.fillRect(fx+fw-w*0.1, fy-h*0.12, w*0.12, h*0.12);

      // Sentry box (garita)
      let gx = fx+fw-w*0.03, gy = fy+h*0.05;
      ctx.fillStyle = '#d4b87a';
      ctx.fillRect(gx, gy, w*0.06, h*0.12);
      ctx.beginPath();
      ctx.arc(gx+w*0.03, gy, w*0.03, Math.PI, 0);
      ctx.fill();
      // Garita stripe
      ctx.fillStyle = '#c4a66a';
      ctx.fillRect(gx+w*0.025, gy, w*0.01, h*0.12);

      // Windows
      ctx.fillStyle = '#2a2a3a';
      for(let i=0;i<3;i++){
        ctx.fillRect(fx+w*0.08+i*w*0.14, fy+h*0.06, w*0.04, h*0.05);
      }

      // PR flag on tower
      let flagX = fx+fw-w*0.06, flagY = fy-h*0.2;
      ctx.fillStyle = '#666';
      ctx.fillRect(flagX, flagY, 2, h*0.09);
      // Flag stripes
      let stripeH = h*0.012;
      for(let i=0;i<5;i++){
        ctx.fillStyle = i%2===0 ? '#CC0000' : '#FFFFFF';
        ctx.fillRect(flagX+2, flagY+i*stripeH, w*0.05, stripeH);
      }
      // Triangle
      ctx.fillStyle = '#003DA5';
      ctx.beginPath();
      ctx.moveTo(flagX+2, flagY);
      ctx.lineTo(flagX+w*0.025, flagY+stripeH*2.5);
      ctx.lineTo(flagX+2, flagY+stripeH*5);
      ctx.fill();

      // Sun reflection on water
      ctx.fillStyle = 'rgba(255,220,100,0.15)';
      ctx.beginPath();
      ctx.ellipse(w*0.5, h*0.54, w*0.15, h*0.02, 0, 0, Math.PI*2);
      ctx.fill();
    }
  },
  {
    id: 'flamenco-beach',
    name: 'Playa Flamenco',
    subtitle: 'Culebra',
    free: true,
    draw: function(ctx, w, h) {
      // Sunset sky
      let skyGrad = ctx.createLinearGradient(0,0,0,h*0.5);
      skyGrad.addColorStop(0,'#FF6B35');
      skyGrad.addColorStop(0.3,'#FF8C5A');
      skyGrad.addColorStop(0.6,'#FFB088');
      skyGrad.addColorStop(1,'#FFD4B8');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0,0,w,h*0.5);

      // Sun
      let sunGrad = ctx.createRadialGradient(w*0.7,h*0.2,0,w*0.7,h*0.2,w*0.15);
      sunGrad.addColorStop(0,'#FFE566');
      sunGrad.addColorStop(0.5,'rgba(255,200,80,0.5)');
      sunGrad.addColorStop(1,'rgba(255,150,50,0)');
      ctx.fillStyle = sunGrad;
      ctx.fillRect(0,0,w,h*0.5);

      ctx.fillStyle = '#FFE566';
      ctx.beginPath();
      ctx.arc(w*0.7, h*0.2, w*0.06, 0, Math.PI*2);
      ctx.fill();

      // Ocean
      let oceanGrad = ctx.createLinearGradient(0,h*0.42,0,h*0.65);
      oceanGrad.addColorStop(0,'#00BCD4');
      oceanGrad.addColorStop(0.5,'#0097A7');
      oceanGrad.addColorStop(1,'#00838F');
      ctx.fillStyle = oceanGrad;
      ctx.fillRect(0,h*0.42,w,h*0.23);

      // Waves
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 2;
      for(let i=0;i<4;i++){
        ctx.beginPath();
        for(let x=0;x<w;x+=3){
          ctx.lineTo(x, h*0.44+i*h*0.05 + Math.sin(x*0.015+i*2)*6);
        }
        ctx.stroke();
      }

      // Beach sand
      let sandGrad = ctx.createLinearGradient(0,h*0.6,0,h);
      sandGrad.addColorStop(0,'#F5DEB3');
      sandGrad.addColorStop(0.3,'#E8D5A0');
      sandGrad.addColorStop(1,'#D4BC82');
      ctx.fillStyle = sandGrad;
      ctx.beginPath();
      ctx.moveTo(0,h*0.65);
      ctx.quadraticCurveTo(w*0.3,h*0.58,w*0.5,h*0.62);
      ctx.quadraticCurveTo(w*0.8,h*0.58,w,h*0.6);
      ctx.lineTo(w,h);
      ctx.lineTo(0,h);
      ctx.fill();

      // Wet sand
      ctx.fillStyle = 'rgba(180,160,120,0.4)';
      ctx.beginPath();
      ctx.moveTo(0,h*0.63);
      ctx.quadraticCurveTo(w*0.5,h*0.58,w,h*0.59);
      ctx.lineTo(w,h*0.66);
      ctx.quadraticCurveTo(w*0.5,h*0.64,0,h*0.67);
      ctx.fill();

      // Palm trees
      drawPalm(ctx, w*0.12, h*0.62, h*0.35, -0.2);
      drawPalm(ctx, w*0.22, h*0.58, h*0.4, 0.15);

      // Beach tank (Flamenco iconic)
      ctx.fillStyle = '#556B2F';
      ctx.fillRect(w*0.6, h*0.63, w*0.12, h*0.06);
      ctx.fillRect(w*0.63, h*0.61, w*0.06, h*0.025);
      // Tank turret
      ctx.fillStyle = '#4A5D23';
      ctx.fillRect(w*0.68, h*0.62, w*0.06, h*0.015);
      // Graffiti colors on tank
      ctx.fillStyle = 'rgba(255,100,100,0.5)';
      ctx.fillRect(w*0.61,h*0.635,w*0.04,h*0.02);
      ctx.fillStyle = 'rgba(100,150,255,0.5)';
      ctx.fillRect(w*0.65,h*0.64,w*0.03,h*0.025);
      ctx.fillStyle = 'rgba(255,255,100,0.5)';
      ctx.fillRect(w*0.685,h*0.635,w*0.03,h*0.02);

      // Footprints in sand
      ctx.fillStyle = 'rgba(160,140,100,0.3)';
      for(let i=0;i<5;i++){
        ctx.beginPath();
        ctx.ellipse(w*0.4+i*w*0.05, h*0.75+Math.sin(i)*h*0.02, 3, 5, 0.3*i, 0, Math.PI*2);
        ctx.fill();
      }

      // Birds
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1.5;
      for(let i=0;i<3;i++){
        let bx = w*0.3+i*w*0.15, by = h*0.15+i*h*0.04;
        ctx.beginPath();
        ctx.moveTo(bx-8,by+4);
        ctx.quadraticCurveTo(bx-4,by,bx,by+2);
        ctx.quadraticCurveTo(bx+4,by,bx+8,by+4);
        ctx.stroke();
      }
    }
  },
  {
    id: 'old-san-juan',
    name: 'Viejo San Juan',
    subtitle: 'Calles de Color',
    free: true,
    draw: function(ctx, w, h) {
      // Sky
      let skyGrad = ctx.createLinearGradient(0,0,0,h*0.35);
      skyGrad.addColorStop(0,'#4A90D9');
      skyGrad.addColorStop(1,'#87CEEB');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0,0,w,h*0.4);

      // Clouds
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      drawCloud(ctx, w*0.2, h*0.1, 30);
      drawCloud(ctx, w*0.7, h*0.06, 40);

      // Cobblestone street
      let streetGrad = ctx.createLinearGradient(0,h*0.65,0,h);
      streetGrad.addColorStop(0,'#708090');
      streetGrad.addColorStop(1,'#5A6A7A');
      ctx.fillStyle = streetGrad;
      ctx.fillRect(0,h*0.65,w,h*0.35);

      // Cobblestone pattern (adoquines)
      ctx.fillStyle = 'rgba(100,130,160,0.3)';
      for(let row=0;row<8;row++){
        for(let col=0;col<12;col++){
          let sx = col*w/10 + (row%2)*w/20;
          let sy = h*0.67 + row*h*0.04;
          ctx.beginPath();
          ctx.roundRect(sx+1, sy+1, w/11-2, h*0.035-2, 2);
          ctx.fill();
        }
      }

      // Buildings - colorful row
      const buildings = [
        { x: 0, w: w*0.22, color: '#FF6B6B', door: '#8B0000', windowColor: '#FFE4E1' },
        { x: w*0.2, w: w*0.2, color: '#4ECDC4', door: '#006060', windowColor: '#E0FFFF' },
        { x: w*0.38, w: w*0.24, color: '#FFE66D', door: '#AA8800', windowColor: '#FFFACD' },
        { x: w*0.6, w: w*0.2, color: '#A8E6CF', door: '#2E7D32', windowColor: '#E8F5E9' },
        { x: w*0.78, w: w*0.24, color: '#DDA0DD', door: '#6A0080', windowColor: '#F3E5F5' }
      ];

      buildings.forEach((b, i) => {
        let bh = h*0.32 + (i%2)*h*0.04;
        let by = h*0.65 - bh;

        // Building face
        ctx.fillStyle = b.color;
        ctx.fillRect(b.x, by, b.w, bh);

        // Shadow on edge
        ctx.fillStyle = 'rgba(0,0,0,0.08)';
        ctx.fillRect(b.x+b.w-4, by, 4, bh);

        // Roof line
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(b.x, by, b.w, 4);

        // Windows (2 rows)
        for(let wy=0; wy<2; wy++){
          for(let wx=0; wx<2; wx++){
            let winX = b.x + b.w*0.15 + wx*b.w*0.45;
            let winY = by + h*0.04 + wy*h*0.1;
            // Window frame
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(winX-1, winY-1, b.w*0.25+2, h*0.07+2);
            // Window
            ctx.fillStyle = b.windowColor;
            ctx.fillRect(winX, winY, b.w*0.25, h*0.07);
            // Shutters
            ctx.fillStyle = 'rgba(0,0,0,0.12)';
            ctx.fillRect(winX, winY, b.w*0.12, h*0.07);
            // Window divider
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(winX+b.w*0.12, winY, 1.5, h*0.07);
          }
        }

        // Door
        let doorW = b.w*0.25, doorH = h*0.12;
        let doorX = b.x + (b.w-doorW)/2;
        let doorY = h*0.65 - doorH;
        ctx.fillStyle = b.door;
        ctx.beginPath();
        ctx.roundRect(doorX, doorY, doorW, doorH, [6,6,0,0]);
        ctx.fill();
        // Door handle
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(doorX+doorW*0.75, doorY+doorH*0.55, 2.5, 0, Math.PI*2);
        ctx.fill();

        // Balcony on some
        if(i % 2 === 0){
          let balY = by + h*0.14;
          ctx.fillStyle = '#333';
          ctx.fillRect(b.x+b.w*0.1, balY, b.w*0.8, 3);
          // Railing
          ctx.strokeStyle = '#444';
          ctx.lineWidth = 1;
          for(let r=0;r<5;r++){
            let rx = b.x+b.w*0.15+r*(b.w*0.7/4);
            ctx.beginPath();
            ctx.moveTo(rx, balY);
            ctx.lineTo(rx, balY-h*0.025);
            ctx.stroke();
          }
          ctx.beginPath();
          ctx.moveTo(b.x+b.w*0.1, balY-h*0.025);
          ctx.lineTo(b.x+b.w*0.9, balY-h*0.025);
          ctx.stroke();

          // Flower pots
          ctx.fillStyle = '#CC4400';
          ctx.fillRect(b.x+b.w*0.25, balY-h*0.015, 8, 6);
          ctx.fillStyle = '#FF6B6B';
          ctx.beginPath();
          ctx.arc(b.x+b.w*0.25+4, balY-h*0.02, 5, 0, Math.PI*2);
          ctx.fill();
        }
      });

      // Hanging string lights
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 0.8;
      ctx.beginPath();
      ctx.moveTo(w*0.1, h*0.28);
      for(let x=w*0.1;x<w*0.9;x+=3){
        ctx.lineTo(x, h*0.28 + Math.sin((x-w*0.1)*0.008)*h*0.03);
      }
      ctx.stroke();

      // Light bulbs
      const bulbColors = ['#FF6B6B','#FFE66D','#4ECDC4','#DDA0DD','#A8E6CF','#FF6B6B','#FFE66D'];
      bulbColors.forEach((c,i) => {
        let bx = w*0.15 + i*w*0.1;
        let by2 = h*0.28 + Math.sin((bx-w*0.1)*0.008)*h*0.03;
        ctx.fillStyle = c;
        ctx.beginPath();
        ctx.arc(bx, by2+6, 4, 0, Math.PI*2);
        ctx.fill();
        // Glow
        ctx.fillStyle = c.replace(')', ',0.2)').replace('rgb','rgba');
        ctx.beginPath();
        ctx.arc(bx, by2+6, 8, 0, Math.PI*2);
        ctx.fill();
      });

      // Cat sitting on street
      ctx.fillStyle = '#222';
      ctx.beginPath();
      ctx.ellipse(w*0.75, h*0.88, 8, 6, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(w*0.75, h*0.83, 5, 5, 0, 0, Math.PI*2);
      ctx.fill();
      // Ears
      ctx.beginPath();
      ctx.moveTo(w*0.75-4,h*0.83-4);
      ctx.lineTo(w*0.75-6,h*0.83-10);
      ctx.lineTo(w*0.75-1,h*0.83-5);
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(w*0.75+4,h*0.83-4);
      ctx.lineTo(w*0.75+6,h*0.83-10);
      ctx.lineTo(w*0.75+1,h*0.83-5);
      ctx.fill();
      // Eyes
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.arc(w*0.75-2, h*0.83-1, 1.5, 0, Math.PI*2);
      ctx.arc(w*0.75+2, h*0.83-1, 1.5, 0, Math.PI*2);
      ctx.fill();
    }
  },
  {
    id: 'el-yunque',
    name: 'El Yunque',
    subtitle: 'Bosque Nacional',
    free: false,
    draw: function(ctx, w, h) {
      // Misty sky
      let skyGrad = ctx.createLinearGradient(0,0,0,h*0.4);
      skyGrad.addColorStop(0,'#6B8E7B');
      skyGrad.addColorStop(1,'#A8C8B8');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0,0,w,h*0.5);

      // Mist layers
      for(let i=0;i<3;i++){
        ctx.fillStyle = `rgba(200,220,210,${0.15-i*0.04})`;
        ctx.beginPath();
        ctx.moveTo(0, h*0.15+i*h*0.08);
        for(let x=0;x<w;x+=20){
          ctx.lineTo(x, h*0.15+i*h*0.08 + Math.sin(x*0.01+i)*h*0.03);
        }
        ctx.lineTo(w, h*0.25+i*h*0.08);
        ctx.lineTo(0, h*0.25+i*h*0.08);
        ctx.fill();
      }

      // Background mountains
      ctx.fillStyle = '#2D5A3D';
      ctx.beginPath();
      ctx.moveTo(0,h*0.5);
      ctx.quadraticCurveTo(w*0.2,h*0.2,w*0.4,h*0.35);
      ctx.quadraticCurveTo(w*0.6,h*0.15,w*0.8,h*0.3);
      ctx.quadraticCurveTo(w*0.9,h*0.25,w,h*0.4);
      ctx.lineTo(w,h*0.5);
      ctx.fill();

      // Mid mountains
      ctx.fillStyle = '#1D4A2D';
      ctx.beginPath();
      ctx.moveTo(0,h*0.55);
      ctx.quadraticCurveTo(w*0.15,h*0.35,w*0.3,h*0.42);
      ctx.quadraticCurveTo(w*0.5,h*0.3,w*0.7,h*0.4);
      ctx.quadraticCurveTo(w*0.85,h*0.35,w,h*0.45);
      ctx.lineTo(w,h*0.55);
      ctx.fill();

      // Forest floor
      let floorGrad = ctx.createLinearGradient(0,h*0.5,0,h);
      floorGrad.addColorStop(0,'#1A3D25');
      floorGrad.addColorStop(1,'#0D2818');
      ctx.fillStyle = floorGrad;
      ctx.fillRect(0,h*0.5,w,h*0.5);

      // Waterfall
      let wfX = w*0.45, wfW = w*0.1;
      // Cliff face
      ctx.fillStyle = '#3D3D3D';
      ctx.fillRect(wfX-w*0.05, h*0.3, wfW+w*0.1, h*0.35);
      // Water
      ctx.fillStyle = 'rgba(180,220,255,0.7)';
      ctx.fillRect(wfX, h*0.32, wfW, h*0.32);
      // Water detail
      for(let i=0;i<8;i++){
        ctx.fillStyle = `rgba(255,255,255,${0.1+Math.random()*0.15})`;
        ctx.fillRect(wfX+Math.random()*wfW, h*0.32+Math.random()*h*0.32, 2, h*0.05);
      }
      // Splash pool
      ctx.fillStyle = 'rgba(100,180,220,0.6)';
      ctx.beginPath();
      ctx.ellipse(wfX+wfW/2, h*0.65, w*0.12, h*0.04, 0, 0, Math.PI*2);
      ctx.fill();
      // Splash foam
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.beginPath();
      ctx.ellipse(wfX+wfW/2, h*0.64, w*0.06, h*0.02, 0, 0, Math.PI*2);
      ctx.fill();

      // Tropical trees
      drawRainforestTree(ctx, w*0.08, h*0.48, h*0.3);
      drawRainforestTree(ctx, w*0.85, h*0.45, h*0.35);
      drawRainforestTree(ctx, w*0.15, h*0.55, h*0.25);
      drawRainforestTree(ctx, w*0.78, h*0.52, h*0.28);

      // Large fern fronds in foreground
      ctx.fillStyle = '#0D5A1A';
      drawFern(ctx, w*0.05, h*0.85, w*0.2, -0.3);
      drawFern(ctx, w*0.9, h*0.9, w*0.2, 0.4);

      // Coqu√≠! (tiny frog)
      ctx.fillStyle = '#8BC34A';
      ctx.beginPath();
      ctx.ellipse(w*0.7, h*0.75, 6, 4, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(w*0.704, h*0.745, 3, 0, Math.PI*2);
      ctx.fill();
      // Eyes
      ctx.fillStyle = '#333';
      ctx.beginPath();
      ctx.arc(w*0.706, h*0.743, 1, 0, Math.PI*2);
      ctx.fill();

      // "CO-QU√ç" text tiny
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
      ctx.font = `${Math.max(8,w*0.02)}px 'Instrument Sans'`;
      ctx.fillText('co-qu√≠!', w*0.72, h*0.74);

      // Fireflies / particles
      for(let i=0;i<12;i++){
        let glow = Math.random()*0.3+0.1;
        ctx.fillStyle = `rgba(200,255,200,${glow})`;
        ctx.beginPath();
        ctx.arc(Math.random()*w, h*0.4+Math.random()*h*0.4, 2+Math.random()*2, 0, Math.PI*2);
        ctx.fill();
      }
    }
  },
  {
    id: 'vejigantes',
    name: 'Los Vejigantes',
    subtitle: 'Fiestas de Lo√≠za',
    free: false,
    draw: function(ctx, w, h) {
      // Vibrant background
      let bgGrad = ctx.createLinearGradient(0,0,w,h);
      bgGrad.addColorStop(0,'#FF1744');
      bgGrad.addColorStop(0.5,'#FF6D00');
      bgGrad.addColorStop(1,'#FFD600');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0,0,w,h);

      // Pattern overlay
      ctx.fillStyle = 'rgba(0,0,0,0.05)';
      for(let i=0;i<20;i++){
        for(let j=0;j<20;j++){
          if((i+j)%2===0){
            ctx.fillRect(i*w/20,j*h/20,w/20,h/20);
          }
        }
      }

      // Main vejigante mask - center
      let mx = w*0.5, my = h*0.45;
      let mw = w*0.6, mh = h*0.5;

      // Mask base
      let maskGrad = ctx.createRadialGradient(mx,my,0,mx,my,mw*0.5);
      maskGrad.addColorStop(0,'#FF0000');
      maskGrad.addColorStop(0.7,'#CC0000');
      maskGrad.addColorStop(1,'#990000');
      ctx.fillStyle = maskGrad;
      ctx.beginPath();
      ctx.ellipse(mx, my, mw*0.4, mh*0.45, 0, 0, Math.PI*2);
      ctx.fill();

      // Horns
      const hornColors = ['#FFD600','#00E676','#2979FF','#FF6D00','#AA00FF'];
      for(let i=0;i<5;i++){
        let angle = -Math.PI*0.8 + i*(Math.PI*0.6/4);
        let hx = mx + Math.cos(angle)*mw*0.35;
        let hy = my + Math.sin(angle)*mh*0.35;
        let tipX = mx + Math.cos(angle)*mw*0.7;
        let tipY = my + Math.sin(angle)*mh*0.7;

        ctx.fillStyle = hornColors[i];
        ctx.beginPath();
        ctx.moveTo(hx-8, hy);
        ctx.quadraticCurveTo((hx+tipX)/2-5, (hy+tipY)/2, tipX, tipY);
        ctx.quadraticCurveTo((hx+tipX)/2+5, (hy+tipY)/2, hx+8, hy);
        ctx.fill();

        // Horn dots
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        for(let d=0;d<3;d++){
          let dx = hx + (tipX-hx)*(d+1)/4;
          let dy = hy + (tipY-hy)*(d+1)/4;
          ctx.beginPath();
          ctx.arc(dx,dy,3,0,Math.PI*2);
          ctx.fill();
        }
      }

      // Eyes
      ctx.fillStyle = '#FFD600';
      ctx.beginPath();
      ctx.ellipse(mx-mw*0.12, my-mh*0.05, mw*0.1, mh*0.08, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(mx+mw*0.12, my-mh*0.05, mw*0.1, mh*0.08, 0, 0, Math.PI*2);
      ctx.fill();

      // Pupils
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(mx-mw*0.12, my-mh*0.05, mw*0.04, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(mx+mw*0.12, my-mh*0.05, mw*0.04, 0, Math.PI*2);
      ctx.fill();

      // Nose
      ctx.fillStyle = '#800000';
      ctx.beginPath();
      ctx.moveTo(mx, my+mh*0.02);
      ctx.lineTo(mx-mw*0.04, my+mh*0.1);
      ctx.lineTo(mx+mw*0.04, my+mh*0.1);
      ctx.fill();

      // Mouth - big grin
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.ellipse(mx, my+mh*0.2, mw*0.2, mh*0.08, 0, 0, Math.PI);
      ctx.fill();

      // Teeth
      ctx.fillStyle = '#FFF';
      for(let t=0;t<6;t++){
        let tx = mx - mw*0.15 + t*mw*0.06;
        ctx.fillRect(tx, my+mh*0.175, mw*0.04, mh*0.03);
      }

      // Cheek dots
      ctx.fillStyle = '#FFD600';
      for(let s=0;s<3;s++){
        ctx.beginPath();
        ctx.arc(mx-mw*0.25+s*5, my+mh*0.1, 4, 0, Math.PI*2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(mx+mw*0.2+s*5, my+mh*0.1, 4, 0, Math.PI*2);
        ctx.fill();
      }

      // Decorative border diamonds
      ctx.fillStyle = 'rgba(0,0,0,0.15)';
      for(let i=0;i<8;i++){
        let angle = i*Math.PI/4;
        let dx = mx + Math.cos(angle)*mw*0.47;
        let dy = my + Math.sin(angle)*mh*0.5;
        ctx.save();
        ctx.translate(dx,dy);
        ctx.rotate(Math.PI/4);
        ctx.fillRect(-6,-6,12,12);
        ctx.restore();
      }

      // "LO√çZA" text at bottom
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.font = `bold ${Math.max(14,w*0.06)}px 'DM Serif Display'`;
      ctx.textAlign = 'center';
      ctx.fillText('LO√çZA', mx, h*0.92);
      ctx.textAlign = 'start';

      // Confetti particles
      const confColors = ['#FFF','#FFD600','#00E676','#2979FF','#FF6D00'];
      for(let i=0;i<30;i++){
        ctx.fillStyle = confColors[i%confColors.length];
        ctx.globalAlpha = 0.4+Math.random()*0.4;
        ctx.save();
        ctx.translate(Math.random()*w, Math.random()*h);
        ctx.rotate(Math.random()*Math.PI);
        ctx.fillRect(-3,-1,6,2);
        ctx.restore();
      }
      ctx.globalAlpha = 1;
    }
  },
  {
    id: 'bioluminiscencia',
    name: 'Bah√≠a Bioluminiscente',
    subtitle: 'Vieques',
    free: false,
    draw: function(ctx, w, h) {
      // Night sky
      let skyGrad = ctx.createLinearGradient(0,0,0,h*0.45);
      skyGrad.addColorStop(0,'#0a0a2e');
      skyGrad.addColorStop(1,'#1a1a4e');
      ctx.fillStyle = skyGrad;
      ctx.fillRect(0,0,w,h*0.45);

      // Stars
      for(let i=0;i<60;i++){
        let sx = Math.random()*w, sy = Math.random()*h*0.4;
        let bright = 0.3+Math.random()*0.7;
        ctx.fillStyle = `rgba(255,255,255,${bright})`;
        ctx.beginPath();
        ctx.arc(sx,sy,0.5+Math.random()*1.5,0,Math.PI*2);
        ctx.fill();
      }

      // Moon
      ctx.fillStyle = '#FFFDE7';
      ctx.beginPath();
      ctx.arc(w*0.8, h*0.12, w*0.05, 0, Math.PI*2);
      ctx.fill();
      // Moon glow
      let moonGlow = ctx.createRadialGradient(w*0.8,h*0.12,0,w*0.8,h*0.12,w*0.15);
      moonGlow.addColorStop(0,'rgba(255,253,231,0.15)');
      moonGlow.addColorStop(1,'rgba(255,253,231,0)');
      ctx.fillStyle = moonGlow;
      ctx.beginPath();
      ctx.arc(w*0.8,h*0.12,w*0.15,0,Math.PI*2);
      ctx.fill();

      // Mangrove silhouettes
      ctx.fillStyle = '#0a0a1e';
      // Left mangroves
      ctx.beginPath();
      ctx.moveTo(0,h*0.45);
      ctx.quadraticCurveTo(w*0.05,h*0.3,w*0.1,h*0.38);
      ctx.quadraticCurveTo(w*0.15,h*0.28,w*0.2,h*0.35);
      ctx.quadraticCurveTo(w*0.22,h*0.32,w*0.25,h*0.4);
      ctx.lineTo(w*0.25,h*0.45);
      ctx.fill();
      // Right mangroves
      ctx.beginPath();
      ctx.moveTo(w,h*0.45);
      ctx.quadraticCurveTo(w*0.95,h*0.32,w*0.9,h*0.38);
      ctx.quadraticCurveTo(w*0.85,h*0.3,w*0.8,h*0.36);
      ctx.quadraticCurveTo(w*0.78,h*0.33,w*0.75,h*0.42);
      ctx.lineTo(w*0.75,h*0.45);
      ctx.fill();

      // Bioluminescent water
      let waterGrad = ctx.createLinearGradient(0,h*0.42,0,h);
      waterGrad.addColorStop(0,'#0a1a3e');
      waterGrad.addColorStop(0.3,'#0a2a4e');
      waterGrad.addColorStop(1,'#0a1a2e');
      ctx.fillStyle = waterGrad;
      ctx.fillRect(0,h*0.42,w,h*0.58);

      // Bioluminescence glow particles
      for(let i=0;i<120;i++){
        let px = Math.random()*w;
        let py = h*0.45 + Math.random()*h*0.5;
        let size = 1+Math.random()*4;
        let bright = 0.2+Math.random()*0.6;

        let glowGrad = ctx.createRadialGradient(px,py,0,px,py,size*3);
        glowGrad.addColorStop(0,`rgba(0,255,200,${bright})`);
        glowGrad.addColorStop(0.5,`rgba(0,200,255,${bright*0.3})`);
        glowGrad.addColorStop(1,'rgba(0,150,255,0)');
        ctx.fillStyle = glowGrad;
        ctx.beginPath();
        ctx.arc(px,py,size*3,0,Math.PI*2);
        ctx.fill();

        ctx.fillStyle = `rgba(0,255,220,${bright})`;
        ctx.beginPath();
        ctx.arc(px,py,size*0.5,0,Math.PI*2);
        ctx.fill();
      }

      // Kayak silhouette
      ctx.fillStyle = '#0a0a1e';
      ctx.beginPath();
      ctx.moveTo(w*0.35, h*0.55);
      ctx.quadraticCurveTo(w*0.4, h*0.53, w*0.55, h*0.55);
      ctx.quadraticCurveTo(w*0.6, h*0.56, w*0.65, h*0.54);
      ctx.quadraticCurveTo(w*0.6, h*0.57, w*0.55, h*0.57);
      ctx.quadraticCurveTo(w*0.45, h*0.58, w*0.35, h*0.55);
      ctx.fill();

      // Paddler silhouette
      ctx.fillStyle = '#0a0a1e';
      ctx.beginPath();
      ctx.ellipse(w*0.48, h*0.52, 5, 8, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(w*0.48, h*0.505, 4, 0, Math.PI*2);
      ctx.fill();
      // Paddle
      ctx.strokeStyle = '#0a0a1e';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(w*0.44, h*0.48);
      ctx.lineTo(w*0.52, h*0.58);
      ctx.stroke();

      // Kayak trail glow
      let trailGrad = ctx.createRadialGradient(w*0.5,h*0.56,0,w*0.5,h*0.56,w*0.15);
      trailGrad.addColorStop(0,'rgba(0,255,200,0.15)');
      trailGrad.addColorStop(1,'rgba(0,255,200,0)');
      ctx.fillStyle = trailGrad;
      ctx.beginPath();
      ctx.ellipse(w*0.5,h*0.57,w*0.15,h*0.03,0,0,Math.PI*2);
      ctx.fill();

      // Water ripples with glow
      ctx.strokeStyle = 'rgba(0,255,200,0.1)';
      ctx.lineWidth = 1;
      for(let i=0;i<5;i++){
        ctx.beginPath();
        let ry = h*0.5+i*h*0.08;
        for(let x=0;x<w;x+=3){
          ctx.lineTo(x, ry + Math.sin(x*0.02+i*1.5)*3);
        }
        ctx.stroke();
      }
    }
  }
];

// ‚ïê‚ïê‚ïê DRAWING HELPERS ‚ïê‚ïê‚ïê
function drawCloud(ctx, x, y, size) {
  ctx.beginPath();
  ctx.arc(x, y, size*0.5, 0, Math.PI*2);
  ctx.arc(x+size*0.4, y-size*0.15, size*0.4, 0, Math.PI*2);
  ctx.arc(x+size*0.7, y, size*0.35, 0, Math.PI*2);
  ctx.arc(x+size*0.35, y+size*0.1, size*0.3, 0, Math.PI*2);
  ctx.fill();
}

function drawPalm(ctx, x, y, height, lean) {
  // Trunk
  ctx.strokeStyle = '#8B6914';
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.quadraticCurveTo(x+lean*height*0.5, y-height*0.5, x+lean*height*0.3, y-height);
  ctx.stroke();

  // Trunk detail
  ctx.strokeStyle = 'rgba(0,0,0,0.15)';
  ctx.lineWidth = 6;
  for(let i=0;i<6;i++){
    let t = i/6;
    let tx = x + lean*height*0.5*t*2 - lean*height*0.2*t;
    let ty = y - height*t;
    ctx.beginPath();
    ctx.moveTo(tx-4, ty);
    ctx.lineTo(tx+4, ty);
    ctx.stroke();
  }

  let topX = x+lean*height*0.3, topY = y-height;

  // Fronds
  ctx.lineWidth = 2;
  for(let i=0;i<6;i++){
    let angle = -Math.PI*0.8 + i*(Math.PI*0.6/5) + lean*0.3;
    let frondLen = height*0.4;

    ctx.strokeStyle = '#228B22';
    ctx.fillStyle = '#228B22';
    ctx.beginPath();
    ctx.moveTo(topX, topY);
    let endX = topX + Math.cos(angle)*frondLen;
    let endY = topY + Math.sin(angle)*frondLen;
    let cpX = topX + Math.cos(angle)*frondLen*0.6;
    let cpY = topY + Math.sin(angle)*frondLen*0.3;
    ctx.quadraticCurveTo(cpX, cpY, endX, endY);
    ctx.stroke();

    // Leaves along frond
    for(let l=0;l<5;l++){
      let t = (l+1)/6;
      let lx = topX + (cpX-topX)*t*2*(1-t) + (endX-topX)*t*t;
      let ly = topY + (cpY-topY)*t*2*(1-t) + (endY-topY)*t*t;
      ctx.fillStyle = l<3 ? '#2E8B2E' : '#1a6020';
      ctx.beginPath();
      ctx.ellipse(lx, ly, frondLen*0.12, 3, angle+0.3, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(lx, ly, frondLen*0.12, 3, angle-0.3, 0, Math.PI*2);
      ctx.fill();
    }
  }

  // Coconuts
  ctx.fillStyle = '#6B4226';
  ctx.beginPath();
  ctx.arc(topX-3, topY+3, 4, 0, Math.PI*2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(topX+4, topY+2, 3.5, 0, Math.PI*2);
  ctx.fill();
}

function drawRainforestTree(ctx, x, y, height) {
  ctx.fillStyle = '#2a1a0a';
  ctx.fillRect(x-3, y-height*0.3, 6, height*0.3);

  // Canopy layers
  const greens = ['#0a4a0a','#0d5a15','#0a6a10','#1a7a20'];
  greens.forEach((c,i) => {
    ctx.fillStyle = c;
    ctx.beginPath();
    ctx.ellipse(x+(i%2?5:-5), y-height*0.3-i*height*0.15, height*0.25-i*4, height*0.15, 0, 0, Math.PI*2);
    ctx.fill();
  });
}

function drawFern(ctx, x, y, size, angle) {
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(angle);

  ctx.strokeStyle = '#0D5A1A';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.quadraticCurveTo(size*0.5, -size*0.3, size, -size*0.1);
  ctx.stroke();

  for(let i=0;i<8;i++){
    let t = (i+1)/9;
    let fx = size*t;
    let fy = -size*0.3*t*(1-t)*4 - size*0.1*t;
    ctx.fillStyle = i<5 ? '#0D6A1A' : '#0A5015';
    ctx.beginPath();
    ctx.ellipse(fx, fy, size*0.08, 2, -0.5, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(fx, fy, size*0.08, 2, 0.5, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.restore();
}

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let currentDifficulty = 9;
let currentScene = null;
let pieces = [];
let placedCount = 0;
let timerInterval = null;
let elapsedSeconds = 0;
let draggingPiece = null;
let dragOffsetX = 0, dragOffsetY = 0;
let boardRect = null;
let isPaid = false;
let completedPuzzles = JSON.parse(localStorage.getItem('bori_isla_completed') || '{}');

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
function init() {
  checkTier();
  renderSceneGrid();
}

function checkTier() {
  const pin = localStorage.getItem('bori_pin');
  if(pin) {
    // Check with server if paid (simplified: check localStorage flag)
    isPaid = localStorage.getItem('bori_tier') === 'plus' || localStorage.getItem('bori_tier') === 'familia';
  }
  document.getElementById('tierBadge').textContent = isPaid ? '‚àû PLUS' : 'LIBRE';
  document.getElementById('tierBadge').style.color = isPaid ? 'var(--gold)' : 'var(--teal)';
}

function setDifficulty(btn, pieces) {
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentDifficulty = pieces;
}

function renderSceneGrid() {
  const grid = document.getElementById('sceneGrid');
  grid.innerHTML = '';

  SCENES.forEach(scene => {
    const card = document.createElement('div');
    card.className = 'scene-card' + (!scene.free && !isPaid ? ' locked' : '');

    // Render preview
    const canvas = document.createElement('canvas');
    canvas.className = 'scene-canvas-preview';
    canvas.width = 400;
    canvas.height = 400;
    const ctx = canvas.getContext('2d');
    scene.draw(ctx, 400, 400);
    card.appendChild(canvas);

    // Label
    const label = document.createElement('div');
    label.className = 'scene-label';
    label.innerHTML = `<span>${scene.name}</span><small>${scene.subtitle}</small>`;
    card.appendChild(label);

    // Completed badge
    let key = `${scene.id}-${currentDifficulty}`;
    if(completedPuzzles[key]) {
      const badge = document.createElement('div');
      badge.className = 'completed-badge';
      badge.textContent = '‚úì Completo';
      card.appendChild(badge);
    }

    // Lock badge
    if(!scene.free && !isPaid) {
      const upsell = document.createElement('div');
      upsell.className = 'upsell-badge';
      upsell.textContent = 'BORI PLUS';
      card.appendChild(upsell);
    }

    if(scene.free || isPaid) {
      card.onclick = () => startPuzzle(scene);
    }

    grid.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê PUZZLE ENGINE ‚ïê‚ïê‚ïê
function startPuzzle(scene) {
  currentScene = scene;
  placedCount = 0;
  elapsedSeconds = 0;
  pieces = [];

  // Switch screens
  document.getElementById('selectScreen').classList.remove('active');
  document.getElementById('puzzleScreen').classList.add('active');
  document.getElementById('puzzleSceneName').textContent = scene.name;

  const cols = Math.sqrt(currentDifficulty);
  document.getElementById('piecesPlaced').textContent = '0';
  document.getElementById('piecesTotal').textContent = currentDifficulty;
  document.getElementById('timer').textContent = '0:00';

  // Draw reference
  const refCanvas = document.getElementById('referenceCanvas');
  refCanvas.width = 600;
  refCanvas.height = 600;
  scene.draw(refCanvas.getContext('2d'), 600, 600);

  // Start timer
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsedSeconds++;
    let m = Math.floor(elapsedSeconds/60);
    let s = elapsedSeconds%60;
    document.getElementById('timer').textContent = `${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);

  // Build puzzle after a short delay for layout
  requestAnimationFrame(() => {
    requestAnimationFrame(() => buildPuzzle(scene, cols));
  });
}

function buildPuzzle(scene, cols) {
  const board = document.getElementById('puzzleBoard');
  const container = document.getElementById('boardContainer');
  board.innerHTML = '';

  boardRect = container.getBoundingClientRect();
  const boardW = boardRect.width;
  const boardH = Math.max(boardRect.height, 300);
  container.style.height = boardH + 'px';

  const pieceW = Math.floor(boardW / cols);
  const pieceH = Math.floor(boardH / cols);

  // Create source canvas
  const srcCanvas = document.createElement('canvas');
  srcCanvas.width = boardW;
  srcCanvas.height = boardH;
  scene.draw(srcCanvas.getContext('2d'), boardW, boardH);

  pieces = [];

  for(let row=0; row<cols; row++){
    for(let col=0; col<cols; col++){
      const piece = document.createElement('canvas');
      piece.width = pieceW;
      piece.height = pieceH;
      piece.className = 'puzzle-piece';

      const pctx = piece.getContext('2d');
      pctx.drawImage(srcCanvas, col*pieceW, row*pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);

      // Add subtle border
      pctx.strokeStyle = 'rgba(255,255,255,0.15)';
      pctx.lineWidth = 1;
      pctx.strokeRect(0,0,pieceW,pieceH);

      // Random starting position (scattered)
      let startX = Math.random() * (boardW - pieceW);
      let startY = Math.random() * (boardH - pieceH);

      piece.style.left = startX + 'px';
      piece.style.top = startY + 'px';
      piece.style.width = pieceW + 'px';
      piece.style.height = pieceH + 'px';
      piece.style.zIndex = Math.floor(Math.random()*50)+1;

      const pieceData = {
        el: piece,
        targetX: col * pieceW,
        targetY: row * pieceH,
        w: pieceW,
        h: pieceH,
        placed: false
      };

      pieces.push(pieceData);

      // Drag events
      piece.addEventListener('mousedown', (e) => startDrag(e, pieceData));
      piece.addEventListener('touchstart', (e) => startDrag(e, pieceData), {passive: false});

      board.appendChild(piece);
    }
  }

  // Global move/end events
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('touchmove', onDrag, {passive: false});
  document.addEventListener('touchend', endDrag);
}

function startDrag(e, pieceData) {
  if(pieceData.placed) return;
  e.preventDefault();

  draggingPiece = pieceData;
  const el = pieceData.el;
  el.style.zIndex = 1000;
  el.style.boxShadow = '0 8px 30px rgba(139,92,246,0.5)';

  boardRect = document.getElementById('boardContainer').getBoundingClientRect();

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  dragOffsetX = clientX - boardRect.left - parseFloat(el.style.left);
  dragOffsetY = clientY - boardRect.top - parseFloat(el.style.top);
}

function onDrag(e) {
  if(!draggingPiece) return;
  e.preventDefault();

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  let newX = clientX - boardRect.left - dragOffsetX;
  let newY = clientY - boardRect.top - dragOffsetY;

  // Clamp
  const maxX = boardRect.width - draggingPiece.w;
  const maxY = boardRect.height - draggingPiece.h;
  newX = Math.max(0, Math.min(maxX, newX));
  newY = Math.max(0, Math.min(maxY, newY));

  draggingPiece.el.style.left = newX + 'px';
  draggingPiece.el.style.top = newY + 'px';

  // Snap feedback
  const snapThreshold = Math.max(draggingPiece.w, draggingPiece.h) * 0.25;
  const dx = Math.abs(newX - draggingPiece.targetX);
  const dy = Math.abs(newY - draggingPiece.targetY);

  if(dx < snapThreshold && dy < snapThreshold) {
    draggingPiece.el.classList.add('near-target');
  } else {
    draggingPiece.el.classList.remove('near-target');
  }
}

function endDrag(e) {
  if(!draggingPiece) return;

  const piece = draggingPiece;
  const el = piece.el;

  el.classList.remove('near-target');
  el.style.boxShadow = '';

  const currentX = parseFloat(el.style.left);
  const currentY = parseFloat(el.style.top);

  const snapThreshold = Math.max(piece.w, piece.h) * 0.25;
  const dx = Math.abs(currentX - piece.targetX);
  const dy = Math.abs(currentY - piece.targetY);

  if(dx < snapThreshold && dy < snapThreshold) {
    // SNAP!
    el.style.left = piece.targetX + 'px';
    el.style.top = piece.targetY + 'px';
    el.style.zIndex = 0;
    el.classList.add('placed');
    piece.placed = true;
    placedCount++;

    document.getElementById('piecesPlaced').textContent = placedCount;

    // Small vibration feedback
    if(navigator.vibrate) navigator.vibrate(30);

    // Check completion
    if(placedCount === pieces.length) {
      onPuzzleComplete();
    }
  } else {
    el.style.zIndex = Math.floor(Math.random()*50)+1;
  }

  draggingPiece = null;
}

// ‚ïê‚ïê‚ïê COMPLETION ‚ïê‚ïê‚ïê
function onPuzzleComplete() {
  clearInterval(timerInterval);

  // Save completion
  let key = `${currentScene.id}-${currentDifficulty}`;
  completedPuzzles[key] = { time: elapsedSeconds, date: Date.now() };
  localStorage.setItem('bori_isla_completed', JSON.stringify(completedPuzzles));

  // Log activity
  logActivity();

  // Show modal after short delay
  setTimeout(() => {
    const compCanvas = document.getElementById('completionCanvas');
    compCanvas.width = 500;
    compCanvas.height = 500;
    currentScene.draw(compCanvas.getContext('2d'), 500, 500);

    document.getElementById('completionScene').textContent = currentScene.name + ' ‚Äî ' + currentScene.subtitle;

    let m = Math.floor(elapsedSeconds/60);
    let s = elapsedSeconds%60;
    document.getElementById('completionStats').textContent =
      `${currentDifficulty} piezas ¬∑ ${m}:${s.toString().padStart(2,'0')} ‚è±Ô∏è`;

    document.getElementById('completionModal').classList.add('active');
    launchConfetti();
  }, 500);
}

function launchConfetti() {
  const container = document.getElementById('confettiContainer');
  container.innerHTML = '';
  const colors = ['#FF6B6B','#FFE66D','#4ECDC4','#DDA0DD','#FFD700','#FF6B35','#8B5CF6','#2DD4A8'];

  for(let i=0;i<60;i++){
    const el = document.createElement('div');
    el.className = 'confetti';
    el.style.left = Math.random()*100 + '%';
    el.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDuration = (2+Math.random()*3) + 's';
    el.style.animationDelay = Math.random()*1 + 's';
    el.style.borderRadius = Math.random()>0.5 ? '50%' : '2px';
    el.style.width = (6+Math.random()*8) + 'px';
    el.style.height = (6+Math.random()*8) + 'px';
    container.appendChild(el);
  }

  setTimeout(() => container.innerHTML = '', 5000);
}

// ‚ïê‚ïê‚ïê ACTIVITY LOGGING ‚ïê‚ïê‚ïê
function logActivity() {
  const pin = localStorage.getItem('bori_pin');
  if(!pin) return;

  fetch('/api/activity', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      pin: pin,
      event: 'game',
      game: 'La Isla',
      scene: currentScene.id,
      difficulty: currentDifficulty,
      time: elapsedSeconds,
      timestamp: new Date().toISOString()
    })
  }).catch(() => {});
}

// ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê
function goBack() {
  if(document.getElementById('puzzleScreen').classList.contains('active')) {
    clearInterval(timerInterval);
    document.getElementById('puzzleScreen').classList.remove('active');
    document.getElementById('selectScreen').classList.add('active');
    renderSceneGrid();
  } else {
    window.location.href = '/';
  }
}

function toggleReference() {
  const ref = document.getElementById('puzzleReference');
  const btn = document.getElementById('refToggle');
  if(ref.style.display === 'none') {
    ref.style.display = 'block';
    btn.textContent = 'Esconder';
  } else {
    ref.style.display = 'none';
    btn.textContent = 'Ver Imagen';
  }
}

function nextPuzzle() {
  document.getElementById('completionModal').classList.remove('active');
  let idx = SCENES.findIndex(s => s.id === currentScene.id);
  let next = SCENES[(idx+1) % SCENES.length];
  if(!next.free && !isPaid) {
    next = SCENES.find(s => s.free && s.id !== currentScene.id) || SCENES[0];
  }
  startPuzzle(next);
}

function backToSelect() {
  document.getElementById('completionModal').classList.remove('active');
  clearInterval(timerInterval);
  document.getElementById('puzzleScreen').classList.remove('active');
  document.getElementById('selectScreen').classList.add('active');
  renderSceneGrid();
}

// ‚ïê‚ïê‚ïê START ‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
