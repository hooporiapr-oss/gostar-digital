<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Habla con Bori ‚Äî Tu Compa√±era Biling√ºe. Chat en espa√±ol boricua o English. Hey Bori üáµüá∑">
  <title>Habla con Bori ‚Äî Hey Bori üáµüá∑</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Instrument+Sans:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --serif:'DM Serif Display',serif;--sans:'Instrument Sans',sans-serif;--display:'Bebas Neue',sans-serif;
      --night:#0B0B14;--surface:#1A1726;--surface2:#211D2E;
      --purple:#8B5CF6;--purple-deep:#6D28D9;--purple-light:#A78BFA;
      --gold:#D4A843;--gold-bright:#F0C75E;--teal:#2DD4A8;
      --text:#EDEBE8;--muted:rgba(237,235,232,.5);--radius:18px
    }
    html,body{height:100%;overflow:hidden}
    body{font-family:var(--sans);background:var(--night);color:var(--text);-webkit-font-smoothing:antialiased;display:flex;flex-direction:column}

    .bg{position:fixed;inset:0;pointer-events:none;z-index:0}
    .bg::before{content:'';position:absolute;top:-20%;left:50%;transform:translateX(-50%);width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(139,92,246,.08) 0%,transparent 60%)}

    .header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(11,11,20,.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.05);position:relative;z-index:10;flex-shrink:0}
    .h-back{display:flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:12px;background:var(--surface);border:1px solid rgba(255,255,255,.06);font-size:16px;text-decoration:none;-webkit-tap-highlight-color:transparent;transition:all .15s;flex-shrink:0}
    .h-back:active{transform:scale(.9)}
    .h-avatar{width:42px;height:42px;border-radius:50%;object-fit:contain;background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(168,85,247,.1));border:1.5px solid rgba(139,92,246,.2);padding:3px;flex-shrink:0}
    .h-info{flex:1;min-width:0}
    .h-name{font-family:var(--display);font-size:18px;letter-spacing:2px;line-height:1}
    .h-status{display:flex;align-items:center;gap:5px;margin-top:2px}
    .h-dot{width:7px;height:7px;border-radius:50%;background:#10B981;animation:pulse 2s ease infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.4)}50%{box-shadow:0 0 0 4px rgba(16,185,129,0)}}
    .h-stat{font-size:11px;color:var(--muted);font-weight:600}
    .h-flag{font-size:22px;flex-shrink:0}
    .h-counter{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:100px;font-size:10px;font-weight:700;letter-spacing:.5px;flex-shrink:0}
    .h-counter.free{background:rgba(212,168,67,.1);border:1px solid rgba(212,168,67,.2);color:var(--gold)}
    .h-counter.paid{background:rgba(45,212,168,.1);border:1px solid rgba(45,212,168,.2);color:var(--teal)}

    .msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;position:relative;z-index:1;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    .msgs::-webkit-scrollbar{width:3px}
    .msgs::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:10px}

    .welcome{text-align:center;padding:24px 16px;animation:fadeIn .6s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .welcome-av{width:80px;height:80px;object-fit:contain;margin-bottom:12px;filter:drop-shadow(0 4px 20px rgba(139,92,246,.3));animation:float 5s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    .welcome-title{font-family:var(--serif);font-size:22px;margin-bottom:4px}
    .welcome-title em{font-style:italic;color:var(--purple-light)}
    .welcome-sub{font-size:13px;color:var(--muted);line-height:1.5;max-width:280px;margin:0 auto}

    .starters{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:16px}
    .starter{padding:8px 14px;border-radius:100px;background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.15);font-size:12.5px;font-weight:600;color:var(--purple-light);cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
    .starter:active{transform:scale(.95);background:rgba(139,92,246,.15)}

    .msg{display:flex;gap:8px;max-width:88%;animation:msgIn .35s cubic-bezier(.22,1,.36,1)}
    @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .msg-user{align-self:flex-end;flex-direction:row-reverse}
    .msg-bori{align-self:flex-start}
    .msg-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;margin-top:2px}
    .msg-av-bori{background:linear-gradient(135deg,rgba(139,92,246,.2),rgba(168,85,247,.1));border:1px solid rgba(139,92,246,.15);display:flex;align-items:center;justify-content:center;font-size:14px;padding:2px}
    .msg-av-user{background:linear-gradient(135deg,rgba(212,168,67,.15),rgba(212,168,67,.05));border:1px solid rgba(212,168,67,.15);display:flex;align-items:center;justify-content:center;font-size:13px}
    .bubble{padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.55;font-weight:500;word-wrap:break-word;overflow-wrap:break-word}
    .b-bori{background:var(--surface);border:1px solid rgba(255,255,255,.05);border-bottom-left-radius:4px;color:var(--text)}
    .b-user{background:linear-gradient(135deg,#7C3AED,#6D28D9);border-bottom-right-radius:4px;color:white}
    .typing{display:flex;align-items:center;gap:4px;padding:12px 16px}
    .typing-dot{width:7px;height:7px;border-radius:50%;background:var(--purple-light);opacity:.4;animation:typeDot 1.4s ease-in-out infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typeDot{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}

    .upgrade{display:none;text-align:center;padding:20px 16px;animation:fadeIn .4s ease}
    .upgrade.show{display:block}
    .upgrade-card{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(212,168,67,.06));border:1.5px solid rgba(139,92,246,.2);border-radius:var(--radius);padding:24px 20px}
    .upgrade-icon{font-size:32px;margin-bottom:8px}
    .upgrade-title{font-family:var(--serif);font-size:18px;margin-bottom:4px}
    .upgrade-desc{font-size:13px;color:var(--muted);line-height:1.5;margin-bottom:16px}
    .upgrade-btn{display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border:none;border-radius:60px;background:linear-gradient(135deg,#7C3AED,#9333EA);color:white;font-family:var(--display);font-size:16px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-decoration:none;-webkit-tap-highlight-color:transparent}
    .upgrade-btn:active{transform:scale(.95)}
    .upgrade-or{font-size:12px;color:var(--muted);margin-top:10px}
    .upgrade-login{color:var(--purple-light);text-decoration:underline;cursor:pointer;font-weight:600}

    .login-modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px}
    .login-modal.show{display:flex}
    .login-box{background:var(--surface);border:1.5px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:28px 24px;width:100%;max-width:340px;text-align:center}
    .login-title{font-family:var(--display);font-size:22px;letter-spacing:2px;margin-bottom:4px}
    .login-sub{font-size:13px;color:var(--muted);margin-bottom:20px}
    .login-input{width:100%;padding:14px;border-radius:14px;border:1.5px solid rgba(255,255,255,.08);background:var(--surface2);color:var(--text);font-family:var(--display);font-size:28px;letter-spacing:10px;text-align:center;outline:none;-webkit-appearance:none}
    .login-input:focus{border-color:rgba(139,92,246,.3)}
    .login-input::placeholder{font-family:var(--sans);font-size:14px;letter-spacing:1px;color:var(--muted)}
    .login-btn{width:100%;margin-top:12px;padding:14px;border:none;border-radius:14px;background:linear-gradient(135deg,#7C3AED,#9333EA);color:white;font-family:var(--display);font-size:16px;letter-spacing:2px;cursor:pointer;transition:all .2s}
    .login-btn:active{transform:scale(.97)}
    .login-btn:disabled{opacity:.4}
    .login-close{margin-top:12px;font-size:13px;color:var(--muted);cursor:pointer}
    .login-error{font-size:12px;color:#EF4444;margin-top:8px;min-height:18px}

    .input-wrap{padding:10px 12px;padding-bottom:max(10px,env(safe-area-inset-bottom));background:rgba(11,11,20,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.05);position:relative;z-index:10;flex-shrink:0}
    .input-row{display:flex;gap:8px;align-items:flex-end;max-width:480px;margin:0 auto}
    .input-field{flex:1;min-height:44px;max-height:120px;padding:10px 14px;border-radius:14px;border:1.5px solid rgba(255,255,255,.08);background:var(--surface);color:var(--text);font-family:var(--sans);font-size:15px;font-weight:500;resize:none;outline:none;line-height:1.4;transition:border-color .2s;-webkit-appearance:none}
    .input-field::placeholder{color:var(--muted);font-weight:500}
    .input-field:focus{border-color:rgba(139,92,246,.3)}
    .input-field:disabled{opacity:.4}
    .send-btn{width:44px;height:44px;border-radius:14px;border:none;background:linear-gradient(135deg,#7C3AED,#9333EA);color:white;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;-webkit-tap-highlight-color:transparent}
    .send-btn:active{transform:scale(.9)}
    .send-btn:disabled{opacity:.3;transform:none}
    .send-btn svg{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}

    /* ‚ïê‚ïê‚ïê VOICE BUTTON ‚Äî PREMIUM ONLY ‚ïê‚ïê‚ïê */
    .voice-fab{display:none;position:fixed;bottom:80px;right:16px;z-index:20;width:56px;height:56px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--night);font-size:24px;cursor:pointer;box-shadow:0 4px 20px rgba(212,168,67,.4),0 0 0 0 rgba(212,168,67,.3);transition:all .3s;-webkit-tap-highlight-color:transparent;align-items:center;justify-content:center}
    .voice-fab.show{display:flex;animation:fabIn .5s cubic-bezier(.22,1,.36,1)}
    .voice-fab:active{transform:scale(.9)}
    .voice-fab:hover{box-shadow:0 6px 28px rgba(212,168,67,.5)}
    @keyframes fabIn{from{opacity:0;transform:scale(.5) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .voice-fab-pulse{animation:fabPulse 2s ease infinite}
    @keyframes fabPulse{0%,100%{box-shadow:0 4px 20px rgba(212,168,67,.4),0 0 0 0 rgba(212,168,67,.3)}50%{box-shadow:0 4px 20px rgba(212,168,67,.4),0 0 0 10px rgba(212,168,67,0)}}
    .voice-label{display:none;position:fixed;bottom:142px;right:10px;z-index:20;background:var(--surface);border:1px solid rgba(212,168,67,.25);border-radius:12px;padding:8px 14px;font-size:12px;font-weight:600;color:var(--gold);white-space:nowrap;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.4)}
    .voice-label.show{display:block;animation:fadeIn .4s ease}
    .voice-label::after{content:'';position:absolute;bottom:-6px;right:24px;width:12px;height:12px;background:var(--surface);border-right:1px solid rgba(212,168,67,.25);border-bottom:1px solid rgba(212,168,67,.25);transform:rotate(45deg)}

    /* ‚ïê‚ïê‚ïê VOICE UPSELL ‚Äî FREE USERS ‚ïê‚ïê‚ïê */
    .voice-upsell{display:none;position:fixed;bottom:80px;right:16px;z-index:20;width:56px;height:56px;border-radius:50%;border:1.5px solid rgba(255,255,255,.1);background:var(--surface2);color:var(--muted);font-size:22px;cursor:pointer;align-items:center;justify-content:center;transition:all .2s;-webkit-tap-highlight-color:transparent;opacity:.7}
    .voice-upsell.show{display:flex;animation:fabIn .5s cubic-bezier(.22,1,.36,1)}
    .voice-upsell:active{transform:scale(.9)}

    .upsell-modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px}
    .upsell-modal.show{display:flex}
    .upsell-box{background:var(--surface);border:1.5px solid rgba(212,168,67,.2);border-radius:var(--radius);padding:28px 24px;width:100%;max-width:340px;text-align:center;animation:fadeIn .3s ease}
    .upsell-icon{font-size:40px;margin-bottom:12px}
    .upsell-title{font-family:var(--serif);font-size:20px;margin-bottom:6px;color:var(--gold)}
    .upsell-desc{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:20px}
    .upsell-cta{display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border:none;border-radius:60px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--night);font-family:var(--display);font-size:16px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-decoration:none;-webkit-tap-highlight-color:transparent;font-weight:700}
    .upsell-cta:active{transform:scale(.95)}
    .upsell-close{margin-top:14px;font-size:13px;color:var(--muted);cursor:pointer}

    @media(max-width:420px){.h-name{font-size:16px}.welcome-av{width:68px;height:68px}.welcome-title{font-size:20px}.bubble{font-size:13.5px}}
    @media(max-height:500px){.welcome{padding:12px}.welcome-av{width:50px;height:50px}.starters{margin-top:8px}}
    @media(min-width:600px){.voice-fab,.voice-upsell{bottom:90px;right:24px}.voice-label{bottom:152px;right:18px}}
  </style>
</head>
<body>

  <div class="bg"></div>

  <div class="header">
    <a href="/" class="h-back">‚Üê</a>
    <img src="/icon.png" alt="Bori" class="h-avatar">
    <div class="h-info">
      <div class="h-name">BORI</div>
      <div class="h-status"><span class="h-dot"></span><span class="h-stat">Siempre contigo</span></div>
    </div>
    <div class="h-counter free" id="counter">5/5</div>
    <span class="h-flag">üáµüá∑</span>
  </div>

  <div class="msgs" id="msgs">
    <div class="welcome" id="welcome">
      <img src="/icon.png" alt="Bori" class="welcome-av">
      <div class="welcome-title">Hey <em>Bori</em> üíõ</div>
      <div class="welcome-sub">Soy tu compa√±era biling√ºe. H√°blame en espa√±ol boricua o en English ‚Äî siempre estoy aqu√≠ pa' ti. üáµüá∑</div>
      <div class="starters">
        <span class="starter" onclick="sendStarter(this)">¬°Hola Bori! üíõ</span>
        <span class="starter" onclick="sendStarter(this)">Talk to me in English</span>
        <span class="starter" onclick="sendStarter(this)">Me siento solita hoy...</span>
        <span class="starter" onclick="sendStarter(this)">¬øQu√© juegos hay?</span>
      </div>
    </div>
    <div class="upgrade" id="upgrade">
      <div class="upgrade-card">
        <div class="upgrade-icon">üíú</div>
        <div class="upgrade-title">¬°Bori quiere seguir hablando!</div>
        <div class="upgrade-desc">Ya usaste tus 5 mensajes gratis de hoy. Con Bori Plus, habla ilimitado todos los d√≠as. üáµüá∑</div>
        <a class="upgrade-btn" href="/#planes">üíú BORI PLUS ‚Äî $9.99/mes</a>
        <div class="upgrade-or">¬øYa tienes PIN? <span class="upgrade-login" onclick="showLogin()">Entra aqu√≠</span></div>
      </div>
    </div>
  </div>

  <!-- PREMIUM: Voice FAB (paid users only) -->
  <div class="voice-label" id="voiceLabel">üé§ Habla con Bori</div>
  <button class="voice-fab voice-fab-pulse" id="voiceFab" onclick="openVoiceBori()">üé§</button>

  <!-- FREE: Locked mic upsell -->
  <button class="voice-upsell" id="voiceUpsell" onclick="showUpsell()">üîí</button>

  <!-- Upsell Modal -->
  <div class="upsell-modal" id="upsellModal">
    <div class="upsell-box">
      <div class="upsell-icon">üé§üíõ</div>
      <div class="upsell-title">Habla con Bori por Voz</div>
      <div class="upsell-desc">Con Bori Plus, puedes hablar con Bori usando tu voz ‚Äî como si fuera una llamada con tu mejor amiga boricua. Ilimitado, todos los d√≠as. üáµüá∑</div>
      <a class="upsell-cta" href="/#planes">BORI PLUS ‚Äî $9.99/mes</a>
      <div class="upsell-close" onclick="hideUpsell()">Ahora no</div>
    </div>
  </div>

  <div class="input-wrap">
    <div class="input-row">
      <textarea class="input-field" id="input" rows="1" placeholder="Escr√≠bele a Bori..." enterkeyhint="send"></textarea>
      <button class="send-btn" id="sendBtn" onclick="send()" disabled>
        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>
  </div>

  <div class="login-modal" id="loginModal">
    <div class="login-box">
      <div class="login-title">ENTRA CON TU PIN</div>
      <div class="login-sub">Tu PIN de Bori Plus o Familia</div>
      <input class="login-input" id="pinInput" type="tel" maxlength="4" placeholder="PIN" inputmode="numeric" autocomplete="off">
      <div class="login-error" id="loginError"></div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()" disabled>ENTRAR</button>
      <div class="login-close" onclick="hideLogin()">Cancelar</div>
    </div>
  </div>

  <script>
    var CHATGPT_BORI_URL='https://chatgpt.com/g/g-69937e6b89148191afdc4d1d0a0acd39-hey-bori-tu-companera-bilingue';
    var input=document.getElementById('input'),sendBtn=document.getElementById('sendBtn'),msgs=document.getElementById('msgs'),welcome=document.getElementById('welcome'),counterEl=document.getElementById('counter'),upgradeEl=document.getElementById('upgrade');
    var voiceFab=document.getElementById('voiceFab'),voiceLabel=document.getElementById('voiceLabel'),voiceUpsell=document.getElementById('voiceUpsell');
    var history=[],sending=false,FREE_DAILY_LIMIT=5,userPin=null,isPaid=false;

    function getTodayKey(){return'bori_msgs_'+new Date().toISOString().split('T')[0]}
    function getTodayCount(){try{var v=localStorage.getItem(getTodayKey());return v?parseInt(v):0}catch(e){return 0}}
    function incrementCount(){try{var k=getTodayKey(),c=getTodayCount()+1;localStorage.setItem(k,String(c));Object.keys(localStorage).forEach(function(x){if(x.startsWith('bori_msgs_')&&x!==k)localStorage.removeItem(x)});return c}catch(e){return 999}}
    function getRemaining(){return isPaid?999:Math.max(0,FREE_DAILY_LIMIT-getTodayCount())}

    function updateCounter(){
      if(isPaid){counterEl.className='h-counter paid';counterEl.textContent='‚àû PLUS';}
      else{var r=getRemaining();counterEl.className='h-counter free';counterEl.textContent=r+'/'+FREE_DAILY_LIMIT;if(r<=1)counterEl.style.borderColor='rgba(239,68,68,.3)';}
    }
    function canSend(){return isPaid||getRemaining()>0}

    /* ‚ïê‚ïê‚ïê LIMIT REACHED ‚Äî REPLACE ENTIRE MSGS AREA ‚ïê‚ïê‚ïê */
    function checkLimitReached(){
      if(!canSend()){
        msgs.innerHTML='<div style="text-align:center;padding:30px 20px;animation:fadeIn .4s ease">'
          +'<div style="font-size:40px;margin-bottom:12px">üíú</div>'
          +'<div style="font-family:var(--serif);font-size:20px;margin-bottom:6px">¬°Bori quiere seguir hablando!</div>'
          +'<div style="font-size:13px;color:rgba(237,235,232,.5);line-height:1.6;margin-bottom:8px">Ya usaste tus 5 mensajes gratis de hoy.</div>'
          +'<div style="font-size:13px;color:rgba(237,235,232,.5);line-height:1.6;margin-bottom:20px">Con Bori Plus, habla ilimitado todos los d√≠as. üáµüá∑</div>'
          +'<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 18px;border-radius:14px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15);font-size:13px;color:#EDEBE8;margin:0 auto 20px;max-width:280px">üïê Se renuevan a la medianoche</div>'
          +'<a href="/#planes" style="display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border:none;border-radius:60px;background:linear-gradient(135deg,#7C3AED,#9333EA);color:white;font-family:var(--display);font-size:16px;letter-spacing:2px;text-decoration:none">üíú BORI PLUS ‚Äî $9.99/mes</a>'
          +'<div style="font-size:12px;color:rgba(237,235,232,.5);margin-top:10px">¬øYa tienes PIN? <span style="color:#A78BFA;text-decoration:underline;cursor:pointer;font-weight:600" onclick="showLogin()">Entra aqu√≠</span></div>'
          +'<a href="/" style="display:flex;align-items:center;justify-content:center;gap:6px;margin:18px auto 0;padding:14px 28px;border:1.5px solid rgba(255,255,255,.2);border-radius:60px;background:rgba(255,255,255,.08);color:#EDEBE8;font-size:14px;font-weight:600;text-decoration:none;max-width:260px">‚Üê Volver a Inicio</a>'
          +'</div>';
        input.disabled=true;
        input.placeholder='Mensajes agotados por hoy...';
        sendBtn.disabled=true;
        return true;
      }
      return false;
    }

    /* ‚ïê‚ïê‚ïê VOICE BUTTON LOGIC ‚ïê‚ïê‚ïê */
    function updateVoiceUI(){
      if(isPaid){
        voiceFab.classList.add('show');
        voiceLabel.classList.add('show');
        voiceUpsell.classList.remove('show');
        setTimeout(function(){voiceLabel.classList.remove('show')},4000);
      } else {
        voiceFab.classList.remove('show');
        voiceLabel.classList.remove('show');
        voiceUpsell.classList.add('show');
      }
    }
    function openVoiceBori(){
      window.open(CHATGPT_BORI_URL,'_blank');
    }
    function showUpsell(){document.getElementById('upsellModal').classList.add('show')}
    function hideUpsell(){document.getElementById('upsellModal').classList.remove('show')}

    function checkSavedPin(){try{var s=localStorage.getItem('bori_pin');if(s)verifyPin(s)}catch(e){}updateCounter();updateVoiceUI()}
    function verifyPin(pin){
      fetch('/api/stripe/status-pin/'+pin).then(function(r){return r.json()}).then(function(d){
        if(d.subscribed){userPin=pin;isPaid=true;try{localStorage.setItem('bori_pin',pin)}catch(e){}updateCounter();updateVoiceUI();input.disabled=false;input.placeholder='Escr√≠bele a Bori...';upgradeEl.classList.remove('show')}
        else{try{localStorage.removeItem('bori_pin')}catch(e){}isPaid=false;updateCounter();updateVoiceUI()}
      }).catch(function(){updateCounter();updateVoiceUI()});
    }

    function showLogin(){document.getElementById('loginModal').classList.add('show');document.getElementById('pinInput').value='';document.getElementById('loginError').textContent='';document.getElementById('pinInput').focus()}
    function hideLogin(){document.getElementById('loginModal').classList.remove('show')}
    var pinInput=document.getElementById('pinInput'),loginBtn=document.getElementById('loginBtn');
    pinInput.addEventListener('input',function(){loginBtn.disabled=this.value.length<4});
    pinInput.addEventListener('keydown',function(e){if(e.key==='Enter'&&this.value.length>=4)doLogin()});

    function doLogin(){
      var pin=pinInput.value.trim();if(pin.length<4)return;
      loginBtn.disabled=true;loginBtn.textContent='...';document.getElementById('loginError').textContent='';
      fetch('/api/stripe/status-pin/'+pin).then(function(r){return r.json()}).then(function(d){
        if(d.subscribed){userPin=pin;isPaid=true;try{localStorage.setItem('bori_pin',pin)}catch(e){}hideLogin();updateCounter();updateVoiceUI();input.disabled=false;input.placeholder='Escr√≠bele a Bori...';upgradeEl.classList.remove('show')}
        else{document.getElementById('loginError').textContent=d.status==='canceled'?'Suscripci√≥n cancelada':'PIN no v√°lido o inactivo'}
        loginBtn.disabled=false;loginBtn.textContent='ENTRAR';
      }).catch(function(){document.getElementById('loginError').textContent='Error de conexi√≥n';loginBtn.disabled=false;loginBtn.textContent='ENTRAR'});
    }

    input.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px';sendBtn.disabled=!this.value.trim()||!canSend()});
    input.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(!sending&&this.value.trim()&&canSend())send()}});
    function sendStarter(el){if(!canSend()){checkLimitReached();return}input.value=el.textContent;sendBtn.disabled=false;send()}

    /* ‚ïê‚ïê‚ïê SAFE WELCOME REMOVAL ‚ïê‚ïê‚ïê */
    function removeWelcome(){
      try{
        var w=document.getElementById('welcome');
        if(w&&w.parentNode)w.parentNode.removeChild(w);
      }catch(e){}
    }

    function addMsg(role,text){
      removeWelcome();
      var w=document.createElement('div');w.className='msg msg-'+role;
      var a=document.createElement('div');a.className='msg-av msg-av-'+role;a.textContent=role==='bori'?'üáµüá∑':'üë§';
      var b=document.createElement('div');b.className='bubble b-'+role;b.textContent=text;
      w.appendChild(a);w.appendChild(b);msgs.appendChild(w);scroll();return b;
    }
    function addTyping(){
      removeWelcome();
      var w=document.createElement('div');w.className='msg msg-bori';w.id='typing';
      var a=document.createElement('div');a.className='msg-av msg-av-bori';a.textContent='üáµüá∑';
      var b=document.createElement('div');b.className='bubble b-bori typing';b.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
      w.appendChild(a);w.appendChild(b);msgs.appendChild(w);scroll();
    }
    function removeTyping(){var t=document.getElementById('typing');if(t)t.remove()}
    function scroll(){msgs.scrollTop=msgs.scrollHeight}

    /* ‚ïê‚ïê‚ïê SEND WITH 15s TIMEOUT ‚ïê‚ïê‚ïê */
    async function send(){
      var text=input.value.trim();if(!text||sending)return;
      if(checkLimitReached())return;
      sending=true;sendBtn.disabled=true;input.value='';input.style.height='auto';
      addMsg('user',text);
      history.push({role:'user',content:text});
      if(!isPaid){incrementCount();updateCounter();}
      addTyping();
      try{
        var controller=new AbortController();
        var timeout=setTimeout(function(){controller.abort();},15000);
        var res=await fetch('/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({messages:history}),
          signal:controller.signal
        });
        clearTimeout(timeout);
        removeTyping();
        if(!res.ok){addMsg('bori','Ay, tuve un problemita. Intenta de nuevo. üíõ');sending=false;sendBtn.disabled=false;return}
        var data=await res.json();var reply=data.reply||'...';
        addMsg('bori',reply);history.push({role:'assistant',content:reply});
        if(history.length>40)history=history.slice(-40);
      }catch(e){
        removeTyping();
        if(e.name==='AbortError'){
          addMsg('bori','Perdona, tard√© mucho en responder. Intenta de nuevo. üíõ');
        }else{
          addMsg('bori','Perdona, no pude conectar. Intenta de nuevo. üíõ');
        }
      }
      sending=false;
      if(checkLimitReached())return;
      sendBtn.disabled=!input.value.trim();input.focus();
    }

    checkSavedPin();
    if(!checkLimitReached()&&window.innerWidth>600)input.focus();
  </script>
</body>
</html>
