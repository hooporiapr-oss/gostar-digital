<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>THE MATCH | LaughCourt‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --cyan: #00CED1;
    --blue: #3B82F6;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --red: #FF1744;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.game-container {
    max-width: 420px;
    height: 100vh;
    height: 100dvh;
    margin: 0 auto;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    text-align: center;
    padding: 5px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
}
.logo .laugh { color: var(--gold); }
.court-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 3px;
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.powered-by {
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
}
.powered-by .ritnome { color: var(--gold); font-weight: 700; }

.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 8px;
    background: var(--card);
    border-radius: 10px;
    margin: 8px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    color: var(--gold);
    line-height: 1;
}
.stat-label {
    font-size: 0.55rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.message-display {
    background: var(--card);
    border: 2px solid var(--cyan);
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 8px;
    text-align: center;
    flex-shrink: 0;
}
.message-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    color: var(--text);
}
.message-text.watch { color: var(--gold); }
.message-text.go { color: var(--teal); }

.target-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 8px;
    flex-shrink: 0;
}
.target-label {
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
}
.target-color {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 3px solid var(--gold);
    box-shadow: 0 0 15px rgba(255,215,0,0.3);
    background: var(--card);
}

.ritnome-tempo {
    margin-bottom: 8px;
    flex-shrink: 0;
}
.tempo-label {
    text-align: center;
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 5px;
}
.tempo-label .ritnome-mark { color: var(--gold); font-weight: 700; }
.speed-selector {
    display: flex;
    gap: 6px;
}
.speed-btn {
    flex: 1;
    padding: 8px 4px;
    border: 2px solid var(--border);
    background: var(--card);
    border-radius: 10px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    position: relative;
}
.speed-btn .icon { font-size: 1rem; }
.speed-btn .bpm { font-size: 1.1rem; line-height: 1; }
.speed-btn .bpm-label {
    font-family: 'Outfit', sans-serif;
    font-size: 0.5rem;
    text-transform: uppercase;
    opacity: 0.7;
}
.speed-btn.active {
    border-color: var(--cyan);
    color: var(--cyan);
    background: rgba(0,206,209,0.1);
}

.speed-btn.locked {
    opacity: 0.5;
    cursor: not-allowed;
    position: relative;
}
.speed-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: 2px;
    right: 4px;
    font-size: 0.7rem;
}
.speed-btn.locked:hover {
    border-color: var(--gold);
}

.court-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    padding: 5px 0;
}
.court-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    padding: 12px;
    background: linear-gradient(145deg, #0d0d12, #080810);
    border-radius: 16px;
    border: 2px solid rgba(0,206,209,0.2);
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    width: 100%;
    max-width: 320px;
    aspect-ratio: 1;
}
.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s;
    background: linear-gradient(145deg, #1e1e2a, #151520);
    border: 2px solid rgba(0,206,209,0.25);
    box-shadow: 0 2px 6px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
}
.grid-cell:active:not(.disabled) { transform: scale(0.95); }
.grid-cell.disabled { pointer-events: none; opacity: 0.5; }
.grid-cell.lit {
    transform: scale(1.05);
    box-shadow: 0 0 20px currentColor;
}
.grid-cell.correct {
    background: var(--teal) !important;
    border-color: var(--teal) !important;
    animation: pulse 0.3s;
}
.grid-cell.wrong {
    background: var(--pink) !important;
    border-color: var(--pink) !important;
    animation: shake 0.3s;
}
@keyframes pulse { 50% { transform: scale(1.1); } }
@keyframes shake { 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

.progress-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 8px 0;
    flex-shrink: 0;
}
.tier-badge {
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    padding: 5px 12px;
    border-radius: 15px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    letter-spacing: 2px;
    color: var(--dark);
    white-space: nowrap;
}
.progress-bar {
    flex: 1;
    height: 10px;
    background: var(--card);
    border-radius: 5px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan), var(--blue));
    border-radius: 5px;
    transition: width 0.3s;
}

.action-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.2s;
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    color: var(--dark);
    flex-shrink: 0;
}
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.feedback-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 100%;
}
.feedback-emoji { font-size: 3rem; margin-bottom: 10px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 3px;
    margin-bottom: 8px;
}
.feedback-title.success { color: var(--teal); }
.feedback-title.fail { color: var(--pink); }
.feedback-title.tierup { color: var(--gold); }
.feedback-message { color: var(--muted); margin-bottom: 15px; font-size: 0.9rem; }
.feedback-stats { display: flex; justify-content: center; gap: 25px; margin-bottom: 15px; }
.feedback-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--gold); }
.feedback-stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; }
.feedback-ritnome { font-size: 0.6rem; color: var(--gold); letter-spacing: 2px; margin-bottom: 15px; opacity: 0.8; }
.feedback-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 3px;
}
.feedback-btn.primary { background: linear-gradient(135deg, var(--cyan), var(--blue)); color: var(--dark); }
.feedback-btn.secondary { background: transparent; color: var(--muted); border: 1px solid var(--muted); }

.upgrade-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 20px;
}
.upgrade-overlay.show { display: flex; }
.upgrade-card {
    background: linear-gradient(145deg, #1a1a25, #0d0d12);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 340px;
    width: 100%;
    box-shadow: 0 0 40px rgba(255,215,0,0.2);
}
.upgrade-icon { font-size: 3rem; margin-bottom: 15px; }
.upgrade-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 10px;
}
.upgrade-subtitle {
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 20px;
}
.upgrade-benefits {
    text-align: left;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
}
.upgrade-benefit {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    color: var(--text);
    font-size: 0.9rem;
}
.upgrade-benefit .check { color: var(--teal); }
.upgrade-price {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 5px;
}
.upgrade-price-note {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 20px;
}
.upgrade-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    letter-spacing: 2px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    margin-bottom: 10px;
}
.upgrade-close {
    background: transparent;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
}

.coach-message {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    color: var(--dark);
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 700;
    font-size: 0.85rem;
    opacity: 0;
    transition: all 0.3s;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }

.lang-toggle {
    position: fixed;
    top: 8px;
    right: 10px;
    display: flex;
    gap: 4px;
    z-index: 100;
}
.lang-btn {
    padding: 4px 10px;
    border: 1px solid var(--muted);
    background: transparent;
    color: var(--muted);
    border-radius: 5px;
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
}
.lang-btn.active { border-color: var(--gold); color: var(--gold); }

.back-btn {
    position: fixed;
    top: 8px;
    left: 10px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 15px;
    color: var(--muted);
    font-size: 0.75rem;
    cursor: pointer;
    text-decoration: none;
    z-index: 100;
}

body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

@media (min-height: 700px) {
    .game-container { padding: 15px; }
    .court-grid { max-width: 350px; gap: 8px; padding: 15px; }
    .stats-bar { padding: 12px; gap: 20px; }
    .stat-value { font-size: 1.4rem; }
    .message-display { padding: 15px; }
    .message-text { font-size: 1.3rem; }
    .action-btn { padding: 16px; font-size: 1.3rem; }
}

@media (max-height: 600px) {
    .game-container { padding: 8px 10px; }
    .header { padding: 3px 0; }
    .court-name { font-size: 1.4rem; }
    .stats-bar { padding: 6px; gap: 12px; margin: 5px 0; }
    .stat-value { font-size: 1rem; }
    .message-display { padding: 8px; margin-bottom: 5px; }
    .message-text { font-size: 1rem; }
    .target-row { margin-bottom: 5px; }
    .target-color { width: 35px; height: 35px; }
    .ritnome-tempo { margin-bottom: 5px; }
    .speed-btn { padding: 6px 3px; }
    .speed-btn .bpm { font-size: 1rem; }
    .court-grid { padding: 10px; gap: 5px; max-width: 280px; }
    .progress-section { margin: 5px 0; }
    .action-btn { padding: 12px; font-size: 1.1rem; }
}
</style>
</head>
<body class="en">

<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<a href="laugh-hub.html" class="back-btn">‚Üê Back</a>

<div class="game-container">
    <header class="header">
        <div class="logo"><span class="laugh">LAUGH</span>COURT</div>
        <h1 class="court-name">üéØ THE MATCH</h1>
        <div class="powered-by">Powered by <span class="ritnome">Ritnome‚Ñ¢</span></div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="currentTier">1</div>
            <div class="stat-label">Tier</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="bestTier">0</div>
            <div class="stat-label">Best</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalLaughs">0</div>
            <div class="stat-label">üòÇ</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streak">0</div>
            <div class="stat-label">üî•</div>
        </div>
    </div>

    <div class="message-display">
        <span class="message-text" id="messageText">
            <span class="lang-en">Select tempo & START!</span>
            <span class="lang-es">¬°Selecciona tempo e INICIA!</span>
        </span>
    </div>

    <div class="target-row">
        <span class="target-label">
            <span class="lang-en">MATCH ‚Üí</span>
            <span class="lang-es">BUSCA ‚Üí</span>
        </span>
        <div class="target-color" id="targetColor"></div>
    </div>

    <div class="ritnome-tempo">
        <div class="tempo-label">üéµ <span class="ritnome-mark">Ritnome‚Ñ¢</span> Tempo</div>
        <div class="speed-selector">
            <button class="speed-btn active" data-speed="slow" data-bpm="60">
                <span class="icon">üê¢</span>
                <span class="bpm">60</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn" data-speed="medium" data-bpm="90">
                <span class="icon">üèÉ</span>
                <span class="bpm">90</span>
                <span class="bpm-label">BPM</span>
            </button>
            <button class="speed-btn" data-speed="fast" data-bpm="120">
                <span class="icon">‚ö°</span>
                <span class="bpm">120</span>
                <span class="bpm-label">BPM</span>
            </button>
        </div>
    </div>

    <div class="court-wrapper">
        <div class="court-grid" id="courtGrid"></div>
    </div>

    <div class="progress-section">
        <div class="tier-badge">TIER <span id="tierDisplay">1</span></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <button class="action-btn" id="actionBtn">
        <span class="lang-en">START MATCH üéØ</span>
        <span class="lang-es">INICIAR üéØ</span>
    </button>
</div>

<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üéâ</div>
        <h2 class="feedback-title" id="feedbackTitle">GREAT JOB!</h2>
        <p class="feedback-message" id="feedbackMessage">You found the match!</p>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackTier">1</div>
                <div class="feedback-stat-label">Tier</div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackLaughs">0</div>
                <div class="feedback-stat-label">üòÇ Earned</div>
            </div>
        </div>
        <div class="feedback-ritnome">Ritnome‚Ñ¢ Training</div>
        <button class="feedback-btn primary" id="continueBtn">CONTINUE üéØ</button>
        <button class="feedback-btn secondary" id="restartBtn">RESTART</button>
    </div>
</div>

<div class="upgrade-overlay" id="upgradeOverlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">üîì</div>
        <h2 class="upgrade-title">
            <span class="lang-en">UNLOCK ALL TEMPOS</span>
            <span class="lang-es">DESBLOQUEA TODOS</span>
        </h2>
        <p class="upgrade-subtitle">
            <span class="lang-en">Train at 90 & 120 BPM for maximum cognitive benefits</span>
            <span class="lang-es">Entrena a 90 y 120 BPM para m√°ximos beneficios</span>
        </p>
        <div class="upgrade-benefits">
            <div class="upgrade-benefit">
                <span class="check">‚úì</span>
                <span class="lang-en">60 BPM ‚Äî Foundation (Current)</span>
                <span class="lang-es">60 BPM ‚Äî Base (Actual)</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">90 BPM ‚Äî Optimal Challenge</span>
                <span class="lang-es">90 BPM ‚Äî Desaf√≠o √ìptimo</span>
            </div>
            <div class="upgrade-benefit">
                <span class="check">üîí</span>
                <span class="lang-en">120 BPM ‚Äî Elite Training</span>
                <span class="lang-es">120 BPM ‚Äî Entrenamiento √âlite</span>
            </div>
        </div>
        <div class="upgrade-price">$5<span style="font-size: 1rem;">/month</span></div>
        <div class="upgrade-price-note">
            <span class="lang-en">Cancel anytime ‚Ä¢ Instant access</span>
            <span class="lang-es">Cancela cuando quieras ‚Ä¢ Acceso inmediato</span>
        </div>
        <button class="upgrade-btn" id="upgradeBtn">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </button>
        <button class="upgrade-close" id="upgradeClose">
            <span class="lang-en">Continue with 60 BPM</span>
            <span class="lang-es">Continuar con 60 BPM</span>
        </button>
    </div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // ==================== ENVIRONMENT DETECTION ====================
    var host = window.location.hostname;
    var isProduction = (host.indexOf('laughcourt') > -1 || host.indexOf('github.io') > -1);
    var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '');
    var isPreview = !isProduction && !isLocal;

    // ==================== PRODUCTION AUTH & HEARTBEAT ====================
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('lc-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) {
            window.location.replace('index.html');
            return;
        }

        var sessionPin = sessionStorage.getItem('lc-pin');
        var sessionToken = sessionStorage.getItem('lc-token');

        function validateSession() {
            if (!sessionPin || !sessionToken) {
                window.location.href = 'index.html';
                return;
            }
            fetch('/api/session/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: sessionPin, token: sessionToken })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.valid) {
                    alert(d.message || 'Session ended. Please log in again.');
                    localStorage.removeItem('lc-user');
                    localStorage.removeItem('lc-bpm-access');
                    sessionStorage.removeItem('lc-pin');
                    sessionStorage.removeItem('lc-token');
                    window.location.href = 'index.html';
                }
            })
            .catch(function(err) {
                console.log('Session validation error:', err);
            });
        }

        validateSession();
        setInterval(validateSession, 30000);
    }
    // ==================== END PRODUCTION AUTH & HEARTBEAT ====================

    var currentLang = localStorage.getItem('lc-lang') || 'en';
    
    // BPM Access Control
    var bpmAccess = {
        allBPM: false,
        userType: 'guest',
        checked: false
    };
    
    // Try to load from localStorage
    try {
        var storedAccess = localStorage.getItem('lc-bpm-access');
        if (storedAccess) {
            bpmAccess = JSON.parse(storedAccess);
            bpmAccess.checked = true;
        }
    } catch(e) {}
    
    var colors = [
        {name: 'red', hex: '#FF4757'},
        {name: 'blue', hex: '#3B82F6'},
        {name: 'green', hex: '#00D9A5'},
        {name: 'yellow', hex: '#FFD700'},
        {name: 'purple', hex: '#9333EA'},
        {name: 'orange', hex: '#FF9500'},
        {name: 'pink', hex: '#FF6B9D'},
        {name: 'cyan', hex: '#00D4FF'}
    ];
    
    var state = {
        tier: parseInt(localStorage.getItem('lc-match-tier')) || 1,
        bestTier: parseInt(localStorage.getItem('lc-match-best')) || 0,
        totalLaughs: parseInt(localStorage.getItem('lc-match-laughs')) || 0,
        streak: 0,
        speed: 'slow',
        bpm: 60,
        targetColor: null,
        matchIndex: -1,
        isPlaying: false,
        isShowing: false,
        circuitsCompleted: parseInt(localStorage.getItem('lc-match-circuits')) || 0,
        cells: []
    };

    var speeds = {
        slow: { bpm: 60, flash: 1500 },
        medium: { bpm: 90, flash: 1000 },
        fast: { bpm: 120, flash: 600 }
    };

    var tierConfig = [
        {distractors: 4}, {distractors: 5}, {distractors: 6}, {distractors: 7}, {distractors: 8},
        {distractors: 9}, {distractors: 10}, {distractors: 11}, {distractors: 12}, {distractors: 14}
    ];

    var courtGrid = document.getElementById('courtGrid');
    var targetColorEl = document.getElementById('targetColor');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var feedbackOverlay = document.getElementById('feedbackOverlay');
    var coachMessage = document.getElementById('coachMessage');
    var upgradeOverlay = document.getElementById('upgradeOverlay');

    var texts = {
        en: {
            selectStart: 'Select tempo & START!',
            watch: 'WATCH THE COLORS...',
            yourTurn: 'TAP THE MATCH!',
            perfect: 'PERFECT!',
            almost: 'ALMOST!',
            tierUp: 'TIER UP!',
            tryAgain: 'The correct one is shown!',
            circuitsTo: 'circuits to next tier!',
            movingTo: 'Moving to Tier',
            continue: 'CONTINUE üéØ',
            nextRound: 'NEXT üéØ',
            tryAgainBtn: 'TRY AGAIN üéØ',
            startMatch: 'START MATCH üéØ',
            ready: 'Ready for Tier'
        },
        es: {
            selectStart: '¬°Selecciona tempo e INICIA!',
            watch: 'OBSERVA LOS COLORES...',
            yourTurn: '¬°TOCA EL PAR!',
            perfect: '¬°PERFECTO!',
            almost: '¬°CASI!',
            tierUp: '¬°SUBISTE DE NIVEL!',
            tryAgain: '¬°El correcto se muestra!',
            circuitsTo: 'circuitos para subir!',
            movingTo: 'Avanzando a Tier',
            continue: 'CONTINUAR üéØ',
            nextRound: 'SIGUIENTE üéØ',
            tryAgainBtn: 'INTENTAR üéØ',
            startMatch: 'INICIAR üéØ',
            ready: 'Listo para Tier'
        }
    };

    function t(key) { return texts[currentLang][key] || texts['en'][key]; }

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('lc-lang', lang);
        document.body.className = lang;
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
    }

    function applyBPMLocks() {
        var speedBtns = document.querySelectorAll('.speed-btn');
        speedBtns.forEach(function(btn) {
            var bpm = parseInt(btn.dataset.bpm);
            if (bpm > 60 && !bpmAccess.allBPM) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        });
        if (!bpmAccess.allBPM) {
            selectSpeed('slow', 60);
        }
    }
    
    function selectSpeed(speed, bpm) {
        state.speed = speed;
        state.bpm = bpm;
        document.querySelectorAll('.speed-btn').forEach(function(b) { 
            b.classList.remove('active'); 
        });
        var targetBtn = document.querySelector('.speed-btn[data-bpm="' + bpm + '"]');
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
    }
    
    function showUpgradeModal() { upgradeOverlay.classList.add('show'); }
    function hideUpgradeModal() { upgradeOverlay.classList.remove('show'); }

    function initGrid() {
        courtGrid.innerHTML = '';
        state.cells = [];
        for (var i = 0; i < 25; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell disabled';
            cell.dataset.index = i;
            cell.addEventListener('click', function() { handleCellClick(parseInt(this.dataset.index)); });
            courtGrid.appendChild(cell);
            state.cells.push(cell);
        }
    }

    function shuffle(arr) {
        for (var i = arr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
        }
        return arr;
    }

    function startRound() {
        state.isShowing = true;
        state.isPlaying = true;
        actionBtn.disabled = true;
        
        state.cells.forEach(function(c) { 
            c.className = 'grid-cell disabled'; 
            c.style.background = ''; 
            c.dataset.isMatch = 'false';
        });
        
        messageText.innerHTML = '<span class="lang-en">' + texts.en.watch + '</span><span class="lang-es">' + texts.es.watch + '</span>';
        messageText.className = 'message-text watch';
        
        var config = tierConfig[state.tier - 1];
        var flashTime = speeds[state.speed].flash;
        var numDistractors = config.distractors;
        
        state.targetColor = colors[Math.floor(Math.random() * colors.length)];
        targetColorEl.style.background = state.targetColor.hex;
        targetColorEl.style.boxShadow = '0 0 20px ' + state.targetColor.hex;
        
        var indices = [];
        for (var i = 0; i < 25; i++) indices.push(i);
        shuffle(indices);
        
        var litCells = indices.slice(0, numDistractors + 1);
        state.matchIndex = litCells[Math.floor(Math.random() * litCells.length)];
        
        var distractorColors = colors.filter(function(c) { return c.name !== state.targetColor.name; });
        shuffle(distractorColors);
        
        var dIdx = 0;
        litCells.forEach(function(cellIdx) {
            var cell = state.cells[cellIdx];
            if (cellIdx === state.matchIndex) {
                cell.style.background = state.targetColor.hex;
                cell.dataset.isMatch = 'true';
            } else {
                cell.style.background = distractorColors[dIdx % distractorColors.length].hex;
                dIdx++;
            }
            cell.classList.add('lit');
        });
        
        setTimeout(function() {
            state.cells.forEach(function(c) { 
                c.classList.remove('lit'); 
                c.style.background = ''; 
                c.classList.remove('disabled');
            });
            state.isShowing = false;
            messageText.innerHTML = '<span class="lang-en">' + texts.en.yourTurn + '</span><span class="lang-es">' + texts.es.yourTurn + '</span>';
            messageText.className = 'message-text go';
        }, flashTime);
    }

    function handleCellClick(index) {
        if (state.isShowing || !state.isPlaying) return;
        state.isPlaying = false;
        
        var cell = state.cells[index];
        var isMatch = cell.dataset.isMatch === 'true';
        
        if (isMatch) {
            cell.style.background = state.targetColor.hex;
            cell.classList.add('correct');
            state.streak++;
            
            var bpmBonus = state.bpm === 120 ? 2 : state.bpm === 90 ? 1 : 0;
            var laughsEarned = state.tier + bpmBonus;
            state.totalLaughs += laughsEarned;
            state.circuitsCompleted++;
            
            if (state.tier > state.bestTier) {
                state.bestTier = state.tier;
                localStorage.setItem('lc-match-best', state.bestTier);
            }
            localStorage.setItem('lc-match-laughs', state.totalLaughs);
            localStorage.setItem('lc-match-circuits', state.circuitsCompleted);
            
            updateStats();
            showCoach(['PERFECT! üéØ', 'COLOR MASTER! üí™', 'GREAT EYE! üëÅÔ∏è', 'RITNOME! üéµ'][Math.floor(Math.random() * 4)]);
            
            var progress = (state.circuitsCompleted % 3) / 3 * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            var tierUp = state.circuitsCompleted % 3 === 0 && state.tier < 10;
            setTimeout(function() { showFeedback(true, laughsEarned, tierUp); }, 800);
        } else {
            cell.classList.add('wrong');
            state.cells[state.matchIndex].style.background = state.targetColor.hex;
            state.cells[state.matchIndex].classList.add('correct');
            state.streak = 0;
            updateStats();
            showCoach(currentLang === 'es' ? '¬°Casi! üòÖ' : 'Close! üòÖ');
            setTimeout(function() { showFeedback(false, 0, false); }, 1200);
        }
        
        state.cells.forEach(function(c) { c.classList.add('disabled'); });
    }

    function showFeedback(success, laughs, tierUp) {
        var emoji = document.getElementById('feedbackEmoji');
        var title = document.getElementById('feedbackTitle');
        var message = document.getElementById('feedbackMessage');
        var continueBtn = document.getElementById('continueBtn');
        
        if (success) {
            if (tierUp) {
                emoji.textContent = 'üöÄ';
                title.textContent = t('tierUp');
                title.className = 'feedback-title tierup';
                message.textContent = t('movingTo') + ' ' + (state.tier + 1) + '!';
                state.tier++;
                localStorage.setItem('lc-match-tier', state.tier);
            } else {
                emoji.textContent = 'üòÇ';
                title.textContent = t('perfect');
                title.className = 'feedback-title success';
                message.textContent = (state.circuitsCompleted % 3) + '/3 ' + t('circuitsTo');
            }
            continueBtn.textContent = tierUp ? t('continue') : t('nextRound');
        } else {
            emoji.textContent = 'üòÖ';
            title.textContent = t('almost');
            title.className = 'feedback-title fail';
            message.textContent = t('tryAgain');
            continueBtn.textContent = t('tryAgainBtn');
        }
        
        document.getElementById('feedbackTier').textContent = state.tier;
        document.getElementById('feedbackLaughs').textContent = laughs;
        feedbackOverlay.classList.add('show');
        updateStats();
    }

    function updateStats() {
        document.getElementById('currentTier').textContent = state.tier;
        document.getElementById('bestTier').textContent = state.bestTier;
        document.getElementById('totalLaughs').textContent = state.totalLaughs;
        document.getElementById('streak').textContent = state.streak;
        document.getElementById('tierDisplay').textContent = state.tier;
    }

    function showCoach(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2000);
    }

    actionBtn.addEventListener('click', function() {
        if (!state.isPlaying && !state.isShowing) startRound();
    });

    document.querySelectorAll('.speed-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (state.isPlaying) return;
            var bpm = parseInt(btn.dataset.bpm);
            if (bpm > 60 && !bpmAccess.allBPM) {
                showUpgradeModal();
                return;
            }
            selectSpeed(btn.dataset.speed, bpm);
        });
    });

    document.getElementById('continueBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        actionBtn.disabled = false;
        messageText.innerHTML = '<span class="lang-en">' + t('ready') + ' ' + state.tier + '!</span><span class="lang-es">' + texts.es.ready + ' ' + state.tier + '!</span>';
        messageText.className = 'message-text';
    });

    document.getElementById('restartBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        state.tier = 1;
        state.circuitsCompleted = 0;
        state.streak = 0;
        localStorage.setItem('lc-match-tier', 1);
        localStorage.setItem('lc-match-circuits', 0);
        document.getElementById('progressFill').style.width = '0%';
        actionBtn.disabled = false;
        messageText.innerHTML = '<span class="lang-en">Back to Tier 1!</span><span class="lang-es">¬°De vuelta al Tier 1!</span>';
        messageText.className = 'message-text';
        updateStats();
    });

    document.getElementById('upgradeBtn').addEventListener('click', function() {
        window.location.href = 'https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005';
    });
    
    document.getElementById('upgradeClose').addEventListener('click', function() {
        hideUpgradeModal();
    });

    document.getElementById('btnEn').addEventListener('click', function() { setLang('en'); });
    document.getElementById('btnEs').addEventListener('click', function() { setLang('es'); });

    initGrid();
    setLang(currentLang);
    updateStats();
    applyBPMLocks();
})();
</script>
</body>
</html>
