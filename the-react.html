<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>THE REACT | RITNOME‚Ñ¢ ‚Äî Recognition ¬∑ Recall ¬∑ Reflex ¬∑ React ¬∑ Rhythm</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --purple: #9B59B6;
    --purple-light: #A873B8;
    --orange: #FF6B35;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --dark: #0a0a0f;
    --card: #111118;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
    --nav-height: 50px;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Outfit',sans-serif;background:var(--dark);color:var(--text);touch-action:manipulation;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}

.mini-nav{position:fixed;top:0;left:0;right:0;background:var(--card);border-bottom:1px solid var(--border);padding-top:env(safe-area-inset-top);z-index:1000;transition:transform 0.3s ease}
.nav-row{display:flex;align-items:center;justify-content:space-between;height:50px;padding:0 12px}
.back-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;font-family:'Outfit',sans-serif;font-size:0.75rem;font-weight:600;cursor:pointer;text-decoration:none;transition:all 0.2s}
.back-btn:hover,.back-btn:active{border-color:var(--purple);color:var(--purple)}
.nav-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--purple);display:flex;align-items:center;gap:6px}
.nav-right{display:flex;align-items:center;gap:6px}
.nav-lang{display:flex;gap:2px}
.nav-lang-btn{padding:5px 8px;border:1px solid var(--border);background:0;color:var(--muted);border-radius:4px;font-size:0.6rem;font-weight:600;cursor:pointer;min-width:28px;min-height:28px}
.nav-lang-btn.active{border-color:var(--gold);color:var(--gold)}
.settings-wrapper{position:relative}
.settings-btn{width:32px;height:32px;border-radius:6px;background:0;border:1px solid var(--border);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.settings-btn.open{background:rgba(255,255,255,0.1);color:var(--gold)}
.settings-dropdown{position:absolute;top:calc(100% + 6px);right:0;width:175px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.settings-dropdown.show{display:block}
.settings-section{margin-bottom:10px}
.settings-section:last-child{margin-bottom:0}
.settings-label{font-size:0.5rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.speed-status{display:flex;gap:4px}
.speed-chip{flex:1;padding:4px 2px;border-radius:4px;font-family:'Bebas Neue',sans-serif;font-size:0.55rem;text-align:center;background:rgba(255,255,255,0.05);color:var(--muted)}
.speed-chip.unlocked{background:rgba(155,89,182,0.15);color:var(--purple)}
.speed-chip.locked{background:rgba(255,215,0,0.1);color:var(--gold)}
.settings-link{display:block;width:100%;padding:8px;border-radius:6px;font-size:0.7rem;text-decoration:none;text-align:center;cursor:pointer;border:none;font-family:'Outfit',sans-serif}
.settings-link.upgrade{background:linear-gradient(135deg,var(--gold),#FFA500);color:var(--dark);font-weight:600;margin-bottom:6px}
.settings-link.logout{background:0;border:1px solid var(--border);color:var(--muted)}

.focus-btn{position:fixed;top:calc(env(safe-area-inset-top, 0px) + 58px);right:12px;width:32px;height:32px;border-radius:6px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:999;transition:all 0.2s}
.focus-btn:active{transform:scale(0.95)}
.focus-btn.active{background:rgba(155,89,182,0.3);border-color:var(--purple);color:var(--purple)}

.refresh-btn{position:fixed;top:calc(env(safe-area-inset-top, 0px) + 58px);right:50px;width:32px;height:32px;border-radius:6px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:999;transition:all 0.2s}
.refresh-btn:active{transform:scale(0.95);background:rgba(155,89,182,0.2);border-color:var(--purple);color:var(--purple)}

body.focus-mode .mini-nav{transform:translateY(-100%)}
body.focus-mode .game-container{padding-top:calc(env(safe-area-inset-top) + 60px)}
body.focus-mode .stats-bar{display:none}
body.focus-mode .message-display{display:none}
body.focus-mode .selectors-row{display:none}
body.focus-mode .progression-display{display:none}
body.focus-mode .division-display{display:none}
body.focus-mode .court-wrapper{flex:1;position:relative;z-index:10}
body.focus-mode .court-grid{width:min(95vw, calc(100dvh - 200px));height:min(95vw, calc(100dvh - 200px));max-width:500px;max-height:500px;position:relative;z-index:20}
body.focus-mode .action-btn{position:fixed;bottom:calc(env(safe-area-inset-bottom, 10px) + 15px);left:15px;right:15px;z-index:100}
body.focus-mode .coach-message{bottom:120px}
body.focus-mode .focus-btn,body.focus-mode .refresh-btn{top:calc(env(safe-area-inset-top, 0px) + 10px)}
.ritnome-badge{position:fixed;bottom:calc(env(safe-area-inset-bottom, 10px) + 70px);left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;background:rgba(5,5,8,0.85);border:1px solid rgba(255,215,0,0.15);border-radius:20px;padding:6px 16px 6px 10px;backdrop-filter:blur(10px);z-index:998;cursor:default;transition:opacity 0.3s}
.ritnome-badge .pulse-dot{width:8px;height:8px;background:var(--gold);border-radius:50%;box-shadow:0 0 6px rgba(255,215,0,0.4);animation:ritnome-pulse 1s ease-in-out infinite}
.ritnome-badge .badge-text{display:flex;flex-direction:column;line-height:1}
.ritnome-badge .powered-by{font-size:0.4rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);font-weight:600}
.ritnome-badge .ritnome-name{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;color:var(--gold)}
@keyframes ritnome-pulse{0%,100%{opacity:0.3;transform:scale(0.8)}50%{opacity:1;transform:scale(1.2)}}
body.focus-mode .ritnome-badge{display:none}

.game-container{width:100%;max-width:420px;height:100dvh;margin:0 auto;padding:5px 10px;padding-top:calc(var(--nav-height) + env(safe-area-inset-top) + 8px);padding-bottom:max(5px,env(safe-area-inset-bottom));display:flex;flex-direction:column;overflow:hidden;transition:padding 0.3s ease}
.stats-bar{display:flex;justify-content:center;gap:12px;padding:5px 8px;background:var(--card);border-radius:8px;margin-bottom:4px;flex-shrink:0}
.stat{text-align:center;min-width:40px}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--purple);line-height:1}
.stat-label{font-size:0.42rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
.message-display{background:var(--card);border:2px solid var(--purple);border-radius:8px;padding:7px;margin-bottom:4px;text-align:center;flex-shrink:0;min-height:36px;display:flex;align-items:center;justify-content:center}
.message-text{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;color:var(--text);transition:color 0.15s}
.message-text.ready{color:var(--purple)}
.message-text.go{color:var(--teal)}
.message-text.perfect{color:var(--teal)}
.message-text.good{color:var(--orange)}
.message-text.late{color:var(--purple-light)}
.message-text.miss{color:var(--pink)}
.message-text.countdown{color:var(--gold);font-size:1.4rem}
.message-text.flash-match{color:var(--orange)}
.message-text.flash-seq{color:var(--teal)}
.selectors-row{display:flex;gap:6px;margin-bottom:4px;flex-shrink:0}
.selector-group{flex:1;background:var(--card);border-radius:8px;padding:5px}
.selector-group.level-group{flex:1.8}
.selector-label{text-align:center;font-size:0.45rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.selector-options{display:flex;gap:3px}
.selector-options.level-options{flex-wrap:wrap;gap:2px}
.selector-btn{flex:1;min-height:34px;padding:5px 2px;border:2px solid var(--border);background:0;border-radius:6px;color:var(--muted);font-family:'Bebas Neue',sans-serif;font-size:0.85rem;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center}
.selector-btn.level-btn{min-height:28px;min-width:28px;flex:0 0 auto;width:calc(20% - 2px);font-size:0.75rem}
.selector-btn.active{border-color:var(--purple);color:var(--purple);background:rgba(155,89,182,0.1)}
.selector-btn.locked{opacity:0.5}
.selector-btn.locked::after{content:'üîí';position:absolute;top:0;right:2px;font-size:0.4rem}

.progression-display{display:flex;justify-content:center;align-items:center;gap:10px;padding:6px;background:var(--card);border-radius:8px;margin-bottom:4px;flex-shrink:0}
.progression-label{font-family:'Bebas Neue',sans-serif;font-size:0.7rem;color:var(--muted);letter-spacing:1px}
.progression-stars{display:flex;gap:6px}
.progression-star{font-size:1.3rem;opacity:0.25;transition:all 0.3s}
.progression-star.earned{opacity:1;transform:scale(1.15);filter:drop-shadow(0 0 4px var(--purple))}

.court-wrapper{flex:1;display:flex;align-items:center;justify-content:center;min-height:0;overflow:hidden;transition:all 0.3s ease}

.court-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;padding:8px;background-color:#1a1a24;background-image:url('/icon.png');background-size:85%;background-position:center;background-repeat:no-repeat;border-radius:16px;border:3px solid var(--purple);width:min(100%,calc(100dvh - 300px),320px);height:min(100%,calc(100dvh - 300px),320px);min-width:200px;min-height:200px;aspect-ratio:1;position:relative;transition:all 0.3s ease}
.court-grid::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.6);border-radius:13px;pointer-events:none;z-index:0}

.grid-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.2);min-width:32px;min-height:32px;transition:all 0.1s;position:relative;z-index:1}
.grid-cell:active:not(.disabled){transform:scale(0.95)}
.grid-cell.disabled{pointer-events:none}

/* Watch phase ‚Äî purple */
.grid-cell.lit{background:var(--purple)!important;border-color:var(--purple)!important;box-shadow:0 0 25px var(--purple);transform:scale(1.08)}
/* Play target ‚Äî gold */
.grid-cell.target{background:var(--gold)!important;border-color:var(--gold)!important;box-shadow:0 0 28px rgba(255,215,0,0.5);transform:scale(1.08)}
/* Tap results */
.grid-cell.correct{background:var(--teal)!important;border-color:var(--teal)!important;box-shadow:0 0 15px var(--teal)}
.grid-cell.good-tap{background:var(--orange)!important;border-color:var(--orange)!important;box-shadow:0 0 15px var(--orange)}
.grid-cell.missed{background:var(--pink)!important;border-color:var(--pink)!important;box-shadow:0 0 15px var(--pink)}

/* Cell sequence number */
.cell-num{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;color:var(--dark);opacity:0;pointer-events:none;position:relative;z-index:2;transition:opacity 0.08s}
.grid-cell.lit .cell-num{opacity:0.85}
.grid-cell.target .cell-num{opacity:1}
.grid-cell.correct .cell-num,.grid-cell.good-tap .cell-num{opacity:0.7}

.division-display{display:flex;justify-content:space-between;align-items:center;padding:5px 10px;background:var(--card);border-radius:8px;margin:4px 0;flex-shrink:0;min-height:34px}
.division-badge{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:2px;color:var(--purple)}
.lives-display{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--purple);letter-spacing:2px}
.court-grid.beat-pulse{border-color:var(--gold)!important;box-shadow:0 0 15px rgba(255,215,0,0.4)}
.taps-counter{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--teal)}
.score-display{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;color:var(--gold)}

.action-btn{width:100%;min-height:46px;padding:11px;border:none;border-radius:10px;font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:4px;cursor:pointer;background:linear-gradient(135deg,var(--purple),var(--purple-light));color:var(--text);flex-shrink:0;transition:all 0.3s ease}
.action-btn:disabled{opacity:0.5;cursor:not-allowed}

.emoji-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;overflow:hidden}
.burst-emoji{position:absolute;font-size:1.6rem;animation:emojiBurst 1.2s ease-out forwards;pointer-events:none}
@keyframes emojiBurst{0%{opacity:1;transform:translate(-50%,-50%) scale(0.3)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.8) rotate(var(--rot))}}
.burst-emoji.big{font-size:2.2rem}
.burst-emoji.party{font-size:1.8rem;animation-duration:2s}
.court-grid.joy-pulse{animation:joyPulse 0.5s ease-out}
@keyframes joyPulse{0%{box-shadow:0 0 0 0 rgba(155,89,182,0.7)}50%{box-shadow:0 0 25px 8px rgba(155,89,182,0.5)}100%{box-shadow:none}}

.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);display:none;align-items:center;justify-content:center;z-index:1100;padding:20px}
.overlay.show{display:flex}
.overlay-card{background:var(--card);border:2px solid var(--purple);border-radius:14px;padding:20px;text-align:center;max-width:280px;width:100%}
.overlay-emoji{font-size:2.5rem;margin-bottom:8px}
.overlay-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;margin-bottom:6px;color:var(--purple)}
.overlay-message{color:var(--muted);margin-bottom:12px;font-size:0.85rem}
.overlay-btn{min-height:44px;padding:12px 24px;border:none;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px;cursor:pointer;margin:4px;background:linear-gradient(135deg,var(--purple),var(--purple-light));color:var(--text)}
.overlay-btn.secondary{background:0;border:1px solid var(--muted);color:var(--muted)}
.upgrade-speed-preview{display:flex;justify-content:center;gap:5px;margin-bottom:10px}
.upgrade-speed-chip{padding:5px 8px;border-radius:6px;font-family:'Bebas Neue',sans-serif;font-size:0.75rem}
.upgrade-speed-chip.current{background:rgba(155,89,182,0.2);color:var(--purple);border:1px solid var(--purple)}
.upgrade-speed-chip.locked{background:rgba(255,215,0,0.15);color:var(--gold);border:1px solid var(--gold)}
.upgrade-price{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--gold);margin-bottom:4px}
.upgrade-price span{font-size:0.75rem;color:var(--muted)}

.coach-message{position:fixed;bottom:70px;left:50%;transform:translateX(-50%) translateY(100px);background:linear-gradient(135deg,var(--purple),var(--purple-light));color:var(--text);padding:8px 16px;border-radius:14px;font-weight:700;font-size:0.85rem;opacity:0;transition:all 0.3s;z-index:50}
.coach-message.show{transform:translateX(-50%) translateY(0);opacity:1}

body.en .lang-es{display:none!important}
body.es .lang-en{display:none!important}

@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.shake{animation:shake 0.3s ease-out}

@media(min-height:720px){.court-grid{width:min(100%,calc(100dvh - 300px),340px);height:min(100%,calc(100dvh - 300px),340px)}.stat-value{font-size:1.1rem}.message-text{font-size:0.95rem}.selector-btn{min-height:38px}.selector-btn.level-btn{min-height:30px}.action-btn{min-height:50px;font-size:1.35rem}}
@media(max-height:620px){.stat-value{font-size:0.9rem}.message-display{padding:5px;min-height:30px}.message-text{font-size:0.8rem}.selector-btn{min-height:30px;font-size:0.75rem}.selector-btn.level-btn{min-height:24px;font-size:0.65rem}.court-grid{min-width:180px;min-height:180px;width:min(100%,calc(100dvh - 260px),280px);height:min(100%,calc(100dvh - 260px),280px);gap:3px;padding:6px}.grid-cell{min-width:28px;min-height:28px}.division-display{padding:4px 8px;min-height:30px}.action-btn{min-height:42px;font-size:1.1rem}.progression-star{font-size:1.1rem}}
@media(max-height:540px){.nav-row{height:44px}.stats-bar{padding:3px 5px;margin-bottom:3px}.stat-value{font-size:0.8rem}.stat-label{font-size:0.38rem}.message-display{padding:4px;margin-bottom:3px;min-height:26px}.message-text{font-size:0.7rem}.selectors-row{margin-bottom:3px}.selector-group{padding:3px}.selector-label{font-size:0.4rem;margin-bottom:2px}.selector-btn{min-height:26px;font-size:0.65rem}.selector-btn.level-btn{min-height:22px;font-size:0.55rem}.court-grid{min-width:150px;min-height:150px;gap:2px;padding:5px}.grid-cell{min-width:24px;min-height:24px}.division-display{padding:3px 6px;min-height:26px;margin:3px 0}.division-badge,.taps-counter,.lives-display{font-size:0.75rem}.score-display{font-size:0.9rem}.action-btn{min-height:38px;padding:8px;font-size:1rem}.progression-display{padding:4px}.progression-star{font-size:1rem}}
</style>
</head>
<body class="en">

<button class="refresh-btn" id="refreshBtn" title="Reset Round">üîÑ</button>
<button class="focus-btn" id="focusBtn" title="Focus Mode">‚õ∂</button>
<div class="ritnome-badge" id="ritnomeBadge"><div class="pulse-dot" id="ritnomeDot"></div><div class="badge-text"><span class="powered-by">Powered by</span><span class="ritnome-name">RITNOME‚Ñ¢</span></div></div>

<nav class="mini-nav">
<div class="nav-row">
<a href="/dashboard.html" class="back-btn">‚Üê <span class="lang-en">DASHBOARD</span><span class="lang-es">TABLERO</span></a>
<div class="nav-title">THE REACT</div>
<div class="nav-right">
<div class="nav-lang"><button class="nav-lang-btn active" id="btnEn">EN</button><button class="nav-lang-btn" id="btnEs">ES</button></div>
<div class="settings-wrapper"><button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
<div class="settings-dropdown" id="settingsDropdown">
<div class="settings-section"><div class="settings-label">Ritnome‚Ñ¢ BPM</div><div class="speed-status" id="speedStatus"><span class="speed-chip unlocked">‚úì 60</span><span class="speed-chip locked">üîí 90</span><span class="speed-chip locked">üîí 120</span></div></div>
<div class="settings-section" id="upgradeSection"><a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="settings-link upgrade">üöÄ UNLOCK ALL</a></div>
<div class="settings-section"><button class="settings-link logout" id="logoutBtn">‚Üê <span class="lang-en">Log Out</span><span class="lang-es">Salir</span></button></div>
</div></div></div></div>
</nav>

<div class="emoji-container" id="emojiContainer"></div>

<div class="game-container">
<div class="stats-bar">
<div class="stat"><div class="stat-value" id="levelDisplay">1</div><div class="stat-label"><span class="lang-en">Level</span><span class="lang-es">Nivel</span></div></div>
<div class="stat"><div class="stat-value" id="roundDisplay">0</div><div class="stat-label"><span class="lang-en">Round</span><span class="lang-es">Ronda</span></div></div>
<div class="stat"><div class="stat-value" id="streakDisplay">0</div><div class="stat-label">üî•</div></div>
<div class="stat"><div class="stat-value" id="scoreDisplay">0</div><div class="stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
</div>
<div class="message-display"><span class="message-text" id="messageText"><span class="lang-en">Select level & LET'S GO!</span><span class="lang-es">¬°Selecciona nivel y PA'LANTE!</span></span></div>
<div class="selectors-row">
<div class="selector-group level-group"><div class="selector-label"><span class="lang-en">Level</span><span class="lang-es">Nivel</span></div><div class="selector-options level-options">
<button class="selector-btn level-btn active" data-level="1">1</button>
<button class="selector-btn level-btn" data-level="2">2</button>
<button class="selector-btn level-btn" data-level="3">3</button>
<button class="selector-btn level-btn" data-level="4">4</button>
<button class="selector-btn level-btn" data-level="5">5</button>
<button class="selector-btn level-btn" data-level="6">6</button>
<button class="selector-btn level-btn" data-level="7">7</button>
<button class="selector-btn level-btn" data-level="8">8</button>
<button class="selector-btn level-btn" data-level="9">9</button>
<button class="selector-btn level-btn" data-level="10">10</button>
</div></div>
<div class="selector-group"><div class="selector-label">Ritnome‚Ñ¢ BPM</div><div class="selector-options"><button class="selector-btn speed-btn active" data-speed="slow">60</button><button class="selector-btn speed-btn" data-speed="med">90</button><button class="selector-btn speed-btn" data-speed="fast">120</button></div></div>
</div>
<div class="progression-display">
<span class="progression-label"><span class="lang-en">LEVEL UP:</span><span class="lang-es">SUBIR:</span></span>
<div class="progression-stars">
<span class="progression-star" id="star1">‚≠ê</span>
<span class="progression-star" id="star2">‚≠ê</span>
</div>
</div>
<div class="court-wrapper"><div class="court-grid" id="courtGrid"></div></div>
<div class="division-display"><div class="division-badge" id="divisionBadge">L1 TRAINING</div><div class="lives-display" id="livesDisplay">‚ô•‚ô•‚ô•</div><div class="taps-counter" id="tapsCounter">‚ô™ 0/3</div><div class="score-display" id="totalScore">0</div></div>
<button class="action-btn" id="actionBtn"><span class="lang-en">LET'S GO</span><span class="lang-es">PA'LANTE</span></button>
</div>

<div class="overlay" id="levelUpOverlay">
<div class="overlay-card">
<div class="overlay-emoji">‚≠ê</div>
<h2 class="overlay-title"><span class="lang-en">LEVEL UP!</span><span class="lang-es">¬°SUBISTE!</span></h2>
<p class="overlay-message" id="levelUpMessage"></p>
<button class="overlay-btn" id="levelUpBtn"><span class="lang-en">LET'S GO!</span><span class="lang-es">¬°VAMOS!</span></button>
</div>
</div>

<div class="overlay" id="upgradeOverlay">
<div class="overlay-card">
<div class="overlay-emoji">üîì</div>
<h2 class="overlay-title">UNLOCK ALL RITNOME‚Ñ¢</h2>
<div class="upgrade-speed-preview">
<span class="upgrade-speed-chip current">‚úì 60</span>
<span class="upgrade-speed-chip locked">üîí 90</span>
<span class="upgrade-speed-chip locked">üîí 120</span>
</div>
<div class="upgrade-price">$5<span>/mo</span></div>
<p class="overlay-message"><span class="lang-en">Get all BPM speeds + all 5 challenges!</span><span class="lang-es">¬°Obt√©n todas las velocidades + los 5 desaf√≠os!</span></p>
<a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="overlay-btn" style="display:block;text-decoration:none;margin-bottom:6px;">UPGRADE üöÄ</a>
<button class="overlay-btn secondary" id="upgradeClose">CONTINUE 60</button>
</div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function(){
    // ===== FOCUS MODE =====
    var focusBtn = document.getElementById('focusBtn');
    var isFocusMode = localStorage.getItem('lc-focus-mode') === 'true';
    function toggleFocusMode() { isFocusMode = !isFocusMode; localStorage.setItem('lc-focus-mode', isFocusMode); applyFocusMode(); }
    function applyFocusMode() {
        if (isFocusMode) { document.body.classList.add('focus-mode'); focusBtn.classList.add('active'); }
        else { document.body.classList.remove('focus-mode'); focusBtn.classList.remove('active'); }
    }
    focusBtn.onclick = toggleFocusMode;
    applyFocusMode();

    // ===== REFRESH BUTTON =====
    document.getElementById('refreshBtn').onclick = function() {
        clearAllTimers();
        state.phase = 'idle';
        state.isPlaying = false;
        state.awaitingTap = false;
        state.lives = MAX_LIVES;
        if (state.cells.length) state.cells.forEach(function(c) { c.className = 'grid-cell'; c.querySelector('.cell-num').textContent = ''; });
        document.getElementById('levelUpOverlay').classList.remove('show');
        document.getElementById('upgradeOverlay').classList.remove('show');
        actionBtn.disabled = false;
        messageText.innerHTML = '<span class="lang-en">TAP LET\'S GO!</span><span class="lang-es">¬°TOCA PA\'LANTE!</span>';
        messageText.className = 'message-text';
        updateStats(); updateDivisionDisplay(); updateRitnomePulse(state.speed); updateLivesDisplay();
        showCoach('üîÑ Ready!');
    };

    // ===== AUTH CHECK =====
    var host = window.location.hostname;
    var isProduction = host.indexOf('ritnome') > -1 || host.indexOf('laughcourt') > -1 || host.indexOf('github.io') > -1 || host.indexOf('gostardigital') > -1;
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('lc-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) { window.location.replace('/login'); return; }
        var sessionPin = sessionStorage.getItem('lc-pin'), sessionToken = sessionStorage.getItem('lc-token');
        function validateSession() {
            if (!sessionPin || !sessionToken) { window.location.href = '/login'; return; }
            fetch('/api/session/validate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pin: sessionPin, token: sessionToken }) })
            .then(function(r) { return r.json(); })
            .then(function(d) { if (!d.valid) { localStorage.removeItem('lc-user'); localStorage.removeItem('lc-speed-access'); sessionStorage.clear(); window.location.href = '/login'; } })
            .catch(function() {});
        }
        validateSession(); setInterval(validateSession, 30000);
    }

    // ===== SETTINGS DROPDOWN =====
    var settingsBtn = document.getElementById('settingsBtn'), settingsDropdown = document.getElementById('settingsDropdown');
    settingsBtn.onclick = function(e) { e.stopPropagation(); settingsBtn.classList.toggle('open'); settingsDropdown.classList.toggle('show'); };
    document.onclick = function(e) { if (!settingsDropdown.contains(e.target) && e.target !== focusBtn) { settingsBtn.classList.remove('open'); settingsDropdown.classList.remove('show'); } };
    document.getElementById('logoutBtn').onclick = function() {
        var p = sessionStorage.getItem('lc-pin'), t = sessionStorage.getItem('lc-token');
        if (p && t) fetch('/api/session/destroy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pin: p, token: t }) }).catch(function() {});
        localStorage.removeItem('lc-user'); localStorage.removeItem('lc-speed-access'); sessionStorage.clear(); window.location.href = '/login';
    };

    // ===== LANGUAGE =====
    var currentLang = localStorage.getItem('lc-lang') || 'en';
    function setLang(l) {
        currentLang = l; localStorage.setItem('lc-lang', l);
        document.body.className = l + (isFocusMode ? ' focus-mode' : '');
        document.getElementById('btnEn').className = l === 'en' ? 'nav-lang-btn active' : 'nav-lang-btn';
        document.getElementById('btnEs').className = l === 'es' ? 'nav-lang-btn active' : 'nav-lang-btn';
        updateDivisionDisplay();
    }
    document.getElementById('btnEn').onclick = function() { setLang('en'); };
    document.getElementById('btnEs').onclick = function() { setLang('es'); };

    // ===== SPEED ACCESS =====
    var speedAccess = { allSpeeds: false };
    try { var sa = localStorage.getItem('lc-speed-access'); if (sa) speedAccess = JSON.parse(sa); } catch(e) {}
    function updateSpeedStatusUI() {
        var ss = document.getElementById('speedStatus'), us = document.getElementById('upgradeSection');
        if (speedAccess.allSpeeds) { ss.innerHTML = '<span class="speed-chip unlocked">‚úì 60</span><span class="speed-chip unlocked">‚úì 90</span><span class="speed-chip unlocked">‚úì 120</span>'; us.style.display = 'none'; }
        else { ss.innerHTML = '<span class="speed-chip unlocked">‚úì 60</span><span class="speed-chip locked">üîí 90</span><span class="speed-chip locked">üîí 120</span>'; us.style.display = 'block'; }
    }
    function initSpeedButtons() {
        document.querySelectorAll('.speed-btn').forEach(function(b) { if (!speedAccess.allSpeeds && b.dataset.speed !== 'slow') b.classList.add('locked'); else b.classList.remove('locked'); });
        if (!speedAccess.allSpeeds) { state.speed = 'slow'; document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); }); document.querySelector('.speed-btn[data-speed="slow"]').classList.add('active'); }
        updateSpeedStatusUI();
    }
    function showUpgradeModal() { document.getElementById('upgradeOverlay').classList.add('show'); }
    document.getElementById('upgradeClose').onclick = function() { document.getElementById('upgradeOverlay').classList.remove('show'); };

    // ===== GAME CONFIG =====
    var TOTAL_CELLS = 25;
    function getCellCount(level) { return level + 2; }
    function getBeatInterval() { return state.speed === 'fast' ? 500 : state.speed === 'med' ? 667 : 1000; }
    var PERFECT_WINDOW = 300;
    var GOOD_WINDOW = 600;
    var MAX_LIVES = 3;
    var LAUGH_EMOJIS = ['üòÇ','üòÜ','ü§£','üòÑ','üòÅ','ü•≥','üòä','üèÄ'];
    var PARTY_EMOJIS = ['ü•≥','üéâ','üòÇ','ü§£','‚ú®','üí´','üèÄ','üèÜ'];

    // ===== RITNOME PULSE =====
    function updateRitnomePulse(speed) {
        var dot = document.getElementById('ritnomeDot');
        if (!dot) return;
        dot.style.animationDuration = speed === 'fast' ? '500ms' : speed === 'med' ? '667ms' : '1000ms';
    }

    // ===== PER-SPEED STATE =====
    function getSpeedKey(speed, key) { return 'lc-reaction-' + speed + '-' + key; }
    function loadSpeedState(speed) {
        return { level: parseInt(localStorage.getItem(getSpeedKey(speed, 'level'))) || 1, score: parseInt(localStorage.getItem(getSpeedKey(speed, 'score'))) || 0, streak: parseInt(localStorage.getItem(getSpeedKey(speed, 'streak'))) || 0 };
    }
    function saveSpeedState(speed, level, score, streak) {
        localStorage.setItem(getSpeedKey(speed, 'level'), level);
        localStorage.setItem(getSpeedKey(speed, 'score'), score);
        localStorage.setItem(getSpeedKey(speed, 'streak'), streak);
    }

    var currentSpeed = localStorage.getItem('lc-reaction-speed') || 'slow';
    var speedData = loadSpeedState(currentSpeed);

    // ===== STATE =====
    var state = {
        level: Math.min(Math.max(speedData.level, 1), 10),
        speed: currentSpeed,
        score: speedData.score,
        streak: speedData.streak,
        round: 0,
        perfectCount: 0,
        phase: 'idle',
        pattern: [],
        beatIndex: 0,
        watchLoop: 0,
        tapResults: [],
        currentBeatTime: 0,
        currentTargetCell: -1,
        awaitingTap: false,
        tapReceived: false,
        lives: 3,
        playStartTime: 0,
        beatTimers: [],
        missTimer: null,
        isPlaying: false,
        cells: []
    };

    var courtGrid = document.getElementById('courtGrid');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var coachMessage = document.getElementById('coachMessage');
    var emojiContainer = document.getElementById('emojiContainer');

    // ===== AUDIO =====
    var audioCtx = null;
    function getAudioContext() { if (!audioCtx) try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} return audioCtx; }
    function beep(freq, dur, vol, type) {
        var c = getAudioContext(); if (!c) return;
        try { if (c.state === 'suspended') c.resume(); var o = c.createOscillator(), g = c.createGain(); o.type = type || 'sine'; o.frequency.value = freq; o.connect(g); g.connect(c.destination); g.gain.setValueAtTime(vol || 0.15, c.currentTime); g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + (dur || 0.1)); o.start(); o.stop(c.currentTime + (dur || 0.1) + 0.02); } catch(e) {}
    }
    function tickSound() { beep(880, 0.04, 0.12); }
    function watchTickSound() { beep(660, 0.06, 0.1); }
    function perfectSound() { beep(1300, 0.08, 0.15); setTimeout(function(){ beep(1600, 0.06, 0.12); }, 60); }
    function goodSound() { beep(1000, 0.06, 0.1); }
    function failSound() { beep(200, 0.25, 0.15, 'sawtooth'); }
    function levelUpSound() { beep(800, 0.1, 0.12); setTimeout(function(){ beep(1000, 0.1, 0.12); }, 100); setTimeout(function(){ beep(1300, 0.15, 0.15); }, 200); }
    function countdownSound() { beep(440, 0.08, 0.1); }

    // ===== CELEBRATIONS =====
    function getCourtCenter() { var r = courtGrid.getBoundingClientRect(); return { x: r.left + r.width / 2, y: r.top + r.height / 2 }; }
    function createBurstEmoji(e, x, y, t) {
        var el = document.createElement('div'); el.className = 'burst-emoji' + (t ? ' ' + t : ''); el.textContent = e;
        var a = Math.random() * Math.PI * 2, d = 50 + Math.random() * 80;
        el.style.cssText = 'left:' + x + 'px;top:' + y + 'px;--tx:' + Math.cos(a) * d + 'px;--ty:' + Math.sin(a) * d + 'px;--rot:' + (Math.random() - 0.5) * 720 + 'deg';
        emojiContainer.appendChild(el); setTimeout(function() { if (el.parentNode) el.remove(); }, 1500);
    }
    function laughCelebration(intensity) {
        var c = getCourtCenter(); var n = intensity === 'party' ? 8 : intensity === 'big' ? 5 : intensity === 'medium' ? 3 : 2;
        var em = intensity === 'party' ? PARTY_EMOJIS : LAUGH_EMOJIS;
        var t = intensity === 'party' ? 'party' : intensity === 'big' ? 'big' : '';
        for (var j = 0; j < n; j++) { (function(idx) { setTimeout(function() { createBurstEmoji(em[Math.floor(Math.random() * em.length)], c.x + (Math.random() - 0.5) * 20, c.y + (Math.random() - 0.5) * 20, t); }, idx * 35); })(j); }
        courtGrid.classList.add('joy-pulse'); setTimeout(function() { courtGrid.classList.remove('joy-pulse'); }, 500);
    }
    function showCoach(m) { coachMessage.textContent = m; coachMessage.classList.add('show'); setTimeout(function() { coachMessage.classList.remove('show'); }, 2000); }

    // ===== INIT COURT =====
    function initCourt() {
        courtGrid.innerHTML = ''; state.cells = [];
        for (var i = 0; i < TOTAL_CELLS; i++) {
            var cell = document.createElement('div'); cell.className = 'grid-cell'; cell.dataset.index = i;
            var num = document.createElement('span'); num.className = 'cell-num'; cell.appendChild(num);
            cell.onclick = (function(idx) { return function() { handleCellTap(idx); }; })(i);
            courtGrid.appendChild(cell); state.cells.push(cell);
        }
    }

    // ===== UI UPDATES =====
    function updateDivisionDisplay() {
        var sp = state.speed === 'slow' ? 'TRAINING' : state.speed === 'med' ? 'TEMPO' : 'ELITE';
        document.getElementById('divisionBadge').textContent = 'L' + state.level + ' ' + sp;
        updateTapsCounter();
    }
    function updateTapsCounter() {
        var needed = getCellCount(state.level);
        var completed = state.tapResults ? state.tapResults.length : 0;
        document.getElementById('tapsCounter').textContent = '‚ô™ ' + completed + '/' + needed;
    }
    function updateStats() {
        document.getElementById('levelDisplay').textContent = state.level;
        document.getElementById('roundDisplay').textContent = state.round;
        document.getElementById('streakDisplay').textContent = state.streak;
        document.getElementById('scoreDisplay').textContent = state.score;
        document.getElementById('totalScore').textContent = state.score;
    }
    function updateProgressionStars() {
        document.getElementById('star1').className = state.perfectCount >= 1 ? 'progression-star earned' : 'progression-star';
        document.getElementById('star2').className = state.perfectCount >= 2 ? 'progression-star earned' : 'progression-star';
    }
    function updateLivesDisplay() {
        var el = document.getElementById('livesDisplay');
        if (!el) return;
        var hearts = '';
        for (var i = 0; i < MAX_LIVES; i++) hearts += i < state.lives ? '‚ô•' : '‚ô°';
        el.textContent = hearts;
        el.style.color = state.lives <= 1 ? 'var(--pink)' : 'var(--purple)';
    }

    // ===== TIMER MANAGEMENT =====
    function clearAllTimers() {
        state.beatTimers.forEach(function(t) { clearTimeout(t); }); state.beatTimers = [];
        if (state.missTimer) { clearTimeout(state.missTimer); state.missTimer = null; }
    }
    function clearAllCells() {
        state.cells.forEach(function(c) { c.className = 'grid-cell'; c.querySelector('.cell-num').textContent = ''; });
    }

    // ===== PATTERN GENERATION =====
    function generatePattern() {
        var len = getCellCount(state.level); var indices = [];
        while (indices.length < len) { var idx = Math.floor(Math.random() * TOTAL_CELLS); if (indices.indexOf(idx) === -1) indices.push(idx); }
        return indices;
    }

    // ===== PHASE: WATCH =====
    function startWatch() {
        state.phase = 'watching'; state.beatIndex = 0; state.watchLoop = 0;
        clearAllCells();
        messageText.innerHTML = '<span class="lang-en">üëÅÔ∏è WATCH THE PATTERN</span><span class="lang-es">üëÅÔ∏è OBSERVA EL PATR√ìN</span>';
        messageText.className = 'message-text ready';
        state.tapResults = [];
        updateTapsCounter();
        state.beatTimers.push(setTimeout(runWatchBeat, 600));
    }

    function runWatchBeat() {
        if (state.phase !== 'watching') return;
        var interval = getBeatInterval();
        var patIdx = state.beatIndex;
        var cellIdx = state.pattern[patIdx];

        clearAllCells();
        state.cells[cellIdx].classList.add('lit');
        state.cells[cellIdx].querySelector('.cell-num').textContent = patIdx + 1;
        watchTickSound();

        // Dim after 55% of beat
        state.beatTimers.push(setTimeout(function() { if (state.cells[cellIdx]) { state.cells[cellIdx].classList.remove('lit'); state.cells[cellIdx].querySelector('.cell-num').textContent = ''; } }, interval * 0.55));

        state.beatIndex++;

        if (state.beatIndex >= state.pattern.length) {
            state.beatIndex = 0; state.watchLoop++;
            if (state.watchLoop >= 3) {
                state.beatTimers.push(setTimeout(function() { clearAllCells(); startCountdown(); }, interval));
                return;
            }
            // Pause between loops
            var loopMsg = state.watchLoop === 1
                ? '<span class="lang-en">üëÅÔ∏è AGAIN...</span><span class="lang-es">üëÅÔ∏è OTRA VEZ...</span>'
                : '<span class="lang-en">üëÅÔ∏è LAST TIME...</span><span class="lang-es">üëÅÔ∏è √öLTIMA VEZ...</span>';
            state.beatTimers.push(setTimeout(function() {
                messageText.innerHTML = loopMsg;
                state.beatTimers.push(setTimeout(runWatchBeat, 500));
            }, interval));
            return;
        }
        state.beatTimers.push(setTimeout(runWatchBeat, interval));
    }

    // ===== PHASE: COUNTDOWN =====
    function startCountdown() {
        state.phase = 'countdown';
        clearAllCells();
        var interval = getBeatInterval();
        var counts = ['3', '2', '1'];
        var i = 0;

        function doCount() {
            if (state.phase !== 'countdown') return;
            messageText.textContent = counts[i];
            messageText.className = 'message-text countdown';
            countdownSound();
            i++;
            if (i < counts.length) { state.beatTimers.push(setTimeout(doCount, interval)); }
            else {
                state.beatTimers.push(setTimeout(function() {
                    messageText.innerHTML = '<span class="lang-en">üèÄ TAP THE PATTERN</span><span class="lang-es">üèÄ TOCA EL PATR√ìN</span>';
                    messageText.className = 'message-text go';
                    tickSound();
                    state.beatTimers.push(setTimeout(startPlay, 300));
                }, interval));
            }
        }
        doCount();
    }

    // ===== PHASE: PLAY =====
    function startPlay() {
        state.phase = 'playing';
        state.beatIndex = 0;
        state.tapResults = [];
        state.lives = MAX_LIVES;
        state.playStartTime = performance.now();
        clearAllCells();
        updateTapsCounter();
        updateLivesDisplay();
        schedulePlayBeat(0);
    }

    function schedulePlayBeat(beatIdx) {
        if (beatIdx >= state.pattern.length) return;
        var interval = getBeatInterval();
        var beatTime = state.playStartTime + (beatIdx * interval);
        var delay = beatTime - performance.now();
        state.beatTimers.push(setTimeout(function() { firePlayBeat(beatIdx, performance.now()); }, Math.max(delay, 0)));
    }

    function firePlayBeat(beatIdx, actualTime) {
        if (state.phase !== 'playing') return;
        var interval = getBeatInterval();
        var cellIdx = state.pattern[beatIdx];

        // Clear previous cells (keep result colors briefly)
        state.cells.forEach(function(c) {
            if (c.classList.contains('target')) { c.classList.remove('target'); c.querySelector('.cell-num').textContent = ''; }
        });

        // Light up target
        state.cells[cellIdx].classList.add('target');
        state.cells[cellIdx].querySelector('.cell-num').textContent = beatIdx + 1;
        tickSound();

        // Beat pulse on grid
        courtGrid.classList.add('beat-pulse');
        state.beatTimers.push(setTimeout(function() { courtGrid.classList.remove('beat-pulse'); }, 150));

        state.beatIndex = beatIdx;
        state.awaitingTap = true;
        state.tapReceived = false;
        state.currentBeatTime = actualTime;
        state.currentTargetCell = cellIdx;

        // Dim target after 55% of beat
        state.beatTimers.push(setTimeout(function() {
            if (state.cells[cellIdx].classList.contains('target')) {
                state.cells[cellIdx].classList.remove('target');
                state.cells[cellIdx].querySelector('.cell-num').textContent = '';
            }
        }, interval * 0.55));

        // Miss deadline: 95% of beat interval
        state.missTimer = setTimeout(function() {
            if (state.phase === 'playing' && !state.tapReceived && state.beatIndex === beatIdx) {
                state.awaitingTap = false;
                state.lives--;
                state.cells[cellIdx].classList.add('missed');
                failSound();
                updateLivesDisplay();
                if (state.lives <= 0) {
                    courtGrid.classList.add('shake'); setTimeout(function() { courtGrid.classList.remove('shake'); }, 300);
                    var isEs = currentLang === 'es';
                    endRound(false, isEs ? 'SIN VIDAS' : 'OUT OF LIVES');
                } else {
                    state.tapResults.push('miss');
                    updateTapsCounter();
                    var isEs = currentLang === 'es';
                    messageText.innerHTML = isEs ? 'üí® ¬°SIGUE!' : 'üí® KEEP GOING!';
                    messageText.className = 'message-text miss';
                }
            }
        }, interval * 0.95);

        // Schedule next beat
        schedulePlayBeat(beatIdx + 1);
    }

    // ===== TAP HANDLER =====
    function handleCellTap(index) {
        getAudioContext(); // init on gesture
        if (state.phase !== 'playing' || !state.awaitingTap || state.tapReceived) return;

        state.tapReceived = true;
        if (state.missTimer) { clearTimeout(state.missTimer); state.missTimer = null; }

        var expected = state.currentTargetCell;
        var delta = performance.now() - state.currentBeatTime;
        var beatIdx = state.beatIndex;
        var isEs = currentLang === 'es';

        if (index !== expected) {
            state.lives--;
            state.cells[index].classList.add('missed');
            failSound();
            updateLivesDisplay();
            if (state.lives <= 0) {
                courtGrid.classList.add('shake'); setTimeout(function() { courtGrid.classList.remove('shake'); }, 300);
                endRound(false, isEs ? 'SIN VIDAS' : 'OUT OF LIVES');
            } else {
                // Wrong cell but still alive - mark as miss, continue
                state.tapResults.push('miss');
                state.awaitingTap = false;
                updateTapsCounter();
                messageText.innerHTML = isEs ? '‚ùå CELDA INCORRECTA' : '‚ùå WRONG CELL';
                messageText.className = 'message-text miss';
            }
            return;
        }

        // Correct cell ‚Äî score timing
        var rating, points;
        if (delta <= PERFECT_WINDOW) { rating = 'perfect'; points = 20; }
        else if (delta <= GOOD_WINDOW) { rating = 'good'; points = 12; }
        else { rating = 'good'; points = 5; } // late = still good visually

        state.cells[index].classList.remove('target');
        state.cells[index].classList.add(rating === 'perfect' ? 'correct' : 'good-tap');
        state.cells[index].querySelector('.cell-num').textContent = '';
        state.tapResults.push(rating);
        state.score += points;
        updateTapsCounter(); updateStats();
        saveSpeedState(state.speed, state.level, state.score, state.streak);

        // Timing feedback
        if (rating === 'perfect') {
            perfectSound();
            messageText.innerHTML = isEs ? '‚ú® ¬°PERFECTO!' : '‚ú® PERFECT!';
            messageText.className = 'message-text perfect';
        } else {
            goodSound();
            messageText.innerHTML = isEs ? 'üëç ¬°BIEN!' : 'üëç GOOD!';
            messageText.className = 'message-text good';
        }

        // Mid-round celebrations
        if (state.tapResults.length % 4 === 0) laughCelebration('small');

        state.awaitingTap = false;

        // Check if pattern complete
        if (beatIdx >= state.pattern.length - 1) {
            setTimeout(function() { endRound(true); }, 250);
        }
    }

    // ===== END ROUND =====
    function endRound(won, reason) {
        state.phase = 'idle';
        clearAllTimers();

        if (won) {
            state.perfectCount++;
            state.streak++;
            saveSpeedState(state.speed, state.level, state.score, state.streak);
            updateProgressionStars(); updateStats();

            var allPerfect = state.tapResults.every(function(r) { return r === 'perfect'; });
            var intensity = allPerfect ? 'party' : state.streak >= 5 ? 'big' : 'medium';
            laughCelebration(intensity);

            var isEs = currentLang === 'es';
            if (allPerfect) {
                messageText.innerHTML = isEs ? 'üî• ¬°PERFECCI√ìN TOTAL!' : 'üî• ALL PERFECT!';
                showCoach(isEs ? 'üèÄ ¬°M√°quina!' : 'üèÄ Locked in!');
            } else {
                messageText.innerHTML = isEs ? 'üî• ¬°CONECTADO!' : 'üî• LOCKED IN!';
                showCoach(state.streak >= 3 ? 'üî• On fire!' : 'üèÄ Nice!');
            }
            messageText.className = 'message-text perfect';

            // Check level up
            setTimeout(function() {
                if (state.perfectCount >= 2) {
                    if (state.level < 10) { levelUp(); }
                    else { showCoach('üëë MAX LEVEL!'); state.perfectCount = 0; updateProgressionStars(); finishRound(); }
                } else { finishRound(); }
            }, 1200);
        } else {
            state.perfectCount = 0;
            state.streak = 0;
            saveSpeedState(state.speed, state.level, state.score, state.streak);
            updateProgressionStars(); updateStats();

            var isEs = currentLang === 'es';
            messageText.innerHTML = '<span style="color:var(--pink)">' + (reason || (isEs ? 'FUERA DE RITMO' : 'OFF THE BEAT')) + '</span>';
            messageText.className = 'message-text miss';
            showCoach(isEs ? 'üí™ ¬°Otra vez!' : 'üí™ Try again!');

            setTimeout(finishRound, 1500);
        }
    }

    // ===== LEVEL UP =====
    function levelUp() {
        state.level++;
        state.perfectCount = 0;
        saveSpeedState(state.speed, state.level, state.score, state.streak);
        document.querySelectorAll('.level-btn').forEach(function(b) { b.classList.toggle('active', parseInt(b.dataset.level) === state.level); });
        updateProgressionStars();
        laughCelebration('party');
        levelUpSound();
        document.getElementById('levelUpMessage').innerHTML = currentLang === 'es'
            ? '¬°Ahora est√°s en Nivel ' + state.level + '!<br>Patr√≥n: ' + getCellCount(state.level) + ' celdas'
            : 'You are now Level ' + state.level + '!<br>Pattern: ' + getCellCount(state.level) + ' cells';
        document.getElementById('levelUpOverlay').classList.add('show');
        updateDivisionDisplay(); updateStats();
    }
    document.getElementById('levelUpBtn').onclick = function() { document.getElementById('levelUpOverlay').classList.remove('show'); finishRound(); };

    // ===== FINISH ROUND =====
    function finishRound() {
        state.isPlaying = false; state.currentTargetCell = -1;
        state.lives = MAX_LIVES;
        clearAllCells();
        updateLivesDisplay();
        messageText.innerHTML = '<span class="lang-en">TAP LET\'S GO!</span><span class="lang-es">¬°TOCA PA\'LANTE!</span>';
        messageText.className = 'message-text';
        actionBtn.disabled = false;
        updateTapsCounter();
    }

    // ===== START ROUND =====
    function startRound() {
        if (state.isPlaying) return;
        getAudioContext();
        state.isPlaying = true;
        state.round++;
        state.pattern = generatePattern();
        state.tapResults = [];
        actionBtn.disabled = true;
        updateStats(); updateDivisionDisplay();
        clearAllCells();

        // Brief "get ready" then start watching
        messageText.innerHTML = '<span class="lang-en">GET READY...</span><span class="lang-es">PREP√ÅRATE...</span>';
        messageText.className = 'message-text ready';
        state.beatTimers.push(setTimeout(startWatch, 600));
    }

    // ===== SELECTORS =====
    document.querySelectorAll('.level-btn').forEach(function(b) {
        b.onclick = function() {
            if (state.isPlaying) return;
            document.querySelectorAll('.level-btn').forEach(function(x) { x.classList.remove('active'); });
            b.classList.add('active');
            state.level = parseInt(b.dataset.level);
            state.perfectCount = 0; state.round = 0;
            saveSpeedState(state.speed, state.level, state.score, state.streak);
            updateProgressionStars(); updateStats(); updateDivisionDisplay();
        };
    });

    document.querySelectorAll('.speed-btn').forEach(function(b) {
        b.onclick = function() {
            if (state.isPlaying) return;
            if (!speedAccess.allSpeeds && b.dataset.speed !== 'slow') { showUpgradeModal(); return; }
            document.querySelectorAll('.speed-btn').forEach(function(x) { x.classList.remove('active'); });
            b.classList.add('active');
            state.speed = b.dataset.speed;
            updateRitnomePulse(state.speed);
            localStorage.setItem('lc-reaction-speed', state.speed);
            var speedData = loadSpeedState(state.speed);
            state.level = speedData.level; state.score = speedData.score; state.streak = speedData.streak;
            document.querySelectorAll('.level-btn').forEach(function(lb) { lb.classList.toggle('active', parseInt(lb.dataset.level) === state.level); });
            state.perfectCount = 0; state.round = 0;
            updateProgressionStars(); updateStats(); updateDivisionDisplay();
        };
    });

    actionBtn.onclick = startRound;

    // ===== INIT =====
    initCourt(); initSpeedButtons(); setLang(currentLang);
    updateDivisionDisplay(); updateStats(); updateProgressionStars(); updateLivesDisplay();
    document.querySelectorAll('.level-btn').forEach(function(b) { b.classList.toggle('active', parseInt(b.dataset.level) === state.level); });
    document.querySelectorAll('.speed-btn').forEach(function(b) { if (!b.classList.contains('locked')) b.classList.toggle('active', b.dataset.speed === state.speed); });
    updateRitnomePulse(state.speed);

    if (isProduction) {
        var pin = sessionStorage.getItem('lc-pin');
        if (pin) { fetch('/api/user/speed-access/' + pin).then(function(r) { return r.json(); }).then(function(d) { speedAccess = d; localStorage.setItem('lc-speed-access', JSON.stringify(d)); initSpeedButtons(); }).catch(function() {}); }
    }
})();
</script>
</body>
</html>
