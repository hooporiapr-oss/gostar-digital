<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Laughleticoâ„¢ - LAUGH 5: Laugh Track</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;overflow-y:scroll}
:root{--purple:#6B21A8;--purple-dark:#581C87;--purple-light:#9333EA;--gold:#FFD700;--gold-dark:#CC9900;--bg-dark:#0a0a0f;--bg-card:#111118;--text-light:#FFFFFF;--text-muted:#8892a0;--success:#00D9A5;--danger:#FF4757;--teal:#00D9A5}
body{font-family:'Outfit',sans-serif;background:var(--bg-dark);color:var(--text-light);min-height:100%}
body[data-lang="es"] .lang-en{display:none!important}
body[data-lang="en"] .lang-es{display:none!important}
.court-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center top,rgba(107,33,168,0.2) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(255,215,0,0.1) 0%,transparent 40%),var(--bg-dark);z-index:-1}
.top-controls{position:fixed;top:0;left:0;right:0;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;z-index:100;background:linear-gradient(180deg,rgba(10,10,15,0.95) 0%,transparent 100%)}
.back-link{padding:8px 16px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:20px;color:var(--text-muted);text-decoration:none;font-weight:600;font-size:0.85rem;cursor:pointer}
.back-link:hover{border-color:var(--gold);color:var(--gold)}
.lang-toggle{display:flex;gap:6px}
.lang-btn{padding:6px 12px;border:2px solid var(--gold);background:transparent;color:var(--gold);border-radius:15px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer;transition:all 0.3s}
.lang-btn.active{background:var(--gold);color:var(--bg-dark)}
.screen{display:none;flex-direction:column;align-items:center;min-height:100vh;width:100%;padding:80px 20px 40px 20px;text-align:center}
.screen.active{display:flex}
.main-logo{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:3px;margin-bottom:5px}
.main-logo .laugh{color:var(--gold)}
.main-logo .letico{color:var(--text-light)}
.main-subtitle{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:4px;color:var(--purple-light);margin-bottom:5px}
.main-icon{font-size:3.5rem;margin:15px 0}
.mastery-badge{background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);padding:10px 20px;border-radius:25px;font-weight:800;font-size:0.85rem;margin-bottom:20px;display:inline-block}
.mastery-quote{max-width:340px;padding:18px;background:rgba(107,33,168,0.1);border-left:4px solid var(--purple);border-radius:0 15px 15px 0;margin-bottom:25px}
.mastery-quote-text{font-style:italic;color:var(--text-light);font-size:0.95rem;line-height:1.5;margin-bottom:8px}
.mastery-quote-attr{font-size:0.8rem;color:var(--gold);font-weight:700}
.tier-section{width:100%;max-width:380px;margin-bottom:20px}
.section-label{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:12px}
.tier-grid{display:flex;flex-direction:column;gap:6px;max-height:280px;overflow-y:auto;padding-right:5px}
.tier-grid::-webkit-scrollbar{width:4px}
.tier-grid::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:2px}
.tier-grid::-webkit-scrollbar-thumb{background:var(--purple);border-radius:2px}
.tier-btn{display:flex;align-items:center;gap:12px;padding:12px 15px;background:var(--bg-card);border:2px solid transparent;border-radius:10px;cursor:pointer;transition:all 0.3s ease;text-align:left}
.tier-btn:hover:not(.locked){border-color:var(--gold);transform:translateX(5px)}
.tier-btn.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.tier-btn.locked{opacity:0.4;cursor:not-allowed}
.tier-btn.mastered{border-color:var(--success);background:rgba(0,217,165,0.08)}
.tier-btn.practice{border-color:var(--purple);background:rgba(107,33,168,0.15)}
.tier-btn.practice.selected{border-color:var(--gold);background:rgba(255,215,0,0.15)}
.tier-icon{font-size:1.5rem;min-width:40px;text-align:center}
.tier-info{flex:1}
.tier-name{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--text-light)}
.tier-desc{font-size:0.7rem;color:var(--text-muted)}
.tier-status{font-size:0.65rem;padding:3px 8px;border-radius:8px;font-weight:700}
.tier-status.mastered{background:var(--success);color:var(--bg-dark)}
.tier-status.locked{background:rgba(255,255,255,0.1);color:var(--text-muted)}
.tier-status.current{background:var(--gold);color:var(--bg-dark)}
.tier-status.practice{background:var(--purple);color:var(--text-light)}
.rhythm-section{width:100%;max-width:380px;margin-bottom:20px}
.rhythm-grid{display:flex;gap:8px;justify-content:center}
.rhythm-btn{padding:10px 14px;background:var(--bg-card);border:2px solid transparent;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:85px;transition:all 0.3s}
.rhythm-btn:hover{border-color:var(--gold)}
.rhythm-btn.selected{border-color:var(--gold);background:rgba(255,215,0,0.1)}
.rhythm-icon{font-size:1.3rem}
.rhythm-label{font-size:0.75rem;font-weight:700;color:var(--text-light)}
.rhythm-bpm{font-size:0.65rem;color:var(--text-muted)}
.start-btn{padding:16px 45px;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:4px;background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;box-shadow:0 5px 25px rgba(255,215,0,0.4);transition:all 0.3s}
.start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(255,215,0,0.5)}
.stats-summary{margin-top:20px;padding:12px 20px;background:var(--bg-card);border-radius:12px;display:flex;gap:25px}
.stat-item{text-align:center}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--gold)}
.stat-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
#countdownScreen{justify-content:center}
.countdown-tier{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:10px}
.countdown-number{font-family:'Bebas Neue',sans-serif;font-size:7rem;color:var(--gold);text-shadow:0 0 50px rgba(255,215,0,0.5)}
.countdown-text{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:5px;color:var(--text-muted)}
#gameScreen{justify-content:flex-start;padding-top:70px}
.scoreboard{width:100%;max-width:380px;background:linear-gradient(180deg,#0a0a0a 0%,#050505 100%);border:3px solid #222;border-radius:12px;padding:12px 18px;margin-bottom:12px}
.scoreboard-main{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.scoreboard-tier{font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px;color:var(--text-muted);padding:4px 10px;background:rgba(255,255,255,0.05);border-radius:8px}
.scoreboard-score{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,0.4)}
.half-display{display:flex;justify-content:center;gap:10px;margin-bottom:8px}
.half-indicator{padding:6px 16px;border-radius:15px;font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:2px}
.half-indicator.active{background:var(--purple);color:var(--text-light)}
.half-indicator.inactive{background:rgba(255,255,255,0.05);color:var(--text-muted)}
.half-indicator.completed{background:var(--success);color:var(--bg-dark)}
.accuracy-display{text-align:center;margin-bottom:8px}
.accuracy-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:3px}
.accuracy-value{font-family:'Bebas Neue',sans-serif;font-size:1.6rem}
.accuracy-value.perfect{color:var(--success)}
.accuracy-value.good{color:var(--gold)}
.accuracy-value.miss{color:var(--danger)}
.message-area{height:40px;display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.game-message{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--text-light)}
.game-message.success{color:var(--success)}
.game-message.error{color:var(--danger)}
.court{position:relative;width:min(90vw,340px);height:min(90vw,340px);background:linear-gradient(145deg,rgba(107,33,168,0.3) 0%,rgba(88,28,135,0.4) 50%,rgba(107,33,168,0.3) 100%);border-radius:20px;border:4px solid var(--purple);overflow:hidden;box-shadow:inset 0 0 60px rgba(0,0,0,0.4),0 15px 50px rgba(107,33,168,0.4)}
.court-markings{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
.court-center-line{position:absolute;top:0;left:50%;width:3px;height:100%;background:rgba(255,215,0,0.2);transform:translateX(-50%)}
.court-center-circle{position:absolute;top:50%;left:50%;width:60px;height:60px;border:3px solid rgba(255,215,0,0.2);border-radius:50%;transform:translate(-50%,-50%)}
.trail-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}
.ball-container{position:absolute;top:0;left:0;right:0;bottom:0;z-index:10}
.ball{position:absolute;width:48px;height:48px;transform:translate(-50%,-50%);cursor:pointer;font-size:40px;display:flex;align-items:center;justify-content:center;transition:transform 0.15s ease,filter 0.15s ease;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
.ball:active{transform:translate(-50%,-50%) scale(0.9)}
.ball.lit{filter:drop-shadow(0 0 25px #FFD700) brightness(1.3);transform:translate(-50%,-50%) scale(1.25);z-index:20}
.ball.completed{filter:brightness(1.5) drop-shadow(0 0 15px #00D9A5);pointer-events:none}
.ball.error{filter:brightness(1.2) hue-rotate(-30deg) drop-shadow(0 0 15px #FF4757);animation:shake 0.3s ease}
.ball.disabled{pointer-events:none;opacity:0.6}
@keyframes shake{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(calc(-50% - 5px),-50%)}75%{transform:translate(calc(-50% + 5px),-50%)}}
#resultScreen{justify-content:center}
.result-icon{font-size:4.5rem;margin-bottom:12px}
.result-title{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:4px;margin-bottom:8px}
.result-title.success{color:var(--success)}
.result-title.retry{color:var(--gold)}
.result-message{font-size:1rem;color:var(--text-muted);margin-bottom:20px;max-width:300px;line-height:1.5}
.result-stats{display:flex;gap:20px;margin-bottom:20px}
.result-stat{text-align:center}
.result-stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--text-light)}
.result-stat-label{font-size:0.7rem;color:var(--text-muted)}
.result-accuracy{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;margin-bottom:8px}
.result-accuracy.perfect{color:var(--success)}
.result-accuracy.miss{color:var(--danger)}
.next-level-preview{background:var(--bg-card);border:2px solid var(--success);border-radius:12px;padding:16px;margin-bottom:20px;max-width:300px}
.next-level-label{font-size:0.75rem;color:var(--success);margin-bottom:6px}
.next-level-name{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--text-light)}
.squad-welcome{background:linear-gradient(135deg,var(--gold) 0%,var(--purple) 100%);border-radius:12px;padding:16px;margin-bottom:20px;max-width:300px}
.squad-welcome-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--bg-dark);margin-bottom:5px}
.squad-welcome-text{font-size:0.85rem;color:var(--bg-dark)}
.continue-timer{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--text-muted);margin-bottom:18px}
.continue-timer span{color:var(--gold);font-size:1.4rem}
.action-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:260px}
.continue-btn{padding:14px 35px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;transition:all 0.3s}
.continue-btn:hover{transform:scale(1.05)}
.retry-btn{padding:14px 35px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:3px;background:linear-gradient(135deg,var(--gold) 0%,var(--gold-dark) 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer;transition:all 0.3s}
.retry-btn:hover{transform:scale(1.05)}
.home-btn{padding:12px 35px;font-family:'Outfit',sans-serif;font-size:0.9rem;font-weight:700;background:transparent;color:var(--text-muted);border:2px solid rgba(255,255,255,0.15);border-radius:50px;cursor:pointer;transition:all 0.3s}
.home-btn:hover{border-color:var(--gold);color:var(--gold)}
.rhythm-badge{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);border:2px solid var(--purple);border-radius:20px;padding:6px 14px;display:none;align-items:center;gap:6px;z-index:100}
.rhythm-badge.visible{display:flex}
.rhythm-badge-text{font-size:0.65rem;color:var(--gold);font-weight:700;letter-spacing:1px}

/* Laugh Counter */
.laugh-counter{position:fixed;top:70px;right:20px;background:rgba(0,0,0,0.8);border:2px solid var(--gold);border-radius:20px;padding:8px 14px;display:flex;align-items:center;gap:8px;z-index:90}
.laugh-counter-icon{font-size:1.2rem}
.laugh-counter-value{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--gold)}

/* Coach GoTrotter AI */
.coach-bubble{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:2px solid var(--teal);border-radius:20px;padding:12px 20px;display:none;align-items:center;gap:10px;z-index:150;max-width:320px;box-shadow:0 10px 40px rgba(0,217,165,0.3);animation:coachIn 0.3s ease}
.coach-bubble.visible{display:flex}
.coach-bubble-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0}
.coach-bubble-text{font-size:0.9rem;color:var(--text-light);line-height:1.4}
.coach-bubble-text strong{color:var(--teal)}
@keyframes coachIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

.chat-fab{position:fixed;bottom:30px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--purple-dark));border:3px solid var(--gold);cursor:pointer;box-shadow:0 6px 25px rgba(107,33,168,0.5);z-index:200;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
.chat-fab:hover{transform:scale(1.1)}
.chat-fab img{width:38px;height:38px;border-radius:50%}

@media(max-width:380px){.main-logo{font-size:2rem}.court{width:min(88vw,300px);height:min(88vw,300px)}.ball{width:42px;height:42px;font-size:36px}.coach-bubble{max-width:280px;bottom:90px}.chat-fab{width:50px;height:50px;bottom:20px;right:15px}.chat-fab img{width:32px;height:32px}.laugh-counter{top:65px;right:15px;padding:6px 10px}.laugh-counter-value{font-size:1rem}}
</style>
</head>
<body data-lang="en">
<div class="court-bg"></div>
<div class="top-controls">
<a class="back-link" href="laugh-hub.html"><span class="lang-en">â† Circuits</span><span class="lang-es">â† Circuitos</span></a>
<div class="lang-toggle">
<button class="lang-btn active" onclick="setLang('en')">EN</button>
<button class="lang-btn" onclick="setLang('es')">ES</button>
</div>
</div>

<!-- Laugh Counter -->
<div class="laugh-counter" id="laughCounter" style="display:none">
<span class="laugh-counter-icon">ğŸ˜‚</span>
<span class="laugh-counter-value" id="laughCounterValue">0</span>
</div>

<div class="screen active" id="welcomeScreen">
<div class="main-logo"><span class="laugh">LAUGH</span><span class="letico">LETICO</span>â„¢</div>
<div class="main-subtitle"><span class="lang-en">LAUGH 5 â€¢ LAUGH TRACK</span><span class="lang-es">RISA 5 â€¢ PISTA DE RISA</span></div>
<div class="main-icon">ğŸ˜‚</div>
<div class="mastery-badge"><span class="lang-en">ğŸ¯ 100% ACCURACY TO ADVANCE</span><span class="lang-es">ğŸ¯ 100% PARA AVANZAR</span></div>
<div class="mastery-quote">
<div class="mastery-quote-text"><span class="lang-en">"Follow the laughs until you can't get it wrong. That's joy mastery!"</span><span class="lang-es">"Sigue las risas hasta que no puedas fallar. Â¡Eso es maestrÃ­a de alegrÃ­a!"</span></div>
<div class="mastery-quote-attr">â€” Coach GoTrotter AI ğŸ˜‚</div>
</div>

<div class="tier-section">
<div class="section-label"><span class="lang-en">SELECT YOUR TIER</span><span class="lang-es">ESCOGE TU NIVEL</span></div>
<div class="tier-grid" id="tierGrid"></div>
</div>

<div class="rhythm-section">
<div class="section-label"><span class="lang-en">RHYTHM</span><span class="lang-es">RITMO</span></div>
<div class="rhythm-grid">
<div class="rhythm-btn" data-rhythm="steady" onclick="selectRhythm('steady')"><span class="rhythm-icon">ğŸ¢</span><span class="rhythm-label"><span class="lang-en">Gentle</span><span class="lang-es">Suave</span></span><span class="rhythm-bpm">90 BPM</span></div>
<div class="rhythm-btn selected" data-rhythm="showtime" onclick="selectRhythm('showtime')"><span class="rhythm-icon">ğŸ˜Š</span><span class="rhythm-label"><span class="lang-en">Happy</span><span class="lang-es">Feliz</span></span><span class="rhythm-bpm">127 BPM</span></div>
<div class="rhythm-btn" data-rhythm="master" onclick="selectRhythm('master')"><span class="rhythm-icon">ğŸ”¥</span><span class="rhythm-label"><span class="lang-en">Hyper</span><span class="lang-es">Hiper</span></span><span class="rhythm-bpm">150 BPM</span></div>
</div>
</div>

<button class="start-btn" onclick="startGame()"><span class="lang-en">START LAUGHING!</span><span class="lang-es">Â¡A REÃR!</span></button>

<div class="stats-summary">
<div class="stat-item"><div class="stat-value" id="currentTier">1</div><div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Nivel</span></div></div>
<div class="stat-item"><div class="stat-value" id="perfectGames">0</div><div class="stat-label"><span class="lang-en">Perfect</span><span class="lang-es">Perfectos</span></div></div>
<div class="stat-item"><div class="stat-value" id="bestScore">0</div><div class="stat-label"><span class="lang-en">Best</span><span class="lang-es">Mejor</span></div></div>
</div>
</div>

<div class="screen" id="countdownScreen">
<div class="countdown-tier" id="countdownTier">TIER 1</div>
<div class="main-icon">ğŸ˜‚</div>
<div class="countdown-number" id="countdownNum">3</div>
<div class="countdown-text"><span class="lang-en">GET READY TO LAUGH!</span><span class="lang-es">Â¡PREPÃRATE PARA REÃR!</span></div>
</div>

<div class="screen" id="gameScreen">
<div class="scoreboard">
<div class="scoreboard-main">
<div class="scoreboard-tier" id="gameTier">TIER 1</div>
<div class="scoreboard-score" id="scoreDisplay">0</div>
</div>
<div class="half-display">
<div class="half-indicator active" id="half1"><span class="lang-en">1ST HALF</span><span class="lang-es">1RA MITAD</span></div>
<div class="half-indicator inactive" id="half2"><span class="lang-en">2ND HALF</span><span class="lang-es">2DA MITAD</span></div>
</div>
<div class="accuracy-display">
<div class="accuracy-label"><span class="lang-en">ACCURACY</span><span class="lang-es">PRECISIÃ“N</span></div>
<div class="accuracy-value perfect" id="accuracyDisplay">100%</div>
</div>
</div>
<div class="message-area"><div class="game-message" id="gameMessage"></div></div>
<div class="court" id="court">
<div class="court-markings"><div class="court-center-line"></div><div class="court-center-circle"></div></div>
<canvas class="trail-canvas" id="trailCanvas"></canvas>
<div class="ball-container" id="ballContainer"></div>
</div>
</div>

<div class="screen" id="halftimeScreen">
<div class="main-icon">â¸ï¸</div>
<div class="main-logo" style="font-size:2rem"><span class="lang-en">HALFTIME</span><span class="lang-es">MEDIO TIEMPO</span></div>
<div class="result-stats">
<div class="result-stat"><div class="result-stat-value" id="htScore">0</div><div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="htAccuracy">100%</div><div class="result-stat-label"><span class="lang-en">Accuracy</span><span class="lang-es">PrecisiÃ³n</span></div></div>
</div>
<p style="color:var(--text-muted);margin-bottom:20px;max-width:280px;font-size:0.95rem">
<span class="lang-en">Keep 100% in 2nd half to advance!</span>
<span class="lang-es">Â¡MantÃ©n 100% en la 2da mitad!</span>
</p>
<button class="retry-btn" onclick="continueToSecondHalf()"><span class="lang-en">2ND HALF â†’</span><span class="lang-es">2DA MITAD â†’</span></button>
</div>

<div class="screen" id="resultScreen">
<div class="result-icon" id="resultIcon">ğŸ†</div>
<div class="result-title" id="resultTitle">PERFECT!</div>
<div class="result-accuracy" id="resultAccuracy">100%</div>
<div class="result-message" id="resultMessage"></div>
<div class="result-stats">
<div class="result-stat"><div class="result-stat-value" id="finalScore">0</div><div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div></div>
<div class="result-stat"><div class="result-stat-value" id="finalCorrect">0/0</div><div class="result-stat-label"><span class="lang-en">Correct</span><span class="lang-es">Correctos</span></div></div>
</div>
<div class="squad-welcome" id="squadWelcome" style="display:none">
<div class="squad-welcome-title">ğŸ˜‚ <span class="lang-en">LAUGH TRACKER UNLOCKED!</span><span class="lang-es">Â¡RASTREADOR DE RISAS DESBLOQUEADO!</span></div>
<div class="squad-welcome-text"><span class="lang-en">You passed practice! Keep laughing!</span><span class="lang-es">Â¡Pasaste la prÃ¡ctica! Â¡Sigue riendo!</span></div>
</div>
<div class="next-level-preview" id="nextLevelBox" style="display:none">
<div class="next-level-label"><span class="lang-en">NEXT TIER</span><span class="lang-es">SIGUIENTE NIVEL</span></div>
<div class="next-level-name" id="nextLevelName">TIER 2</div>
</div>
<div class="continue-timer" id="continueTimer"><span class="lang-en">Continuing in <span id="timerCount">5</span>...</span><span class="lang-es">Continuando en <span id="timerCountEs">5</span>...</span></div>
<div class="action-buttons">
<button class="continue-btn" id="advanceBtn" onclick="advanceNow()" style="display:none"><span class="lang-en">ADVANCE NOW</span><span class="lang-es">AVANZAR</span></button>
<button class="retry-btn" id="retryBtn" onclick="retryNow()" style="display:none"><span class="lang-en">RETRY NOW</span><span class="lang-es">REINTENTAR</span></button>
<button class="home-btn" onclick="window.location.href='laugh-hub.html'"><span class="lang-en">â† Circuits</span><span class="lang-es">â† Circuitos</span></button>
</div>
</div>

<div class="rhythm-badge" id="rhythmBadge"><span class="rhythm-badge-text" id="rhythmBadgeText">HAPPY â€¢ 127 BPM</span></div>

<!-- Coach GoTrotter AI Bubble -->
<div class="coach-bubble" id="coachBubble">
<img src="go_chat.png" alt="Coach" class="coach-bubble-avatar">
<div class="coach-bubble-text" id="coachText"></div>
</div>

<!-- Chat FAB -->
<button class="chat-fab" id="chatFab" onclick="window.location.href='index.html'">
<img src="go_chat.png" alt="GoTrotter AI">
</button>

<script>
var currentLang = localStorage.getItem('lw-lang') || 'en';
function setLang(l) {
    currentLang = l;
    localStorage.setItem('lw-lang', l);
    document.body.setAttribute('data-lang', l);
    document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.toggle('active', b.textContent.trim() === l.toUpperCase());
    });
}
document.body.setAttribute('data-lang', currentLang);

// Laughing emoji pool
var laughEmojis = ['ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜†', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ˜„', 'ğŸ˜', 'ğŸ¥³', 'ğŸ˜¹'];

function getRandomLaughEmoji() {
    return laughEmojis[Math.floor(Math.random() * laughEmojis.length)];
}

// Audio - metronome style beeps (kept from original)
var audioCtx = null;
function playBeep(freq, dur) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

// ========== LAUGH MOMENTS TRACKING ==========
var circuitLaughs = 0;

function addLaughs(n) {
    circuitLaughs += n;
    
    // Update localStorage totals
    var today = new Date().toDateString();
    var storedDate = localStorage.getItem('lw-laughs-date');
    
    if (storedDate !== today) {
        localStorage.setItem('lw-laughs-today', '0');
        localStorage.setItem('lw-laughs-date', today);
    }
    
    var todayLaughs = parseInt(localStorage.getItem('lw-laughs-today') || '0') + n;
    var weekLaughs = parseInt(localStorage.getItem('lw-laughs-week') || '0') + n;
    var totalLaughs = parseInt(localStorage.getItem('lw-laughs-total') || '0') + n;
    
    localStorage.setItem('lw-laughs-today', todayLaughs.toString());
    localStorage.setItem('lw-laughs-week', weekLaughs.toString());
    localStorage.setItem('lw-laughs-total', totalLaughs.toString());
    
    updateLaughCounter();
}

function updateLaughCounter() {
    var el = document.getElementById('laughCounterValue');
    if (el) el.textContent = circuitLaughs;
}

// ========== COACH GOTROTTER AI ==========
var coachMessages = {
    welcome: {en: "Let's follow the laugh track! ğŸ˜‚", es: "Â¡Sigamos la pista de risa! ğŸ˜‚"},
    watch: {en: "Focus... watch the giggles light up!", es: "EnfÃ³cate... Â¡mira las risas iluminarse!"},
    yourTurn: {en: "Your turn! Follow the laughs!", es: "Â¡Tu turno! Â¡Sigue las risas!"},
    perfect: [
        {en: "Ha! Perfect! ğŸ˜‚", es: "Â¡Ja! Â¡Perfecto! ğŸ˜‚"},
        {en: "You got the giggles! ğŸ¤£", es: "Â¡Lo tienes! ğŸ¤£"},
        {en: "Laugh master! ğŸ˜†", es: "Â¡Maestro de risa! ğŸ˜†"},
        {en: "Your memory is hilarious! ğŸ§ ğŸ˜‚", es: "Â¡Tu memoria es graciosa! ğŸ§ ğŸ˜‚"},
        {en: "LOL! Nailed it! ğŸ¯", es: "Â¡LOL! Â¡Clavado! ğŸ¯"}
    ],
    error: [
        {en: "Oops! Laugh it off! ğŸ˜„", es: "Â¡Ups! Â¡RÃ­ete! ğŸ˜„"},
        {en: "Almost! Keep smiling! ğŸ˜Š", es: "Â¡Casi! Â¡Sigue sonriendo! ğŸ˜Š"},
        {en: "Ha! Try again! ğŸ˜‚", es: "Â¡Ja! Â¡Otra vez! ğŸ˜‚"},
        {en: "That's okay, keep giggling!", es: "Â¡EstÃ¡ bien, sigue riendo!"}
    ],
    halftime: {en: "Great first half! More laughs coming! ğŸ˜‚ğŸ’ª", es: "Â¡Gran primera mitad! Â¡MÃ¡s risas vienen! ğŸ˜‚ğŸ’ª"},
    tierUp: {en: "TIER UP! Your laugh track is growing! ğŸ†ğŸ˜‚", es: "Â¡SUBISTE! Â¡Tu pista de risa crece! ğŸ†ğŸ˜‚"},
    perfectGame: {en: "PERFECT CIRCUIT! You're a laugh legend! ğŸ†ğŸ¤£", es: "Â¡CIRCUITO PERFECTO! Â¡Eres leyenda de risa! ğŸ†ğŸ¤£"},
    keepTrying: {en: "Good giggles! 100% unlocks more laughs. You can do it! ğŸ˜Š", es: "Â¡Buenas risas! 100% desbloquea mÃ¡s. Â¡TÃº puedes! ğŸ˜Š"},
    squadWelcome: {en: "Welcome to the Laugh Squad! Keep those giggles coming! ğŸ˜‚ğŸ‰", es: "Â¡Bienvenido al EscuadrÃ³n de Risa! Â¡Sigue riendo! ğŸ˜‚ğŸ‰"}
};

var coachTimeout = null;
function showCoach(msgKey, duration) {
    var bubble = document.getElementById('coachBubble');
    var textEl = document.getElementById('coachText');
    
    var msg;
    if (Array.isArray(coachMessages[msgKey])) {
        var arr = coachMessages[msgKey];
        msg = arr[Math.floor(Math.random() * arr.length)];
    } else {
        msg = coachMessages[msgKey];
    }
    
    textEl.innerHTML = '<span class="lang-en">' + msg.en + '</span><span class="lang-es">' + msg.es + '</span>';
    bubble.classList.add('visible');
    
    if (coachTimeout) clearTimeout(coachTimeout);
    coachTimeout = setTimeout(function() {
        bubble.classList.remove('visible');
    }, duration || 3000);
}

function hideCoach() {
    document.getElementById('coachBubble').classList.remove('visible');
    if (coachTimeout) clearTimeout(coachTimeout);
}

// 10 TIER SYSTEM
var tiers = {
    tier1: {name: 'TIER 1', icon: 'ğŸ˜Š', stars: 2, seqMin: 2, seqMax: 2, plays: 2, isPractice: true},
    tier2: {name: 'TIER 2', icon: 'ğŸ˜„', stars: 3, seqMin: 2, seqMax: 3, plays: 2, isPractice: true},
    tier3: {name: 'TIER 3', icon: 'ğŸ˜†', stars: 4, seqMin: 3, seqMax: 4, plays: 3, isPractice: false},
    tier4: {name: 'TIER 4', icon: 'ğŸ˜‚', stars: 5, seqMin: 4, seqMax: 5, plays: 3, isPractice: false},
    tier5: {name: 'TIER 5', icon: 'ğŸ¤£', stars: 6, seqMin: 5, seqMax: 6, plays: 3, isPractice: false},
    tier6: {name: 'TIER 6', icon: 'ğŸ˜œ', stars: 7, seqMin: 6, seqMax: 7, plays: 4, isPractice: false},
    tier7: {name: 'TIER 7', icon: 'ğŸ¤ª', stars: 8, seqMin: 7, seqMax: 8, plays: 4, isPractice: false},
    tier8: {name: 'TIER 8', icon: 'ğŸ¥³', stars: 9, seqMin: 8, seqMax: 9, plays: 4, isPractice: false},
    tier9: {name: 'TIER 9', icon: 'ğŸ†', stars: 10, seqMin: 9, seqMax: 10, plays: 5, isPractice: false},
    tier10: {name: 'MASTER 10', icon: 'ğŸ‘‘', stars: 12, seqMin: 10, seqMax: 12, plays: 5, isPractice: false}
};
var tierList = ['tier1', 'tier2', 'tier3', 'tier4', 'tier5', 'tier6', 'tier7', 'tier8', 'tier9', 'tier10'];

var rhythms = {
    steady: {ms: 650, pause: 380, label: 'GENTLE â€¢ 90 BPM'},
    showtime: {ms: 470, pause: 260, label: 'HAPPY â€¢ 127 BPM'},
    master: {ms: 380, pause: 180, label: 'HYPER â€¢ 150 BPM'}
};

function getProgress() {
    try { return JSON.parse(localStorage.getItem('laughletico-laugh5-mastery')) || {unlockedLevel: 0, perfect: {}, best: 0}; }
    catch (e) { return {unlockedLevel: 0, perfect: {}, best: 0}; }
}
function saveProgress(p) { localStorage.setItem('laughletico-laugh5-mastery', JSON.stringify(p)); }

var selTier = 'tier1', selRhythm = 'showtime';
var currentHalf = 1, play = 1, score = 0;
var balls = [], seq = [], idx = 0, done = [], showing = false;
var correct = 0, attempts = 0;
var autoTimer = null;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
    document.getElementById(id).classList.add('active');
}

function renderTiers() {
    var grid = document.getElementById('tierGrid');
    grid.innerHTML = '';
    var prog = getProgress();
    var unlockedIdx = prog.unlockedLevel || 0;
    
    tierList.forEach(function(id, idx) {
        var t = tiers[id];
        var unlocked = idx <= unlockedIdx;
        var mastered = idx < unlockedIdx;
        
        var btn = document.createElement('div');
        var classes = 'tier-btn';
        if (id === selTier) classes += ' selected';
        if (!unlocked) classes += ' locked';
        if (mastered) classes += ' mastered';
        if (t.isPractice && unlocked && !mastered) classes += ' practice';
        btn.className = classes;
        
        if (unlocked) {
            btn.onclick = function() {
                selTier = id;
                renderTiers();
            };
        }
        
        var statusHtml = '';
        if (mastered) {
            statusHtml = '<span class="tier-status mastered">âœ“</span>';
        } else if (!unlocked) {
            statusHtml = '<span class="tier-status locked">ğŸ”’</span>';
        } else if (t.isPractice) {
            statusHtml = '<span class="tier-status practice">' + (currentLang === 'es' ? 'PRÃCTICA' : 'PRACTICE') + '</span>';
        } else if (idx === unlockedIdx) {
            statusHtml = '<span class="tier-status current">' + (currentLang === 'es' ? 'ACTUAL' : 'CURRENT') + '</span>';
        }
        
        btn.innerHTML = '<span class="tier-icon">' + t.icon + '</span>' +
            '<div class="tier-info"><div class="tier-name">' + t.name + '</div>' +
            '<div class="tier-desc">' + t.stars + ' laughs</div></div>' + statusHtml;
        
        grid.appendChild(btn);
    });
    
    var totalPerfect = 0;
    for (var k in prog.perfect) totalPerfect += prog.perfect[k];
    document.getElementById('currentTier').textContent = unlockedIdx + 1;
    document.getElementById('perfectGames').textContent = totalPerfect;
    document.getElementById('bestScore').textContent = prog.best || 0;
    
    // Auto-select current tier
    selTier = tierList[Math.min(unlockedIdx, tierList.length - 1)];
}

function selectRhythm(r) {
    selRhythm = r;
    document.querySelectorAll('.rhythm-btn').forEach(function(b) {
        b.classList.toggle('selected', b.dataset.rhythm === r);
    });
}

function startGame() {
    currentHalf = 1; play = 1; score = 0; correct = 0; attempts = 0;
    circuitLaughs = 0;
    updateLaughCounter();
    document.getElementById('laughCounter').style.display = 'flex';
    document.getElementById('rhythmBadgeText').textContent = rhythms[selRhythm].label;
    document.getElementById('rhythmBadge').classList.add('visible');
    document.getElementById('countdownTier').textContent = tiers[selTier].name;
    updateHalfDisplay();
    showScreen('countdownScreen');
    showCoach('welcome', 2500);
    
    // +1 laugh for starting
    addLaughs(1);
    
    countdown(3);
}

function countdown(n) {
    document.getElementById('countdownNum').textContent = n;
    if (n > 0) {
        playBeep(440, 0.1);
        setTimeout(function() { countdown(n - 1); }, 1000);
    } else {
        playBeep(880, 0.3);
        hideCoach();
        showScreen('gameScreen');
        initRound();
    }
}

function initRound() {
    document.getElementById('gameTier').textContent = tiers[selTier].name;
    updateHalfDisplay();
    updateAccuracy();
    startPlay();
}

function updateHalfDisplay() {
    var h1 = document.getElementById('half1');
    var h2 = document.getElementById('half2');
    if (currentHalf === 1) {
        h1.className = 'half-indicator active';
        h2.className = 'half-indicator inactive';
    } else {
        h1.className = 'half-indicator completed';
        h2.className = 'half-indicator active';
    }
}

function updateAccuracy() {
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var el = document.getElementById('accuracyDisplay');
    el.textContent = pct + '%';
    el.className = 'accuracy-value ' + (pct === 100 ? 'perfect' : (pct >= 80 ? 'good' : 'miss'));
}

function updateScore() { document.getElementById('scoreDisplay').textContent = score; }

function setMsg(txt, type) {
    var el = document.getElementById('gameMessage');
    el.textContent = txt;
    el.className = 'game-message' + (type ? ' ' + type : '');
}

function makeBalls(n) {
    var court = document.getElementById('court');
    var w = court.offsetWidth, h = court.offsetHeight;
    balls = [];
    for (var i = 0; i < n; i++) {
        var x, y, ok, tries = 0;
        do {
            x = 40 + Math.random() * (w - 80);
            y = 40 + Math.random() * (h - 80);
            ok = true;
            for (var j = 0; j < balls.length; j++) {
                var dx = x - balls[j].x, dy = y - balls[j].y;
                if (Math.sqrt(dx*dx + dy*dy) < 55) { ok = false; break; }
            }
            tries++;
        } while (!ok && tries < 100);
        balls.push({x: x, y: y, emoji: getRandomLaughEmoji()});
    }
}

function renderBalls() {
    var container = document.getElementById('ballContainer');
    container.innerHTML = '';
    for (var i = 0; i < balls.length; i++) {
        var b = balls[i];
        var div = document.createElement('div');
        div.className = 'ball';
        div.setAttribute('data-idx', i);
        div.style.left = b.x + 'px';
        div.style.top = b.y + 'px';
        div.textContent = b.emoji;
        (function(index) { div.onclick = function() { clickBall(index); }; })(i);
        container.appendChild(div);
    }
    clearTrail();
    
    // +1 laugh for seeing the laughing emojis
    addLaughs(1);
}

function clearTrail() {
    var cv = document.getElementById('trailCanvas');
    var ct = document.getElementById('court');
    cv.width = ct.offsetWidth;
    cv.height = ct.offsetHeight;
}

function drawTrail() {
    var cv = document.getElementById('trailCanvas');
    var ctx = cv.getContext('2d');
    ctx.clearRect(0, 0, cv.width, cv.height);
    if (done.length < 2) return;
    ctx.strokeStyle = '#FFD700';
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.shadowColor = '#FFD700';
    ctx.shadowBlur = 20;
    ctx.beginPath();
    for (var i = 0; i < done.length; i++) {
        var b = balls[done[i]];
        if (i === 0) ctx.moveTo(b.x, b.y);
        else ctx.lineTo(b.x, b.y);
    }
    ctx.stroke();
}

function disableBalls(d) {
    document.querySelectorAll('.ball').forEach(function(b) { b.classList.toggle('disabled', d); });
}

function startPlay() {
    idx = 0; done = [];
    var t = tiers[selTier];
    makeBalls(t.stars);
    renderBalls();
    var len = t.seqMin + Math.floor(Math.random() * (t.seqMax - t.seqMin + 1));
    var avail = [];
    for (var i = 0; i < balls.length; i++) avail.push(i);
    seq = [];
    for (var i = 0; i < len; i++) {
        if (!avail.length) break;
        var r = Math.floor(Math.random() * avail.length);
        seq.push(avail[r]);
        avail.splice(r, 1);
    }
    setMsg(currentLang === 'es' ? 'Mira la pista de risa...' : 'Watch the laugh track...');
    showCoach('watch', 2000);
    disableBalls(true);
    setTimeout(showSeq, 700);
}

function showSeq() {
    showing = true;
    var rhy = rhythms[selRhythm];
    var i = 0;
    function next() {
        if (i > 0) {
            var prev = document.querySelector('.ball[data-idx="' + seq[i-1] + '"]');
            if (prev) prev.classList.remove('lit');
        }
        if (i >= seq.length) {
            showing = false;
            setMsg(currentLang === 'es' ? 'Â¡Te toca!' : 'Your turn!');
            showCoach('yourTurn', 2000);
            disableBalls(false);
            return;
        }
        var el = document.querySelector('.ball[data-idx="' + seq[i] + '"]');
        if (el) {
            el.classList.add('lit');
            playBeep(261.63 * (1 + seq[i] * 0.1), 0.2);
        }
        i++;
        setTimeout(next, rhy.ms + rhy.pause);
    }
    next();
}

function clickBall(i) {
    if (showing) return;
    var el = document.querySelector('.ball[data-idx="' + i + '"]');
    if (!el || el.classList.contains('completed')) return;
    
    if (i === seq[idx]) {
        done.push(i);
        el.classList.add('completed');
        playBeep(523.25, 0.15);
        drawTrail();
        idx++;
        
        // +1 laugh for correct tap
        addLaughs(1);
        
        if (idx >= seq.length) {
            correct++;
            attempts++;
            var pts = seq.length * 20;
            score += pts;
            disableBalls(true);
            updateScore();
            updateAccuracy();
            setMsg((currentLang === 'es' ? 'Â¡Ja ja! +' : 'Ha ha! +') + pts, 'success');
            showCoach('perfect', 2000);
            
            // +2 laughs for completing sequence
            addLaughs(2);
            
            setTimeout(nextPlay, 1000);
        }
    } else {
        attempts++;
        el.classList.add('error');
        playBeep(150, 0.25);
        setTimeout(function() { el.classList.remove('error'); }, 300);
        var partial = idx * 10;
        if (partial > 0) { score += partial; updateScore(); }
        updateAccuracy();
        setMsg(currentLang === 'es' ? 'Â¡Otra vez!' : 'Try again!', 'error');
        showCoach('error', 2000);
        setTimeout(nextPlay, 800);
    }
}

function nextPlay() {
    play++;
    var t = tiers[selTier];
    if (play > t.plays) {
        if (currentHalf === 1) { showHalftime(); }
        else { endGame(); }
        return;
    }
    hideCoach();
    setTimeout(startPlay, 400);
}

function showHalftime() {
    document.getElementById('rhythmBadge').classList.remove('visible');
    document.getElementById('htScore').textContent = score;
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    document.getElementById('htAccuracy').textContent = pct + '%';
    showScreen('halftimeScreen');
    showCoach('halftime', 3000);
}

function continueToSecondHalf() {
    currentHalf = 2;
    play = 1;
    hideCoach();
    document.getElementById('rhythmBadge').classList.add('visible');
    updateHalfDisplay();
    showScreen('gameScreen');
    setMsg(currentLang === 'es' ? 'Â¡Segunda mitad!' : '2nd Half!');
    setTimeout(startPlay, 800);
}

function endGame() {
    document.getElementById('rhythmBadge').classList.remove('visible');
    document.getElementById('laughCounter').style.display = 'none';
    hideCoach();
    
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var isPerfect = pct === 100;
    
    // +5 laughs for circuit complete
    addLaughs(5);
    
    // +3 laughs for tier up
    if (isPerfect) addLaughs(3);
    
    var prog = getProgress();
    if (score > prog.best) prog.best = score;
    
    var currentIdx = tierList.indexOf(selTier);
    var canAdvance = isPerfect && currentIdx < tierList.length - 1;
    
    // Check if passing tier2 to become official
    var joiningSquad = isPerfect && selTier === 'tier2';
    
    if (isPerfect) {
        prog.perfect[selTier] = (prog.perfect[selTier] || 0) + 1;
        var unlockedIdx = prog.unlockedLevel || 0;
        if (currentIdx >= unlockedIdx && currentIdx < tierList.length - 1) {
            prog.unlockedLevel = currentIdx + 1;
        }
    }
    saveProgress(prog);
    
    // Update result screen
    document.getElementById('resultIcon').textContent = isPerfect ? 'ğŸ†' : 'ğŸ˜‚';
    document.getElementById('resultTitle').textContent = isPerfect ? 
        (currentLang === 'es' ? 'Â¡PERFECTO!' : 'PERFECT!') : 
        (currentLang === 'es' ? 'SIGUE RIENDO' : 'KEEP LAUGHING');
    document.getElementById('resultTitle').className = 'result-title ' + (isPerfect ? 'success' : 'retry');
    
    document.getElementById('resultAccuracy').textContent = pct + '%';
    document.getElementById('resultAccuracy').className = 'result-accuracy ' + (isPerfect ? 'perfect' : 'miss');
    
    var msgEN = isPerfect ? 'Laugh Track mastered at this tier!' : 'You need 100% to advance. Keep giggling!';
    var msgES = isPerfect ? 'Â¡Pista de Risa dominada en este nivel!' : 'Necesitas 100% para avanzar. Â¡Sigue riendo!';
    document.getElementById('resultMessage').innerHTML = '<span class="lang-en">' + msgEN + '</span><span class="lang-es">' + msgES + '</span>';
    
    document.getElementById('finalScore').textContent = score;
    document.getElementById('finalCorrect').textContent = correct + '/' + attempts;
    
    // Squad welcome for passing practice
    document.getElementById('squadWelcome').style.display = joiningSquad ? 'block' : 'none';
    
    // Next level preview
    if (canAdvance) {
        var nextTier = tierList[currentIdx + 1];
        document.getElementById('nextLevelName').textContent = tiers[nextTier].icon + ' ' + tiers[nextTier].name;
        document.getElementById('nextLevelBox').style.display = 'block';
        document.getElementById('advanceBtn').style.display = 'block';
        document.getElementById('retryBtn').style.display = 'none';
    } else {
        document.getElementById('nextLevelBox').style.display = 'none';
        document.getElementById('advanceBtn').style.display = 'none';
        document.getElementById('retryBtn').style.display = 'block';
    }
    
    showScreen('resultScreen');
    
    // Coach message based on result
    if (joiningSquad) {
        showCoach('squadWelcome', 5000);
    } else if (isPerfect && canAdvance) {
        showCoach('tierUp', 4000);
    } else if (isPerfect) {
        showCoach('perfectGame', 4000);
    } else {
        showCoach('keepTrying', 4000);
    }
    
    startAutoTimer(isPerfect, canAdvance);
    
    // Save to server if logged in
    var pin = sessionStorage.getItem('lw-user-pin');
    if (pin) {
        var data = {game: 'laugh5', score: score, tier: selTier, accuracy: pct, perfect: isPerfect, pin: pin};
        fetch('/api/game/session', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).catch(function(){});
    }
}

function startAutoTimer(isPerfect, canAdvance) {
    var count = 5;
    document.getElementById('timerCount').textContent = count;
    document.getElementById('timerCountEs').textContent = count;
    document.getElementById('continueTimer').style.display = 'block';
    
    autoTimer = setInterval(function() {
        count--;
        document.getElementById('timerCount').textContent = count;
        document.getElementById('timerCountEs').textContent = count;
        if (count <= 0) {
            clearInterval(autoTimer);
            if (isPerfect && canAdvance) advanceNow();
            else retryNow();
        }
    }, 1000);
}

function advanceNow() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    var currentIdx = tierList.indexOf(selTier);
    if (currentIdx < tierList.length - 1) selTier = tierList[currentIdx + 1];
    startGame();
}

function retryNow() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    startGame();
}

function goHome() {
    if (autoTimer) clearInterval(autoTimer);
    hideCoach();
    document.getElementById('rhythmBadge').classList.remove('visible');
    document.getElementById('laughCounter').style.display = 'none';
    renderTiers();
    showScreen('welcomeScreen');
}

// Init
document.querySelectorAll('.lang-btn').forEach(function(b) {
    b.classList.toggle('active', b.textContent.trim() === currentLang.toUpperCase());
});
renderTiers();
</script>
</body>
</html>
