<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>THE CHALLENGE</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
    width:100%;
    height:100%;
    background:#0d0d12;
    color:#fff;
    font-family:system-ui,-apple-system,sans-serif;
    overflow:hidden;
    touch-action:manipulation;
    -webkit-user-select:none;
    user-select:none;
}
#app{
    width:100%;
    height:100%;
    max-width:400px;
    margin:0 auto;
    padding:12px;
    padding-top:calc(12px + env(safe-area-inset-top));
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
    display:grid;
    grid-template-rows:auto auto auto 1fr auto auto;
    gap:10px;
}
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.back{
    padding:10px 16px;
    background:#1a1a24;
    border:none;
    color:#888;
    border-radius:8px;
    font-size:14px;
    text-decoration:none;
}
.title{
    font-size:20px;
    font-weight:700;
    color:#FFD700;
}
.stats{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:8px;
}
.stat{
    background:#1a1a24;
    border-radius:10px;
    padding:12px 8px;
    text-align:center;
}
.stat-val{
    font-size:24px;
    font-weight:700;
    color:#FFD700;
}
.stat-lbl{
    font-size:11px;
    color:#666;
    text-transform:uppercase;
}
#msgBox{
    background:#1a1a24;
    border:3px solid #FFD700;
    border-radius:12px;
    padding:14px;
    text-align:center;
    font-size:18px;
    font-weight:700;
    letter-spacing:1px;
}
#msgBox.react{border-color:#9B59B6}
#msgBox.recall{border-color:#00D9A5}
.court-area{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:0;
}
#court{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:6px;
    padding:10px;
    background:#14141c;
    border:3px solid #FFD700;
    border-radius:14px;
    width:min(100%, 70vh, 320px);
    aspect-ratio:1;
}
#court.react{border-color:#9B59B6;box-shadow:0 0 25px rgba(155,89,182,0.3)}
#court.recall{border-color:#00D9A5;box-shadow:0 0 25px rgba(0,217,165,0.3)}
.c{
    aspect-ratio:1;
    background:rgba(255,255,255,0.05);
    border:2px solid rgba(255,255,255,0.12);
    border-radius:6px;
}
.c.lit{background:#9B59B6!important;border-color:#9B59B6!important;box-shadow:0 0 15px #9B59B6}
.c.ok{background:#00D9A5!important;border-color:#00D9A5!important}
.c.bad{background:#FF1493!important;border-color:#FF1493!important}
.info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
}
.info-box{
    background:#1a1a24;
    border-radius:8px;
    padding:10px;
    text-align:center;
    font-size:16px;
    font-weight:600;
    color:#FFD700;
}
#mainBtn{
    width:100%;
    padding:18px;
    border:none;
    border-radius:12px;
    font-size:22px;
    font-weight:700;
    letter-spacing:2px;
    cursor:pointer;
    background:linear-gradient(135deg,#FFD700,#FFA500);
    color:#000;
}
#mainBtn:disabled{opacity:0.4}
#mainBtn.teal{background:linear-gradient(135deg,#00D9A5,#00B890)}
.popup{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100;
}
.popup.show{display:flex}
.popup-inner{
    background:#1a1a24;
    border:2px solid #FFD700;
    border-radius:16px;
    padding:30px;
    text-align:center;
    width:280px;
}
.popup-inner h2{font-size:26px;color:#FFD700;margin:15px 0}
.popup-inner p{color:#888;margin-bottom:20px}
.popup-inner button{
    padding:16px 30px;
    border:none;
    border-radius:10px;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    background:linear-gradient(135deg,#FFD700,#FFA500);
    color:#000;
}
</style>
</head>
<body>
<div id="app">
    <div class="header">
        <a href="/dashboard.html" class="back">‚Üê BACK</a>
        <div class="title">üèÜ THE CHALLENGE</div>
        <div style="width:80px"></div>
    </div>
    
    <div class="stats">
        <div class="stat"><div class="stat-val" id="sLvl">1</div><div class="stat-lbl">Level</div></div>
        <div class="stat"><div class="stat-val" id="sStr">0</div><div class="stat-lbl">Streak</div></div>
        <div class="stat"><div class="stat-val" id="sScr">0</div><div class="stat-lbl">Score</div></div>
    </div>
    
    <div id="msgBox">TAP GO TO START</div>
    
    <div class="court-area">
        <div id="court"></div>
    </div>
    
    <div class="info">
        <div class="info-box" id="iTaps">0 / 5</div>
        <div class="info-box" id="iState">READY</div>
    </div>
    
    <button id="mainBtn">GO</button>
</div>

<div class="popup" id="winPop">
    <div class="popup-inner">
        <div style="font-size:50px">‚¨ÜÔ∏è</div>
        <h2>LEVEL UP!</h2>
        <p id="winMsg">Level 2</p>
        <button id="winBtn">CONTINUE</button>
    </div>
</div>

<script>
// GLOBALS
var MODE = 'idle';
var level = parseInt(localStorage.getItem('lc-challenge-level')) || 1;
var score = 0;
var streak = 0;
var sequence = [];
var seqPos = 0;
var currentLit = -1;
var tapCount = 0;
var targetTaps = 5;
var canTap = false;
var flashTimer = null;
var cells = [];

// AUDIO
var audioCtx = null;
function beep(freq) {
    if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return; }
    }
    try {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.12);
    } catch(e) {}
}

// UI HELPERS
function $(id) { return document.getElementById(id); }

function updateUI() {
    $('sLvl').textContent = level;
    $('sStr').textContent = streak;
    $('sScr').textContent = score;
    $('iState').textContent = MODE.toUpperCase();
}

function setMsg(txt) {
    $('msgBox').textContent = txt;
}

function setTaps(cur, max) {
    $('iTaps').textContent = cur + ' / ' + max;
}

// BUILD COURT
function buildCourt() {
    var court = $('court');
    court.innerHTML = '';
    cells = [];
    for (var i = 0; i < 25; i++) {
        var cell = document.createElement('div');
        cell.className = 'c';
        (function(index) {
            cell.onclick = function() { onCellTap(index); };
        })(i);
        court.appendChild(cell);
        cells.push(cell);
    }
}

function clearCells() {
    for (var i = 0; i < 25; i++) {
        cells[i].className = 'c';
    }
}

// MAIN BUTTON
$('mainBtn').onclick = function() {
    if (MODE === 'idle') {
        startReact();
    } else if (MODE === 'waitRecall') {
        startRecall();
    }
};

// START REACT PHASE
function startReact() {
    MODE = 'react';
    score = 0;
    sequence = [];
    seqPos = 0;
    currentLit = -1;
    tapCount = 0;
    targetTaps = level + 4;
    canTap = false;
    
    $('mainBtn').disabled = true;
    $('mainBtn').textContent = '...';
    $('mainBtn').className = '';
    $('court').className = 'react';
    $('msgBox').className = 'react';
    
    clearCells();
    updateUI();
    setTaps(0, targetTaps);
    setMsg('GET READY...');
    
    setTimeout(function() {
        setMsg('‚ö° REACT - TAP LIT CELLS!');
        flashNext();
    }, 600);
}

// FLASH NEXT CELL
function flashNext() {
    if (MODE !== 'react') return;
    
    // Clear previous
    if (currentLit >= 0) {
        cells[currentLit].classList.remove('lit');
    }
    
    // Pick new random cell
    var next;
    do {
        next = Math.floor(Math.random() * 25);
    } while (next === currentLit);
    
    currentLit = next;
    sequence.push(next);
    cells[next].classList.add('lit');
    canTap = true;
    beep(880);
    
    // Timeout for this flash
    var speed = level <= 3 ? 1200 : level <= 6 ? 800 : 500;
    flashTimer = setTimeout(function() {
        if (canTap && MODE === 'react') {
            canTap = false;
            failGame('TOO SLOW!');
        }
    }, speed);
}

// START RECALL PHASE
function startRecall() {
    MODE = 'recall';
    seqPos = 0;
    canTap = true;
    
    clearCells();
    $('mainBtn').disabled = true;
    $('mainBtn').textContent = '...';
    $('mainBtn').className = '';
    $('court').className = 'recall';
    $('msgBox').className = 'recall';
    
    updateUI();
    setTaps(0, sequence.length);
    setMsg('üî¢ RECALL - TAP IN ORDER!');
}

// CELL TAP HANDLER
function onCellTap(index) {
    if (!canTap) return;
    
    var cell = cells[index];
    
    // REACT PHASE
    if (MODE === 'react') {
        clearTimeout(flashTimer);
        canTap = false;
        
        if (index === currentLit) {
            // CORRECT!
            beep(660);
            cell.classList.remove('lit');
            cell.classList.add('ok');
            tapCount++;
            score += 15;
            
            setTaps(tapCount, targetTaps);
            $('sScr').textContent = score;
            
            if (tapCount >= targetTaps) {
                // REACT COMPLETE!
                reactComplete();
            } else {
                setTimeout(function() {
                    cell.classList.remove('ok');
                    flashNext();
                }, 120);
            }
        } else {
            // WRONG!
            cell.classList.add('bad');
            failGame('WRONG CELL!');
        }
        return;
    }
    
    // RECALL PHASE
    if (MODE === 'recall') {
        var expected = sequence[seqPos];
        
        if (index === expected) {
            // CORRECT!
            beep(660);
            cell.classList.add('ok');
            seqPos++;
            score += 20;
            
            setTaps(seqPos, sequence.length);
            $('sScr').textContent = score;
            
            if (seqPos >= sequence.length) {
                // WIN!
                canTap = false;
                winGame();
            }
        } else {
            // WRONG!
            cell.classList.add('bad');
            cells[expected].classList.add('lit');
            canTap = false;
            failGame('WRONG ORDER!');
        }
    }
}

// REACT COMPLETE - SHOW RECALL BUTTON
function reactComplete() {
    MODE = 'waitRecall';
    canTap = false;
    
    beep(784);
    setMsg('‚úì REACT DONE! TAP RECALL');
    $('iState').textContent = 'WAIT RECALL';
    
    // ENABLE RECALL BUTTON
    $('mainBtn').disabled = false;
    $('mainBtn').className = 'teal';
    $('mainBtn').textContent = 'üî¢ RECALL';
}

// WIN
function winGame() {
    MODE = 'idle';
    streak++;
    
    beep(523);
    setTimeout(function() { beep(659); }, 70);
    setTimeout(function() { beep(784); }, 140);
    setTimeout(function() { beep(1047); }, 210);
    
    setMsg('üèÜ CHALLENGE COMPLETE!');
    
    level++;
    if (level > 10) level = 10;
    localStorage.setItem('lc-challenge-level', level);
    
    setTimeout(function() {
        $('winMsg').textContent = 'Now Level ' + level + '!';
        $('winPop').classList.add('show');
    }, 800);
}

// FAIL
function failGame(msg) {
    MODE = 'idle';
    clearTimeout(flashTimer);
    beep(200);
    
    if (currentLit >= 0) {
        cells[currentLit].classList.remove('lit');
        cells[currentLit].classList.add('bad');
    }
    
    streak = 0;
    canTap = false;
    setMsg(msg);
    
    setTimeout(resetGame, 1000);
}

// RESET
function resetGame() {
    MODE = 'idle';
    currentLit = -1;
    
    clearCells();
    updateUI();
    
    $('court').className = '';
    $('msgBox').className = '';
    setMsg('TAP GO TO START');
    setTaps(0, level + 4);
    
    $('mainBtn').disabled = false;
    $('mainBtn').className = '';
    $('mainBtn').textContent = 'GO';
}

// WIN POPUP CLOSE
$('winBtn').onclick = function() {
    $('winPop').classList.remove('show');
    resetGame();
};

// INIT
buildCourt();
updateUI();
setTaps(0, level + 4);
</script>
</body>
</html>
