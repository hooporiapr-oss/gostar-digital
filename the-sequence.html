<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>THE SEQUENCE | GoTrotter - The LaughCourt</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B35;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --purple: #9D4EDD;
    --cyan: #00CED1;
    --dark: #1A1A1A;
    --card: #111118;
    --hardwood: #C4935A;
    --hardwood-dark: #8B6914;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { height: 100%; overflow: hidden; }
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.game-container {
    width: 100%;
    max-width: 420px;
    height: 100vh;
    height: 100dvh;
    margin: 0 auto;
    padding: 6px 10px;
    padding-top: max(6px, env(safe-area-inset-top));
    padding-bottom: max(6px, env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    text-align: center;
    padding: 2px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 2px;
}
.logo .go { color: var(--text); }
.logo .trotter { color: var(--cyan); }
.tagline {
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
}
.game-mode-badge {
    display: inline-block;
    background: linear-gradient(135deg, var(--cyan), var(--teal));
    color: var(--dark);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    padding: 3px 12px;
    border-radius: 10px;
    margin-top: 2px;
}

.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 6px 10px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--gold);
    line-height: 1;
}
.stat-label {
    font-size: 0.45rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.message-display {
    background: var(--card);
    border: 2px solid var(--cyan);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 4px;
    text-align: center;
    flex-shrink: 0;
}
.message-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--text);
}
.message-text.watch { color: var(--gold); }
.message-text.go { color: var(--teal); }
.message-text.error { color: var(--pink); }

.selectors-row {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
    flex-shrink: 0;
}
.selector-group {
    flex: 1;
    background: var(--card);
    border-radius: 8px;
    padding: 6px;
}
.selector-label {
    text-align: center;
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
}
.selector-options { display: flex; gap: 3px; }
.selector-btn {
    flex: 1;
    padding: 6px 2px;
    border: 2px solid var(--border);
    background: transparent;
    border-radius: 6px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.selector-btn.active {
    border-color: var(--cyan);
    color: var(--cyan);
    background: rgba(0,206,209,0.1);
}
.selector-btn.locked { opacity: 0.5; cursor: pointer; }
.selector-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: -2px;
    right: 2px;
    font-size: 0.5rem;
}

.tier-display {
    display: flex;
    justify-content: center;
    gap: 4px;
    margin-bottom: 4px;
    flex-shrink: 0;
}
.tier-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: all 0.3s;
}
.tier-dot.completed { background: var(--teal); box-shadow: 0 0 6px var(--teal); }
.tier-dot.current { background: var(--gold); box-shadow: 0 0 8px var(--gold); transform: scale(1.2); }

.court-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    overflow: hidden;
}
.court-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    padding: 10px;
    background: repeating-linear-gradient(90deg, var(--hardwood) 0px, var(--hardwood) 15px, var(--hardwood-dark) 15px, var(--hardwood-dark) 30px);
    border-radius: 12px;
    border: 3px solid var(--cyan);
    width: 100%;
    height: 100%;
    max-width: min(100%, 40vh);
    max-height: 40vh;
    aspect-ratio: 1;
}

.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    background: rgba(255,255,255,0.15);
    border: 3px solid rgba(255,255,255,0.3);
    font-size: 1.5rem;
}
.grid-cell:active:not(.disabled) { transform: scale(0.95); }
.grid-cell.disabled { pointer-events: none; opacity: 0.6; }

.grid-cell.lit {
    background: var(--gold) !important;
    border-color: var(--gold) !important;
    box-shadow: 0 0 25px var(--gold), 0 0 50px rgba(255,215,0,0.5);
    transform: scale(1.05);
}
.grid-cell.player-tap {
    background: var(--cyan) !important;
    border-color: var(--cyan) !important;
    box-shadow: 0 0 20px var(--cyan);
}
.grid-cell.correct {
    animation: correctPulse 0.4s;
    background: var(--teal) !important;
    border-color: var(--teal) !important;
    box-shadow: 0 0 20px var(--teal);
}
.grid-cell.wrong {
    animation: shake 0.4s;
    background: var(--pink) !important;
    border-color: var(--pink) !important;
    box-shadow: 0 0 20px var(--pink);
}

@keyframes correctPulse { 50% { transform: scale(1.15); } }
@keyframes shake { 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

.division-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 12px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.division-badge {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--cyan);
}
.sequence-counter {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--teal);
}
.score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    color: var(--gold);
}

.action-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 4px;
    cursor: pointer;
    transition: all 0.2s;
    background: linear-gradient(135deg, var(--cyan), var(--teal));
    color: var(--dark);
    flex-shrink: 0;
    margin-top: 4px;
}
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.action-btn:active:not(:disabled) { transform: scale(0.98); }

/* Emoji Celebration */
.emoji-container {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 999;
    overflow: hidden;
}
.burst-emoji {
    position: absolute;
    font-size: 2rem;
    animation: emojiBurst 1.2s ease-out forwards;
    pointer-events: none;
}
@keyframes emojiBurst {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.3); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.8) rotate(var(--rot)); }
}
.burst-emoji.big { font-size: 3rem; }
.burst-emoji.party { font-size: 2.5rem; animation-duration: 2s; }

.court-grid.joy-pulse { animation: joyPulse 0.5s ease-out; }
@keyframes joyPulse {
    0% { box-shadow: 0 0 0 0 rgba(0,206,209,0.7); }
    50% { box-shadow: 0 0 30px 10px rgba(0,206,209,0.4); }
    100% { box-shadow: none; }
}

/* Overlays */
.overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}
.overlay.show { display: flex; }
.overlay-card {
    background: var(--card);
    border: 2px solid var(--cyan);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 100%;
}
.overlay-card.gold-border { border-color: var(--gold); box-shadow: 0 20px 60px rgba(255,215,0,0.3); }
.overlay-emoji { font-size: 3rem; margin-bottom: 10px; }
.overlay-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 3px;
    margin-bottom: 8px;
    color: var(--teal);
}
.overlay-title.gold { color: var(--gold); }
.overlay-message { color: var(--muted); margin-bottom: 15px; font-size: 0.9rem; }
.overlay-stats { display: flex; justify-content: center; gap: 25px; margin-bottom: 15px; }
.overlay-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--gold); }
.overlay-stat-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; }
.overlay-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 5px;
    background: linear-gradient(135deg, var(--cyan), var(--teal));
    color: var(--dark);
}
.overlay-btn.gold { background: linear-gradient(135deg, var(--gold), #FFA500); }
.overlay-btn.secondary { background: transparent; color: var(--muted); border: 1px solid var(--muted); }

/* Upgrade Overlay */
.upgrade-speed-preview { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
.upgrade-speed-chip {
    padding: 6px 12px;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
}
.upgrade-speed-chip.current { background: rgba(0,217,165,0.2); color: var(--teal); border: 1px solid var(--teal); }
.upgrade-speed-chip.locked { background: rgba(255,215,0,0.15); color: var(--gold); border: 1px solid var(--gold); }
.upgrade-price { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--gold); margin-bottom: 5px; }
.upgrade-price span { font-size: 0.9rem; color: var(--muted); }

.coach-message {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--cyan), var(--teal));
    color: var(--dark);
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    opacity: 0;
    transition: all 0.3s;
    z-index: 50;
}
.coach-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }

.lang-toggle {
    position: fixed;
    top: 8px;
    right: 10px;
    display: flex;
    gap: 4px;
    z-index: 100;
}
.lang-btn {
    padding: 4px 10px;
    border: 1px solid var(--muted);
    background: transparent;
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    cursor: pointer;
}
.lang-btn.active { border-color: var(--gold); color: var(--gold); }

.back-btn {
    position: fixed;
    top: 8px;
    left: 10px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 12px;
    color: var(--muted);
    font-size: 0.7rem;
    cursor: pointer;
    text-decoration: none;
    z-index: 100;
}

body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

@media (min-height: 750px) {
    .game-container { padding: 10px 15px; }
    .logo { font-size: 2rem; }
    .stat-value { font-size: 1.2rem; }
    .message-text { font-size: 1.1rem; }
    .court-grid { gap: 8px; padding: 12px; }
    .action-btn { padding: 16px; font-size: 1.4rem; }
}
@media (max-height: 600px) {
    .game-container { padding: 4px 8px; }
    .logo { font-size: 1.5rem; }
    .stats-bar { padding: 4px 6px; gap: 10px; margin: 3px 0; }
    .stat-value { font-size: 0.9rem; }
    .message-display { padding: 5px; margin-bottom: 3px; }
    .message-text { font-size: 0.85rem; }
    .court-grid { padding: 8px; gap: 4px; }
    .action-btn { padding: 10px; font-size: 1.1rem; }
}
</style>
</head>
<body class="en">

<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<a href="/hub" class="back-btn">
    <span class="lang-en">‚Üê Hub</span>
    <span class="lang-es">‚Üê Hub</span>
</a>

<div class="emoji-container" id="emojiContainer"></div>

<div class="game-container">
    <header class="header">
        <div class="logo"><span class="go">GO</span><span class="trotter">TROTTER</span></div>
        <div class="tagline">The LaughCourt</div>
        <div class="game-mode-badge">THE SEQUENCE</div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="tierDisplay">1</div>
            <div class="stat-label"><span class="lang-en">Tier</span><span class="lang-es">Tier</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="roundDisplay">0/3</div>
            <div class="stat-label"><span class="lang-en">Round</span><span class="lang-es">Ronda</span></div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streakDisplay">0</div>
            <div class="stat-label">üî•</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="scoreDisplay">0</div>
            <div class="stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div>
        </div>
    </div>

    <div class="message-display">
        <span class="message-text" id="messageText">
            <span class="lang-en">Select division & GO!</span>
            <span class="lang-es">¬°Selecciona divisi√≥n e IR!</span>
        </span>
    </div>

    <div class="selectors-row">
        <div class="selector-group">
            <div class="selector-label"><span class="lang-en">Level</span><span class="lang-es">Nivel</span></div>
            <div class="selector-options">
                <button class="selector-btn active" data-level="1">1</button>
                <button class="selector-btn" data-level="2">2</button>
                <button class="selector-btn" data-level="3">3</button>
                <button class="selector-btn" data-level="4">4</button>
                <button class="selector-btn" data-level="5">5</button>
            </div>
        </div>
        <div class="selector-group">
            <div class="selector-label"><span class="lang-en">Speed</span><span class="lang-es">Velocidad</span></div>
            <div class="selector-options">
                <button class="selector-btn speed-btn active" data-speed="slow">
                    <span class="lang-en">Slow</span><span class="lang-es">Lento</span>
                </button>
                <button class="selector-btn speed-btn" data-speed="med">
                    <span class="lang-en">Med</span><span class="lang-es">Med</span>
                </button>
                <button class="selector-btn speed-btn" data-speed="fast">
                    <span class="lang-en">Fast</span><span class="lang-es">R√°pido</span>
                </button>
            </div>
        </div>
    </div>

    <div class="tier-display" id="tierDots"></div>

    <div class="court-wrapper">
        <div class="court-grid" id="courtGrid"></div>
    </div>

    <div class="division-display">
        <div class="division-badge" id="divisionBadge">L1 SLOW</div>
        <div class="sequence-counter" id="sequenceCounter">SEQ: 3</div>
        <div class="score-display" id="totalScore">0</div>
    </div>

    <button class="action-btn" id="actionBtn">
        <span class="lang-en">GO</span>
        <span class="lang-es">IR</span>
    </button>
</div>

<!-- Tier Up Overlay -->
<div class="overlay" id="tierupOverlay">
    <div class="overlay-card gold-border">
        <div class="overlay-emoji">üéâ</div>
        <h2 class="overlay-title gold" id="tierupTitle">
            <span class="lang-en">TIER UP!</span>
            <span class="lang-es">¬°SUBISTE!</span>
        </h2>
        <p class="overlay-message" id="tierupMessage"></p>
        <button class="overlay-btn gold" id="tierupBtn">
            <span class="lang-en">LET'S GO!</span>
            <span class="lang-es">¬°VAMOS!</span>
        </button>
    </div>
</div>

<!-- Upgrade Overlay -->
<div class="overlay" id="upgradeOverlay">
    <div class="overlay-card gold-border">
        <div class="overlay-emoji">üîì‚ö°</div>
        <h2 class="overlay-title gold">
            <span class="lang-en">UNLOCK ALL SPEEDS</span>
            <span class="lang-es">DESBLOQUEAR VELOCIDADES</span>
        </h2>
        <p class="overlay-message">
            <span class="lang-en">Upgrade to unlock <strong>MEDIUM</strong> and <strong>FAST</strong> speeds!</span>
            <span class="lang-es">¬°Actualiza para desbloquear velocidades <strong>MEDIO</strong> y <strong>R√ÅPIDO</strong>!</span>
        </p>
        <div class="upgrade-speed-preview">
            <span class="upgrade-speed-chip current">‚úì Slow</span>
            <span class="upgrade-speed-chip locked">üîí Med</span>
            <span class="upgrade-speed-chip locked">üîí Fast</span>
        </div>
        <div class="upgrade-price">$5<span>/mo</span></div>
        <a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="overlay-btn gold" style="display:block;text-decoration:none;margin-bottom:10px;">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </a>
        <button class="overlay-btn secondary" id="upgradeClose">
            <span class="lang-en">CONTINUE AT SLOW</span>
            <span class="lang-es">CONTINUAR LENTO</span>
        </button>
    </div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    var host = window.location.hostname;
    var isProduction = (host.indexOf('gotrotter') > -1 || host.indexOf('github.io') > -1);

    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('gt-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) {
            window.location.replace('index.html');
            return;
        }
        var sessionPin = sessionStorage.getItem('gt-pin');
        var sessionToken = sessionStorage.getItem('gt-token');
        function validateSession() {
            if (!sessionPin || !sessionToken) { window.location.href = 'index.html'; return; }
            fetch('/api/session/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: sessionPin, token: sessionToken })
            }).then(function(r) { return r.json(); }).then(function(d) {
                if (!d.valid) {
                    alert(d.message || 'Session ended.');
                    localStorage.removeItem('gt-user');
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            }).catch(function() {});
        }
        validateSession();
        setInterval(validateSession, 30000);
    }

    var currentLang = localStorage.getItem('gotrotter_lang') || 'en';
    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('gotrotter_lang', lang);
        document.body.className = lang;
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
        updateDivisionDisplay();
    }
    document.getElementById('btnEn').onclick = function() { setLang('en'); };
    document.getElementById('btnEs').onclick = function() { setLang('es'); };

    var speedAccess = { allSpeeds: false };
    try { var sa = localStorage.getItem('gt-speed-access'); if (sa) speedAccess = JSON.parse(sa); } catch(e) {}

    function initSpeedButtons() {
        document.querySelectorAll('.speed-btn').forEach(function(btn) {
            if (!speedAccess.allSpeeds && btn.dataset.speed !== 'slow') btn.classList.add('locked');
            else btn.classList.remove('locked');
        });
        if (!speedAccess.allSpeeds) {
            state.speed = 'slow';
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelector('.speed-btn[data-speed="slow"]').classList.add('active');
        }
    }

    function showUpgrade() { document.getElementById('upgradeOverlay').classList.add('show'); }
    document.getElementById('upgradeClose').onclick = function() { document.getElementById('upgradeOverlay').classList.remove('show'); };

    var TOTAL_CELLS = 16;
    var ROUNDS_PER_TIER = 3;
    var TOTAL_TIERS = 10;
    var LEVEL_BASE = { 1: 3, 2: 4, 3: 5, 4: 6, 5: 7 };
    var SPEED_CFG = { slow: { show: 800, gap: 300 }, med: { show: 500, gap: 200 }, fast: { show: 300, gap: 150 } };
    var LAUGH_EMOJIS = ['üòÇ', 'üòÜ', 'ü§£', 'üòÑ', 'üòÅ', 'ü•≥', 'üòä', 'üéâ'];
    var PARTY_EMOJIS = ['ü•≥', 'üéâ', 'üòÇ', 'ü§£', '‚ú®', 'üí´', 'üåü', 'üèÜ'];
    var CELL_EMOJIS = ['üòä', 'üòÑ', 'üòÅ', 'üòÜ', 'ü§£', 'üòÇ', 'ü•≥', 'üòÉ', 'üòÄ', 'üò∏', 'üòπ', 'ü§≠', 'üòè', 'üòå', 'üéâ', '‚ú®'];

    var state = {
        level: parseInt(localStorage.getItem('gt-seq-level')) || 1,
        speed: localStorage.getItem('gt-seq-speed') || 'slow',
        tier: parseInt(localStorage.getItem('gt-seq-tier')) || 1,
        score: parseInt(localStorage.getItem('gt-seq-score')) || 0,
        streak: parseInt(localStorage.getItem('gt-seq-streak')) || 0,
        roundsCompleted: 0,
        sequence: [],
        playerIndex: 0,
        isPlaying: false,
        canTap: false,
        cells: []
    };

    var courtGrid = document.getElementById('courtGrid');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var tierupOverlay = document.getElementById('tierupOverlay');
    var coachMessage = document.getElementById('coachMessage');
    var emojiContainer = document.getElementById('emojiContainer');

    function getCourtCenter() {
        var r = courtGrid.getBoundingClientRect();
        return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
    }

    function createBurstEmoji(emoji, x, y, type) {
        var el = document.createElement('div');
        el.className = 'burst-emoji' + (type ? ' ' + type : '');
        el.textContent = emoji;
        var angle = Math.random() * Math.PI * 2;
        var dist = 80 + Math.random() * 120;
        el.style.cssText = 'left:' + x + 'px;top:' + y + 'px;--tx:' + Math.cos(angle) * dist + 'px;--ty:' + Math.sin(angle) * dist + 'px;--rot:' + (Math.random() - 0.5) * 720 + 'deg';
        emojiContainer.appendChild(el);
        setTimeout(function() { if (el.parentNode) el.remove(); }, 2000);
    }

    function laughCelebration(intensity) {
        var center = getCourtCenter();
        var count = intensity === 'party' ? 12 : intensity === 'big' ? 8 : intensity === 'medium' ? 5 : 2;
        var emojis = intensity === 'party' ? PARTY_EMOJIS : LAUGH_EMOJIS;
        var type = intensity === 'party' ? 'party' : intensity === 'big' ? 'big' : '';
        for (var i = 0; i < count; i++) {
            (function(idx) {
                setTimeout(function() {
                    createBurstEmoji(emojis[Math.floor(Math.random() * emojis.length)], center.x + (Math.random() - 0.5) * 40, center.y + (Math.random() - 0.5) * 40, type);
                }, idx * 50);
            })(i);
        }
        courtGrid.classList.add('joy-pulse');
        setTimeout(function() { courtGrid.classList.remove('joy-pulse'); }, 500);
    }

    var audioCtx = null;
    function playTone(freq, dur) {
        if (!audioCtx) try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return; }
        try {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            var osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.value = freq;
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start(); osc.stop(audioCtx.currentTime + dur + 0.05);
        } catch(e) {}
    }
    var NOTES = [262, 294, 330, 349, 392, 440, 494, 523, 587, 659, 698, 784, 880, 988, 1047, 1175];
    function playNote(idx) { playTone(NOTES[idx % 16], 0.2); }
    function playSuccess() { [523, 659, 784].forEach(function(f, i) { setTimeout(function() { playTone(f, 0.12); }, i * 80); }); }
    function playError() { playTone(200, 0.3); }

    function initCourt() {
        courtGrid.innerHTML = '';
        state.cells = [];
        for (var i = 0; i < TOTAL_CELLS; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.index = i;
            cell.textContent = CELL_EMOJIS[i];
            cell.onclick = function() { handleTap(parseInt(this.dataset.index)); };
            courtGrid.appendChild(cell);
            state.cells.push(cell);
        }
    }

    function renderTierDots() {
        var c = document.getElementById('tierDots');
        c.innerHTML = '';
        for (var i = 1; i <= TOTAL_TIERS; i++) {
            var d = document.createElement('div');
            d.className = 'tier-dot' + (i < state.tier ? ' completed' : '') + (i === state.tier ? ' current' : '');
            c.appendChild(d);
        }
    }

    function getSeqLen() { return LEVEL_BASE[state.level] + (state.tier - 1); }

    function updateDivisionDisplay() {
        var sp = state.speed.toUpperCase();
        if (currentLang === 'es') sp = state.speed === 'slow' ? 'LENTO' : state.speed === 'med' ? 'MEDIO' : 'R√ÅPIDO';
        document.getElementById('divisionBadge').textContent = 'L' + state.level + ' ' + sp;
        document.getElementById('sequenceCounter').textContent = 'SEQ: ' + getSeqLen();
    }

    function updateStats() {
        document.getElementById('tierDisplay').textContent = state.tier;
        document.getElementById('roundDisplay').textContent = state.roundsCompleted + '/' + ROUNDS_PER_TIER;
        document.getElementById('streakDisplay').textContent = state.streak;
        document.getElementById('scoreDisplay').textContent = state.score;
        document.getElementById('totalScore').textContent = state.score;
        renderTierDots();
    }

    function showCoach(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2000);
    }

    function generateSequence() {
        var len = getSeqLen(), avail = [];
        for (var i = 0; i < TOTAL_CELLS; i++) avail.push(i);
        for (var j = avail.length - 1; j > 0; j--) { var k = Math.floor(Math.random() * (j + 1)); var t = avail[j]; avail[j] = avail[k]; avail[k] = t; }
        return avail.slice(0, len);
    }

    function playSequence(cb) {
        var cfg = SPEED_CFG[state.speed], i = 0;
        function next() {
            if (i > 0) state.cells[state.sequence[i - 1]].classList.remove('lit');
            if (i < state.sequence.length) {
                state.cells[state.sequence[i]].classList.add('lit');
                playNote(state.sequence[i]);
                i++;
                setTimeout(next, cfg.show + cfg.gap);
            } else setTimeout(cb, 300);
        }
        next();
    }

    function startRound() {
        if (state.isPlaying) return;
        state.isPlaying = true;
        state.canTap = false;
        state.playerIndex = 0;
        actionBtn.disabled = true;
        state.cells.forEach(function(c) { c.classList.remove('lit', 'correct', 'wrong', 'player-tap'); });
        state.sequence = generateSequence();
        messageText.innerHTML = '<span class="lang-en">WATCH THE SEQUENCE...</span><span class="lang-es">MIRA LA SECUENCIA...</span>';
        messageText.className = 'message-text watch';
        setTimeout(function() {
            playSequence(function() {
                messageText.innerHTML = '<span class="lang-en">YOUR TURN! TAP THE SEQUENCE</span><span class="lang-es">¬°TU TURNO! REPITE LA SECUENCIA</span>';
                messageText.className = 'message-text go';
                state.canTap = true;
            });
        }, 500);
    }

    function handleTap(idx) {
        if (!state.canTap || !state.isPlaying) return;
        var cell = state.cells[idx];
        cell.classList.add('player-tap');
        playNote(idx);
        setTimeout(function() { cell.classList.remove('player-tap'); }, 200);

        if (idx === state.sequence[state.playerIndex]) {
            cell.classList.add('correct');
            state.playerIndex++;
            if (state.playerIndex > 2) laughCelebration('small');
            if (state.playerIndex >= state.sequence.length) {
                state.canTap = false;
                roundComplete(true);
            }
        } else {
            cell.classList.add('wrong');
            playError();
            state.canTap = false;
            setTimeout(function() {
                state.sequence.forEach(function(i) { state.cells[i].classList.add('correct'); });
            }, 400);
            setTimeout(function() { roundComplete(false); }, 1500);
        }
    }

    function roundComplete(success) {
        state.isPlaying = false;
        if (success) {
            var pts = state.sequence.length * 10 * state.level * (state.speed === 'fast' ? 3 : state.speed === 'med' ? 2 : 1);
            state.score += pts;
            state.streak++;
            state.roundsCompleted++;
            localStorage.setItem('gt-seq-score', state.score);
            localStorage.setItem('gt-seq-streak', state.streak);
            var intensity = state.streak >= 5 ? 'party' : state.streak >= 3 ? 'big' : 'medium';
            var msgs = state.streak >= 5 ? ['üéâ LEGENDARY!', 'üèÜ UNSTOPPABLE!'] : state.streak >= 3 ? ['üòÇ ON FIRE!', 'ü§£ CRUSHING IT!'] : ['üòÑ NICE!', 'üòä GREAT!'];
            playSuccess();
            laughCelebration(intensity);
            showCoach(msgs[Math.floor(Math.random() * msgs.length)]);
            updateStats();
            if (state.roundsCompleted >= ROUNDS_PER_TIER) {
                setTimeout(function() { state.tier < TOTAL_TIERS ? tierUp() : maxTier(); }, 800);
            } else setTimeout(resetRound, 1000);
        } else {
            state.streak = 0;
            localStorage.setItem('gt-seq-streak', 0);
            updateStats();
            messageText.innerHTML = '<span class="lang-en">WRONG SEQUENCE!</span><span class="lang-es">¬°SECUENCIA INCORRECTA!</span>';
            messageText.className = 'message-text error';
            setTimeout(resetRound, 1500);
        }
    }

    function tierUp() {
        state.tier++;
        state.roundsCompleted = 0;
        localStorage.setItem('gt-seq-tier', state.tier);
        laughCelebration('party');
        document.getElementById('tierupMessage').innerHTML = currentLang === 'es' ? '¬°Tier ' + state.tier + ' desbloqueado!' : 'Tier ' + state.tier + ' unlocked!';
        tierupOverlay.classList.add('show');
        updateStats();
        updateDivisionDisplay();
    }

    function maxTier() {
        state.roundsCompleted = 0;
        document.getElementById('tierupMessage').innerHTML = currentLang === 'es' ? '¬°TIER M√ÅXIMO! ¬°Eres un maestro!' : 'MAX TIER! You\'re a master!';
        document.querySelector('#tierupOverlay .overlay-emoji').textContent = 'üëë';
        tierupOverlay.classList.add('show');
        updateStats();
    }

    document.getElementById('tierupBtn').onclick = function() {
        tierupOverlay.classList.remove('show');
        document.querySelector('#tierupOverlay .overlay-emoji').textContent = 'üéâ';
        resetRound();
    };

    function resetRound() {
        state.cells.forEach(function(c) { c.classList.remove('lit', 'correct', 'wrong', 'player-tap'); });
        var msg = currentLang === 'es' ? '¬°Ronda ' + (state.roundsCompleted + 1) + '/' + ROUNDS_PER_TIER + '!' : 'Round ' + (state.roundsCompleted + 1) + '/' + ROUNDS_PER_TIER + '!';
        messageText.innerHTML = '<span>' + msg + '</span>';
        messageText.className = 'message-text';
        actionBtn.disabled = false;
        updateStats();
    }

    document.querySelectorAll('[data-level]').forEach(function(btn) {
        btn.onclick = function() {
            if (state.isPlaying) return;
            document.querySelectorAll('[data-level]').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.level = parseInt(btn.dataset.level);
            state.tier = 1;
            state.roundsCompleted = 0;
            localStorage.setItem('gt-seq-level', state.level);
            localStorage.setItem('gt-seq-tier', 1);
            updateDivisionDisplay();
            updateStats();
        };
    });

    document.querySelectorAll('.speed-btn').forEach(function(btn) {
        btn.onclick = function() {
            if (state.isPlaying) return;
            if (!speedAccess.allSpeeds && btn.dataset.speed !== 'slow') { showUpgrade(); return; }
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.speed = btn.dataset.speed;
            state.tier = 1;
            state.roundsCompleted = 0;
            localStorage.setItem('gt-seq-speed', state.speed);
            localStorage.setItem('gt-seq-tier', 1);
            updateDivisionDisplay();
            updateStats();
        };
    });

    actionBtn.onclick = startRound;

    function loadState() {
        var sl = localStorage.getItem('gt-seq-level');
        if (sl) { state.level = parseInt(sl); document.querySelectorAll('[data-level]').forEach(function(b) { b.classList.remove('active'); }); var lb = document.querySelector('[data-level="' + state.level + '"]'); if (lb) lb.classList.add('active'); }
        var ss = localStorage.getItem('gt-seq-speed');
        if (ss && (speedAccess.allSpeeds || ss === 'slow')) { state.speed = ss; document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); }); var sb = document.querySelector('.speed-btn[data-speed="' + state.speed + '"]'); if (sb) sb.classList.add('active'); }
    }

    initCourt();
    initSpeedButtons();
    loadState();
    setLang(currentLang);
    updateDivisionDisplay();
    updateStats();
    renderTierDots();
})();
</script>
</body>
</html>
