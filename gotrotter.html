<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>GoTrotter | The Cognitive Sport</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B35;
    --gold: #FFD700;
    --teal: #00D9A5;
    --pink: #FF1493;
    --purple: #9D4EDD;
    --dark: #1A1A1A;
    --card: #111118;
    --hardwood: #C4935A;
    --hardwood-dark: #8B6914;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.1);
    --green: #4CAF50;
    --red: #F44336;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { height: 100%; overflow: hidden; }
body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

/* MOBILE-FIRST PERFECT FIT */
.game-container {
    width: 100%;
    max-width: 420px;
    height: 100vh;
    height: 100dvh;
    margin: 0 auto;
    padding: 6px 10px;
    padding-top: max(6px, env(safe-area-inset-top));
    padding-bottom: max(6px, env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    text-align: center;
    padding: 2px 0;
    flex-shrink: 0;
}
.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 2px;
}
.logo .go { color: var(--text); }
.logo .trotter { color: var(--orange); }
.tagline {
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
}

.stats-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding: 6px 10px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.stat { text-align: center; }
.stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--gold);
    line-height: 1;
}
.stat-label {
    font-size: 0.45rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.message-display {
    background: var(--card);
    border: 2px solid var(--orange);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 4px;
    text-align: center;
    flex-shrink: 0;
}
.message-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--text);
}
.message-text.watch { color: var(--gold); }
.message-text.go { color: var(--teal); }

/* DIVISION SELECTORS */
.selectors-row {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
    flex-shrink: 0;
}
.selector-group {
    flex: 1;
    background: var(--card);
    border-radius: 8px;
    padding: 6px;
}
.selector-label {
    text-align: center;
    font-size: 0.5rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
}
.selector-options {
    display: flex;
    gap: 3px;
}
.selector-btn {
    flex: 1;
    padding: 6px 2px;
    border: 2px solid var(--border);
    background: transparent;
    border-radius: 6px;
    color: var(--muted);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.selector-btn.active {
    border-color: var(--orange);
    color: var(--orange);
    background: rgba(255,107,53,0.1);
}
.selector-btn.locked {
    opacity: 0.5;
    cursor: pointer;
}
.selector-btn.locked::after {
    content: 'üîí';
    position: absolute;
    top: -2px;
    right: 2px;
    font-size: 0.5rem;
}

/* COURT GRID - 40vh MOBILE PERFECT FIT */
.court-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    overflow: hidden;
    position: relative;
}
.court-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    padding: 8px;
    background: 
        repeating-linear-gradient(
            90deg,
            var(--hardwood) 0px,
            var(--hardwood) 15px,
            var(--hardwood-dark) 15px,
            var(--hardwood-dark) 30px
        );
    border-radius: 12px;
    border: 3px solid var(--text);
    width: 100%;
    height: 100%;
    max-width: min(100%, 40vh);
    max-height: 40vh;
    aspect-ratio: 1;
    position: relative;
}
/* Court center circle */
.court-grid::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 50px;
    height: 50px;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
}
/* Court half line */
.court-grid::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: rgba(255,255,255,0.2);
    pointer-events: none;
}

.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    background: rgba(255,255,255,0.1);
    border: 3px solid transparent;
    position: relative;
}
/* Rainbow Row Borders */
.grid-cell:nth-child(-n+5) { border-color: #FF6B6B; }
.grid-cell:nth-child(n+6):nth-child(-n+10) { border-color: #FFE66D; }
.grid-cell:nth-child(n+11):nth-child(-n+15) { border-color: #4ECDC4; }
.grid-cell:nth-child(n+16):nth-child(-n+20) { border-color: #45B7D1; }
.grid-cell:nth-child(n+21) { border-color: #96CEB4; }

/* Center cell special styling */
.grid-cell.center {
    background: rgba(0,0,0,0.4);
    border: 3px solid var(--text);
    cursor: default;
}
.grid-cell:active:not(.disabled):not(.center) { transform: scale(0.95); }
.grid-cell.disabled { pointer-events: none; opacity: 0.6; }

/* Game Colors */
.color-red { background: #E53935 !important; }
.color-blue { background: #1E88E5 !important; }
.color-green { background: #43A047 !important; }
.color-yellow { background: #FDD835 !important; }
.color-purple { background: #8E24AA !important; }
.color-orange { background: #FB8C00 !important; }
.color-pink { background: #EC407A !important; }
.color-teal { background: #26A69A !important; }

.grid-cell.correct {
    animation: pulse 0.3s;
    box-shadow: 0 0 20px var(--teal);
}
.grid-cell.wrong {
    animation: shake 0.3s;
    box-shadow: 0 0 20px var(--pink);
}
.grid-cell.revealed {
    border: 3px solid var(--gold) !important;
    box-shadow: 0 0 15px var(--gold);
}
@keyframes pulse { 50% { transform: scale(1.1); } }
@keyframes shake { 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

.division-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 12px;
    background: var(--card);
    border-radius: 8px;
    margin: 4px 0;
    flex-shrink: 0;
}
.division-badge {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    color: var(--orange);
}
.matches-counter {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    color: var(--teal);
}
.score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.2rem;
    color: var(--gold);
}

.action-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 4px;
    cursor: pointer;
    transition: all 0.2s;
    background: linear-gradient(135deg, var(--orange), #FF8C00);
    color: var(--dark);
    flex-shrink: 0;
    margin-top: 4px;
}
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.action-btn:active:not(:disabled) { transform: scale(0.98); }

/* ==================== LAUGH EMOJI CELEBRATION ==================== */
.emoji-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 999;
    overflow: hidden;
}

.burst-emoji {
    position: absolute;
    font-size: 2rem;
    animation: emojiBurst 1.2s ease-out forwards;
    pointer-events: none;
    z-index: 1000;
}

@keyframes emojiBurst {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.3);
    }
    20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0.8) rotate(var(--rot));
    }
}

/* Big celebration burst */
.burst-emoji.big {
    font-size: 3rem;
    animation: emojiBurstBig 1.5s ease-out forwards;
}

@keyframes emojiBurstBig {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.2);
    }
    15% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.5);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(1) rotate(var(--rot));
    }
}

/* Party mode - extra special */
.burst-emoji.party {
    font-size: 2.5rem;
    animation: emojiParty 2s ease-out forwards;
}

@keyframes emojiParty {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0);
    }
    10% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.8);
    }
    30% {
        opacity: 1;
        transform: translate(calc(var(--tx) * 0.3), calc(var(--ty) * 0.3)) scale(1.3);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0.5) rotate(var(--rot));
    }
}

/* Joy pulse on court after celebration */
.court-grid.joy-pulse {
    animation: joyPulse 0.5s ease-out;
}

@keyframes joyPulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
    50% { box-shadow: 0 0 30px 10px rgba(255, 215, 0, 0.4); }
    100% { box-shadow: none; }
}

/* OVERLAYS */
.feedback-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}
.feedback-overlay.show { display: flex; }
.feedback-card {
    background: var(--card);
    border: 2px solid var(--orange);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 320px;
    width: 100%;
}
.feedback-emoji { font-size: 3rem; margin-bottom: 10px; }
.feedback-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    letter-spacing: 3px;
    margin-bottom: 8px;
}
.feedback-title.success { color: var(--teal); }
.feedback-title.fail { color: var(--pink); }
.feedback-message { color: var(--muted); margin-bottom: 15px; font-size: 0.9rem; }
.feedback-stats { display: flex; justify-content: center; gap: 25px; margin-bottom: 15px; }
.feedback-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--gold); }
.feedback-stat-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; }
.feedback-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    cursor: pointer;
    margin: 5px;
}
.feedback-btn.primary { background: linear-gradient(135deg, var(--orange), #FF8C00); color: var(--dark); }
.feedback-btn.secondary { background: transparent; color: var(--muted); border: 1px solid var(--muted); }

/* UPGRADE OVERLAY */
.upgrade-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 20px;
}
.upgrade-overlay.show { display: flex; }
.upgrade-card {
    background: linear-gradient(145deg, var(--card), #0a0a12);
    border: 2px solid var(--gold);
    border-radius: 20px;
    padding: 25px 20px;
    text-align: center;
    max-width: 320px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(255,215,0,0.2);
}
.upgrade-icon { font-size: 2.5rem; margin-bottom: 12px; }
.upgrade-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 3px;
    color: var(--gold);
    margin-bottom: 8px;
}
.upgrade-text {
    color: var(--muted);
    font-size: 0.85rem;
    line-height: 1.5;
    margin-bottom: 15px;
}
.upgrade-text strong { color: var(--text); }
.upgrade-speed-preview {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 15px;
}
.upgrade-speed-chip {
    padding: 6px 12px;
    border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 1px;
}
.upgrade-speed-chip.current {
    background: rgba(0,217,165,0.2);
    color: var(--teal);
    border: 1px solid var(--teal);
}
.upgrade-speed-chip.locked {
    background: rgba(255,215,0,0.15);
    color: var(--gold);
    border: 1px solid var(--gold);
}
.upgrade-price {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 5px;
}
.upgrade-price span { font-size: 0.9rem; color: var(--muted); }
.upgrade-btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--gold), #FFA500);
    color: var(--dark);
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    text-decoration: none;
    margin-bottom: 10px;
}
.upgrade-close {
    background: transparent;
    border: 1px solid var(--muted);
    color: var(--muted);
    padding: 8px 20px;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 1px;
    cursor: pointer;
}

.coach-message {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: linear-gradient(135deg, var(--orange), var(--gold));
    color: var(--dark);
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    opacity: 0;
    transition: all 0.3s;
    z-index: 50;
    white-space: nowrap;
}
.coach-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Language & Navigation */
.lang-toggle {
    position: fixed;
    top: 8px;
    right: 10px;
    display: flex;
    gap: 4px;
    z-index: 100;
}
.lang-btn {
    padding: 4px 10px;
    border: 1px solid var(--muted);
    background: transparent;
    color: var(--muted);
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    cursor: pointer;
}
.lang-btn.active { border-color: var(--gold); color: var(--gold); }

.back-btn {
    position: fixed;
    top: 8px;
    left: 10px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 12px;
    color: var(--muted);
    font-size: 0.7rem;
    cursor: pointer;
    text-decoration: none;
    z-index: 100;
}

/* Language visibility */
body.en .lang-es { display: none !important; }
body.es .lang-en { display: none !important; }

/* LARGER SCREENS */
@media (min-height: 750px) {
    .game-container { padding: 10px 15px; }
    .logo { font-size: 2rem; }
    .stats-bar { padding: 8px 12px; }
    .stat-value { font-size: 1.2rem; }
    .message-display { padding: 10px; }
    .message-text { font-size: 1.1rem; }
    .court-grid { gap: 5px; padding: 10px; }
    .action-btn { padding: 16px; font-size: 1.4rem; }
}

/* VERY SHORT SCREENS */
@media (max-height: 600px) {
    .game-container { padding: 4px 8px; }
    .logo { font-size: 1.5rem; }
    .tagline { font-size: 0.45rem; }
    .stats-bar { padding: 4px 6px; gap: 10px; margin: 3px 0; }
    .stat-value { font-size: 0.9rem; }
    .message-display { padding: 5px; margin-bottom: 3px; }
    .message-text { font-size: 0.85rem; }
    .selectors-row { gap: 5px; margin-bottom: 3px; }
    .selector-group { padding: 4px; }
    .selector-btn { padding: 5px 2px; font-size: 0.8rem; }
    .court-grid { padding: 6px; gap: 3px; }
    .grid-cell { border-width: 2px; border-radius: 5px; }
    .division-display { padding: 4px 10px; margin: 3px 0; }
    .action-btn { padding: 10px; font-size: 1.1rem; }
    .burst-emoji { font-size: 1.5rem; }
    .burst-emoji.big { font-size: 2rem; }
}
</style>
</head>
<body class="en">

<div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
</div>

<a href="index.html" class="back-btn">
    <span class="lang-en">‚Üê Home</span>
    <span class="lang-es">‚Üê Inicio</span>
</a>

<!-- Emoji Celebration Container -->
<div class="emoji-container" id="emojiContainer"></div>

<div class="game-container">
    <header class="header">
        <div class="logo"><span class="go">GO</span><span class="trotter">TROTTER</span></div>
        <div class="tagline">
            <span class="lang-en">The Cognitive Sport</span>
            <span class="lang-es">El Deporte Cognitivo</span>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-value" id="circuitNum">1</div>
            <div class="stat-label">
                <span class="lang-en">Circuit</span>
                <span class="lang-es">Circuito</span>
            </div>
        </div>
        <div class="stat">
            <div class="stat-value" id="playsDisplay">0/5</div>
            <div class="stat-label">
                <span class="lang-en">Plays</span>
                <span class="lang-es">Jugadas</span>
            </div>
        </div>
        <div class="stat">
            <div class="stat-value" id="streakDisplay">0</div>
            <div class="stat-label">üî•</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="scoreDisplay">0</div>
            <div class="stat-label">
                <span class="lang-en">Score</span>
                <span class="lang-es">Puntos</span>
            </div>
        </div>
    </div>

    <div class="message-display">
        <span class="message-text" id="messageText">
            <span class="lang-en">Select division & GO!</span>
            <span class="lang-es">¬°Selecciona divisi√≥n e IR!</span>
        </span>
    </div>

    <div class="selectors-row">
        <div class="selector-group">
            <div class="selector-label">
                <span class="lang-en">Level</span>
                <span class="lang-es">Nivel</span>
            </div>
            <div class="selector-options">
                <button class="selector-btn active" data-level="1">1</button>
                <button class="selector-btn" data-level="2">2</button>
                <button class="selector-btn" data-level="3">3</button>
                <button class="selector-btn" data-level="4">4</button>
                <button class="selector-btn" data-level="5">5</button>
            </div>
        </div>
        <div class="selector-group">
            <div class="selector-label">
                <span class="lang-en">Speed</span>
                <span class="lang-es">Velocidad</span>
            </div>
            <div class="selector-options">
                <button class="selector-btn speed-btn active" data-speed="slow">
                    <span class="lang-en">Slow</span>
                    <span class="lang-es">Lento</span>
                </button>
                <button class="selector-btn speed-btn" data-speed="med">
                    <span class="lang-en">Med</span>
                    <span class="lang-es">Med</span>
                </button>
                <button class="selector-btn speed-btn" data-speed="fast">
                    <span class="lang-en">Fast</span>
                    <span class="lang-es">R√°pido</span>
                </button>
            </div>
        </div>
    </div>

    <div class="court-wrapper">
        <div class="court-grid" id="courtGrid"></div>
    </div>

    <div class="division-display">
        <div class="division-badge" id="divisionBadge">L1 SLOW</div>
        <div class="matches-counter" id="matchesCounter">0/1</div>
        <div class="score-display" id="totalScore">0</div>
    </div>

    <button class="action-btn" id="actionBtn">
        <span class="lang-en">GO</span>
        <span class="lang-es">IR</span>
    </button>
</div>

<!-- Circuit Complete Modal -->
<div class="feedback-overlay" id="feedbackOverlay">
    <div class="feedback-card">
        <div class="feedback-emoji" id="feedbackEmoji">üèÜ</div>
        <h2 class="feedback-title" id="feedbackTitle">
            <span class="lang-en">CIRCUIT COMPLETE!</span>
            <span class="lang-es">¬°CIRCUITO COMPLETO!</span>
        </h2>
        <p class="feedback-message" id="feedbackMessage"></p>
        <div class="feedback-stats">
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackScore">0</div>
                <div class="feedback-stat-label">
                    <span class="lang-en">Score</span>
                    <span class="lang-es">Puntos</span>
                </div>
            </div>
            <div class="feedback-stat">
                <div class="feedback-stat-value" id="feedbackStreak">0</div>
                <div class="feedback-stat-label">
                    <span class="lang-en">Streak</span>
                    <span class="lang-es">Racha</span>
                </div>
            </div>
        </div>
        <button class="feedback-btn primary" id="nextCircuitBtn">
            <span class="lang-en">NEXT CIRCUIT</span>
            <span class="lang-es">SIGUIENTE</span>
        </button>
        <button class="feedback-btn secondary" id="changeDivisionBtn">
            <span class="lang-en">CHANGE DIVISION</span>
            <span class="lang-es">CAMBIAR</span>
        </button>
    </div>
</div>

<!-- Upgrade Modal -->
<div class="upgrade-overlay" id="upgradeOverlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">üîì‚ö°</div>
        <h2 class="upgrade-title">
            <span class="lang-en">UNLOCK ALL SPEEDS</span>
            <span class="lang-es">DESBLOQUEAR VELOCIDADES</span>
        </h2>
        <p class="upgrade-text">
            <span class="lang-en">You're training at <strong>SLOW</strong> speed. Upgrade to unlock <strong>MEDIUM</strong> and <strong>FAST</strong> for maximum brain training!</span>
            <span class="lang-es">Est√°s entrenando en <strong>LENTO</strong>. ¬°Actualiza para desbloquear <strong>MEDIO</strong> y <strong>R√ÅPIDO</strong> para m√°ximo entrenamiento!</span>
        </p>
        <div class="upgrade-speed-preview">
            <span class="upgrade-speed-chip current">‚úì Slow</span>
            <span class="upgrade-speed-chip locked">üîí Med</span>
            <span class="upgrade-speed-chip locked">üîí Fast</span>
        </div>
        <div class="upgrade-price">$5<span>/mo</span></div>
        <a href="https://buy.stripe.com/9B6bJ2c9i1qy0Qrbqh00005" class="upgrade-btn" id="upgradeBtn">
            <span class="lang-en">UPGRADE NOW üöÄ</span>
            <span class="lang-es">ACTUALIZAR üöÄ</span>
        </a>
        <button class="upgrade-close" id="upgradeClose">
            <span class="lang-en">CONTINUE AT SLOW</span>
            <span class="lang-es">CONTINUAR LENTO</span>
        </button>
    </div>
</div>

<div class="coach-message" id="coachMessage"></div>

<script>
(function() {
    // ==================== ENVIRONMENT DETECTION ====================
    var host = window.location.hostname;
    var isProduction = (host.indexOf('gotrotter') > -1 || host.indexOf('github.io') > -1);
    var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '');
    var isPreview = !isProduction && !isLocal;

    // ==================== PRODUCTION AUTH & HEARTBEAT ====================
    if (isProduction) {
        var user = null;
        try { user = JSON.parse(localStorage.getItem('gt-user')); } catch(e) {}
        if (!user || !user.pin || user.pin.length < 4) {
            window.location.replace('index.html');
            return;
        }

        var sessionPin = sessionStorage.getItem('gt-pin');
        var sessionToken = sessionStorage.getItem('gt-token');

        function validateSession() {
            if (!sessionPin || !sessionToken) {
                window.location.href = 'index.html';
                return;
            }
            fetch('/api/session/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: sessionPin, token: sessionToken })
            })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.valid) {
                    alert(d.message || 'Session ended. Please log in again.');
                    localStorage.removeItem('gt-user');
                    localStorage.removeItem('gt-speed-access');
                    sessionStorage.removeItem('gt-pin');
                    sessionStorage.removeItem('gt-token');
                    window.location.href = 'index.html';
                }
            })
            .catch(function(err) {
                console.log('Session validation error:', err);
            });
        }

        validateSession();
        setInterval(validateSession, 30000);
    }
    // ==================== END PRODUCTION AUTH & HEARTBEAT ====================

    // ==================== LANGUAGE ====================
    var currentLang = localStorage.getItem('gotrotter_lang') || 'en';

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('gotrotter_lang', lang);
        document.body.className = lang;
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
        updateDivisionDisplay();
    }

    document.getElementById('btnEn').addEventListener('click', function() { setLang('en'); });
    document.getElementById('btnEs').addEventListener('click', function() { setLang('es'); });

    // ==================== SPEED ACCESS (FREEMIUM) ====================
    var speedAccess = { allSpeeds: false, userType: 'guest' };
    try {
        var storedAccess = localStorage.getItem('gt-speed-access');
        if (storedAccess) speedAccess = JSON.parse(storedAccess);
    } catch(e) {}

    function initSpeedButtons() {
        var speedBtns = document.querySelectorAll('.speed-btn');
        speedBtns.forEach(function(btn) {
            var speed = btn.dataset.speed;
            if (!speedAccess.allSpeeds && speed !== 'slow') {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        });
        // Force slow if not subscribed
        if (!speedAccess.allSpeeds) {
            state.speed = 'slow';
            speedBtns.forEach(function(b) { b.classList.remove('active'); });
            document.querySelector('.speed-btn[data-speed="slow"]').classList.add('active');
        }
    }

    function showUpgradeModal() { document.getElementById('upgradeOverlay').classList.add('show'); }
    function hideUpgradeModal() { document.getElementById('upgradeOverlay').classList.remove('show'); }
    document.getElementById('upgradeClose').addEventListener('click', hideUpgradeModal);

    // ==================== GAME CONFIG ====================
    var COLORS = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'];
    var LEVEL_CONFIG = {
        1: { matches: 1, distractors: 3 },
        2: { matches: 2, distractors: 4 },
        3: { matches: 3, distractors: 5 },
        4: { matches: 4, distractors: 6 },
        5: { matches: 5, distractors: 7 }
    };
    var SPEED_CONFIG = {
        slow: 2500,
        med: 1500,
        fast: 800
    };
    var PLAYS_PER_CIRCUIT = 5;
    var CENTER_CELL = 12;

    // ==================== LAUGH EMOJI CONFIG ====================
    var LAUGH_EMOJIS = ['üòÇ', 'üòÜ', 'ü§£', 'üòÑ', 'üòÅ', 'ü•≥', 'üòä', 'üéâ'];
    var PARTY_EMOJIS = ['ü•≥', 'üéâ', 'üòÇ', 'ü§£', '‚ú®', 'üí´', 'üåü', 'üèÜ'];

    // ==================== GAME STATE ====================
    var state = {
        level: parseInt(localStorage.getItem('gt-level')) || 1,
        speed: localStorage.getItem('gt-speed') || 'slow',
        score: parseInt(localStorage.getItem('gt-score')) || 0,
        circuitNum: 1,
        playsCompleted: 0,
        streak: parseInt(localStorage.getItem('gt-streak')) || 0,
        matchesFound: 0,
        matchesNeeded: 1,
        targetColor: '',
        matchCells: [],
        isPlaying: false,
        canTap: false,
        cells: []
    };

    // ==================== DOM ELEMENTS ====================
    var courtGrid = document.getElementById('courtGrid');
    var messageText = document.getElementById('messageText');
    var actionBtn = document.getElementById('actionBtn');
    var feedbackOverlay = document.getElementById('feedbackOverlay');
    var coachMessage = document.getElementById('coachMessage');
    var emojiContainer = document.getElementById('emojiContainer');

    // ==================== LAUGH EMOJI CELEBRATION SYSTEM ====================
    function getCourtCenter() {
        var courtRect = courtGrid.getBoundingClientRect();
        return {
            x: courtRect.left + courtRect.width / 2,
            y: courtRect.top + courtRect.height / 2
        };
    }

    function createBurstEmoji(emoji, x, y, type) {
        var el = document.createElement('div');
        el.className = 'burst-emoji' + (type ? ' ' + type : '');
        el.textContent = emoji;
        
        // Random burst direction
        var angle = Math.random() * Math.PI * 2;
        var distance = 80 + Math.random() * 120;
        var tx = Math.cos(angle) * distance + 'px';
        var ty = Math.sin(angle) * distance + 'px';
        var rot = (Math.random() - 0.5) * 720 + 'deg';
        
        el.style.cssText = 
            'left:' + x + 'px;' +
            'top:' + y + 'px;' +
            '--tx:' + tx + ';' +
            '--ty:' + ty + ';' +
            '--rot:' + rot + ';';
        
        emojiContainer.appendChild(el);
        
        // Clean up after animation
        setTimeout(function() {
            if (el.parentNode) el.parentNode.removeChild(el);
        }, type === 'party' ? 2000 : 1500);
    }

    function laughCelebration(intensity) {
        // intensity: 'small' (1 match), 'medium' (found all), 'big' (streak 3+), 'party' (perfect circuit/streak 5+)
        var center = getCourtCenter();
        var count, emojis, type;
        
        switch(intensity) {
            case 'small':
                count = 2;
                emojis = LAUGH_EMOJIS;
                type = '';
                break;
            case 'medium':
                count = 5;
                emojis = LAUGH_EMOJIS;
                type = '';
                break;
            case 'big':
                count = 8;
                emojis = LAUGH_EMOJIS;
                type = 'big';
                break;
            case 'party':
                count = 12;
                emojis = PARTY_EMOJIS;
                type = 'party';
                break;
            default:
                count = 3;
                emojis = LAUGH_EMOJIS;
                type = '';
        }
        
        // Stagger the emoji spawns for better visual effect
        for (var i = 0; i < count; i++) {
            (function(index) {
                setTimeout(function() {
                    var emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    // Slight position variation
                    var offsetX = (Math.random() - 0.5) * 40;
                    var offsetY = (Math.random() - 0.5) * 40;
                    createBurstEmoji(emoji, center.x + offsetX, center.y + offsetY, type);
                }, index * 50);
            })(i);
        }
        
        // Add joy pulse to court
        courtGrid.classList.add('joy-pulse');
        setTimeout(function() {
            courtGrid.classList.remove('joy-pulse');
        }, 500);
    }

    // ==================== AUDIO ====================
    var audioCtx = null;
    function getAudioContext() {
        if (!audioCtx) {
            try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } 
            catch(e) { return null; }
        }
        return audioCtx;
    }

    function playCorrectSound() {
        var ctx = getAudioContext();
        if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 880;
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.2);
        } catch(e) {}
    }

    function playSuccessSound() {
        var ctx = getAudioContext();
        if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            [523, 659, 784].forEach(function(freq, i) {
                setTimeout(function() {
                    var osc = ctx.createOscillator();
                    var gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    gain.gain.setValueAtTime(0.25, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.15);
                }, i * 80);
            });
        } catch(e) {}
    }

    function playErrorSound() {
        var ctx = getAudioContext();
        if (!ctx) return;
        try {
            if (ctx.state === 'suspended') ctx.resume();
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = 200;
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
        } catch(e) {}
    }

    // ==================== INIT COURT ====================
    function initCourt() {
        courtGrid.innerHTML = '';
        state.cells = [];
        for (var i = 0; i < 25; i++) {
            var cell = document.createElement('div');
            cell.className = 'grid-cell' + (i === CENTER_CELL ? ' center' : '');
            cell.dataset.index = i;
            if (i !== CENTER_CELL) {
                cell.addEventListener('click', function() { handleCellTap(parseInt(this.dataset.index)); });
            }
            courtGrid.appendChild(cell);
            state.cells.push(cell);
        }
    }

    function shuffleArray(arr) {
        for (var i = arr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = arr[i];
            arr[i] = arr[j];
            arr[j] = temp;
        }
    }

    // ==================== UPDATE DISPLAYS ====================
    function updateDivisionDisplay() {
        var speedText = state.speed.toUpperCase();
        if (currentLang === 'es') {
            speedText = state.speed === 'slow' ? 'LENTO' : state.speed === 'med' ? 'MEDIO' : 'R√ÅPIDO';
        }
        document.getElementById('divisionBadge').textContent = 'L' + state.level + ' ' + speedText;
        state.matchesNeeded = LEVEL_CONFIG[state.level].matches;
        updateMatchesDisplay();
    }

    function updateMatchesDisplay() {
        document.getElementById('matchesCounter').textContent = state.matchesFound + '/' + state.matchesNeeded;
    }

    function updateStats() {
        document.getElementById('circuitNum').textContent = state.circuitNum;
        document.getElementById('playsDisplay').textContent = state.playsCompleted + '/' + PLAYS_PER_CIRCUIT;
        document.getElementById('streakDisplay').textContent = state.streak;
        document.getElementById('scoreDisplay').textContent = state.score;
        document.getElementById('totalScore').textContent = state.score;
    }

    function showCoach(msg) {
        coachMessage.textContent = msg;
        coachMessage.classList.add('show');
        setTimeout(function() { coachMessage.classList.remove('show'); }, 2000);
    }

    // ==================== START PLAY ====================
    function startPlay() {
        if (state.isPlaying) return;
        state.isPlaying = true;
        state.canTap = false;
        state.matchesFound = 0;
        state.matchCells = [];
        updateMatchesDisplay();

        actionBtn.disabled = true;
        messageText.innerHTML = '<span class="lang-en">WATCH THE COURT...</span><span class="lang-es">MIRA LA CANCHA...</span>';
        messageText.className = 'message-text watch';

        // Clear all cells
        state.cells.forEach(function(cell, idx) {
            cell.className = idx === CENTER_CELL ? 'grid-cell center' : 'grid-cell';
        });

        // Select target color
        state.targetColor = COLORS[Math.floor(Math.random() * COLORS.length)];

        // Get available cells (not center)
        var availableCells = [];
        for (var i = 0; i < 25; i++) {
            if (i !== CENTER_CELL) availableCells.push(i);
        }
        shuffleArray(availableCells);

        // Select match cells and distractor cells
        var config = LEVEL_CONFIG[state.level];
        state.matchCells = availableCells.slice(0, config.matches);
        var distractorCells = availableCells.slice(config.matches, config.matches + config.distractors);

        // Show center color
        state.cells[CENTER_CELL].classList.add('color-' + state.targetColor);

        // Show match colors
        state.matchCells.forEach(function(idx) {
            state.cells[idx].classList.add('color-' + state.targetColor);
        });

        // Show distractor colors
        distractorCells.forEach(function(idx) {
            var distractorColor;
            do {
                distractorColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            } while (distractorColor === state.targetColor);
            state.cells[idx].classList.add('color-' + distractorColor);
        });

        // Hide after display time
        var displayTime = SPEED_CONFIG[state.speed];
        setTimeout(function() {
            // Hide all colors except center
            state.cells.forEach(function(cell, idx) {
                if (idx !== CENTER_CELL) {
                    COLORS.forEach(function(c) { cell.classList.remove('color-' + c); });
                }
            });
            messageText.innerHTML = '<span class="lang-en">FIND THE MATCHES!</span><span class="lang-es">¬°ENCUENTRA LAS COINCIDENCIAS!</span>';
            messageText.className = 'message-text go';
            state.canTap = true;
        }, displayTime);
    }

    // ==================== HANDLE TAP ====================
    function handleCellTap(index) {
        if (!state.canTap || !state.isPlaying) return;

        var cell = state.cells[index];

        // Check if already tapped
        if (cell.classList.contains('correct') || cell.classList.contains('wrong')) return;

        if (state.matchCells.indexOf(index) !== -1) {
            // Correct!
            cell.classList.add('correct', 'color-' + state.targetColor);
            state.matchesFound++;
            updateMatchesDisplay();
            playCorrectSound();

            // Add points
            state.score += 10 * state.level;
            updateStats();

            // Small celebration for each correct tap
            laughCelebration('small');

            // Check if all matches found
            if (state.matchesFound >= state.matchesNeeded) {
                // All found bonus
                state.score += 25 * state.level;
                state.streak++;
                updateStats();
                playSuccessSound();
                
                // Determine celebration intensity based on streak
                var celebrationIntensity;
                var coachMsg;
                
                if (state.streak >= 5) {
                    // Party mode for 5+ streak!
                    celebrationIntensity = 'party';
                    coachMsg = ['üéâ PARTY!', 'üèÜ LEGENDARY!', 'üåü SUPERSTAR!', 'üí´ UNSTOPPABLE!'][Math.floor(Math.random() * 4)];
                } else if (state.streak >= 3) {
                    // Big celebration for 3+ streak
                    celebrationIntensity = 'big';
                    coachMsg = ['üòÇ ON FIRE!', 'ü§£ AMAZING!', 'üòÜ CRUSHING IT!', 'ü•≥ NAILED IT!'][Math.floor(Math.random() * 4)];
                } else {
                    // Medium celebration for completing the round
                    celebrationIntensity = 'medium';
                    coachMsg = ['üòÑ NICE!', 'üòä GREAT!', 'üòÅ SMOOTH!', 'üéâ GOT IT!'][Math.floor(Math.random() * 4)];
                }
                
                laughCelebration(celebrationIntensity);
                showCoach(coachMsg);
                setTimeout(completedPlay, 500);
            }
        } else {
            // Wrong!
            cell.classList.add('wrong');
            playErrorSound();
            state.streak = 0;
            updateStats();

            // Reveal remaining matches
            setTimeout(function() {
                state.matchCells.forEach(function(i) {
                    var matchCell = state.cells[i];
                    if (!matchCell.classList.contains('correct')) {
                        matchCell.classList.add('revealed', 'color-' + state.targetColor);
                    }
                });
                setTimeout(completedPlay, 1000);
            }, 300);
        }
    }

    // ==================== COMPLETE PLAY ====================
    function completedPlay() {
        state.canTap = false;
        state.isPlaying = false;
        state.playsCompleted++;
        updateStats();

        // Save progress
        localStorage.setItem('gt-score', state.score);
        localStorage.setItem('gt-streak', state.streak);

        if (state.playsCompleted >= PLAYS_PER_CIRCUIT) {
            // Circuit complete! Party celebration!
            laughCelebration('party');
            showCircuitModal();
        } else {
            var playText = currentLang === 'es' ? 'Jugada' : 'Play';
            messageText.innerHTML = '<span>' + playText + ' ' + state.playsCompleted + '/' + PLAYS_PER_CIRCUIT + '</span>';
            messageText.className = 'message-text';
            actionBtn.disabled = false;
        }
    }

    // ==================== CIRCUIT MODAL ====================
    function showCircuitModal() {
        document.getElementById('feedbackScore').textContent = state.score;
        document.getElementById('feedbackStreak').textContent = state.streak;
        var speedText = state.speed === 'slow' ? 'Slow' : state.speed === 'med' ? 'Medium' : 'Fast';
        if (currentLang === 'es') {
            speedText = state.speed === 'slow' ? 'Lento' : state.speed === 'med' ? 'Medio' : 'R√°pido';
        }
        document.getElementById('feedbackMessage').textContent = 'Level ' + state.level + ' ' + speedText;
        
        // Update emoji based on streak
        var emoji = state.streak >= 5 ? 'üèÜ' : state.streak >= 3 ? 'üéâ' : 'üòÑ';
        document.getElementById('feedbackEmoji').textContent = emoji;
        
        feedbackOverlay.classList.add('show');
    }

    document.getElementById('nextCircuitBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        state.playsCompleted = 0;
        state.circuitNum++;
        updateStats();
        var readyText = currentLang === 'es' ? '¬°Listo para el circuito ' : 'Ready for circuit ';
        messageText.innerHTML = '<span>' + readyText + state.circuitNum + '!</span>';
        messageText.className = 'message-text';
        actionBtn.disabled = false;
    });

    document.getElementById('changeDivisionBtn').addEventListener('click', function() {
        feedbackOverlay.classList.remove('show');
        state.score = 0;
        state.playsCompleted = 0;
        state.circuitNum = 1;
        state.streak = 0;
        localStorage.setItem('gt-score', 0);
        localStorage.setItem('gt-streak', 0);
        updateStats();
        var selectText = currentLang === 'es' ? '¬°Selecciona divisi√≥n e IR!' : 'Select division & GO!';
        messageText.innerHTML = '<span>' + selectText + '</span>';
        messageText.className = 'message-text';
        actionBtn.disabled = false;
    });

    // ==================== LEVEL SELECTORS ====================
    document.querySelectorAll('[data-level]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (state.isPlaying) return;
            document.querySelectorAll('[data-level]').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.level = parseInt(btn.dataset.level);
            localStorage.setItem('gt-level', state.level);
            updateDivisionDisplay();
        });
    });

    // ==================== SPEED SELECTORS ====================
    document.querySelectorAll('.speed-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (state.isPlaying) return;
            var speed = btn.dataset.speed;
            
            // Check if locked
            if (!speedAccess.allSpeeds && speed !== 'slow') {
                showUpgradeModal();
                return;
            }
            
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.speed = speed;
            localStorage.setItem('gt-speed', state.speed);
            updateDivisionDisplay();
        });
    });

    // ==================== START BUTTON ====================
    actionBtn.addEventListener('click', startPlay);

    // ==================== LOAD SAVED STATE ====================
    function loadSavedState() {
        // Load level
        var savedLevel = localStorage.getItem('gt-level');
        if (savedLevel) {
            state.level = parseInt(savedLevel);
            document.querySelectorAll('[data-level]').forEach(function(b) { b.classList.remove('active'); });
            var levelBtn = document.querySelector('[data-level="' + state.level + '"]');
            if (levelBtn) levelBtn.classList.add('active');
        }

        // Load speed (but respect access)
        var savedSpeed = localStorage.getItem('gt-speed');
        if (savedSpeed && (speedAccess.allSpeeds || savedSpeed === 'slow')) {
            state.speed = savedSpeed;
            document.querySelectorAll('.speed-btn').forEach(function(b) { b.classList.remove('active'); });
            var speedBtn = document.querySelector('.speed-btn[data-speed="' + state.speed + '"]');
            if (speedBtn) speedBtn.classList.add('active');
        }
    }

    // ==================== INIT ====================
    initCourt();
    initSpeedButtons();
    loadSavedState();
    setLang(currentLang);
    updateDivisionDisplay();
    updateStats();

})();
</script>
</body>
</html>
