<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GoTrotters - Mastery Mode</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;overflow-y:scroll}
:root{
--ball-orange:#FF6B00;--ball-dark:#CC5500;
--primary:#1E3A8A;--primary-light:#3B82F6;
--secondary:#FF6B00;
--bg-dark:#0a0a12;--bg-card:#12121a;
--text-light:#FFFFFF;--text-muted:#8892a0;
--success:#00D9A5;--danger:#FF4757;--gold:#FFD700;
--q1:#22C55E;--q2:#FF6B00;--q3:#F59E0B;--q4:#EF4444;
}
body{font-family:'Nunito',sans-serif;background:var(--bg-dark);color:var(--text-light);min-height:100%}
body[data-lang="es"] .lang-en{display:none!important}
body[data-lang="en"] .lang-es{display:none!important}
.court-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,var(--bg-dark) 0%,#0d0d18 100%);z-index:-1}
.top-controls{position:fixed;top:0;left:0;right:0;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;z-index:100;background:linear-gradient(180deg,rgba(10,10,18,0.95) 0%,transparent 100%)}
.back-link{padding:8px 16px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);border-radius:20px;color:var(--text-muted);text-decoration:none;font-weight:600;font-size:0.85rem}
.lang-toggle{display:flex;gap:6px}
.lang-btn{padding:6px 12px;border:2px solid var(--secondary);background:transparent;color:var(--secondary);border-radius:15px;font-family:'Nunito',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.lang-btn.active{background:var(--secondary);color:var(--text-light)}
.screen{display:none;flex-direction:column;align-items:center;min-height:100vh;width:100%;padding:80px 20px 40px 20px;text-align:center}
.screen.active{display:flex}
.pistol-logo{font-family:'Bebas Neue',sans-serif;font-size:3.2rem;letter-spacing:6px;background:linear-gradient(135deg,var(--secondary) 0%,var(--gold) 50%,var(--secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:5px}
.pistol-subtitle{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:8px;color:var(--text-muted)}
.pistol-icon{font-size:4rem;margin:20px 0}
.mastery-badge{background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);padding:12px 24px;border-radius:30px;font-weight:800;font-size:0.9rem;margin-bottom:25px;display:inline-block}
.mastery-info{max-width:340px;padding:20px;background:rgba(255,107,0,0.05);border-left:4px solid var(--secondary);border-radius:0 15px 15px 0;margin-bottom:30px}
.mastery-info-text{color:var(--text-light);font-size:0.95rem;line-height:1.6}
.tier-section,.rhythm-section{width:100%;max-width:380px;margin-bottom:25px}
.section-label{font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:15px}
.tier-grid{display:flex;flex-direction:column;gap:8px}
.tier-btn{display:flex;align-items:center;gap:15px;padding:14px 18px;background:var(--bg-card);border:2px solid transparent;border-radius:12px;cursor:pointer;transition:all 0.3s ease;text-align:left}
.tier-btn:hover:not(.locked){border-color:var(--secondary);transform:translateX(5px)}
.tier-btn.selected{border-color:var(--secondary);background:rgba(255,107,0,0.1)}
.tier-btn.locked{opacity:0.4;cursor:not-allowed}
.tier-btn.mastered{border-color:var(--success);background:rgba(0,217,165,0.1)}
.tier-icon{font-size:1.8rem;min-width:45px;text-align:center}
.tier-info{flex:1}
.tier-name{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--text-light)}
.tier-desc{font-size:0.75rem;color:var(--text-muted)}
.tier-status{font-size:0.7rem;padding:4px 10px;border-radius:10px;font-weight:700}
.tier-status.mastered{background:var(--success);color:var(--bg-dark)}
.tier-status.locked{background:rgba(255,255,255,0.1);color:var(--text-muted)}
.tier-status.current{background:var(--secondary);color:var(--text-light)}
.rhythm-grid{display:flex;gap:10px;justify-content:center}
.rhythm-btn{padding:12px 18px;background:var(--bg-card);border:2px solid transparent;border-radius:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:90px}
.rhythm-btn:hover{border-color:var(--primary-light)}
.rhythm-btn.selected{border-color:var(--secondary);background:rgba(255,107,0,0.1)}
.rhythm-icon{font-size:1.5rem}
.rhythm-label{font-size:0.8rem;font-weight:700;color:var(--text-light)}
.rhythm-bpm{font-size:0.7rem;color:var(--text-muted)}
.start-btn{padding:18px 50px;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:5px;background:linear-gradient(135deg,var(--secondary) 0%,var(--ball-dark) 100%);color:var(--text-light);border:none;border-radius:50px;cursor:pointer;box-shadow:0 5px 25px rgba(255,107,0,0.4)}
.stats-summary{margin-top:25px;padding:15px 25px;background:var(--bg-card);border-radius:15px;display:flex;gap:30px}
.stat-item{text-align:center}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--secondary)}
.stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
#countdownScreen{justify-content:center}
.countdown-tier{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:4px;color:var(--text-muted);margin-bottom:10px}
.countdown-number{font-family:'Bebas Neue',sans-serif;font-size:8rem;color:var(--secondary);text-shadow:0 0 50px rgba(255,107,0,0.5)}
.countdown-text{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:6px;color:var(--text-muted)}
#gameScreen{justify-content:flex-start;padding-top:70px}
.scoreboard{width:100%;max-width:380px;background:linear-gradient(180deg,#0a0a0a 0%,#050505 100%);border:3px solid #222;border-radius:15px;padding:15px 20px;margin-bottom:15px}
.scoreboard-main{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.scoreboard-tier{font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:2px;color:var(--text-muted);padding:4px 10px;background:rgba(255,255,255,0.05);border-radius:8px}
.scoreboard-score{font-family:'Bebas Neue',sans-serif;font-size:2.8rem;color:var(--secondary);text-shadow:0 0 20px rgba(255,107,0,0.4)}
.half-display{display:flex;justify-content:center;gap:12px;margin-bottom:10px}
.half-indicator{padding:8px 20px;border-radius:20px;font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:2px}
.half-indicator.active{background:var(--secondary);color:var(--text-light)}
.half-indicator.inactive{background:rgba(255,255,255,0.05);color:var(--text-muted)}
.half-indicator.completed{background:var(--success);color:var(--bg-dark)}
.accuracy-display{text-align:center;margin-bottom:10px}
.accuracy-label{font-size:0.75rem;color:var(--text-muted);margin-bottom:4px}
.accuracy-value{font-family:'Bebas Neue',sans-serif;font-size:1.8rem}
.accuracy-value.perfect{color:var(--success)}
.accuracy-value.good{color:var(--gold)}
.accuracy-value.miss{color:var(--danger)}
.message-area{height:45px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.game-message{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;color:var(--text-light)}
.game-message.success{color:var(--success)}
.game-message.error{color:var(--danger)}
.court{position:relative;width:min(92vw,360px);height:min(92vw,360px);background:linear-gradient(145deg,#C4813A 0%,#A66B2A 50%,#8B5A1B 100%);border-radius:15px;border:4px solid #6B4513;overflow:hidden;box-shadow:inset 0 0 60px rgba(0,0,0,0.4),0 15px 50px rgba(0,0,0,0.6)}
.court-markings{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
.court-center-line{position:absolute;top:0;left:50%;width:3px;height:100%;background:rgba(255,255,255,0.5);transform:translateX(-50%)}
.court-center-circle{position:absolute;top:50%;left:50%;width:70px;height:70px;border:3px solid rgba(255,255,255,0.5);border-radius:50%;transform:translate(-50%,-50%)}
.trail-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}
.ball-container{position:absolute;top:0;left:0;right:0;bottom:0;z-index:10}
.ball{position:absolute;width:50px;height:50px;transform:translate(-50%,-50%);cursor:pointer;font-size:42px;display:flex;align-items:center;justify-content:center;transition:transform 0.15s ease,filter 0.15s ease;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
.ball:active{transform:translate(-50%,-50%) scale(0.9)}
.ball.lit{filter:drop-shadow(0 0 25px #FF6B00) brightness(1.3);transform:translate(-50%,-50%) scale(1.25);z-index:20}
.ball.completed{filter:brightness(1.5) hue-rotate(100deg) drop-shadow(0 0 15px #00D9A5);pointer-events:none}
.ball.error{filter:brightness(1.2) hue-rotate(-30deg) drop-shadow(0 0 15px #FF4757);animation:shake 0.3s ease}
.ball.disabled{pointer-events:none;opacity:0.6}
@keyframes shake{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(calc(-50% - 5px),-50%)}75%{transform:translate(calc(-50% + 5px),-50%)}}

/* Result Screen */
#resultScreen{justify-content:center}
.result-icon{font-size:5rem;margin-bottom:15px}
.result-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:4px;margin-bottom:10px}
.result-title.success{color:var(--success)}
.result-title.retry{color:var(--secondary)}
.result-message{font-size:1.1rem;color:var(--text-muted);margin-bottom:25px;max-width:320px;line-height:1.5}
.result-stats{display:flex;gap:25px;margin-bottom:25px}
.result-stat{text-align:center}
.result-stat-value{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--text-light)}
.result-stat-label{font-size:0.75rem;color:var(--text-muted)}
.result-accuracy{font-family:'Bebas Neue',sans-serif;font-size:4rem;margin-bottom:10px}
.result-accuracy.perfect{color:var(--success)}
.result-accuracy.miss{color:var(--danger)}
.next-level-preview{background:var(--bg-card);border:2px solid var(--success);border-radius:15px;padding:20px;margin-bottom:25px;max-width:320px}
.next-level-label{font-size:0.8rem;color:var(--success);margin-bottom:8px}
.next-level-name{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--text-light)}
.continue-timer{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--text-muted);margin-bottom:20px}
.continue-timer span{color:var(--secondary);font-size:1.5rem}
.action-buttons{display:flex;flex-direction:column;gap:12px;width:100%;max-width:280px}
.continue-btn{padding:16px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;background:linear-gradient(135deg,var(--success) 0%,#00B389 100%);color:var(--bg-dark);border:none;border-radius:50px;cursor:pointer}
.retry-btn{padding:16px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;background:linear-gradient(135deg,var(--secondary) 0%,var(--ball-dark) 100%);color:var(--text-light);border:none;border-radius:50px;cursor:pointer}
.home-btn{padding:14px 40px;font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:700;background:transparent;color:var(--text-muted);border:2px solid rgba(255,255,255,0.15);border-radius:50px;cursor:pointer}
.rhythm-badge{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);border:2px solid var(--secondary);border-radius:25px;padding:8px 18px;display:none;align-items:center;gap:8px;z-index:100}
.rhythm-badge.visible{display:flex}
.rhythm-badge-text{font-size:0.7rem;color:var(--secondary);font-weight:700;letter-spacing:1px}
@media(max-width:380px){.pistol-logo{font-size:2.6rem}.court{width:min(88vw,320px);height:min(88vw,320px)}.ball{width:42px;height:42px;font-size:36px}}
</style>
</head>
<body data-lang="en">
<div class="court-bg"></div>
<div class="top-controls">
<a href="#" onclick="goHome();return false;" class="back-link"><span class="lang-en">‚Üê Menu</span><span class="lang-es">‚Üê Men√∫</span></a>
<div class="lang-toggle">
<button class="lang-btn active" onclick="setLang('en')">EN</button>
<button class="lang-btn" onclick="setLang('es')">ES</button>
</div>
</div>

<!-- WELCOME SCREEN -->
<div class="screen active" id="welcomeScreen">
<div class="pistol-logo">GOTROTTERS</div>
<div class="pistol-subtitle"><span class="lang-en">MASTERY MODE</span><span class="lang-es">MODO MAESTR√çA</span></div>
<div class="pistol-icon">üèÄ</div>

<div class="mastery-badge">
<span class="lang-en">üéØ 100% ACCURACY TO ADVANCE</span>
<span class="lang-es">üéØ 100% PRECISI√ìN PARA AVANZAR</span>
</div>

<div class="mastery-info">
<div class="mastery-info-text">
<span class="lang-en">Play both halves perfectly to unlock the next level. Keep training until you achieve 100% accuracy!</span>
<span class="lang-es">Juega ambas mitades perfectamente para desbloquear el siguiente nivel. ¬°Sigue entrenando hasta lograr 100% de precisi√≥n!</span>
</div>
</div>

<div class="tier-section">
<div class="section-label"><span class="lang-en">SELECT YOUR LEVEL</span><span class="lang-es">ESCOGE TU NIVEL</span></div>
<div class="tier-grid" id="tierGrid"></div>
</div>

<div class="rhythm-section">
<div class="section-label"><span class="lang-en">RHYTHM</span><span class="lang-es">RITMO</span></div>
<div class="rhythm-grid">
<div class="rhythm-btn" data-rhythm="steady" onclick="selectRhythm('steady')">
<span class="rhythm-icon">üö∂</span>
<span class="rhythm-label"><span class="lang-en">Steady</span><span class="lang-es">Suave</span></span>
<span class="rhythm-bpm">90 BPM</span>
</div>
<div class="rhythm-btn selected" data-rhythm="showtime" onclick="selectRhythm('showtime')">
<span class="rhythm-icon">‚≠ê</span>
<span class="rhythm-label">Showtime</span>
<span class="rhythm-bpm">127 BPM</span>
</div>
<div class="rhythm-btn" data-rhythm="pistol" onclick="selectRhythm('pistol')">
<span class="rhythm-icon">üî•</span>
<span class="rhythm-label">Pistol</span>
<span class="rhythm-bpm">150 BPM</span>
</div>
</div>
</div>

<button class="start-btn" onclick="startGame()">
<span class="lang-en">START TRAINING</span>
<span class="lang-es">COMENZAR</span>
</button>

<div class="stats-summary">
<div class="stat-item">
<div class="stat-value" id="currentLevel">1</div>
<div class="stat-label"><span class="lang-en">Level</span><span class="lang-es">Nivel</span></div>
</div>
<div class="stat-item">
<div class="stat-value" id="perfectGames">0</div>
<div class="stat-label"><span class="lang-en">Perfect</span><span class="lang-es">Perfectos</span></div>
</div>
<div class="stat-item">
<div class="stat-value" id="bestScore">0</div>
<div class="stat-label"><span class="lang-en">Best</span><span class="lang-es">Mejor</span></div>
</div>
</div>
</div>

<!-- COUNTDOWN SCREEN -->
<div class="screen" id="countdownScreen">
<div class="countdown-tier" id="countdownTier">ROOKIE</div>
<div class="countdown-number" id="countdownNum">3</div>
<div class="countdown-text"><span class="lang-en">GET READY</span><span class="lang-es">PREP√ÅRATE</span></div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="gameScreen">
<div class="scoreboard">
<div class="scoreboard-main">
<div class="scoreboard-tier" id="gameTier">ROOKIE</div>
<div class="scoreboard-score" id="scoreDisplay">0</div>
</div>
<div class="half-display">
<div class="half-indicator active" id="half1"><span class="lang-en">1ST HALF</span><span class="lang-es">1RA MITAD</span></div>
<div class="half-indicator inactive" id="half2"><span class="lang-en">2ND HALF</span><span class="lang-es">2DA MITAD</span></div>
</div>
<div class="accuracy-display">
<div class="accuracy-label"><span class="lang-en">ACCURACY</span><span class="lang-es">PRECISI√ìN</span></div>
<div class="accuracy-value perfect" id="accuracyDisplay">100%</div>
</div>
</div>
<div class="message-area"><div class="game-message" id="gameMessage"></div></div>
<div class="court" id="court">
<div class="court-markings"><div class="court-center-line"></div><div class="court-center-circle"></div></div>
<canvas class="trail-canvas" id="trailCanvas"></canvas>
<div class="ball-container" id="ballContainer"></div>
</div>
</div>

<!-- HALFTIME SCREEN -->
<div class="screen" id="halftimeScreen">
<div class="pistol-icon">‚è∏Ô∏è</div>
<div class="pistol-logo"><span class="lang-en">HALFTIME</span><span class="lang-es">MEDIO TIEMPO</span></div>
<div class="result-stats">
<div class="result-stat">
<div class="result-stat-value" id="htScore">0</div>
<div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="htAccuracy">100%</div>
<div class="result-stat-label"><span class="lang-en">Accuracy</span><span class="lang-es">Precisi√≥n</span></div>
</div>
</div>
<p style="color:var(--text-muted);margin-bottom:25px;max-width:300px">
<span class="lang-en">Keep your accuracy at 100% in the 2nd half to advance!</span>
<span class="lang-es">¬°Mant√©n tu precisi√≥n al 100% en la 2da mitad para avanzar!</span>
</p>
<button class="retry-btn" onclick="continueToSecondHalf()">
<span class="lang-en">2ND HALF ‚Üí</span>
<span class="lang-es">2DA MITAD ‚Üí</span>
</button>
</div>

<!-- RESULT SCREEN -->
<div class="screen" id="resultScreen">
<div class="result-icon" id="resultIcon">üèÜ</div>
<div class="result-title" id="resultTitle">PERFECT!</div>
<div class="result-accuracy" id="resultAccuracy">100%</div>
<div class="result-message" id="resultMessage">You've mastered this level!</div>

<div class="result-stats">
<div class="result-stat">
<div class="result-stat-value" id="finalScore">0</div>
<div class="result-stat-label"><span class="lang-en">Score</span><span class="lang-es">Puntos</span></div>
</div>
<div class="result-stat">
<div class="result-stat-value" id="finalCorrect">0/0</div>
<div class="result-stat-label"><span class="lang-en">Correct</span><span class="lang-es">Correctos</span></div>
</div>
</div>

<div class="next-level-preview" id="nextLevelBox" style="display:none">
<div class="next-level-label"><span class="lang-en">NEXT LEVEL</span><span class="lang-es">SIGUIENTE NIVEL</span></div>
<div class="next-level-name" id="nextLevelName">JV</div>
</div>

<div class="continue-timer" id="continueTimer">
<span class="lang-en">Continuing in <span id="timerCount">3</span>...</span>
<span class="lang-es">Continuando en <span id="timerCountEs">3</span>...</span>
</div>

<div class="action-buttons">
<button class="continue-btn" id="advanceBtn" onclick="advanceNow()" style="display:none">
<span class="lang-en">ADVANCE NOW</span>
<span class="lang-es">AVANZAR AHORA</span>
</button>
<button class="retry-btn" id="retryBtn" onclick="retryNow()" style="display:none">
<span class="lang-en">RETRY NOW</span>
<span class="lang-es">REINTENTAR</span>
</button>
<button class="home-btn" onclick="goHome()">
<span class="lang-en">‚Üê Back to Menu</span>
<span class="lang-es">‚Üê Volver al Men√∫</span>
</button>
</div>
</div>

<div class="rhythm-badge" id="rhythmBadge"><span class="rhythm-badge-text" id="rhythmBadgeText">SHOWTIME ‚Ä¢ 127 BPM</span></div>

<script>
var currentLang = localStorage.getItem('gt-lang') || 'en';
function setLang(l) {
    currentLang = l;
    localStorage.setItem('gt-lang', l);
    document.body.setAttribute('data-lang', l);
    document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.toggle('active', b.textContent.trim() === l.toUpperCase());
    });
}
document.body.setAttribute('data-lang', currentLang);

var audioCtx = null;
function playBeep(freq, dur) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

// TIER DEFINITIONS
var tiers = {
    rookie: {name: 'ROOKIE', icon: 'üåü', stars: 4, seqMin: 3, seqMax: 4, rounds: 3},
    jv: {name: 'JV', icon: 'üèÄ', stars: 5, seqMin: 4, seqMax: 5, rounds: 4},
    varsity: {name: 'VARSITY', icon: 'üéΩ', stars: 6, seqMin: 5, seqMax: 6, rounds: 4},
    college: {name: 'COLLEGE', icon: 'üéì', stars: 7, seqMin: 6, seqMax: 7, rounds: 5},
    pro: {name: 'PRO', icon: 'üí∞', stars: 8, seqMin: 7, seqMax: 8, rounds: 5},
    allstar: {name: 'ALL-STAR', icon: '‚≠ê', stars: 9, seqMin: 8, seqMax: 9, rounds: 5},
    legend: {name: 'LEGEND', icon: 'üèÜ', stars: 10, seqMin: 9, seqMax: 10, rounds: 6},
    pistol: {name: 'PISTOL', icon: 'üî•', stars: 12, seqMin: 10, seqMax: 12, rounds: 6}
};
var tierList = ['rookie', 'jv', 'varsity', 'college', 'pro', 'allstar', 'legend', 'pistol'];

var rhythms = {
    steady: {ms: 650, pause: 380, label: 'STEADY ‚Ä¢ 90 BPM'},
    showtime: {ms: 470, pause: 260, label: 'SHOWTIME ‚Ä¢ 127 BPM'},
    pistol: {ms: 380, pause: 180, label: 'PISTOL ‚Ä¢ 150 BPM'}
};

// PROGRESS - stores highest unlocked level and perfect game counts
function getProgress() {
    try { return JSON.parse(localStorage.getItem('gotrotters-mastery')) || {unlockedLevel: 0, perfect: {}, best: 0}; } 
    catch (e) { return {unlockedLevel: 0, perfect: {}, best: 0}; }
}
function saveProgress(p) { localStorage.setItem('gotrotters-mastery', JSON.stringify(p)); }

var selTier = 'rookie', selRhythm = 'showtime';
var currentHalf = 1, round = 1, score = 0;
var balls = [], seq = [], idx = 0, done = [], showing = false;
var correct = 0, attempts = 0;
var autoTimer = null;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
    document.getElementById(id).classList.add('active');
}

function renderTiers() {
    var grid = document.getElementById('tierGrid');
    grid.innerHTML = '';
    var prog = getProgress();
    var unlockedIdx = prog.unlockedLevel || 0;
    
    tierList.forEach(function(id, idx) {
        var t = tiers[id];
        var unlocked = idx <= unlockedIdx;
        var mastered = idx < unlockedIdx;
        var perfectCount = prog.perfect[id] || 0;
        
        var btn = document.createElement('div');
        btn.className = 'tier-btn' + (id === selTier ? ' selected' : '') + (!unlocked ? ' locked' : '') + (mastered ? ' mastered' : '');
        
        if (unlocked) {
            btn.onclick = function() {
                selTier = id;
                document.querySelectorAll('.tier-btn').forEach(function(b, i) {
                    b.classList.toggle('selected', tierList[i] === id);
                });
            };
        }
        
        var statusHtml = '';
        if (mastered) {
            statusHtml = '<span class="tier-status mastered">‚úì ' + (currentLang === 'es' ? 'MAESTRO' : 'MASTERED') + '</span>';
        } else if (!unlocked) {
            statusHtml = '<span class="tier-status locked">üîí</span>';
        } else if (id === tierList[unlockedIdx]) {
            statusHtml = '<span class="tier-status current">' + (currentLang === 'es' ? 'ACTUAL' : 'CURRENT') + '</span>';
        }
        
        btn.innerHTML = '<span class="tier-icon">' + t.icon + '</span>' +
            '<div class="tier-info"><div class="tier-name">' + t.name + '</div>' +
            '<div class="tier-desc">' + t.stars + ' balls ‚Ä¢ ' + t.rounds + ' rounds</div></div>' + statusHtml;
        
        grid.appendChild(btn);
    });
    
    // Update stats
    var totalPerfect = 0;
    for (var k in prog.perfect) totalPerfect += prog.perfect[k];
    document.getElementById('currentLevel').textContent = unlockedIdx + 1;
    document.getElementById('perfectGames').textContent = totalPerfect;
    document.getElementById('bestScore').textContent = prog.best || 0;
}

function selectRhythm(r) {
    selRhythm = r;
    document.querySelectorAll('.rhythm-btn').forEach(function(b) {
        b.classList.toggle('selected', b.dataset.rhythm === r);
    });
}

function startGame() {
    currentHalf = 1;
    round = 1;
    score = 0;
    correct = 0;
    attempts = 0;
    
    document.getElementById('rhythmBadgeText').textContent = rhythms[selRhythm].label;
    document.getElementById('rhythmBadge').classList.add('visible');
    document.getElementById('countdownTier').textContent = tiers[selTier].name;
    
    updateHalfDisplay();
    showScreen('countdownScreen');
    countdown(3);
}

function countdown(n) {
    document.getElementById('countdownNum').textContent = n;
    if (n > 0) {
        playBeep(440, 0.1);
        setTimeout(function() { countdown(n - 1); }, 1000);
    } else {
        playBeep(880, 0.3);
        showScreen('gameScreen');
        initRound();
    }
}

function initRound() {
    document.getElementById('gameTier').textContent = tiers[selTier].name;
    updateHalfDisplay();
    updateAccuracy();
    startRound();
}

function updateHalfDisplay() {
    var h1 = document.getElementById('half1');
    var h2 = document.getElementById('half2');
    
    if (currentHalf === 1) {
        h1.className = 'half-indicator active';
        h2.className = 'half-indicator inactive';
    } else {
        h1.className = 'half-indicator completed';
        h2.className = 'half-indicator active';
    }
}

function updateAccuracy() {
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var el = document.getElementById('accuracyDisplay');
    el.textContent = pct + '%';
    el.className = 'accuracy-value ' + (pct === 100 ? 'perfect' : (pct >= 80 ? 'good' : 'miss'));
}

function updateScore() { document.getElementById('scoreDisplay').textContent = score; }

function setMsg(txt, type) {
    var el = document.getElementById('gameMessage');
    el.textContent = txt;
    el.className = 'game-message' + (type ? ' ' + type : '');
}

function makeBalls(n) {
    var court = document.getElementById('court');
    var w = court.offsetWidth, h = court.offsetHeight;
    balls = [];
    
    for (var i = 0; i < n; i++) {
        var x, y, ok, tries = 0;
        do {
            x = 45 + Math.random() * (w - 90);
            y = 45 + Math.random() * (h - 90);
            ok = true;
            for (var j = 0; j < balls.length; j++) {
                var dx = x - balls[j].x, dy = y - balls[j].y;
                if (Math.sqrt(dx*dx + dy*dy) < 55) { ok = false; break; }
            }
            tries++;
        } while (!ok && tries < 100);
        balls.push({x: x, y: y});
    }
}

function renderBalls() {
    var container = document.getElementById('ballContainer');
    container.innerHTML = '';
    
    for (var i = 0; i < balls.length; i++) {
        var b = balls[i];
        var div = document.createElement('div');
        div.className = 'ball';
        div.setAttribute('data-idx', i);
        div.style.left = b.x + 'px';
        div.style.top = b.y + 'px';
        div.textContent = 'üèÄ';
        
        (function(index) {
            div.onclick = function() { clickBall(index); };
        })(i);
        
        container.appendChild(div);
    }
    clearTrail();
}

function clearTrail() {
    var cv = document.getElementById('trailCanvas');
    var ct = document.getElementById('court');
    cv.width = ct.offsetWidth;
    cv.height = ct.offsetHeight;
}

function drawTrail() {
    var cv = document.getElementById('trailCanvas');
    var ctx = cv.getContext('2d');
    ctx.clearRect(0, 0, cv.width, cv.height);
    if (done.length < 2) return;
    
    ctx.strokeStyle = '#00D9A5';
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.shadowColor = '#00D9A5';
    ctx.shadowBlur = 20;
    ctx.beginPath();
    for (var i = 0; i < done.length; i++) {
        var b = balls[done[i]];
        if (i === 0) ctx.moveTo(b.x, b.y);
        else ctx.lineTo(b.x, b.y);
    }
    ctx.stroke();
}

function disableBalls(d) {
    document.querySelectorAll('.ball').forEach(function(b) {
        b.classList.toggle('disabled', d);
    });
}

function startRound() {
    idx = 0;
    done = [];
    
    var t = tiers[selTier];
    makeBalls(t.stars);
    renderBalls();
    
    var len = t.seqMin + Math.floor(Math.random() * (t.seqMax - t.seqMin + 1));
    var avail = [];
    for (var i = 0; i < balls.length; i++) avail.push(i);
    
    seq = [];
    for (var i = 0; i < len; i++) {
        if (!avail.length) break;
        var r = Math.floor(Math.random() * avail.length);
        seq.push(avail[r]);
        avail.splice(r, 1);
    }
    
    setMsg(currentLang === 'es' ? 'Mira el camino...' : 'Watch the trail...');
    disableBalls(true);
    setTimeout(showSeq, 700);
}

function showSeq() {
    showing = true;
    var rhy = rhythms[selRhythm];
    var i = 0;
    
    function next() {
        if (i > 0) {
            var prev = document.querySelector('.ball[data-idx="' + seq[i-1] + '"]');
            if (prev) prev.classList.remove('lit');
        }
        
        if (i >= seq.length) {
            showing = false;
            setMsg(currentLang === 'es' ? '¬°Te toca!' : 'Your turn!');
            disableBalls(false);
            return;
        }
        
        var el = document.querySelector('.ball[data-idx="' + seq[i] + '"]');
        if (el) {
            el.classList.add('lit');
            playBeep(261.63 * (1 + seq[i] * 0.1), 0.2);
        }
        
        i++;
        setTimeout(next, rhy.ms + rhy.pause);
    }
    next();
}

function clickBall(i) {
    if (showing) return;
    
    var el = document.querySelector('.ball[data-idx="' + i + '"]');
    if (!el || el.classList.contains('completed')) return;
    
    if (i === seq[idx]) {
        // CORRECT
        done.push(i);
        el.classList.add('completed');
        playBeep(523.25, 0.15);
        drawTrail();
        idx++;
        
        if (idx >= seq.length) {
            // Completed sequence
            correct++;
            attempts++;
            var pts = seq.length * 20;
            score += pts;
            disableBalls(true);
            updateScore();
            updateAccuracy();
            setMsg((currentLang === 'es' ? '¬°Wepa! +' : 'Perfect! +') + pts, 'success');
            setTimeout(nextRound, 1000);
        }
    } else {
        // WRONG
        attempts++;
        el.classList.add('error');
        playBeep(150, 0.25);
        
        setTimeout(function() {
            el.classList.remove('error');
        }, 300);
        
        // Partial points
        var partial = idx * 10;
        if (partial > 0) {
            score += partial;
            updateScore();
        }
        
        updateAccuracy();
        setMsg(currentLang === 'es' ? '¬°Otra vez!' : 'Try again!', 'error');
        setTimeout(nextRound, 800);
    }
}

function nextRound() {
    round++;
    var t = tiers[selTier];
    
    if (round > t.rounds) {
        // End of rounds for this half
        if (currentHalf === 1) {
            showHalftime();
        } else {
            endGame();
        }
        return;
    }
    
    setTimeout(startRound, 400);
}

function showHalftime() {
    document.getElementById('rhythmBadge').classList.remove('visible');
    document.getElementById('htScore').textContent = score;
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    document.getElementById('htAccuracy').textContent = pct + '%';
    showScreen('halftimeScreen');
}

function continueToSecondHalf() {
    currentHalf = 2;
    round = 1;
    document.getElementById('rhythmBadge').classList.add('visible');
    updateHalfDisplay();
    showScreen('gameScreen');
    setMsg(currentLang === 'es' ? '¬°Segunda mitad!' : '2nd Half!');
    setTimeout(startRound, 800);
}

function endGame() {
    document.getElementById('rhythmBadge').classList.remove('visible');
    
    var pct = attempts === 0 ? 100 : Math.round((correct / attempts) * 100);
    var isPerfect = pct === 100;
    
    var prog = getProgress();
    if (score > prog.best) prog.best = score;
    
    var currentIdx = tierList.indexOf(selTier);
    var canAdvance = isPerfect && currentIdx < tierList.length - 1;
    
    if (isPerfect) {
        prog.perfect[selTier] = (prog.perfect[selTier] || 0) + 1;
        if (currentIdx >= prog.unlockedLevel && currentIdx < tierList.length - 1) {
            prog.unlockedLevel = currentIdx + 1;
        }
    }
    saveProgress(prog);
    
    // Show result
    document.getElementById('resultIcon').textContent = isPerfect ? 'üèÜ' : 'üèÄ';
    document.getElementById('resultTitle').textContent = isPerfect ? 
        (currentLang === 'es' ? '¬°PERFECTO!' : 'PERFECT!') : 
        (currentLang === 'es' ? 'SIGUE PRACTICANDO' : 'KEEP PRACTICING');
    document.getElementById('resultTitle').className = 'result-title ' + (isPerfect ? 'success' : 'retry');
    
    document.getElementById('resultAccuracy').textContent = pct + '%';
    document.getElementById('resultAccuracy').className = 'result-accuracy ' + (isPerfect ? 'perfect' : 'miss');
    
    document.getElementById('resultMessage').innerHTML = isPerfect ?
        (currentLang === 'es' ? '¬°Has dominado este nivel!' : 'You\'ve mastered this level!') :
        (currentLang === 'es' ? 'Necesitas 100% para avanzar. ¬°T√∫ puedes!' : 'You need 100% to advance. You got this!');
    
    document.getElementById('finalScore').textContent = score;
    document.getElementById('finalCorrect').textContent = correct + '/' + attempts;
    
    // Next level preview
    if (canAdvance) {
        var nextTier = tierList[currentIdx + 1];
        document.getElementById('nextLevelName').textContent = tiers[nextTier].icon + ' ' + tiers[nextTier].name;
        document.getElementById('nextLevelBox').style.display = 'block';
        document.getElementById('advanceBtn').style.display = 'block';
        document.getElementById('retryBtn').style.display = 'none';
    } else {
        document.getElementById('nextLevelBox').style.display = 'none';
        document.getElementById('advanceBtn').style.display = 'none';
        document.getElementById('retryBtn').style.display = 'block';
    }
    
    showScreen('resultScreen');
    
    // Auto-continue timer
    startAutoTimer(isPerfect, canAdvance);
    
    // Save to server
    var pin = sessionStorage.getItem('gostar-user-pin');
    var code = sessionStorage.getItem('gostar-user-code');
    var name = sessionStorage.getItem('gostar-user-name');
    if (pin || (code && name)) {
        var data = {game: 'gotrotters', score: score, tier: selTier, accuracy: pct, perfect: isPerfect};
        if (pin) data.pin = pin; else { data.accessCode = code; data.username = name; }
        fetch('/api/game/session', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).catch(function(){});
    }
}

function startAutoTimer(isPerfect, canAdvance) {
    var count = 5;
    document.getElementById('timerCount').textContent = count;
    document.getElementById('timerCountEs').textContent = count;
    document.getElementById('continueTimer').style.display = 'block';
    
    autoTimer = setInterval(function() {
        count--;
        document.getElementById('timerCount').textContent = count;
        document.getElementById('timerCountEs').textContent = count;
        
        if (count <= 0) {
            clearInterval(autoTimer);
            if (isPerfect && canAdvance) {
                advanceNow();
            } else {
                retryNow();
            }
        }
    }, 1000);
}

function advanceNow() {
    if (autoTimer) clearInterval(autoTimer);
    var currentIdx = tierList.indexOf(selTier);
    if (currentIdx < tierList.length - 1) {
        selTier = tierList[currentIdx + 1];
    }
    startGame();
}

function retryNow() {
    if (autoTimer) clearInterval(autoTimer);
    startGame();
}

function goHome() {
    if (autoTimer) clearInterval(autoTimer);
    document.getElementById('rhythmBadge').classList.remove('visible');
    renderTiers();
    showScreen('welcomeScreen');
}

// Init
document.querySelectorAll('.lang-btn').forEach(function(b) {
    b.classList.toggle('active', b.textContent.trim() === currentLang.toUpperCase());
});
renderTiers();

// Auth check for production
if (window.location.hostname === 'gostar.digital' && !sessionStorage.getItem('gostar-user-pin')) {
    window.location.replace('https://gostar.digital/play.html');
}
</script>
</body>
</html>
