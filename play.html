<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GoTrotters‚Ñ¢ - Join the Team</title>
<meta name="description" content="Join Team GoTrotters. Start your FREE 7-day trial. GoTrotter AI guides you through the M¬≥ Performance Engine. $5/month.">
<meta name="keywords" content="cognitive training, brain games, memory exercises, senior fitness, mental agility, GoTrotters, M3 Performance">
<meta name="author" content="GoStar Digital LLC">
<meta name="robots" content="index, follow">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gotrotter.ai/play.html">
<meta property="og:title" content="GoTrotters‚Ñ¢ - Join the Team">
<meta property="og:description" content="Join Team GoTrotters. Start your FREE 7-day trial. GoTrotter AI guides you through the M¬≥ Performance Engine.">
<meta property="og:image" content="https://gotrotter.ai/m3_logo.png">
<meta property="og:site_name" content="GoTrotters">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="GoTrotters‚Ñ¢ - Join the Team">
<meta name="twitter:description" content="Join Team GoTrotters. Start your FREE 7-day trial. GoTrotter AI guides you through the M¬≥ Performance Engine.">
<meta name="twitter:image" content="https://gotrotter.ai/m3_logo.png">
<link rel="canonical" href="https://gotrotter.ai/play.html">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08WZ11ZC5X"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-08WZ11ZC5X');
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--orange:#FF6B00;--orange-dark:#CC5500;--teal:#00D9A5;--gold:#FFD700;--blue:#3B82F6;--dark:#0a0a0f;--darker:#050508;--card:#111118;--text:#FFFFFF;--muted:#8892a0;--success:#00D9A5;--danger:#FF4757}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',sans-serif;background:var(--dark);color:var(--text)}
body.es .lang-en{display:none !important}
body.en .lang-es{display:none !important}
.landing{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;background:radial-gradient(ellipse at center top,rgba(255,107,0,0.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(0,217,165,0.1) 0%,transparent 40%),var(--dark);z-index:1;transition:opacity 0.4s,transform 0.4s}
.landing.hidden{opacity:0;transform:scale(0.95);pointer-events:none}
.lang-toggle{position:absolute;top:20px;right:20px;display:flex;gap:5px}
.lang-btn{padding:8px 14px;border:2px solid var(--orange);background:transparent;color:var(--orange);border-radius:20px;font-family:'Outfit',sans-serif;font-weight:700;font-size:0.8rem;cursor:pointer;transition:all 0.3s}
.lang-btn.active{background:var(--orange);color:var(--dark)}
.logo-section{margin-bottom:30px}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(3.5rem,12vw,5rem);letter-spacing:4px;line-height:1}
.logo .go{color:var(--orange)}
.logo .trotters{color:var(--teal)}
.tagline{font-family:'Bebas Neue',sans-serif;font-size:clamp(1rem,3vw,1.3rem);letter-spacing:3px;color:var(--gold);margin-top:5px}
.hero-icon{width:100px;height:100px;margin-bottom:20px;animation:bounce 2s infinite;border-radius:50%;object-fit:cover}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.hero-text{max-width:320px;margin-bottom:40px}
.hero-text p{font-size:1.1rem;color:var(--muted);line-height:1.6}
.hero-text strong{color:var(--text)}
.go-btn{padding:22px 60px;font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:5px;background:linear-gradient(135deg,var(--orange) 0%,var(--orange-dark) 100%);color:var(--text);border:none;border-radius:60px;cursor:pointer;box-shadow:0 10px 40px rgba(255,107,0,0.5);transition:all 0.3s;display:flex;align-items:center;gap:12px}
.go-btn:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 15px 50px rgba(255,107,0,0.6)}
.go-btn:active{transform:translateY(0) scale(0.98)}
.go-btn-icon{width:32px;height:32px;border-radius:50%;object-fit:cover}
.footer-text{position:absolute;bottom:25px;font-size:0.75rem;color:var(--muted)}
.footer-text a{color:var(--teal);text-decoration:none}
.chat-screen{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--dark);display:flex;flex-direction:column;z-index:10;opacity:0;transform:translateY(100%);transition:opacity 0.4s,transform 0.4s;pointer-events:none}
.chat-screen.active{opacity:1;transform:translateY(0);pointer-events:auto}
.chat-header{padding:15px 20px;background:linear-gradient(135deg,rgba(255,107,0,0.1),rgba(0,217,165,0.05));border-bottom:2px solid rgba(255,107,0,0.3);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.chat-header-left{display:flex;align-items:center;gap:12px}
.chat-avatar{width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:transparent}
.chat-avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.chat-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px}
.chat-title .go{color:var(--orange)}
.chat-title .tr{color:var(--teal)}
.chat-subtitle{font-size:0.65rem;color:var(--muted);letter-spacing:1px}
.chat-status{display:flex;align-items:center;gap:6px;font-size:0.7rem;color:var(--teal)}
.chat-dot{width:8px;height:8px;background:var(--teal);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.chat-header-right{display:flex;align-items:center;gap:10px}
.chat-lang-btn{padding:6px 12px;border:2px solid var(--orange);background:transparent;color:var(--orange);border-radius:15px;font-weight:700;font-size:0.7rem;cursor:pointer;transition:all 0.3s}
.chat-lang-btn.active{background:var(--orange);color:var(--dark)}
.chat-close{width:36px;height:36px;background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:var(--muted);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.chat-body{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px}
.chat-msg{display:flex;gap:10px;max-width:90%;animation:msgIn 0.3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.bot{align-self:flex-start}
.chat-msg.user{align-self:flex-end;flex-direction:row-reverse}
.chat-msg-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden}
.chat-msg-avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.chat-msg.bot .chat-msg-avatar{background:transparent}
.chat-msg.user .chat-msg-avatar{background:var(--blue)}
.chat-msg-bubble{background:var(--card);border:1px solid rgba(255,255,255,0.1);border-radius:18px;padding:14px 18px;font-size:0.95rem;line-height:1.6}
.chat-msg.user .chat-msg-bubble{background:linear-gradient(135deg,var(--blue),#2563EB);border:none}
.chat-msg-bubble strong{color:var(--orange)}
.chat-msg-bubble .highlight{color:var(--teal)}
.chat-options{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.chat-option{padding:12px 20px;background:rgba(0,217,165,0.1);border:2px solid rgba(0,217,165,0.4);color:var(--teal);border-radius:25px;font-weight:700;font-size:0.85rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
.chat-option:hover{background:rgba(0,217,165,0.2);transform:scale(1.02)}
.chat-option:active{transform:scale(0.98)}
.chat-option.primary{background:linear-gradient(135deg,var(--orange),var(--orange-dark));border:none;color:var(--text)}
.chat-option.secondary{background:rgba(255,107,0,0.1);border:2px solid rgba(255,107,0,0.4);color:var(--orange)}
.chat-typing{display:flex;gap:5px;padding:10px 0}
.chat-typing span{width:10px;height:10px;background:var(--muted);border-radius:50%;animation:typing 1.4s infinite}
.chat-typing span:nth-child(2){animation-delay:0.2s}
.chat-typing span:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,100%{transform:translateY(0);opacity:0.5}50%{transform:translateY(-8px);opacity:1}}
.chat-input-area{padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1);background:var(--darker);flex-shrink:0;display:none}
.chat-input-area.visible{display:block}
.chat-input-row{display:flex;gap:10px;align-items:center;background:var(--card);border:2px solid rgba(255,255,255,0.1);border-radius:50px;padding:6px 6px 6px 20px}
.chat-input-row:focus-within{border-color:var(--orange)}
.chat-input{flex:1;background:none;border:none;color:var(--text);font-size:1rem;outline:none;font-family:'Outfit',sans-serif}
.chat-input::placeholder{color:var(--muted)}
.chat-send{width:44px;height:44px;background:linear-gradient(135deg,var(--orange),var(--teal));border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-send svg{width:20px;height:20px;fill:var(--text)}
.pin-input-container{display:flex;gap:12px;justify-content:center;margin-top:15px}
.pin-digit{width:50px;height:60px;background:var(--card);border:3px solid rgba(255,255,255,0.2);border-radius:12px;font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--text);text-align:center;outline:none;transition:all 0.2s}
.pin-digit:focus{border-color:var(--orange);box-shadow:0 0 20px rgba(255,107,0,0.3)}
.pin-digit.filled{border-color:var(--teal);background:rgba(0,217,165,0.1)}
.pin-submit{margin-top:20px;padding:14px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:var(--text);border:none;border-radius:30px;cursor:pointer;opacity:0.5;pointer-events:none;transition:all 0.3s}
.pin-submit.ready{opacity:1;pointer-events:auto}
.pin-submit.ready:hover{transform:scale(1.05)}
.plan-cards{display:flex;flex-direction:column;gap:12px;margin-top:15px;width:100%}
.plan-card{background:var(--card);border:2px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px;cursor:pointer;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center}
.plan-card:hover{border-color:var(--orange);transform:translateX(5px)}
.plan-card.selected{border-color:var(--teal);background:rgba(0,217,165,0.1)}
.plan-card.popular{border-color:var(--gold)}
.plan-card-left{text-align:left}
.plan-name{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--text);display:flex;align-items:center;gap:8px}
.plan-name .popular-badge{font-size:0.6rem;background:var(--gold);color:var(--dark);padding:3px 8px;border-radius:10px;font-family:'Outfit',sans-serif;font-weight:700}
.plan-desc{font-size:0.75rem;color:var(--muted);margin-top:4px}
.plan-price{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--orange)}
.plan-price span{font-size:0.8rem;color:var(--muted)}
.billing-toggle{display:flex;gap:8px;margin-top:15px;justify-content:center}
.billing-btn{padding:10px 20px;background:var(--card);border:2px solid rgba(255,255,255,0.1);border-radius:20px;color:var(--muted);font-weight:700;font-size:0.8rem;cursor:pointer;transition:all 0.2s}
.billing-btn.active{border-color:var(--teal);background:rgba(0,217,165,0.1);color:var(--teal)}
.billing-btn .save-badge{font-size:0.65rem;background:var(--success);color:var(--dark);padding:2px 6px;border-radius:8px;margin-left:6px}
.subscribe-btn{margin-top:20px;padding:16px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:var(--text);border:none;border-radius:30px;cursor:pointer;box-shadow:0 5px 25px rgba(255,107,0,0.4);transition:all 0.3s;opacity:0.5;pointer-events:none}
.subscribe-btn.ready{opacity:1;pointer-events:auto}
.subscribe-btn.ready:hover{transform:scale(1.05);box-shadow:0 8px 30px rgba(255,107,0,0.5)}
.subscribe-btn.loading{opacity:0.7;pointer-events:none}
.terms-section{margin-top:20px;text-align:left;font-size:0.85rem}
.terms-check{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;cursor:pointer}
.terms-check input{display:none}
.terms-checkbox{width:22px;height:22px;border:2px solid var(--muted);border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;background:var(--darker)}
.terms-check input:checked + .terms-checkbox{background:var(--teal);border-color:var(--teal)}
.terms-check input:checked + .terms-checkbox::after{content:'‚úì';color:var(--dark);font-weight:700;font-size:0.9rem}
.terms-label{color:var(--muted);line-height:1.4}
.terms-label a{color:var(--teal);text-decoration:underline}
.terms-label a:hover{color:var(--orange)}
.trial-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:20px;font-size:0.8rem;color:var(--gold);margin-top:10px}
.status-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:20px;font-size:0.8rem;margin-top:10px}
.status-badge.active{background:rgba(0,217,165,0.1);border:1px solid rgba(0,217,165,0.3);color:var(--teal)}
.status-badge.trialing{background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);color:var(--gold)}
.pin-display{background:linear-gradient(135deg,rgba(0,217,165,0.2),rgba(255,107,0,0.2));border:3px solid var(--teal);border-radius:20px;padding:25px;margin:15px 0;text-align:center}
.pin-display-label{font-size:0.85rem;color:var(--muted);margin-bottom:10px;letter-spacing:1px}
.pin-display-value{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;letter-spacing:15px;color:var(--teal);text-shadow:0 0 30px rgba(0,217,165,0.5)}
.pin-display-note{font-size:0.75rem;color:var(--gold);margin-top:10px}
.email-input-container{margin-top:15px}
.email-input{width:100%;padding:14px 20px;background:var(--card);border:2px solid rgba(255,255,255,0.2);border-radius:12px;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--text);outline:none;transition:all 0.2s}
.email-input:focus{border-color:var(--orange);box-shadow:0 0 20px rgba(255,107,0,0.2)}
.email-input::placeholder{color:var(--muted)}
.email-submit{margin-top:15px;padding:14px 40px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:var(--text);border:none;border-radius:30px;cursor:pointer;transition:all 0.3s}
.email-submit:hover{transform:scale(1.05)}
.email-submit.loading{opacity:0.7;pointer-events:none}
.success-burst{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:6rem;z-index:100;animation:burst 0.8s ease-out forwards;pointer-events:none}
@keyframes burst{0%{opacity:1;transform:translate(-50%,-50%) scale(0.5)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}}
@media(max-width:400px){
.go-btn{padding:18px 45px;font-size:1.5rem}
.pin-digit{width:45px;height:55px;font-size:1.8rem}
.plan-card{padding:12px}
.pin-display-value{font-size:2.8rem;letter-spacing:10px}
}
</style>
</head>
<body class="en">
<div class="landing" id="landing">
<div class="lang-toggle">
<button class="lang-btn active" data-lang="en">EN</button>
<button class="lang-btn" data-lang="es">ES</button>
</div>
<div class="logo-section">
<div class="logo"><span class="go">GO</span><span class="trotters">TROTTERS</span><sup style="font-size:0.3em;vertical-align:super;">‚Ñ¢</sup></div>
<div class="tagline">TEAM GOTROTTERS</div>
</div>
<img src="m3_logo.png" alt="M¬≥ Performance Engine" class="hero-icon">
<div class="hero-text">
<p><span class="lang-en"><strong>The M¬≥ Performance Engine.</strong> 10-shift progression. Coach GoTrotter AI. $5/month.</span><span class="lang-es"><strong>El Motor de Rendimiento M¬≥.</strong> Progresi√≥n de 10 cambios. Coach GoTrotter AI. $5/mes.</span></p>
</div>
<button class="go-btn" id="goBtn">
<img src="go_chat.png" alt="" class="go-btn-icon">
<span class="lang-en">JOIN THE TEAM</span><span class="lang-es">√öNETE AL EQUIPO</span>
</button>
<div class="footer-text">
<span class="lang-en">Powered by</span><span class="lang-es">Impulsado por</span> <a href="https://gostar.digital">GoStar Digital</a> üå¥
</div>
</div>
<div class="chat-screen" id="chatScreen">
<div class="chat-header">
<div class="chat-header-left">
<div class="chat-avatar"><img src="m3_logo.png" alt="M¬≥" class="chat-avatar-img"></div>
<div>
<div class="chat-title"><span class="go">GO</span><span class="tr">TROTTER</span>‚Ñ¢ AI</div>
<div class="chat-subtitle">Coach, Team GoTrotters</div>
<div class="chat-status"><span class="chat-dot"></span><span class="lang-en">Online</span><span class="lang-es">En L√≠nea</span></div>
</div>
</div>
<div class="chat-header-right">
<button class="chat-lang-btn active" data-lang="en">EN</button>
<button class="chat-lang-btn" data-lang="es">ES</button>
<button class="chat-close" id="chatClose">√ó</button>
</div>
</div>
<div class="chat-body" id="chatBody"></div>
<div class="chat-input-area" id="chatInputArea">
<div class="chat-input-row">
<input type="text" class="chat-input" id="chatInput" maxlength="100">
<button class="chat-send" id="chatSend">
<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
</button>
</div>
</div>
</div>
<script>
(function() {
    var lang = localStorage.getItem('gt-lang') || 'en';
    function setLang(l) {
        lang = l;
        localStorage.setItem('gt-lang', l);
        document.body.className = l;
        document.querySelectorAll('.lang-btn, .chat-lang-btn').forEach(function(b) {
            b.classList.toggle('active', b.dataset.lang === l);
        });
    }
    setLang(lang);
    document.querySelectorAll('.lang-btn, .chat-lang-btn').forEach(function(b) {
        b.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            setLang(this.dataset.lang);
        });
    });
    var landing = document.getElementById('landing');
    var chatScreen = document.getElementById('chatScreen');
    var chatBody = document.getElementById('chatBody');
    var chatInputArea = document.getElementById('chatInputArea');
    var chatInput = document.getElementById('chatInput');
    var chatSend = document.getElementById('chatSend');
    var goBtn = document.getElementById('goBtn');
    var chatClose = document.getElementById('chatClose');
    var currentFlow = null;
    var currentStep = null;
    var tempData = {};
    var selectedPlan = 'individual';
    var selectedBilling = 'monthly';
    function getUser() {
        try { return JSON.parse(localStorage.getItem('gotrotter-user')) || null; }
        catch(e) { return null; }
    }
    function saveUser(data) {
        localStorage.setItem('gotrotter-user', JSON.stringify(data));
    }
    function setSession(name, pin) {
        sessionStorage.setItem('gostar-user-pin', pin);
        sessionStorage.setItem('gostar-user-name', name);
    }
    function bi(en, es) {
        return '<span class="lang-en">' + en + '</span><span class="lang-es">' + es + '</span>';
    }
    function addMsg(content, isUser, options) {
        var msg = document.createElement('div');
        msg.className = 'chat-msg ' + (isUser ? 'user' : 'bot');
        var avatarContent = isUser ? 'üë§' : '<img src="go_chat.png" class="chat-msg-avatar-img">';
        var html = '<div class="chat-msg-avatar">' + avatarContent + '</div>';
        html += '<div class="chat-msg-bubble">' + content;
        if (options && options.length) {
            html += '<div class="chat-options">';
            options.forEach(function(opt) {
                var cls = 'chat-option';
                if (opt.primary) cls += ' primary';
                if (opt.secondary) cls += ' secondary';
                var label = opt.labelEn ? bi(opt.labelEn, opt.labelEs) : opt.label;
                html += '<button class="' + cls + '" data-action="' + opt.action + '">' + label + '</button>';
            });
            html += '</div>';
        }
        html += '</div>';
        msg.innerHTML = html;
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        msg.querySelectorAll('.chat-option').forEach(function(btn) {
            btn.addEventListener('click', function() {
                handleOption(this.dataset.action);
            });
        });
    }
    function addTyping() {
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.id = 'typingMsg';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble"><div class="chat-typing"><span></span><span></span><span></span></div></div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
    function removeTyping() {
        var t = document.getElementById('typingMsg');
        if (t) t.remove();
    }
    function botSay(content, options, delay) {
        delay = delay || 800;
        addTyping();
        setTimeout(function() {
            removeTyping();
            addMsg(content, false, options);
        }, delay);
    }
    function showInput(placeholderEn, placeholderEs) {
        chatInputArea.classList.add('visible');
        chatInput.placeholder = lang === 'es' ? (placeholderEs || 'Escribe aqu√≠...') : (placeholderEn || 'Type here...');
        chatInput.value = '';
        setTimeout(function() { chatInput.focus(); }, 100);
    }
    function hideInput() {
        chatInputArea.classList.remove('visible');
    }
    function addPinInput() {
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble">' +
            '<div class="pin-input-container">' +
            '<input type="tel" class="pin-digit" maxlength="1" data-idx="0">' +
            '<input type="tel" class="pin-digit" maxlength="1" data-idx="1">' +
            '<input type="tel" class="pin-digit" maxlength="1" data-idx="2">' +
            '<input type="tel" class="pin-digit" maxlength="1" data-idx="3">' +
            '</div>' +
            '<button class="pin-submit" id="pinSubmit">' + bi("LET'S GO!", "PA'LANTE!") + '</button>' +
            '<div style="margin-top:15px;"><a href="#" class="forgot-pin-link" style="color:var(--muted);font-size:0.8rem;text-decoration:underline;">' + bi('Forgot PIN?', '¬øOlvidaste tu PIN?') + '</a></div>' +
            '</div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        var digits = msg.querySelectorAll('.pin-digit');
        var submitBtn = msg.querySelector('#pinSubmit');
        var forgotLink = msg.querySelector('.forgot-pin-link');
        function checkComplete() {
            var pin = '';
            digits.forEach(function(d) { pin += d.value; });
            submitBtn.classList.toggle('ready', pin.length === 4);
        }
        digits.forEach(function(d, i) {
            d.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value && i < 3) digits[i + 1].focus();
                this.classList.toggle('filled', this.value !== '');
                checkComplete();
            });
            d.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && i > 0) digits[i - 1].focus();
            });
        });
        submitBtn.addEventListener('click', function() {
            if (!this.classList.contains('ready')) return;
            var pin = '';
            digits.forEach(function(d) { pin += d.value; });
            handlePinSubmit(pin);
        });
        forgotLink.addEventListener('click', function(e) {
            e.preventDefault();
            addForgotPinInput();
        });
        setTimeout(function() { digits[0].focus(); }, 100);
    }
    function addForgotPinInput() {
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble">' +
            bi(
                'üîë <strong>No problem!</strong><br><br>Enter your email to recover your PIN:',
                'üîë <strong>¬°No hay problema!</strong><br><br>Ingresa tu email para recuperar tu PIN:'
            ) +
            '<div class="email-input-container">' +
            '<input type="email" class="email-input" id="forgotEmailInput" placeholder="' + (lang === 'es' ? 'tu@email.com' : 'your@email.com') + '">' +
            '<button class="email-submit" id="forgotEmailSubmit">' + bi('RECOVER PIN', 'RECUPERAR PIN') + '</button>' +
            '</div>' +
            '</div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        var emailInput = msg.querySelector('#forgotEmailInput');
        var emailSubmit = msg.querySelector('#forgotEmailSubmit');
        emailInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleForgotPinLookup(this.value);
        });
        emailSubmit.addEventListener('click', function() {
            handleForgotPinLookup(emailInput.value);
        });
        setTimeout(function() { emailInput.focus(); }, 100);
    }
    function handleForgotPinLookup(email) {
        email = email.trim().toLowerCase();
        if (!email || !email.includes('@')) {
            alert(lang === 'es' ? 'Por favor ingresa un email v√°lido' : 'Please enter a valid email');
            return;
        }
        var submitBtn = document.getElementById('forgotEmailSubmit');
        if (submitBtn) {
            submitBtn.classList.add('loading');
            submitBtn.innerHTML = bi('LOADING...', 'CARGANDO...');
        }
        fetch('/api/stripe/status/' + encodeURIComponent(email))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.subscribed && data.pin) {
                    showPinDisplay(data.pin, email, data.plan_type, data.status);
                } else {
                    botSay(bi(
                        '‚ùå No subscription found for that email.<br><br>Make sure you entered the correct email.',
                        '‚ùå No se encontr√≥ suscripci√≥n para ese email.<br><br>Aseg√∫rate de ingresar el email correcto.'
                    ), [
                        {labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar de Nuevo', action: 'forgot_pin'},
                        {labelEn: 'üÜï Subscribe', labelEs: 'üÜï Suscribirme', action: 'new'}
                    ], 600);
                }
            })
            .catch(function(err) {
                console.error('Forgot PIN lookup error:', err);
                botSay(bi('‚ùå Connection error. Please try again.', '‚ùå Error de conexi√≥n. Por favor intenta de nuevo.'), [
                    {labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar de Nuevo', action: 'forgot_pin'}
                ], 600);
            });
    }
    function addEmailInput() {
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble">' +
            bi(
                'üéâ <strong>WELCOME TO TEAM GOTROTTERS!</strong><br><br>Your <strong>7-day free trial</strong> has started!<br><br>Enter the email you used at checkout to get your PIN:',
                'üéâ <strong>¬°BIENVENIDO A TEAM GOTROTTERS!</strong><br><br>¬°Tu <strong>prueba gratis de 7 d√≠as</strong> ha comenzado!<br><br>Ingresa el email que usaste en el pago para obtener tu PIN:'
            ) +
            '<div class="email-input-container">' +
            '<input type="email" class="email-input" id="emailInput" placeholder="' + (lang === 'es' ? 'tu@email.com' : 'your@email.com') + '">' +
            '<button class="email-submit" id="emailSubmit">' + bi('GET MY PIN', 'OBTENER MI PIN') + '</button>' +
            '</div>' +
            '</div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        var emailInput = msg.querySelector('#emailInput');
        var emailSubmit = msg.querySelector('#emailSubmit');
        emailInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleEmailLookup(this.value);
        });
        emailSubmit.addEventListener('click', function() {
            handleEmailLookup(emailInput.value);
        });
        setTimeout(function() { emailInput.focus(); }, 100);
    }
    function handleEmailLookup(email) {
        email = email.trim().toLowerCase();
        if (!email || !email.includes('@')) {
            alert(lang === 'es' ? 'Por favor ingresa un email v√°lido' : 'Please enter a valid email');
            return;
        }
        var submitBtn = document.getElementById('emailSubmit');
        if (submitBtn) {
            submitBtn.classList.add('loading');
            submitBtn.innerHTML = bi('LOADING...', 'CARGANDO...');
        }
        fetch('/api/stripe/status/' + encodeURIComponent(email))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.subscribed && data.pin) {
                    showPinDisplay(data.pin, email, data.plan, data.status);
                } else {
                    botSay(bi(
                        '‚ùå No subscription found for that email.<br><br>Make sure you entered the same email you used at checkout.',
                        '‚ùå No se encontr√≥ suscripci√≥n para ese email.<br><br>Aseg√∫rate de ingresar el mismo email que usaste en el pago.'
                    ), [
                        {labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar de Nuevo', action: 'retry_email'},
                        {labelEn: 'üÜï Subscribe', labelEs: 'üÜï Suscribirme', action: 'new'}
                    ], 600);
                }
            })
            .catch(function(err) {
                console.error('Email lookup error:', err);
                botSay(bi('‚ùå Connection error. Please try again.', '‚ùå Error de conexi√≥n. Por favor intenta de nuevo.'), [
                    {labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar de Nuevo', action: 'retry_email'}
                ], 600);
            });
    }
    function showPinDisplay(pin, email, plan, status) {
        var userData = { email: email, pin: pin, plan: plan, type: 'subscriber' };
        saveUser(userData);
        setSession(email, pin);
        showSuccess('üéâ');
        var statusText = status === 'trialing' ? bi('üÜì FREE TRIAL ACTIVE', 'üÜì PRUEBA GRATIS ACTIVA') : bi('‚úÖ SUBSCRIPTION ACTIVE', '‚úÖ SUSCRIPCI√ìN ACTIVA');
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble">' +
            '<div class="pin-display">' +
            '<div class="pin-display-label">' + bi('YOUR LOGIN PIN', 'TU PIN DE ACCESO') + '</div>' +
            '<div class="pin-display-value">' + pin + '</div>' +
            '<div class="pin-display-note">üìù ' + bi('Save this PIN!', '¬°Guarda este PIN!') + '</div>' +
            '</div>' +
            '<div class="status-badge ' + status + '">' + statusText + '</div>' +
            '<div class="chat-options">' +
            '<button class="chat-option primary" data-action="start_training">' + bi("üèÄ LET'S GO!", "üèÄ PA'LANTE!") + '</button>' +
            '</div>' +
            '</div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        msg.querySelectorAll('.chat-option').forEach(function(btn) {
            btn.addEventListener('click', function() { handleOption(this.dataset.action); });
        });
    }
    function addPlanSelector() {
        var msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = '<div class="chat-msg-avatar"><img src="go_chat.png" class="chat-msg-avatar-img"></div><div class="chat-msg-bubble">' +
            '<div class="billing-toggle">' +
            '<button class="billing-btn active" data-billing="monthly">' + bi('Monthly', 'Mensual') + '</button>' +
            '<button class="billing-btn" data-billing="annual">' + bi('Annual', 'Anual') + '<span class="save-badge">' + bi('SAVE 17%', 'AHORRA 17%') + '</span></button>' +
            '</div>' +
            '<div class="plan-cards" id="planCards">' +
            '<div class="plan-card popular selected" data-plan="individual">' +
            '<div class="plan-card-left"><div class="plan-name">üë§ ' + bi('Individual', 'Individual') + ' <span class="popular-badge">' + bi('POPULAR', 'POPULAR') + '</span></div>' +
            '<div class="plan-desc">' + bi('1 user ‚Ä¢ All 3 gears ‚Ä¢ 10 shifts', '1 usuario ‚Ä¢ 3 engranajes ‚Ä¢ 10 cambios') + '</div></div>' +
            '<div class="plan-price" id="priceIndividual">$5<span>/mo</span></div>' +
            '</div>' +
            '<div class="plan-card" data-plan="family">' +
            '<div class="plan-card-left"><div class="plan-name">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ' + bi('Family', 'Familia') + '</div>' +
            '<div class="plan-desc">' + bi('Up to 5 users ‚Ä¢ All features', 'Hasta 5 usuarios ‚Ä¢ Todas las funciones') + '</div></div>' +
            '<div class="plan-price" id="priceFamily">$20<span>/mo</span></div>' +
            '</div>' +
            '</div>' +
            '<div class="trial-badge">üÜì ' + bi('7-DAY FREE TRIAL INCLUDED', '7 D√çAS GRATIS INCLUIDOS') + '</div>' +
            '<div class="terms-section">' +
            '<label class="terms-check"><input type="checkbox" id="termsCheck"><span class="terms-checkbox"></span><span class="terms-label">' + bi('I agree to the <a href="/terms.html" target="_blank">Terms of Service</a>', 'Acepto los <a href="/terms.html" target="_blank">T√©rminos de Servicio</a>') + '</span></label>' +
            '<label class="terms-check"><input type="checkbox" id="privacyCheck"><span class="terms-checkbox"></span><span class="terms-label">' + bi('I agree to the <a href="/privacy.html" target="_blank">Privacy Policy</a>', 'Acepto la <a href="/privacy.html" target="_blank">Pol√≠tica de Privacidad</a>') + '</span></label>' +
            '</div>' +
            '<button class="subscribe-btn" id="subscribeBtn">' + bi('START FREE TRIAL', 'COMENZAR PRUEBA GRATIS') + '</button>' +
            '</div>';
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        var planCards = msg.querySelectorAll('.plan-card');
        var billingBtns = msg.querySelectorAll('.billing-btn');
        var subscribeBtn = msg.querySelector('#subscribeBtn');
        var priceIndividual = msg.querySelector('#priceIndividual');
        var priceFamily = msg.querySelector('#priceFamily');
        var termsCheck = msg.querySelector('#termsCheck');
        var privacyCheck = msg.querySelector('#privacyCheck');
        
        function checkTermsAccepted() {
            if (termsCheck.checked && privacyCheck.checked) {
                subscribeBtn.classList.add('ready');
            } else {
                subscribeBtn.classList.remove('ready');
            }
        }
        
        termsCheck.addEventListener('change', checkTermsAccepted);
        privacyCheck.addEventListener('change', checkTermsAccepted);
        
        function updatePrices() {
            if (selectedBilling === 'monthly') {
                priceIndividual.innerHTML = '$5<span>/mo</span>';
                priceFamily.innerHTML = '$20<span>/mo</span>';
            } else {
                priceIndividual.innerHTML = '$50<span>/yr</span>';
                priceFamily.innerHTML = '$200<span>/yr</span>';
            }
        }
        planCards.forEach(function(card) {
            card.addEventListener('click', function() {
                planCards.forEach(function(c) { c.classList.remove('selected'); });
                this.classList.add('selected');
                selectedPlan = this.dataset.plan;
            });
        });
        billingBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                billingBtns.forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                selectedBilling = this.dataset.billing;
                updatePrices();
            });
        });
        subscribeBtn.addEventListener('click', function() { 
            if (!termsCheck.checked || !privacyCheck.checked) {
                alert(lang === 'es' ? 'Por favor acepta los T√©rminos de Servicio y la Pol√≠tica de Privacidad' : 'Please accept the Terms of Service and Privacy Policy');
                return;
            }
            handleSubscribe(); 
        });
    }
    function showSuccess(emoji) {
        var burst = document.createElement('div');
        burst.className = 'success-burst';
        burst.textContent = emoji || 'üèÄ';
        document.body.appendChild(burst);
        setTimeout(function() { burst.remove(); }, 800);
    }
    function goToGameHub() {
        showSuccess('üèÜ');
        setTimeout(function() { window.location.href = 'game-hub.html'; }, 1000);
    }
    function handleSubscribe() {
        var subscribeBtn = document.getElementById('subscribeBtn');
        if (subscribeBtn) {
            subscribeBtn.classList.add('loading');
            subscribeBtn.innerHTML = bi('LOADING...', 'CARGANDO...');
        }
        fetch('/api/stripe/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: selectedPlan, billing: selectedBilling })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert(lang === 'es' ? 'Error al crear la sesi√≥n de pago' : 'Error creating checkout session');
                if (subscribeBtn) {
                    subscribeBtn.classList.remove('loading');
                    subscribeBtn.innerHTML = bi('START FREE TRIAL', 'COMENZAR PRUEBA GRATIS');
                }
            }
        })
        .catch(function(err) {
            console.error('Checkout error:', err);
            alert(lang === 'es' ? 'Error de conexi√≥n' : 'Connection error');
            if (subscribeBtn) {
                subscribeBtn.classList.remove('loading');
                subscribeBtn.innerHTML = bi('START FREE TRIAL', 'COMENZAR PRUEBA GRATIS');
            }
        });
    }
    
    // ========== UPDATED: Auto-fetch PIN using session_id ==========
    function checkUrlParams() {
        var params = new URLSearchParams(window.location.search);
        
        if (params.get('success') === 'true') {
            var sessionId = params.get('session_id');
            window.history.replaceState({}, '', window.location.pathname);
            
            setTimeout(function() {
                openChat();
                setTimeout(function() {
                    // Show loading message
                    addMsg(bi(
                        'üéâ <strong>PAYMENT SUCCESSFUL!</strong><br><br>Loading your account...',
                        'üéâ <strong>¬°PAGO EXITOSO!</strong><br><br>Cargando tu cuenta...'
                    ), false);
                    addTyping();
                    
                    // If we have session_id, auto-fetch PIN (no email needed!)
                    if (sessionId) {
                        fetchPinBySession(sessionId);
                    } else {
                        // Fallback to email input
                        removeTyping();
                        addEmailInput();
                    }
                }, 500);
            }, 300);
            return true;
        }
        
        if (params.get('canceled') === 'true') {
            window.history.replaceState({}, '', window.location.pathname);
            setTimeout(function() {
                openChat();
                setTimeout(function() {
                    addMsg(bi('No worries! üèÄ<br><br>You can subscribe anytime.', '¬°Sin problema! üèÄ<br><br>Puedes suscribirte cuando quieras.'), false, [
                        {labelEn: 'üÜï Subscribe', labelEs: 'üÜï Suscribirme', action: 'new'},
                        {labelEn: 'üîë I Have PIN', labelEs: 'üîë Tengo PIN', action: 'returning'},
                        {labelEn: 'üè¢ Facility', labelEs: 'üè¢ Instalaci√≥n', action: 'facility'}
                    ]);
                }, 500);
            }, 300);
            return true;
        }
        return false;
    }
    
    // ========== NEW: Fetch PIN by Stripe Session ID ==========
    function fetchPinBySession(sessionId) {
        var retryCount = 0;
        var maxRetries = 5;
        
        function attemptFetch() {
            fetch('/api/stripe/session/' + sessionId)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    removeTyping();
                    
                    if (data.success && data.pin) {
                        // SUCCESS! Show PIN automatically
                        showPinDisplay(data.pin, data.email, data.plan_type, data.status);
                    } else if (data.email && !data.success && retryCount < maxRetries) {
                        // Webhook might still be processing, retry
                        retryCount++;
                        addMsg(bi(
                            '‚è≥ Setting up your account... (' + retryCount + '/' + maxRetries + ')',
                            '‚è≥ Configurando tu cuenta... (' + retryCount + '/' + maxRetries + ')'
                        ), false);
                        addTyping();
                        setTimeout(attemptFetch, 2000);
                    } else if (data.email) {
                        // Have email but no subscriber yet - try one more lookup
                        addMsg(bi(
                            '‚è≥ Almost there! Checking your account...',
                            '‚è≥ ¬°Casi listo! Verificando tu cuenta...'
                        ), false);
                        handleEmailLookup(data.email);
                    } else {
                        // No email found - fallback to manual entry
                        addEmailInput();
                    }
                })
                .catch(function(err) {
                    removeTyping();
                    console.error('Session lookup error:', err);
                    // Fallback to email input
                    addEmailInput();
                });
        }
        
        attemptFetch();
    }
    
    function openChat() {
        landing.classList.add('hidden');
        chatScreen.classList.add('active');
        chatBody.innerHTML = '';
        hideInput();
        var user = getUser();
        if (user && user.pin && user.type === 'subscriber') {
            setTimeout(function() {
                addMsg(bi('Hey! üèÄ Welcome back to <strong>Team GoTrotters</strong>!', '¬°Hola! üèÄ ¬°Bienvenido de vuelta a <strong>Team GoTrotters</strong>!'), false);
                currentFlow = 'subscriber';
                currentStep = 'ask_pin';
                botSay(bi('Enter your PIN to continue:', 'Ingresa tu PIN para continuar:'), null, 600);
                setTimeout(addPinInput, 1500);
            }, 400);
        } else if (user && user.pin && user.type === 'facility') {
            setTimeout(function() {
                addMsg(bi('Hey! üèÄ Welcome back!', '¬°Hola! üèÄ ¬°Bienvenido de vuelta!'), false);
                botSay(bi('Are you <strong>' + user.name + '</strong>?', '¬øEres <strong>' + user.name + '</strong>?'), [
                    {labelEn: '‚úÖ Yes', labelEs: '‚úÖ S√≠', action: 'confirm_facility_user'},
                    {labelEn: 'üë§ No', labelEs: 'üë§ No', action: 'new'}
                ], 600);
            }, 400);
        } else {
            setTimeout(function() {
                addMsg(bi('Hey! üèÄ I\'m <strong>GoTrotter‚Ñ¢ AI</strong> ‚Äî Coach, Team GoTrotters.', '¬°Qu√© pasa! üèÄ Soy <strong>GoTrotter‚Ñ¢ AI</strong> ‚Äî Coach, Team GoTrotters.'), false);
                botSay(bi('Welcome to Team GoTrotters.<br><br>What brings you here?', 'Bienvenido a Team GoTrotters.<br><br>¬øQu√© te trae por aqu√≠?'), [
                    {labelEn: 'üÜï I\'m New ‚Äî Subscribe', labelEs: 'üÜï Soy Nuevo ‚Äî Suscribirme', action: 'new', primary: true},
                    {labelEn: 'üîë I Have PIN', labelEs: 'üîë Tengo PIN', action: 'returning'},
                    {labelEn: 'üè¢ Facility Code', labelEs: 'üè¢ C√≥digo Instalaci√≥n', action: 'facility'}
                ], 600);
            }, 400);
        }
    }
    function handleOption(action) {
        document.querySelectorAll('.chat-option').forEach(function(b) {
            b.style.pointerEvents = 'none';
            b.style.opacity = '0.5';
        });
        switch(action) {
            case 'new':
                currentFlow = 'new';
                botSay(bi("Let's get you on the team! üéâ<br><br>Choose your plan:", '¬°Vamos a ponerte en el equipo! üéâ<br><br>Elige tu plan:'), null, 600);
                setTimeout(addPlanSelector, 1500);
                break;
            case 'returning':
                currentFlow = 'subscriber';
                currentStep = 'ask_pin';
                botSay(bi('Welcome back! üèÄ<br><br>Enter your 4-digit PIN:', '¬°Bienvenido! üèÄ<br><br>Ingresa tu PIN de 4 d√≠gitos:'), null, 600);
                setTimeout(addPinInput, 1500);
                break;
            case 'facility':
                currentFlow = 'facility';
                currentStep = 'ask_facility_code';
                botSay(bi('Perfect! üè¢<br><br>What\'s your facility code?', '¬°Perfecto! üè¢<br><br>¬øCu√°l es tu c√≥digo de instalaci√≥n?'), null, 600);
                setTimeout(function() { showInput('Facility code...', 'C√≥digo...'); }, 1500);
                break;
            case 'confirm_facility_user':
                currentFlow = 'facility';
                currentStep = 'ask_pin';
                botSay(bi('Great! Enter your PIN:', '¬°Excelente! Ingresa tu PIN:'), null, 400);
                setTimeout(addPinInput, 1200);
                break;
            case 'start_training':
                goToGameHub();
                break;
            case 'manage_subscription':
                handleManageSubscription();
                break;
            case 'retry_email':
                addEmailInput();
                break;
            case 'forgot_pin':
                addForgotPinInput();
                break;
        }
    }
    function handleTextInput(text) {
        text = text.trim();
        if (!text) return;
        addMsg(text, true);
        hideInput();
        if (currentFlow === 'facility' && currentStep === 'ask_facility_code') {
            tempData.facilityCode = text.toUpperCase();
            currentStep = 'ask_facility_name';
            botSay(bi('Got it! üè¢<br><br>What\'s your name?', '¬°Recibido! üè¢<br><br>¬øCu√°l es tu nombre?'), null, 600);
            setTimeout(function() { showInput('Your name...', 'Tu nombre...'); }, 1500);
        }
        else if (currentFlow === 'facility' && currentStep === 'ask_facility_name') {
            tempData.name = text;
            fetch('/api/play/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accessCode: tempData.facilityCode, username: tempData.name })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    var userData = { name: data.username, pin: data.pin, facilityCode: tempData.facilityCode, type: 'facility' };
                    saveUser(userData);
                    setSession(userData.name, userData.pin);
                    var msg = bi(
                        'üè¢ <strong>YOU\'RE ON THE TEAM!</strong><br><br>Welcome, <strong>' + data.username + '</strong>!',
                        'üè¢ <strong>¬°EST√ÅS EN EL EQUIPO!</strong><br><br>¬°Bienvenido, <strong>' + data.username + '</strong>!'
                    ) + '<div class="pin-display"><div class="pin-display-label">' + bi('YOUR PIN', 'TU PIN') + '</div><div class="pin-display-value">' + data.pin + '</div><div class="pin-display-note">üìù ' + bi('Save this!', '¬°Gu√°rdalo!') + '</div></div>';
                    botSay(msg, [{labelEn: "üèÄ LET'S GO!", labelEs: "üèÄ PA'LANTE!", action: 'start_training', primary: true}], 800);
                } else {
                    botSay(bi('‚ùå ' + (data.error || 'Error'), '‚ùå ' + (data.error || 'Error')), [{labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar', action: 'facility'}], 600);
                }
            })
            .catch(function() {
                botSay(bi('‚ùå Connection error', '‚ùå Error de conexi√≥n'), [{labelEn: 'üîÑ Try Again', labelEs: 'üîÑ Intentar', action: 'facility'}], 600);
            });
        }
    }
    function handlePinSubmit(pin) {
        document.querySelectorAll('.pin-digit').forEach(function(d) { d.disabled = true; });
        var submitBtn = document.getElementById('pinSubmit');
        if (submitBtn) submitBtn.style.opacity = '0.5';
        addMsg('‚Ä¢‚Ä¢‚Ä¢‚Ä¢', true);
        if (currentFlow === 'subscriber' && currentStep === 'ask_pin') {
            fetch('/api/subscriber/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pin: pin })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    var userData = { email: data.email, pin: pin, plan: data.plan, type: 'subscriber' };
                    saveUser(userData);
                    setSession(data.email, pin);
                    var statusBadge = data.status === 'trialing' ? '<div class="status-badge trialing">üÜì ' + bi('FREE TRIAL', 'PRUEBA GRATIS') + '</div>' : '<div class="status-badge active">‚úÖ ' + bi('ACTIVE', 'ACTIVO') + '</div>';
                    botSay(bi('üèÄ <strong>Welcome back!</strong>', 'üèÄ <strong>¬°Bienvenido!</strong>') + '<br><br>' + statusBadge + '<br><br>' + bi('Ready to train?', '¬øListo para entrenar?'), [
                        {labelEn: "üèÄ LET'S GO!", labelEs: "üèÄ PA'LANTE!", action: 'start_training', primary: true},
                        {labelEn: '‚öôÔ∏è Manage', labelEs: '‚öôÔ∏è Gestionar', action: 'manage_subscription', secondary: true}
                    ], 800);
                } else {
                    tryFacilityLogin(pin);
                }
            })
            .catch(function() { tryFacilityLogin(pin); });
        }
        else if (currentFlow === 'facility' && currentStep === 'ask_pin') {
            var user = getUser();
            if (user && user.pin === pin) {
                setSession(user.name, user.pin);
                botSay(bi('üèÄ <strong>Welcome back, ' + user.name + '!</strong>', 'üèÄ <strong>¬°Bienvenido, ' + user.name + '!</strong>'), [{labelEn: "üèÄ LET'S GO!", labelEs: "üèÄ PA'LANTE!", action: 'start_training', primary: true}], 800);
            } else {
                tryFacilityLogin(pin);
            }
        }
    }
    function tryFacilityLogin(pin) {
        fetch('/api/play/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin: pin })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                var userData = { name: data.username, pin: data.pin, accessCode: data.accessCode, type: 'facility' };
                saveUser(userData);
                setSession(data.username, data.pin);
                botSay(bi('üèÄ <strong>Welcome back, ' + data.username + '!</strong>', 'üèÄ <strong>¬°Bienvenido, ' + data.username + '!</strong>'), [{labelEn: "üèÄ LET'S GO!", labelEs: "üèÄ PA'LANTE!", action: 'start_training', primary: true}], 800);
            } else {
                botSay(bi('‚ùå Invalid PIN. Try again:', '‚ùå PIN inv√°lido. Intenta:'), null, 600);
                setTimeout(addPinInput, 1400);
            }
        })
        .catch(function() {
            botSay(bi('‚ùå Invalid PIN. Try again:', '‚ùå PIN inv√°lido. Intenta:'), null, 600);
            setTimeout(addPinInput, 1400);
        });
    }
    function handleManageSubscription() {
        var user = getUser();
        if (!user || !user.email) {
            botSay(bi('Please login first.', 'Por favor inicia sesi√≥n primero.'), null, 400);
            return;
        }
        addTyping();
        fetch('/api/stripe/portal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: user.email })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            removeTyping();
            if (data.url) window.location.href = data.url;
            else addMsg(bi('‚ùå Could not open portal.', '‚ùå No se pudo abrir el portal.'), false);
        })
        .catch(function() {
            removeTyping();
            addMsg(bi('‚ùå Connection error.', '‚ùå Error de conexi√≥n.'), false);
        });
    }
    goBtn.addEventListener('click', openChat);
    chatClose.addEventListener('click', function() {
        chatScreen.classList.remove('active');
        landing.classList.remove('hidden');
    });
    chatSend.addEventListener('click', function() {
        handleTextInput(chatInput.value);
        chatInput.value = '';
    });
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            handleTextInput(chatInput.value);
            chatInput.value = '';
        }
    });
    if (!checkUrlParams()) { }
})();
</script>
</body>
</html>
