<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Team GoTrotters | GoStar Digital</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --orange: #FF6B00;
    --orange-dark: #CC5500;
    --teal: #00D9A5;
    --gold: #FFD700;
    --purple: #9B59B6;
    --blue: #3B82F6;
    --dark: #0a0a0f;
    --darker: #050508;
    --card: #111118;
    --card-hover: #1a1a24;
    --text: #FFFFFF;
    --muted: #8892a0;
    --border: rgba(255,255,255,0.08);
    --success: #00D9A5;
    --danger: #FF4757;
    --sidebar: 260px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Outfit', sans-serif;
    background: var(--dark);
    color: var(--text);
    min-height: 100vh;
}

body.es .lang-en { display: none !important; }
body.en .lang-es { display: none !important; }

.login-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.login-screen.hidden { display: none; }

.login-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px 40px;
    width: 100%;
    max-width: 380px;
    text-align: center;
}

.login-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    letter-spacing: 4px;
    margin-bottom: 10px;
}

.login-logo .go { color: var(--orange); }
.login-logo .trotters { color: var(--teal); }

.login-badge {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--dark);
    background: var(--gold);
    padding: 5px 15px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 30px;
}

.login-subtitle {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 30px;
}

.pin-input-group {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
}

.pin-input {
    width: 60px;
    height: 72px;
    font-size: 1.8rem;
    font-weight: 700;
    font-family: 'Bebas Neue', sans-serif;
    text-align: center;
    background: var(--darker);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    transition: all 0.2s;
}

.pin-input:focus {
    outline: none;
    border-color: var(--orange);
    box-shadow: 0 0 20px rgba(255,107,0,0.2);
}

.login-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--orange), var(--orange-dark));
    color: var(--text);
    border: none;
    border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 25px rgba(255,107,0,0.4);
}

.login-error {
    color: var(--danger);
    font-size: 0.85rem;
    margin-top: 15px;
    display: none;
}

.login-error.show { display: block; }

.dashboard { display: none; min-height: 100vh; }
.dashboard.visible { display: flex; }

.sidebar {
    width: var(--sidebar);
    background: var(--darker);
    border-right: 1px solid var(--border);
    padding: 24px 0;
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-header {
    padding: 0 24px 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
}

.sidebar-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    letter-spacing: 3px;
    margin-bottom: 5px;
}

.sidebar-logo .go { color: var(--orange); }
.sidebar-logo .trotters { color: var(--teal); }

.sidebar-team {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 10px;
}

.admin-badge {
    display: inline-block;
    background: linear-gradient(135deg, var(--danger), #cc3344);
    color: var(--text);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.nav-section { padding: 0 12px; margin-bottom: 20px; }

.nav-section-title {
    font-size: 0.65rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0 16px;
    margin-bottom: 10px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: transparent;
    border-radius: 10px;
    color: var(--muted);
    font-family: 'Outfit', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    margin-bottom: 4px;
}

.nav-item:hover { background: var(--card); color: var(--text); }
.nav-item.active { background: var(--orange); color: var(--text); }
.nav-item-icon { font-size: 1.1rem; width: 24px; text-align: center; }

.sidebar-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border);
    margin-top: auto;
}

.lang-toggle {
    display: flex;
    gap: 8px;
    background: var(--card);
    padding: 4px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.lang-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background: transparent;
    color: var(--muted);
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
    font-family: 'Outfit', sans-serif;
}

.lang-btn.active { background: var(--orange); color: var(--text); }

.logout-btn {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Outfit', sans-serif;
}

.logout-btn:hover { border-color: var(--danger); color: var(--danger); }

.main-content { flex: 1; margin-left: var(--sidebar); padding: 30px; max-width: 1400px; }
.page-header { margin-bottom: 30px; }
.page-title { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 3px; margin-bottom: 5px; }
.page-subtitle { font-size: 0.9rem; color: var(--muted); }
.page-section { display: none; }
.page-section.active { display: block; }

.team-banner {
    background: linear-gradient(135deg, rgba(255,107,0,0.15), rgba(0,217,165,0.15));
    border: 1px solid var(--orange);
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.team-banner-text { font-size: 1rem; }
.team-banner-text strong { color: var(--orange); font-size: 1.2rem; }
.team-banner-badge { background: var(--teal); color: var(--dark); padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }

.stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s;
}

.stat-card:hover { transform: translateY(-3px); border-color: var(--orange); }

.stat-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 15px;
}

.stat-card-icon.orange { background: rgba(255,107,0,0.15); }
.stat-card-icon.teal { background: rgba(0,217,165,0.15); }
.stat-card-icon.gold { background: rgba(255,215,0,0.15); }
.stat-card-icon.purple { background: rgba(155,89,182,0.15); }
.stat-card-value { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 2px; margin-bottom: 5px; }
.stat-card-label { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

.gear-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }

.gear-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s;
}

.gear-card:hover { transform: translateY(-3px); }

.gear-card-header { padding: 16px 20px; display: flex; align-items: center; gap: 12px; }
.gear-card-header.g1 { background: linear-gradient(135deg, rgba(255,107,0,0.2), transparent); border-bottom: 2px solid var(--orange); }
.gear-card-header.g2 { background: linear-gradient(135deg, rgba(0,217,165,0.2), transparent); border-bottom: 2px solid var(--teal); }
.gear-card-header.g3 { background: linear-gradient(135deg, rgba(255,215,0,0.2), transparent); border-bottom: 2px solid var(--gold); }
.gear-card-icon { font-size: 1.5rem; }
.gear-card-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; flex: 1; }
.gear-card-num { font-size: 0.7rem; color: var(--muted); }

.gear-card-edit {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.gear-card-edit:hover { border-color: var(--orange); color: var(--orange); }
.gear-card-body { padding: 20px; }
.gear-card-stats { display: flex; gap: 20px; }
.gear-stat { text-align: center; flex: 1; }
.gear-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; }
.gear-stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }

.table-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; margin-bottom: 30px; }
.table-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.table-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 2px; }
.table-actions { display: flex; gap: 10px; }
.btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; font-family: 'Outfit', sans-serif; }
.btn-primary { background: var(--orange); color: var(--text); }
.btn-primary:hover { background: var(--orange-dark); }
.btn-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text); }
.btn-secondary:hover { border-color: var(--orange); }
.btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
.btn-danger:hover { background: var(--danger); color: var(--text); }

.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); }
th { font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; background: var(--darker); }
td { font-size: 0.9rem; }
tr:hover { background: var(--card-hover); }

.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-trial, .badge-trialing { background: rgba(155,89,182,0.15); color: var(--purple); }
.badge-paid, .badge-active { background: rgba(0,217,165,0.15); color: var(--teal); }
.badge-canceled { background: rgba(255,71,87,0.15); color: var(--danger); }
.badge-past_due { background: rgba(255,215,0,0.15); color: var(--gold); }

.shift-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; }
.shift-badge.practice { background: rgba(155,89,182,0.2); color: #b57edc; }
.shift-badge.level3 { background: rgba(255,215,0,0.2); color: var(--gold); }
.shift-badge.level4 { background: rgba(255,107,0,0.2); color: var(--orange); }
.shift-badge.level5 { background: rgba(0,217,165,0.2); color: var(--teal); }
.shift-badge.level6 { background: rgba(52,152,219,0.2); color: var(--blue); }
.shift-badge.level7 { background: rgba(155,89,182,0.2); color: var(--purple); }
.shift-badge.level8 { background: rgba(255,215,0,0.2); color: var(--gold); }
.shift-badge.level9 { background: rgba(255,107,0,0.2); color: var(--orange); }
.shift-badge.master { background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,107,0,0.3)); color: var(--gold); }

.action-btns { display: flex; gap: 6px; }

.action-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--border);
    background: transparent;
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.action-btn:hover { border-color: var(--orange); color: var(--orange); }
.action-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

.activity-list { padding: 0; }

.activity-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
}

.activity-item:last-child { border-bottom: none; }
.activity-item:hover { background: var(--card-hover); }

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.activity-icon.user { background: rgba(0,217,165,0.15); color: var(--teal); }
.activity-icon.gear { background: rgba(155,89,182,0.15); color: var(--purple); }
.activity-icon.subscription { background: rgba(255,107,0,0.15); color: var(--orange); }
.activity-icon.game { background: rgba(59,130,246,0.15); color: var(--blue); }
.activity-icon.facility { background: rgba(255,215,0,0.15); color: var(--gold); }
.activity-content { flex: 1; }
.activity-text { font-size: 0.9rem; margin-bottom: 3px; }
.activity-time { font-size: 0.75rem; color: var(--muted); }
.activity-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
.activity-item:hover .activity-actions { opacity: 1; }

.shift-dist-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.shift-dist-table th, .shift-dist-table td { padding: 10px 12px; text-align: center; border: 1px solid var(--border); font-size: 0.8rem; }
.shift-dist-table th { background: var(--darker); font-weight: 600; color: var(--muted); }
.shift-dist-table td { background: var(--card); }

.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-overlay.show { display: flex; }

.modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 2px; }

.modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--darker);
    border-radius: 10px;
    color: var(--muted);
    font-size: 1.2rem;
    cursor: pointer;
}

.modal-close:hover { color: var(--danger); }
.modal-body { padding: 24px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }

.form-input, .form-select {
    width: 100%;
    padding: 14px 16px;
    background: var(--darker);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 0.95rem;
    font-family: 'Outfit', sans-serif;
}

.form-input:focus, .form-select:focus { outline: none; border-color: var(--orange); }
.form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
.confirm-dialog { text-align: center; padding: 20px 0; }
.confirm-dialog-icon { font-size: 3rem; margin-bottom: 15px; }
.confirm-dialog-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 2px; margin-bottom: 10px; }
.confirm-dialog-text { color: var(--muted); font-size: 0.9rem; margin-bottom: 5px; }

.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--card);
    border: 1px solid var(--teal);
    border-radius: 12px;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 2000;
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast.error { border-color: var(--danger); }
.toast-icon { font-size: 1.2rem; }
.toast-text { font-size: 0.9rem; }

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--muted);
    border-top-color: var(--orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
}

.empty-state-icon { font-size: 3rem; margin-bottom: 15px; }
.empty-state-text { font-size: 1rem; }

tr.clickable { cursor: pointer; transition: background 0.2s; }
tr.clickable:hover { background: var(--card-hover); }

.subscriber-detail-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}

.subscriber-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--orange), var(--teal));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--dark);
    font-weight: 700;
}

.subscriber-info h4 { font-size: 1.2rem; margin-bottom: 5px; }
.subscriber-info p { font-size: 0.85rem; color: var(--muted); }

.subscriber-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.subscriber-stat {
    background: var(--darker);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
}

.subscriber-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    color: var(--orange);
}

.subscriber-stat-label {
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.game-scores-section h5 {
    font-size: 0.85rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 15px;
}

.game-score-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    background: var(--darker);
    border-radius: 10px;
    margin-bottom: 10px;
}

.game-score-name {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.game-score-name span.icon { font-size: 1.2rem; }

.game-score-stats {
    display: flex;
    align-items: center;
    gap: 15px;
}

.game-score-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    color: var(--text);
}

.shift-badge-large {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
}

.shift-1, .shift-2 { background: rgba(155,89,182,0.2); color: #b57edc; }
.shift-3 { background: rgba(255,215,0,0.2); color: var(--gold); }
.shift-4 { background: rgba(255,107,0,0.2); color: var(--orange); }
.shift-5 { background: rgba(0,217,165,0.2); color: var(--teal); }
.shift-6 { background: rgba(59,130,246,0.2); color: var(--blue); }
.shift-7 { background: rgba(155,89,182,0.2); color: var(--purple); }
.shift-8 { background: rgba(255,215,0,0.2); color: var(--gold); }
.shift-9 { background: rgba(255,107,0,0.2); color: var(--orange); }
.shift-10 { background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,107,0,0.3)); color: var(--gold); }

.family-members-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }

.family-member-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: var(--darker);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.family-member-row:hover { background: var(--card-hover); }

.activity-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Outfit', sans-serif;
}

.filter-btn:hover { border-color: var(--orange); color: var(--orange); }
.filter-btn.active { background: var(--orange); border-color: var(--orange); color: var(--text); }

.activity-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.activity-summary-card {
    background: var(--darker);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
}

.activity-summary-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    color: var(--orange);
}

.activity-summary-label {
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.day-group {
    margin-bottom: 15px;
}

.day-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--darker);
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 8px;
}

.day-group-header:hover { background: var(--card-hover); }

.day-group-title {
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.day-group-count {
    background: var(--orange);
    color: var(--text);
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
}

.day-group-toggle {
    color: var(--muted);
    transition: transform 0.2s;
}

.day-group.collapsed .day-group-toggle { transform: rotate(-90deg); }
.day-group.collapsed .day-group-items { display: none; }

.day-group-items {
    padding-left: 10px;
    border-left: 2px solid var(--border);
    margin-left: 20px;
}

.aggregated-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    background: var(--card);
    border-radius: 8px;
    margin-bottom: 6px;
    transition: background 0.2s;
}

.aggregated-item:hover { background: var(--card-hover); }

.aggregated-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.aggregated-icon.game { background: rgba(59,130,246,0.15); color: var(--blue); }
.aggregated-icon.subscription { background: rgba(255,107,0,0.15); color: var(--orange); }
.aggregated-icon.milestone { background: rgba(255,215,0,0.15); color: var(--gold); }

.aggregated-content { flex: 1; }
.aggregated-text { font-size: 0.85rem; }
.aggregated-details { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

.milestone-badge {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,107,0,0.2));
    color: var(--gold);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 700;
}

.activity-delete-btn {
    opacity: 0;
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    transition: all 0.2s;
    flex-shrink: 0;
}

.aggregated-item:hover .activity-delete-btn,
.day-group-header:hover .day-delete-btn { opacity: 1; }
.activity-delete-btn:hover { background: rgba(255,71,87,0.15); color: var(--danger); }

.day-delete-btn {
    opacity: 0;
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    transition: all 0.2s;
    margin-right: 10px;
}

.day-delete-btn:hover { background: rgba(255,71,87,0.15); color: var(--danger); }

.delete-activity-summary {
    background: var(--darker);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.delete-activity-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--danger);
    text-align: center;
}

.delete-activity-label {
    text-align: center;
    color: var(--muted);
    font-size: 0.85rem;
}

@media (max-width: 1024px) {
    .sidebar { width: 80px; padding: 15px 0; }
    .sidebar-header { padding: 0 10px 15px; }
    .sidebar-logo span, .sidebar-team, .nav-item span:not(.nav-item-icon), .nav-section-title, .sidebar-footer .lang-toggle, .logout-btn span { display: none; }
    .nav-item { justify-content: center; padding: 12px; }
    .nav-item-icon { margin: 0; }
    .main-content { margin-left: 80px; }
}

@media (max-width: 768px) {
    .sidebar { display: none; }
    .main-content { margin-left: 0; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .team-banner { flex-direction: column; text-align: center; }
    .form-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body class="en">

<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <div class="login-logo"><span class="go">Go</span><span class="trotters">Trotters</span></div>
        <div class="login-badge">Coach Admin Portal</div>
        <p class="login-subtitle">
            <span class="lang-en">Enter your 4-digit admin PIN</span>
            <span class="lang-es">Ingresa tu PIN de 4 d√≠gitos</span>
        </p>
        <div class="pin-input-group">
            <input type="password" class="pin-input" maxlength="1" id="pin1" inputmode="numeric">
            <input type="password" class="pin-input" maxlength="1" id="pin2" inputmode="numeric">
            <input type="password" class="pin-input" maxlength="1" id="pin3" inputmode="numeric">
            <input type="password" class="pin-input" maxlength="1" id="pin4" inputmode="numeric">
        </div>
        <button class="login-btn" id="loginBtn">
            <span class="lang-en">ACCESS DASHBOARD</span>
            <span class="lang-es">ACCEDER</span>
        </button>
        <p class="login-error" id="loginError">
            <span class="lang-en">Invalid PIN</span>
            <span class="lang-es">PIN inv√°lido</span>
        </p>
    </div>
</div>

<div class="dashboard" id="dashboard">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><span class="go">Go</span><span class="trotters">Trotters</span></div>
            <div class="sidebar-team">Team GoTrotters</div>
            <span class="admin-badge">Coach Admin</span>
        </div>
        <nav class="nav-section">
            <div class="nav-section-title">
                <span class="lang-en">Dashboard</span>
                <span class="lang-es">Panel</span>
            </div>
            <button class="nav-item active" data-page="overview">
                <span class="nav-item-icon">üìä</span>
                <span class="lang-en">Overview</span>
                <span class="lang-es">Resumen</span>
            </button>
            <button class="nav-item" data-page="subscribers">
                <span class="nav-item-icon">üí≥</span>
                <span class="lang-en">Subscribers</span>
                <span class="lang-es">Suscriptores</span>
            </button>
            <button class="nav-item" data-page="facilities">
                <span class="nav-item-icon">üè¢</span>
                <span class="lang-en">Facilities</span>
                <span class="lang-es">Centros</span>
            </button>
            <button class="nav-item" data-page="activity">
                <span class="nav-item-icon">üìã</span>
                <span class="lang-en">Activity</span>
                <span class="lang-es">Actividad</span>
            </button>
        </nav>
        <div class="sidebar-footer">
            <div class="lang-toggle">
                <button class="lang-btn active" id="btnEn">EN</button>
                <button class="lang-btn" id="btnEs">ES</button>
            </div>
            <button class="logout-btn" id="logoutBtn">üö™ 
                <span class="lang-en">Logout</span>
                <span class="lang-es">Salir</span>
            </button>
        </div>
    </aside>

    <main class="main-content">
        <!-- OVERVIEW PAGE -->
        <section class="page-section active" id="page-overview">
            <header class="page-header">
                <h1 class="page-title">GOTROTTERS ADMIN</h1>
                <p class="page-subtitle">
                    <span class="lang-en">Platform Overview ‚Ä¢ Subscribers & Facilities</span>
                    <span class="lang-es">Resumen de Plataforma ‚Ä¢ Suscriptores y Centros</span>
                </p>
            </header>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-icon teal">üí≥</div>
                    <div class="stat-card-value" id="totalSubscribers">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Subscribers</span>
                        <span class="lang-es">Suscriptores</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon orange">üè¢</div>
                    <div class="stat-card-value" id="totalFacilities">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Facilities</span>
                        <span class="lang-es">Centros</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon gold">üë•</div>
                    <div class="stat-card-value" id="totalUsers">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Facility Users</span>
                        <span class="lang-es">Usuarios de Centros</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon purple">üéÆ</div>
                    <div class="stat-card-value" id="totalSessions">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Total Sessions</span>
                        <span class="lang-es">Sesiones Totales</span>
                    </div>
                </div>
            </div>
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">
                        <span class="lang-en">RECENT ACTIVITY</span>
                        <span class="lang-es">ACTIVIDAD RECIENTE</span>
                    </h3>
                </div>
                <div class="activity-list" id="overviewActivity"></div>
            </div>
        </section>

        <!-- SUBSCRIBERS PAGE -->
        <section class="page-section" id="page-subscribers">
            <header class="page-header">
                <h1 class="page-title">
                    <span class="lang-en">SUBSCRIBERS</span>
                    <span class="lang-es">SUSCRIPTORES</span>
                </h1>
                <p class="page-subtitle">
                    <span class="lang-en">Stripe subscription management ‚Ä¢ Click user for details</span>
                    <span class="lang-es">Gesti√≥n de suscripciones Stripe ‚Ä¢ Haz clic en usuario para detalles</span>
                </p>
            </header>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-icon teal">‚úÖ</div>
                    <div class="stat-card-value" id="activeSubscribers">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Active</span>
                        <span class="lang-es">Activos</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon purple">üÜì</div>
                    <div class="stat-card-value" id="trialingSubscribers">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Trialing</span>
                        <span class="lang-es">En Prueba</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon gold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="stat-card-value" id="familyPlans">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Family Plans</span>
                        <span class="lang-es">Planes Familiares</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon orange">üë§</div>
                    <div class="stat-card-value" id="individualPlans">0</div>
                    <div class="stat-card-label">
                        <span class="lang-en">Individual Plans</span>
                        <span class="lang-es">Planes Individuales</span>
                    </div>
                </div>
            </div>
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">ALL SUBSCRIBERS</h3>
                    <div class="table-actions">
                        <button class="btn btn-secondary" id="refreshSubscribersBtn">üîÑ 
                            <span class="lang-en">Refresh</span>
                            <span class="lang-es">Actualizar</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>PIN</th>
                                <th><span class="lang-en">Plan</span><span class="lang-es">Plan</span></th>
                                <th><span class="lang-en">Status</span><span class="lang-es">Estado</span></th>
                                <th><span class="lang-en">Sessions</span><span class="lang-es">Sesiones</span></th>
                                <th><span class="lang-en">Streak</span><span class="lang-es">Racha</span></th>
                                <th><span class="lang-en">Last Active</span><span class="lang-es">√öltima Vez</span></th>
                            </tr>
                        </thead>
                        <tbody id="subscribersTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- FACILITIES PAGE -->
        <section class="page-section" id="page-facilities">
            <header class="page-header">
                <h1 class="page-title">
                    <span class="lang-en">FACILITIES</span>
                    <span class="lang-es">CENTROS</span>
                </h1>
                <p class="page-subtitle">
                    <span class="lang-en">Nursing homes & facilities</span>
                    <span class="lang-es">Hogares de ancianos y centros</span>
                </p>
            </header>
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">ALL FACILITIES</h3>
                    <div class="table-actions">
                        <button class="btn btn-secondary" id="refreshFacilitiesBtn">üîÑ 
                            <span class="lang-en">Refresh</span>
                            <span class="lang-es">Actualizar</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th><span class="lang-en">Name</span><span class="lang-es">Nombre</span></th>
                                <th><span class="lang-en">License</span><span class="lang-es">Licencia</span></th>
                                <th><span class="lang-en">Users</span><span class="lang-es">Usuarios</span></th>
                                <th><span class="lang-en">Sessions</span><span class="lang-es">Sesiones</span></th>
                                <th><span class="lang-en">Status</span><span class="lang-es">Estado</span></th>
                                <th><span class="lang-en">Expires</span><span class="lang-es">Expira</span></th>
                            </tr>
                        </thead>
                        <tbody id="facilitiesTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ACTIVITY PAGE -->
        <section class="page-section" id="page-activity">
            <header class="page-header">
                <h1 class="page-title">
                    <span class="lang-en">ACTIVITY LOG</span>
                    <span class="lang-es">REGISTRO DE ACTIVIDAD</span>
                </h1>
                <p class="page-subtitle">
                    <span class="lang-en">Platform activity summary</span>
                    <span class="lang-es">Resumen de actividad de la plataforma</span>
                </p>
            </header>
            
            <div class="activity-summary-grid">
                <div class="activity-summary-card">
                    <div class="activity-summary-value" id="sessionsToday">0</div>
                    <div class="activity-summary-label">
                        <span class="lang-en">Sessions Today</span>
                        <span class="lang-es">Sesiones Hoy</span>
                    </div>
                </div>
                <div class="activity-summary-card">
                    <div class="activity-summary-value" id="sessionsWeek">0</div>
                    <div class="activity-summary-label">
                        <span class="lang-en">This Week</span>
                        <span class="lang-es">Esta Semana</span>
                    </div>
                </div>
                <div class="activity-summary-card">
                    <div class="activity-summary-value" id="newSubsWeek">0</div>
                    <div class="activity-summary-label">
                        <span class="lang-en">New Subs</span>
                        <span class="lang-es">Nuevos Subs</span>
                    </div>
                </div>
                <div class="activity-summary-card">
                    <div class="activity-summary-value" id="milestonesWeek">0</div>
                    <div class="activity-summary-label">
                        <span class="lang-en">Milestones</span>
                        <span class="lang-es">Logros</span>
                    </div>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title">
                        <span class="lang-en">ACTIVITY</span>
                        <span class="lang-es">ACTIVIDAD</span>
                    </h3>
                    <div class="table-actions">
                        <button class="btn btn-secondary" id="refreshActivityBtn">üîÑ 
                            <span class="lang-en">Refresh</span>
                            <span class="lang-es">Actualizar</span>
                        </button>
                        <button class="btn btn-danger" id="clearAllActivityBtn">üóëÔ∏è 
                            <span class="lang-en">Clear All</span>
                            <span class="lang-es">Limpiar Todo</span>
                        </button>
                    </div>
                </div>
                <div style="padding: 15px 20px 5px;">
                    <div class="activity-filters">
                        <button class="filter-btn active" data-filter="all">
                            <span class="lang-en">All</span>
                            <span class="lang-es">Todo</span>
                        </button>
                        <button class="filter-btn" data-filter="subscription">üí≥ 
                            <span class="lang-en">Subscriptions</span>
                            <span class="lang-es">Suscripciones</span>
                        </button>
                        <button class="filter-btn" data-filter="game">üéÆ 
                            <span class="lang-en">Games</span>
                            <span class="lang-es">Juegos</span>
                        </button>
                        <button class="filter-btn" data-filter="milestone">üèÜ 
                            <span class="lang-en">Milestones</span>
                            <span class="lang-es">Logros</span>
                        </button>
                    </div>
                </div>
                <div class="activity-list" id="activityList"></div>
            </div>
        </section>
    </main>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><span class="lang-en">CONFIRM</span><span class="lang-es">CONFIRMAR</span></h3>
            <button class="modal-close" data-close="deleteModal">√ó</button>
        </div>
        <div class="modal-body">
            <div class="confirm-dialog">
                <div class="confirm-dialog-icon">‚ö†Ô∏è</div>
                <div class="confirm-dialog-title"><span class="lang-en">ARE YOU SURE?</span><span class="lang-es">¬øEST√ÅS SEGURO?</span></div>
                <div class="confirm-dialog-text" id="deleteText"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-close="deleteModal"><span class="lang-en">Cancel</span><span class="lang-es">Cancelar</span></button>
            <button class="btn btn-danger" id="confirmDeleteBtn"><span class="lang-en">Delete</span><span class="lang-es">Eliminar</span></button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="subscriberModal">
    <div class="modal" style="max-width:560px">
        <div class="modal-header">
            <h3 class="modal-title" id="subscriberModalTitle">SUBSCRIBER DETAILS</h3>
            <button class="modal-close" data-close="subscriberModal">√ó</button>
        </div>
        <div class="modal-body" id="subscriberModalBody">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editSubscriberModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="editSubscriberModalTitle">EDIT SUBSCRIBER</h3>
            <button class="modal-close" data-close="editSubscriberModal">√ó</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editSubPin">
            <input type="hidden" id="editSubIsFamily">
            <div class="form-group" id="editEmailGroup">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="editSubEmail" placeholder="email@example.com">
            </div>
            <div class="form-group" id="editNameGroup" style="display:none">
                <label class="form-label"><span class="lang-en">Name</span><span class="lang-es">Nombre</span></label>
                <input type="text" class="form-input" id="editSubName" placeholder="Name">
            </div>
            <div class="form-group">
                <label class="form-label">PIN</label>
                <input type="text" class="form-input" id="editSubNewPin" maxlength="4" placeholder="4-digit PIN">
            </div>
            <div class="form-group" id="editStatusGroup">
                <label class="form-label"><span class="lang-en">Status</span><span class="lang-es">Estado</span></label>
                <select class="form-select" id="editSubStatus">
                    <option value="active">Active</option>
                    <option value="trialing">Trialing</option>
                    <option value="canceled">Canceled</option>
                    <option value="past_due">Past Due</option>
                </select>
            </div>
            <div class="form-group" id="editPlanGroup">
                <label class="form-label"><span class="lang-en">Plan</span><span class="lang-es">Plan</span></label>
                <select class="form-select" id="editSubPlan">
                    <option value="individual_monthly">Individual Monthly</option>
                    <option value="individual_annual">Individual Annual</option>
                    <option value="family_monthly">Family Monthly</option>
                    <option value="family_annual">Family Annual</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-close="editSubscriberModal"><span class="lang-en">Cancel</span><span class="lang-es">Cancelar</span></button>
            <button class="btn btn-primary" id="saveSubscriberBtn"><span class="lang-en">Save</span><span class="lang-es">Guardar</span></button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deleteSubscriberModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><span class="lang-en">DELETE SUBSCRIBER</span><span class="lang-es">ELIMINAR SUSCRIPTOR</span></h3>
            <button class="modal-close" data-close="deleteSubscriberModal">√ó</button>
        </div>
        <div class="modal-body">
            <div class="confirm-dialog">
                <div class="confirm-dialog-icon">‚ö†Ô∏è</div>
                <div class="confirm-dialog-title"><span class="lang-en">ARE YOU SURE?</span><span class="lang-es">¬øEST√ÅS SEGURO?</span></div>
                <div class="confirm-dialog-text" id="deleteSubscriberText"></div>
                <p style="color:var(--danger);font-size:0.85rem;margin-top:15px">
                    <span class="lang-en">This action cannot be undone.</span>
                    <span class="lang-es">Esta acci√≥n no se puede deshacer.</span>
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-close="deleteSubscriberModal"><span class="lang-en">Cancel</span><span class="lang-es">Cancelar</span></button>
            <button class="btn btn-danger" id="confirmDeleteSubscriberBtn"><span class="lang-en">Delete</span><span class="lang-es">Eliminar</span></button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deleteActivityModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><span class="lang-en">DELETE ACTIVITY</span><span class="lang-es">ELIMINAR ACTIVIDAD</span></h3>
            <button class="modal-close" data-close="deleteActivityModal">√ó</button>
        </div>
        <div class="modal-body">
            <div class="confirm-dialog">
                <div class="confirm-dialog-icon">üóëÔ∏è</div>
                <div class="confirm-dialog-title" id="deleteActivityTitle"><span class="lang-en">DELETE ACTIVITY?</span><span class="lang-es">¬øELIMINAR ACTIVIDAD?</span></div>
                <div class="confirm-dialog-text" id="deleteActivityText"></div>
                <div class="delete-activity-summary" id="deleteActivitySummary" style="display:none">
                    <div class="delete-activity-count" id="deleteActivityCount">0</div>
                    <div class="delete-activity-label"><span class="lang-en">activities will be deleted</span><span class="lang-es">actividades ser√°n eliminadas</span></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-close="deleteActivityModal"><span class="lang-en">Cancel</span><span class="lang-es">Cancelar</span></button>
            <button class="btn btn-danger" id="confirmDeleteActivityBtn"><span class="lang-en">Delete</span><span class="lang-es">Eliminar</span></button>
        </div>
    </div>
</div>

<div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon">‚úì</span>
    <span class="toast-text" id="toastText">Saved</span>
</div>

<script>
(function() {
    'use strict';

    var authToken = null;
    var subscribers = [];
    var facilities = [];
    var users = [];
    var activities = [];
    var currentLang = localStorage.getItem('gt-admin-lang') || 'en';
    var currentActivityFilter = 'all';
    var pendingActivityDelete = { type: null, ids: [], date: null, username: null };

    function init() {
        setLang(currentLang);
        setupPinInputs();
        setupEventListeners();
        
        // Check existing session
        var savedToken = sessionStorage.getItem('gostar-admin-token');
        if (savedToken) {
            verifyToken(savedToken);
        }
    }

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('gt-admin-lang', lang);
        document.body.className = lang;
        document.getElementById('btnEn').className = lang === 'en' ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btnEs').className = lang === 'es' ? 'lang-btn active' : 'lang-btn';
    }

    function setupPinInputs() {
        var pins = [document.getElementById('pin1'), document.getElementById('pin2'), document.getElementById('pin3'), document.getElementById('pin4')];
        pins.forEach(function(input, idx) {
            input.addEventListener('input', function() { 
                if (this.value.length === 1 && idx < 3) pins[idx + 1].focus(); 
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && idx > 0) pins[idx - 1].focus();
                if (e.key === 'Enter') attemptLogin();
            });
        });
        pins[0].focus();
    }

    function attemptLogin() {
        var pin = '';
        for (var i = 1; i <= 4; i++) pin += document.getElementById('pin' + i).value;
        
        if (pin.length !== 4) return;
        
        fetch('/api/admin/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin: pin })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success && data.token) {
                authToken = data.token;
                sessionStorage.setItem('gostar-admin-token', authToken);
                showDashboard();
            } else {
                showLoginError();
            }
        })
        .catch(function(err) {
            console.error('Login error:', err);
            showLoginError();
        });
    }

    function verifyToken(token) {
        fetch('/api/admin/verify-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: token })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                authToken = token;
                showDashboard();
            } else {
                sessionStorage.removeItem('gostar-admin-token');
            }
        })
        .catch(function() {
            sessionStorage.removeItem('gostar-admin-token');
        });
    }

    function showLoginError() {
        document.getElementById('loginError').classList.add('show');
        for (var i = 1; i <= 4; i++) document.getElementById('pin' + i).value = '';
        document.getElementById('pin1').focus();
        setTimeout(function() { document.getElementById('loginError').classList.remove('show'); }, 3000);
    }

    function showDashboard() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        loadAllData();
    }

    function logout() {
        fetch('/api/admin/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: authToken })
        });
        authToken = null;
        sessionStorage.removeItem('gostar-admin-token');
        document.getElementById('dashboard').classList.remove('visible');
        document.getElementById('loginScreen').classList.remove('hidden');
        for (var i = 1; i <= 4; i++) document.getElementById('pin' + i).value = '';
        document.getElementById('pin1').focus();
    }

    function setupEventListeners() {
        document.getElementById('loginBtn').addEventListener('click', attemptLogin);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('btnEn').addEventListener('click', function() { setLang('en'); });
        document.getElementById('btnEs').addEventListener('click', function() { setLang('es'); });

        document.querySelectorAll('.nav-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var page = this.getAttribute('data-page');
                showPage(page);
                document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
                this.classList.add('active');
            });
        });

        document.querySelectorAll('[data-close]').forEach(function(btn) {
            btn.addEventListener('click', function() { closeModal(this.getAttribute('data-close')); });
        });

        document.getElementById('refreshSubscribersBtn').addEventListener('click', loadSubscribers);
        document.getElementById('refreshFacilitiesBtn').addEventListener('click', loadFacilities);
        document.getElementById('refreshActivityBtn').addEventListener('click', loadActivity);
        document.getElementById('clearAllActivityBtn').addEventListener('click', promptClearAllActivity);
        document.getElementById('saveSubscriberBtn').addEventListener('click', saveSubscriber);
        document.getElementById('confirmDeleteSubscriberBtn').addEventListener('click', confirmDeleteSubscriber);
        document.getElementById('confirmDeleteActivityBtn').addEventListener('click', confirmDeleteActivity);
        
        // Activity filters
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                currentActivityFilter = this.dataset.filter;
                renderActivity();
            });
        });

        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.classList.remove('show'); });
        });
    }

    function showPage(page) {
        document.querySelectorAll('.page-section').forEach(function(s) { s.classList.remove('active'); });
        document.getElementById('page-' + page).classList.add('active');
    }

    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    function showToast(message, isError) {
        var toast = document.getElementById('toast');
        document.getElementById('toastText').textContent = message;
        document.getElementById('toastIcon').textContent = isError ? '‚úó' : '‚úì';
        toast.classList.toggle('error', isError);
        toast.classList.add('show');
        setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function apiGet(endpoint) {
        return fetch(endpoint, {
            headers: { 'Authorization': 'Bearer ' + authToken }
        }).then(function(res) { return res.json(); });
    }

    function loadAllData() {
        loadSubscribers();
        loadFacilities();
        loadActivity();
    }

    function loadSubscribers() {
        apiGet('/api/admin/subscribers')
            .then(function(data) {
                if (data.success) {
                    subscribers = data.subscribers || [];
                    renderSubscribers();
                    updateOverviewStats();
                }
            })
            .catch(function(err) {
                console.error('Error loading subscribers:', err);
                subscribers = [];
                renderSubscribers();
            });
    }

    function loadFacilities() {
        apiGet('/api/admin/facilities')
            .then(function(data) {
                if (data.success) {
                    facilities = data.facilities || [];
                    renderFacilities();
                    updateOverviewStats();
                }
            })
            .catch(function(err) {
                console.error('Error loading facilities:', err);
                facilities = [];
                renderFacilities();
            });

        apiGet('/api/admin/users')
            .then(function(data) {
                if (data.success) {
                    users = data.users || [];
                    updateOverviewStats();
                }
            })
            .catch(function(err) {
                console.error('Error loading users:', err);
                users = [];
            });
    }

    function loadActivity() {
        apiGet('/api/admin/activity')
            .then(function(data) {
                if (data.success) {
                    activities = data.activities || [];
                    renderActivity();
                    renderOverviewActivity();
                }
            })
            .catch(function(err) {
                console.error('Error loading activity:', err);
                activities = [];
                renderActivity();
            });
    }

    function updateOverviewStats() {
        document.getElementById('totalSubscribers').textContent = subscribers.length;
        document.getElementById('totalFacilities').textContent = facilities.length;
        document.getElementById('totalUsers').textContent = users.length;
        
        var totalSessions = facilities.reduce(function(sum, f) { return sum + (f.total_sessions || 0); }, 0);
        document.getElementById('totalSessions').textContent = totalSessions;

        // Subscriber stats
        var active = subscribers.filter(function(s) { return s.status === 'active'; }).length;
        var trialing = subscribers.filter(function(s) { return s.status === 'trialing'; }).length;
        var family = subscribers.filter(function(s) { return s.plan_type && s.plan_type.includes('family'); }).length;
        var individual = subscribers.filter(function(s) { return s.plan_type && s.plan_type.includes('individual'); }).length;

        document.getElementById('activeSubscribers').textContent = active;
        document.getElementById('trialingSubscribers').textContent = trialing;
        document.getElementById('familyPlans').textContent = family;
        document.getElementById('individualPlans').textContent = individual;
    }

    function renderSubscribers() {
        var tbody = document.getElementById('subscribersTable');
        
        if (subscribers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted)"><span class="lang-en">No subscribers yet</span><span class="lang-es">A√∫n no hay suscriptores</span></td></tr>';
            return;
        }

        var html = '';
        subscribers.forEach(function(sub) {
            var statusClass = 'badge-' + (sub.status || 'unknown');
            var planDisplay = (sub.plan_type || 'unknown').replace('_', ' ');
            var totalSessions = sub.sessions ? Object.values(sub.sessions).reduce(function(a,b){return a+b;}, 0) : 0;
            var lastActive = sub.lastActive ? formatTimeAgo(sub.lastActive) : '-';
            
            html += '<tr class="clickable" onclick="window.viewSubscriber(\'' + sub.pin + '\')">';
            html += '<td>' + (sub.email || '-') + '</td>';
            html += '<td><strong style="color:var(--orange)">' + (sub.pin || '-') + '</strong></td>';
            html += '<td>' + planDisplay + '</td>';
            html += '<td><span class="badge ' + statusClass + '">' + (sub.status || 'unknown') + '</span></td>';
            html += '<td>' + totalSessions + '</td>';
            html += '<td>üî• ' + (sub.streak || 0) + '</td>';
            html += '<td>' + lastActive + '</td>';
            html += '</tr>';
            
            // Also add family members as clickable rows
            if (sub.family_members && sub.family_members.length > 0) {
                sub.family_members.forEach(function(member) {
                    var memberSessions = member.sessions ? Object.values(member.sessions).reduce(function(a,b){return a+b;}, 0) : 0;
                    var memberLastActive = member.lastActive ? formatTimeAgo(member.lastActive) : '-';
                    
                    html += '<tr class="clickable" onclick="window.viewSubscriber(\'' + member.pin + '\')" style="background:rgba(255,107,0,0.05)">';
                    html += '<td style="padding-left:40px">‚Ü≥ ' + member.name + ' <span style="color:var(--muted);font-size:0.75rem">(family)</span></td>';
                    html += '<td><strong style="color:var(--teal)">' + (member.pin || '-') + '</strong></td>';
                    html += '<td>-</td>';
                    html += '<td>-</td>';
                    html += '<td>' + memberSessions + '</td>';
                    html += '<td>-</td>';
                    html += '<td>' + memberLastActive + '</td>';
                    html += '</tr>';
                });
            }
        });
        
        tbody.innerHTML = html;
    }

    window.viewSubscriber = function(pin) {
        openModal('subscriberModal');
        document.getElementById('subscriberModalBody').innerHTML = '<div style="text-align:center;padding:40px"><div class="loading-spinner"></div></div>';
        
        apiGet('/api/admin/subscriber/' + pin)
            .then(function(data) {
                if (data.success) {
                    renderSubscriberDetail(data.subscriber);
                } else {
                    document.getElementById('subscriberModalBody').innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading subscriber</div>';
                }
            })
            .catch(function(err) {
                console.error('Error fetching subscriber:', err);
                document.getElementById('subscriberModalBody').innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading subscriber</div>';
            });
    };

    function renderSubscriberDetail(sub) {
        var initial = sub.name ? sub.name.charAt(0).toUpperCase() : '?';
        var gameIcons = {
            sequence: 'üß†',
            startrail: '‚ö°',
            duo: 'üëÅÔ∏è',
            gonogo: 'üéØ',
            trailtrotter: 'üèÉ',
            gotrotters: 'üèÄ'
        };
        var gameNames = {
            sequence: 'Sequence Memory',
            startrail: 'StarTrail',
            duo: 'Pattern Duo',
            gonogo: 'Go/No-Go',
            trailtrotter: 'TrailTrotter',
            gotrotters: 'GoTrotters'
        };
        
        var html = '<div class="subscriber-detail-header">';
        html += '<div class="subscriber-avatar">' + initial + '</div>';
        html += '<div class="subscriber-info" style="flex:1">';
        html += '<h4>' + (sub.name || 'Unknown') + (sub.is_family_member ? ' <span style="color:var(--teal);font-size:0.8rem">(Family Member)</span>' : '') + '</h4>';
        html += '<p>' + (sub.email || '-') + ' ‚Ä¢ PIN: <strong style="color:var(--orange)">' + sub.pin + '</strong></p>';
        html += '</div>';
        html += '<div class="action-btns">';
        html += '<button class="action-btn" onclick="window.editSubscriber(\'' + sub.pin + '\', ' + sub.is_family_member + ')" title="Edit">‚úèÔ∏è</button>';
        html += '<button class="action-btn delete" onclick="window.deleteSubscriber(\'' + sub.pin + '\', \'' + (sub.name || sub.email) + '\')" title="Delete">üóëÔ∏è</button>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="subscriber-stats-grid">';
        html += '<div class="subscriber-stat"><div class="subscriber-stat-value">' + (sub.totalSessions || 0) + '</div><div class="subscriber-stat-label">Sessions</div></div>';
        html += '<div class="subscriber-stat"><div class="subscriber-stat-value">üî• ' + (sub.streak || 0) + '</div><div class="subscriber-stat-label">Streak</div></div>';
        html += '<div class="subscriber-stat"><div class="subscriber-stat-value">' + (sub.status || '-') + '</div><div class="subscriber-stat-label">Status</div></div>';
        html += '</div>';
        
        // Game scores section
        html += '<div class="game-scores-section">';
        html += '<h5>' + (currentLang === 'es' ? 'Mejores Puntuaciones por Juego' : 'Best Scores by Game') + '</h5>';
        
        var hasBestScores = sub.best && Object.keys(sub.best).length > 0;
        if (hasBestScores) {
            for (var game in sub.best) {
                var scoreData = sub.best[game];
                var icon = gameIcons[game] || 'üéÆ';
                var name = gameNames[game] || game;
                var shiftClass = 'shift-' + scoreData.shift;
                
                html += '<div class="game-score-row">';
                html += '<div class="game-score-name"><span class="icon">' + icon + '</span> ' + name + '</div>';
                html += '<div class="game-score-stats">';
                html += '<div class="game-score-value">' + scoreData.score + '</div>';
                html += '<span class="shift-badge-large ' + shiftClass + '">Shift ' + scoreData.shift + '</span>';
                html += '</div>';
                html += '</div>';
            }
        } else {
            html += '<div style="text-align:center;padding:20px;color:var(--muted)">' + (currentLang === 'es' ? 'A√∫n no hay puntuaciones' : 'No scores yet') + '</div>';
        }
        
        // Sessions breakdown
        if (sub.sessions && Object.keys(sub.sessions).length > 0) {
            html += '<h5 style="margin-top:20px">' + (currentLang === 'es' ? 'Sesiones por Juego' : 'Sessions by Game') + '</h5>';
            for (var game in sub.sessions) {
                var icon = gameIcons[game] || 'üéÆ';
                var name = gameNames[game] || game;
                html += '<div class="game-score-row">';
                html += '<div class="game-score-name"><span class="icon">' + icon + '</span> ' + name + '</div>';
                html += '<div class="game-score-value">' + sub.sessions[game] + ' sessions</div>';
                html += '</div>';
            }
        }
        
        html += '</div>';
        
        document.getElementById('subscriberModalBody').innerHTML = html;
        
        // Store current subscriber data for edit
        window.currentSubscriberData = sub;
    }

    var deleteSubscriberPin = null;

    window.editSubscriber = function(pin, isFamily) {
        closeModal('subscriberModal');
        
        var sub = window.currentSubscriberData;
        if (!sub) return;
        
        document.getElementById('editSubPin').value = pin;
        document.getElementById('editSubIsFamily').value = isFamily ? 'true' : 'false';
        document.getElementById('editSubNewPin').value = pin;
        
        if (isFamily) {
            document.getElementById('editEmailGroup').style.display = 'none';
            document.getElementById('editNameGroup').style.display = 'block';
            document.getElementById('editStatusGroup').style.display = 'none';
            document.getElementById('editPlanGroup').style.display = 'none';
            document.getElementById('editSubName').value = sub.name || '';
            document.getElementById('editSubscriberModalTitle').textContent = currentLang === 'es' ? 'EDITAR MIEMBRO' : 'EDIT FAMILY MEMBER';
        } else {
            document.getElementById('editEmailGroup').style.display = 'block';
            document.getElementById('editNameGroup').style.display = 'none';
            document.getElementById('editStatusGroup').style.display = 'block';
            document.getElementById('editPlanGroup').style.display = 'block';
            document.getElementById('editSubEmail').value = sub.email || '';
            document.getElementById('editSubStatus').value = sub.status || 'active';
            document.getElementById('editSubPlan').value = sub.plan_type || 'individual_monthly';
            document.getElementById('editSubscriberModalTitle').textContent = currentLang === 'es' ? 'EDITAR SUSCRIPTOR' : 'EDIT SUBSCRIBER';
        }
        
        openModal('editSubscriberModal');
    };

    window.deleteSubscriber = function(pin, name) {
        deleteSubscriberPin = pin;
        document.getElementById('deleteSubscriberText').innerHTML = (currentLang === 'es' ? 'Eliminar ' : 'Delete ') + '<strong style="color:var(--orange)">' + name + '</strong>?';
        closeModal('subscriberModal');
        openModal('deleteSubscriberModal');
    };

    function saveSubscriber() {
        var pin = document.getElementById('editSubPin').value;
        var isFamily = document.getElementById('editSubIsFamily').value === 'true';
        var newPin = document.getElementById('editSubNewPin').value;
        
        var body = { pin: newPin };
        
        if (isFamily) {
            body.name = document.getElementById('editSubName').value;
        } else {
            body.email = document.getElementById('editSubEmail').value;
            body.status = document.getElementById('editSubStatus').value;
            body.plan_type = document.getElementById('editSubPlan').value;
        }
        
        fetch('/api/admin/subscriber/' + pin, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken 
            },
            body: JSON.stringify(body)
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                closeModal('editSubscriberModal');
                loadSubscribers();
                showToast(currentLang === 'es' ? 'Guardado' : 'Saved');
            } else {
                showToast(data.error || 'Error', true);
            }
        })
        .catch(function(err) {
            console.error('Error saving subscriber:', err);
            showToast('Error', true);
        });
    }

    function confirmDeleteSubscriber() {
        if (!deleteSubscriberPin) return;
        
        fetch('/api/admin/subscriber/' + deleteSubscriberPin, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                closeModal('deleteSubscriberModal');
                loadSubscribers();
                showToast(currentLang === 'es' ? 'Eliminado' : 'Deleted');
            } else {
                showToast(data.error || 'Error', true);
            }
        })
        .catch(function(err) {
            console.error('Error deleting subscriber:', err);
            showToast('Error', true);
        });
        
        deleteSubscriberPin = null;
    }

    function renderFacilities() {
        var tbody = document.getElementById('facilitiesTable');
        
        if (facilities.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--muted)"><span class="lang-en">No facilities yet</span><span class="lang-es">A√∫n no hay centros</span></td></tr>';
            return;
        }

        var html = '';
        facilities.forEach(function(fac) {
            var statusClass = fac.status === 'active' ? 'badge-active' : (fac.status === 'expired' ? 'badge-canceled' : 'badge-trialing');
            var expiresDate = fac.expires_at ? new Date(fac.expires_at).toLocaleDateString() : '-';
            
            html += '<tr>';
            html += '<td><strong>' + (fac.name || '-') + '</strong></td>';
            html += '<td><code style="background:var(--darker);padding:4px 8px;border-radius:4px">' + (fac.license_key || '-') + '</code></td>';
            html += '<td>' + (fac.user_count || 0) + ' / ' + (fac.user_limit || 0) + '</td>';
            html += '<td>' + (fac.total_sessions || 0) + '</td>';
            html += '<td><span class="badge ' + statusClass + '">' + (fac.status || 'unknown') + '</span></td>';
            html += '<td>' + expiresDate + '</td>';
            html += '</tr>';
        });
        
        tbody.innerHTML = html;
    }

    function getActivityIcon(type) {
        var icons = {
            'subscription_created': { icon: 'üí≥', class: 'subscription' },
            'subscription_updated': { icon: 'üí≥', class: 'subscription' },
            'subscription_canceled': { icon: '‚ùå', class: 'subscription' },
            'subscriber_login': { icon: 'üîë', class: 'subscription' },
            'user_register': { icon: 'üë§', class: 'user' },
            'user_login': { icon: 'üîë', class: 'user' },
            'game_session': { icon: 'üéÆ', class: 'game' },
            'facility_login': { icon: 'üè¢', class: 'facility' },
            'family_member_added': { icon: 'üë®‚Äçüë©‚Äçüëß', class: 'subscription' },
            'family_member_removed': { icon: 'üë§', class: 'subscription' }
        };
        return icons[type] || { icon: 'üìã', class: 'gear' };
    }

    function formatTimeAgo(timestamp) {
        if (!timestamp) return '-';
        var date = new Date(timestamp);
        var now = new Date();
        var diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return currentLang === 'es' ? 'hace ' + diff + 's' : diff + 's ago';
        if (diff < 3600) return currentLang === 'es' ? 'hace ' + Math.floor(diff/60) + 'm' : Math.floor(diff/60) + 'm ago';
        if (diff < 86400) return currentLang === 'es' ? 'hace ' + Math.floor(diff/3600) + 'h' : Math.floor(diff/3600) + 'h ago';
        return currentLang === 'es' ? 'hace ' + Math.floor(diff/86400) + 'd' : Math.floor(diff/86400) + 'd ago';
    }

    function getActivityCategory(type) {
        if (type && type.includes('subscription') || type && type.includes('subscriber')) return 'subscription';
        if (type === 'game_session') return 'game';
        if (type && (type.includes('milestone') || type.includes('shift') || type.includes('master'))) return 'milestone';
        return 'other';
    }

    function isMilestone(details) {
        if (!details) return false;
        var lower = details.toLowerCase();
        return lower.includes('shift 5') || lower.includes('shift 7') || lower.includes('shift 10') || 
               lower.includes('master') || lower.includes('streak');
    }

    function getDateKey(timestamp) {
        if (!timestamp) return 'unknown';
        var date = new Date(timestamp);
        return date.toISOString().split('T')[0];
    }

    function formatDateLabel(dateKey) {
        var today = new Date().toISOString().split('T')[0];
        var yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        
        if (dateKey === today) return currentLang === 'es' ? 'Hoy' : 'Today';
        if (dateKey === yesterday) return currentLang === 'es' ? 'Ayer' : 'Yesterday';
        
        var date = new Date(dateKey + 'T00:00:00');
        var options = { weekday: 'short', month: 'short', day: 'numeric' };
        return date.toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US', options);
    }

    function calculateActivityStats() {
        var now = new Date();
        var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        var weekStart = todayStart - (now.getDay() * 86400000);
        
        var sessionsToday = 0;
        var sessionsWeek = 0;
        var newSubsWeek = 0;
        var milestonesWeek = 0;
        
        activities.forEach(function(act) {
            var ts = new Date(act.timestamp).getTime();
            var isGame = act.type === 'game_session';
            var isSub = act.type && act.type.includes('subscription_created');
            var isMile = isMilestone(act.details);
            
            if (ts >= todayStart && isGame) sessionsToday++;
            if (ts >= weekStart) {
                if (isGame) sessionsWeek++;
                if (isSub) newSubsWeek++;
                if (isMile) milestonesWeek++;
            }
        });
        
        document.getElementById('sessionsToday').textContent = sessionsToday;
        document.getElementById('sessionsWeek').textContent = sessionsWeek;
        document.getElementById('newSubsWeek').textContent = newSubsWeek;
        document.getElementById('milestonesWeek').textContent = milestonesWeek;
    }

    function aggregateActivities(activityList) {
        var grouped = {};
        
        activityList.forEach(function(act) {
            var dateKey = getDateKey(act.timestamp);
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(act);
        });
        
        // Aggregate game sessions per user per day
        var result = {};
        for (var dateKey in grouped) {
            var dayActivities = grouped[dateKey];
            var userGames = {};
            var otherActivities = [];
            var allIds = [];
            var allIndices = [];
            
            dayActivities.forEach(function(act) {
                if (act.id) allIds.push(act.id);
                if (act._originalIndex !== undefined) allIndices.push(act._originalIndex);
                
                if (act.type === 'game_session' && act.username) {
                    if (!userGames[act.username]) {
                        userGames[act.username] = { count: 0, games: [], ids: [], indices: [], details: act.details, timestamp: act.timestamp };
                    }
                    userGames[act.username].count++;
                    if (act.id) userGames[act.username].ids.push(act.id);
                    if (act._originalIndex !== undefined) userGames[act.username].indices.push(act._originalIndex);
                    if (act.details) {
                        var gameName = act.details.split('|')[0].trim();
                        if (userGames[act.username].games.indexOf(gameName) === -1) {
                            userGames[act.username].games.push(gameName);
                        }
                    }
                } else {
                    otherActivities.push(act);
                }
            });
            
            result[dateKey] = { aggregated: userGames, other: otherActivities, allIds: allIds, allIndices: allIndices };
        }
        
        return result;
    }

    function renderActivity() {
        var container = document.getElementById('activityList');
        
        calculateActivityStats();
        
        if (activities.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text"><span class="lang-en">No activity yet</span><span class="lang-es">A√∫n no hay actividad</span></div></div>';
            return;
        }

        // Filter activities but keep original index
        var filtered = [];
        activities.forEach(function(act, idx) {
            var include = false;
            if (currentActivityFilter === 'all') {
                include = true;
            } else {
                var category = getActivityCategory(act.type);
                if (currentActivityFilter === 'milestone') {
                    include = category === 'milestone' || isMilestone(act.details);
                } else {
                    include = category === currentActivityFilter;
                }
            }
            if (include) {
                var actWithIndex = {};
                for (var key in act) { actWithIndex[key] = act[key]; }
                actWithIndex._originalIndex = idx;
                filtered.push(actWithIndex);
            }
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-state-text"><span class="lang-en">No matching activity</span><span class="lang-es">Sin actividad coincidente</span></div></div>';
            return;
        }

        var aggregated = aggregateActivities(filtered);
        var dateKeys = Object.keys(aggregated).sort().reverse();
        
        var html = '<div style="padding: 0 20px 20px;">';
        
        dateKeys.slice(0, 14).forEach(function(dateKey, dayIndex) {
            var dayData = aggregated[dateKey];
            var totalItems = Object.keys(dayData.aggregated).length + dayData.other.length;
            var totalCount = dayData.allIds.length;
            var isCollapsed = dayIndex > 1 ? ' collapsed' : '';
            var idsJson = JSON.stringify(dayData.allIds);
            
            html += '<div class="day-group' + isCollapsed + '" data-date="' + dateKey + '">';
            html += '<div class="day-group-header">';
            html += '<div class="day-group-title" onclick="window.toggleDayGroup(this.parentElement)">';
            html += '<span>' + formatDateLabel(dateKey) + '</span>';
            html += '<span class="day-group-count">' + totalItems + '</span>';
            html += '</div>';
            html += '<button class="day-delete-btn" onclick="event.stopPropagation(); window.promptDeleteDay(\'' + dateKey + '\', ' + totalCount + ')" title="' + (currentLang === 'es' ? 'Eliminar d√≠a' : 'Delete day') + '">üóëÔ∏è ' + (currentLang === 'es' ? 'D√≠a' : 'Day') + '</button>';
            html += '<span class="day-group-toggle" onclick="window.toggleDayGroup(this.parentElement)">‚ñº</span>';
            html += '</div>';
            
            html += '<div class="day-group-items">';
            
            // Render aggregated game sessions
            for (var username in dayData.aggregated) {
                var userData = dayData.aggregated[username];
                var gamesPlayed = userData.games.join(', ') || 'Games';
                var userIdsJson = JSON.stringify(userData.ids);
                
                html += '<div class="aggregated-item">';
                html += '<div class="aggregated-icon game">üéÆ</div>';
                html += '<div class="aggregated-content">';
                html += '<div class="aggregated-text"><strong>' + username + '</strong> ' + (currentLang === 'es' ? 'jug√≥' : 'played') + ' <strong>' + userData.count + '</strong> ' + (userData.count === 1 ? (currentLang === 'es' ? 'sesi√≥n' : 'session') : (currentLang === 'es' ? 'sesiones' : 'sessions')) + '</div>';
                html += '<div class="aggregated-details">' + gamesPlayed + '</div>';
                html += '</div>';
                html += '<button class="activity-delete-btn" onclick="window.promptDeleteUserSessions(\'' + dateKey + '\', \'' + username + '\', ' + userData.count + ')" title="' + (currentLang === 'es' ? 'Eliminar' : 'Delete') + '">üóëÔ∏è</button>';
                html += '</div>';
            }
            
            // Render other activities (subscriptions, milestones, etc.)
            dayData.other.forEach(function(act) {
                var iconInfo = getActivityIcon(act.type);
                var description = act.details || act.type || 'Activity';
                var hasMilestone = isMilestone(description);
                var iconClass = hasMilestone ? 'milestone' : (act.type && act.type.includes('subscription') ? 'subscription' : 'game');
                var actId = act.id || '';
                var actIndex = act._originalIndex;
                
                html += '<div class="aggregated-item">';
                html += '<div class="aggregated-icon ' + iconClass + '">' + iconInfo.icon + '</div>';
                html += '<div class="aggregated-content">';
                html += '<div class="aggregated-text">';
                if (act.username) html += '<strong>' + act.username + '</strong> - ';
                html += description;
                if (hasMilestone) html += ' <span class="milestone-badge">üèÜ</span>';
                html += '</div>';
                if (act.facility) html += '<div class="aggregated-details">' + act.facility + '</div>';
                html += '</div>';
                // Always show delete button - use ID if available, otherwise use index
                html += '<button class="activity-delete-btn" onclick="window.promptDeleteSingle(\'' + actId + '\', \'' + (act.username || '') + '\', ' + actIndex + ')" title="' + (currentLang === 'es' ? 'Eliminar' : 'Delete') + '">üóëÔ∏è</button>';
                html += '</div>';
            });
            
            html += '</div></div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    window.toggleDayGroup = function(header) {
        var group = header.parentElement;
        group.classList.toggle('collapsed');
    };

    // Delete activity prompts
    window.promptDeleteDay = function(dateKey, count) {
        pendingActivityDelete = { type: 'day', ids: [], date: dateKey, username: null };
        document.getElementById('deleteActivityTitle').innerHTML = currentLang === 'es' ? '¬øELIMINAR D√çA COMPLETO?' : 'DELETE ENTIRE DAY?';
        document.getElementById('deleteActivityText').innerHTML = currentLang === 'es' 
            ? 'Esto eliminar√° <strong>todas las actividades</strong> del ' + formatDateLabel(dateKey) + '.'
            : 'This will delete <strong>all activities</strong> from ' + formatDateLabel(dateKey) + '.';
        document.getElementById('deleteActivitySummary').style.display = 'block';
        document.getElementById('deleteActivityCount').textContent = count;
        openModal('deleteActivityModal');
    };

    window.promptDeleteUserSessions = function(dateKey, username, count) {
        pendingActivityDelete = { type: 'user_day', ids: [], date: dateKey, username: username };
        document.getElementById('deleteActivityTitle').innerHTML = currentLang === 'es' ? '¬øELIMINAR SESIONES?' : 'DELETE SESSIONS?';
        document.getElementById('deleteActivityText').innerHTML = currentLang === 'es' 
            ? 'Esto eliminar√° todas las sesiones de <strong>' + username + '</strong> del ' + formatDateLabel(dateKey) + '.'
            : 'This will delete all sessions for <strong>' + username + '</strong> from ' + formatDateLabel(dateKey) + '.';
        document.getElementById('deleteActivitySummary').style.display = 'block';
        document.getElementById('deleteActivityCount').textContent = count;
        openModal('deleteActivityModal');
    };

    window.promptDeleteSingle = function(actId, username, actIndex) {
        pendingActivityDelete = { type: 'single', ids: actId ? [actId] : [], date: null, username: username, index: actIndex };
        document.getElementById('deleteActivityTitle').innerHTML = currentLang === 'es' ? '¬øELIMINAR ACTIVIDAD?' : 'DELETE ACTIVITY?';
        document.getElementById('deleteActivityText').innerHTML = currentLang === 'es' 
            ? 'Esto eliminar√° esta actividad' + (username ? ' de <strong>' + username + '</strong>' : '') + '.'
            : 'This will delete this activity' + (username ? ' for <strong>' + username + '</strong>' : '') + '.';
        document.getElementById('deleteActivitySummary').style.display = 'none';
        openModal('deleteActivityModal');
    };

    function promptClearAllActivity() {
        pendingActivityDelete = { type: 'all', ids: [], date: null, username: null };
        document.getElementById('deleteActivityTitle').innerHTML = currentLang === 'es' ? '¬øLIMPIAR TODA LA ACTIVIDAD?' : 'CLEAR ALL ACTIVITY?';
        document.getElementById('deleteActivityText').innerHTML = currentLang === 'es' 
            ? 'Esto eliminar√° <strong>TODA</strong> la actividad registrada. Esta acci√≥n no se puede deshacer.'
            : 'This will delete <strong>ALL</strong> recorded activity. This cannot be undone.';
        document.getElementById('deleteActivitySummary').style.display = 'block';
        document.getElementById('deleteActivityCount').textContent = activities.length;
        openModal('deleteActivityModal');
    }

    function confirmDeleteActivity() {
        var deleteInfo = pendingActivityDelete;
        closeModal('deleteActivityModal');
        
        if (deleteInfo.type === 'all') {
            deleteAllActivity();
        } else if (deleteInfo.type === 'single') {
            if (deleteInfo.ids.length > 0 && deleteInfo.ids[0]) {
                deleteActivityById(deleteInfo.ids[0]);
            } else if (deleteInfo.index !== undefined) {
                deleteActivityByIndex(deleteInfo.index);
            }
        } else if (deleteInfo.type === 'day' && deleteInfo.date) {
            deleteActivitiesByDate(deleteInfo.date);
        } else if (deleteInfo.type === 'user_day' && deleteInfo.date && deleteInfo.username) {
            deleteActivitiesByUserDate(deleteInfo.username, deleteInfo.date);
        }
    }

    function deleteAllActivity() {
        fetch(API_BASE + '/admin/activity/all', {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) {
            if (res.ok) {
                showToast(currentLang === 'es' ? 'Toda la actividad eliminada' : 'All activity deleted');
                loadActivity();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(function(err) {
            showToast(currentLang === 'es' ? 'Error al eliminar' : 'Delete failed', true);
        });
    }

    function deleteActivityById(actId) {
        fetch(API_BASE + '/admin/activity/' + actId, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) {
            if (res.ok) {
                showToast(currentLang === 'es' ? 'Actividad eliminada' : 'Activity deleted');
                loadActivity();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(function(err) {
            showToast(currentLang === 'es' ? 'Error al eliminar' : 'Delete failed', true);
        });
    }

    function deleteActivityByIndex(index) {
        fetch(API_BASE + '/admin/activity/by-index/' + index, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) {
            if (res.ok) {
                showToast(currentLang === 'es' ? 'Actividad eliminada' : 'Activity deleted');
                loadActivity();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(function(err) {
            showToast(currentLang === 'es' ? 'Error al eliminar' : 'Delete failed', true);
        });
    }

    function deleteActivitiesByDate(dateKey) {
        fetch(API_BASE + '/admin/activity/by-date/' + dateKey, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) {
            if (res.ok) {
                showToast(currentLang === 'es' ? 'Actividades eliminadas' : 'Activities deleted');
                loadActivity();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(function(err) {
            showToast(currentLang === 'es' ? 'Error al eliminar' : 'Delete failed', true);
        });
    }

    function deleteActivitiesByUserDate(username, dateKey) {
        fetch(API_BASE + '/admin/activity/by-user-date/' + encodeURIComponent(username) + '/' + dateKey, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        })
        .then(function(res) {
            if (res.ok) {
                showToast(currentLang === 'es' ? 'Sesiones eliminadas' : 'Sessions deleted');
                loadActivity();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(function(err) {
            showToast(currentLang === 'es' ? 'Error al eliminar' : 'Delete failed', true);
        });
    }

    function renderOverviewActivity() {
        var container = document.getElementById('overviewActivity');
        
        if (activities.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text"><span class="lang-en">No activity yet</span><span class="lang-es">A√∫n no hay actividad</span></div></div>';
            return;
        }

        // Show summary view for overview - just key events
        var keyEvents = activities.filter(function(act) {
            var isSub = act.type && act.type.includes('subscription');
            var isMile = isMilestone(act.details);
            return isSub || isMile;
        }).slice(0, 5);

        // If no key events, show aggregated today
        if (keyEvents.length === 0) {
            var today = new Date().toISOString().split('T')[0];
            var todayGames = {};
            
            activities.forEach(function(act) {
                if (getDateKey(act.timestamp) === today && act.type === 'game_session' && act.username) {
                    if (!todayGames[act.username]) todayGames[act.username] = 0;
                    todayGames[act.username]++;
                }
            });
            
            var html = '<div style="padding: 15px 20px;">';
            var userCount = Object.keys(todayGames).length;
            
            if (userCount === 0) {
                html += '<div class="aggregated-item"><div class="aggregated-icon game">üìã</div><div class="aggregated-content"><div class="aggregated-text" style="color:var(--muted)">' + (currentLang === 'es' ? 'Sin actividad hoy' : 'No activity today') + '</div></div></div>';
            } else {
                for (var user in todayGames) {
                    html += '<div class="aggregated-item">';
                    html += '<div class="aggregated-icon game">üéÆ</div>';
                    html += '<div class="aggregated-content">';
                    html += '<div class="aggregated-text"><strong>' + user + '</strong> ' + (currentLang === 'es' ? 'jug√≥' : 'played') + ' <strong>' + todayGames[user] + '</strong> ' + (todayGames[user] === 1 ? (currentLang === 'es' ? 'sesi√≥n hoy' : 'session today') : (currentLang === 'es' ? 'sesiones hoy' : 'sessions today')) + '</div>';
                    html += '</div></div>';
                }
            }
            html += '</div>';
            container.innerHTML = html;
            return;
        }

        var html = '<div style="padding: 15px 20px;">';
        keyEvents.forEach(function(act) {
            var iconInfo = getActivityIcon(act.type);
            var description = act.details || act.type || 'Activity';
            var hasMilestone = isMilestone(description);
            var iconClass = hasMilestone ? 'milestone' : 'subscription';
            
            html += '<div class="aggregated-item">';
            html += '<div class="aggregated-icon ' + iconClass + '">' + iconInfo.icon + '</div>';
            html += '<div class="aggregated-content">';
            html += '<div class="aggregated-text">';
            if (act.username) html += '<strong>' + act.username + '</strong> - ';
            html += description;
            if (hasMilestone) html += ' <span class="milestone-badge">üèÜ</span>';
            html += '</div>';
            html += '<div class="aggregated-details">' + formatTimeAgo(act.timestamp) + '</div>';
            html += '</div></div>';
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    init();
})();
</script>
</body>
</html>
